# Sales Call Analyzer - Progress Tracker

Last Updated: 2026-01-28

## Current Status: Past Calls Transcript Analysis Feature Complete

---

## Past Calls Transcript Analysis Feature (2026-01-28)

### SUMMARY
Enhanced the Lead Quality page's Past Calls tab with transcript analysis capabilities, model selection, and configurable prompts.

### Features Implemented:

1. **Model Selection for Transcript Analysis**:
   - Users can choose between GPT-5-nano and Perplexity Sonar for analysis
   - Visual model selector with icons in the analysis modal
   - Model-specific service configuration checks before analysis

2. **Transcript Availability Detection**:
   - `GET /api/lead-quality/check-transcript/:id` - Check if transcript exists
   - Searches Calls tab by date range (±2 hours from booking) and name/email matching
   - Falls back to Fireflies search if not in Calls tab
   - Returns availability status for both sources

3. **Transcript Fetching & Linking**:
   - `POST /api/lead-quality/fetch-transcript/:id` - Fetch and link transcript
   - Can fetch from Calls tab or Fireflies
   - Options: `syncToCallsTab` (default: true), `autoAnalyze` (default: true)
   - Triggers full analysis pipeline (DFY detection, copy extraction) when syncing

4. **Transcript Analysis with Model Selection**:
   - `POST /api/lead-quality/analyze-transcript/:id` - Analyze with chosen model
   - Body: `{ model: 'gpt-5-nano' | 'perplexity-sonar' }`
   - Stores results with model_used in post_call_analysis_json field
   - Updates post_call_score based on analysis

5. **Configurable Transcript Analysis Prompts**:
   - `GET /api/settings/prompts/transcript-analysis` - Get current prompts
   - `PUT /api/settings/prompts/transcript-analysis` - Save prompts
   - `DELETE /api/settings/prompts/transcript-analysis` - Reset to defaults
   - Two configurable prompts: System Prompt, Scoring Prompt
   - Prompts stored in secrets.json (TRANSCRIPT_ANALYSIS_PROMPTS)

6. **Frontend UI Updates**:
   - Transcript Analysis Modal in lead-quality.html
   - Model selector with OpenAI and Perplexity icons
   - Transcript status display (linked, available, not found)
   - Fetch options (from Calls tab or Fireflies)
   - Settings page: Prompt editor with tabs for each prompt type

### Files Modified:
- `backend/routes/leadQuality.js` - Added analyze-transcript, fetch-transcript, check-transcript endpoints
- `backend/services/leadQualityService.js` - Added analyzeTranscript, checkTranscriptAvailability, fetchAndLinkTranscript
- `backend/services/secretManager.js` - Added getTranscriptAnalysisPrompts, saveTranscriptAnalysisPrompts
- `backend/routes/settings.js` - Added prompt management endpoints
- `backend/public/admin/lead-quality.html` - Added modal UI, model selector, JavaScript handlers
- `backend/public/admin/settings.html` - Added transcript prompt editor section
- `backend/public/admin/icons/openai.svg` - Created OpenAI icon

### API Endpoints:
```
GET  /api/lead-quality/check-transcript/:id  - Check transcript availability
POST /api/lead-quality/fetch-transcript/:id  - Fetch and link transcript
POST /api/lead-quality/analyze-transcript/:id - Analyze transcript (body: { model })
GET  /api/settings/prompts/transcript-analysis - Get prompts
PUT  /api/settings/prompts/transcript-analysis - Save prompts
DELETE /api/settings/prompts/transcript-analysis - Reset prompts
```

---

## PostgreSQL Data Flow Fix Deployed (2026-01-28 - Earlier)

---

## PostgreSQL Data Flow Fix - Dashboard/Founder Services (2026-01-28)

### SUMMARY
Fixed critical bug where Calls tab shows data but other tabs (Copy, Closing Rate, Founder) show zero data on PostgreSQL deployment. Root cause: services were using sql.js-specific APIs instead of the dbAdapter abstraction layer.

### Root Cause:
Several services bypassed the `dbAdapter` abstraction layer and used direct sql.js database calls:
- `database.exec()` and `database.run()` are sql.js-specific methods
- These methods don't exist on PostgreSQL's pg.Pool client
- Services affected: dashboardAggregationService, founderSnapshotService, searchService

### Fixes Applied:

1. **dashboardAggregationService.js**:
   - Replaced `database.exec()` calls with `dbAdapter.query()`
   - Added `parseJsonFields()` helper for consistent JSON parsing
   - Added `deleted_at IS NULL` filter to exclude soft-deleted calls
   - Fixed parameter placeholder format for PostgreSQL ($1, $2, etc.)

2. **founderSnapshotService.js**:
   - Replaced `database.exec()` calls with `dbAdapter.query()`
   - Added PostgreSQL/SQLite date handling via `dbAdapter.isUsingPostgres()`
   - Fixed `stripe_data` → `stripeData` field mapping
   - Added `parseJsonFields()` helper

3. **searchService.js**:
   - Complete rewrite to support both SQLite FTS4 and PostgreSQL full-text search
   - PostgreSQL: Uses `tsvector`, `plainto_tsquery`, `ts_headline`, GIN indexes
   - SQLite: Uses existing FTS4 virtual table approach
   - Added `deleted_at IS NULL` filter

### Files Modified:
- `backend/services/dashboardAggregationService.js` - Use dbAdapter.query()
- `backend/services/founderSnapshotService.js` - Use dbAdapter.query()
- `backend/services/searchService.js` - PostgreSQL full-text search support

### Test Results:
- dashboardAggregation: 26 tests passing
- founderSnapshotService: 40 tests passing
- Local API verification:
  - `/api/dashboard/filters` returns reps and date ranges
  - `/api/dashboard?limit=5` returns full aggregation data (47 analyzed calls)
  - `/api/founder/phil` returns 25 calls with metrics

### Deployment:
- Committed and pushed to Railway
- Commit: `4f90f34 Fix dashboard and founder services to use dbAdapter for PostgreSQL`

---

## Persistent Deleted Calls + Restore + Analysis Exclusion (2026-01-28)

### SUMMARY
Implemented soft delete for calls with auto-delete rules for internal/non-relevant calls, restore functionality, and analysis exclusion for deleted calls.

### Features Implemented:

1. **Database Schema Changes** - Added to `transcripts` table:
   - `deleted_at TIMESTAMP` - When call was deleted (null = active)
   - `deleted_reason TEXT` - Why it was deleted (e.g., 'manual', 'auto-filter:weekly')
   - Index on `deleted_at` for efficient queries

2. **Auto-Delete Rules** (applied on sync):
   - Title contains "weekly" anywhere → auto-deleted with reason `auto-filter:weekly`
   - Title contains "AF ads jour fixe" anywhere → auto-deleted with reason `auto-filter:jour-fixe`
   - Title is exactly "dev" (case-insensitive) → auto-deleted with reason `auto-filter:dev`
   - Titles like "dev call", "dev sync" are NOT auto-deleted (only exact "dev")

3. **Persistence Requirements**:
   - Deleted calls remain deleted across page refresh, app restart, re-sync
   - Sync/import does not overwrite deleted state
   - Re-syncing a deleted call keeps it deleted (wasAlreadyDeleted flag)

4. **UI/UX**:
   - View dropdown in Calls page: "Active Calls" (default) / "Deleted Calls"
   - Deleted view shows: Call Title, Rep, Call Date, Deleted timestamp, Reason badge
   - Bulk "Restore Selected" button in deleted view
   - Individual "Restore" button per row in deleted view
   - Tooltips on all new actions

5. **API Endpoints**:
   - `GET /api/admin/deleted` - List deleted calls with pagination
   - `POST /api/admin/calls/:id/restore` - Restore single call
   - `DELETE /api/admin/calls/:id` - Soft delete single call
   - `POST /api/bulk/delete` - Now does soft delete (was hard delete)
   - `POST /api/bulk/restore` - Restore multiple calls

6. **Analysis Exclusion**:
   - `getTranscriptsNeedingAnalysis()` excludes deleted calls
   - `getRecentTranscripts()` excludes deleted by default
   - `getTranscriptCount()` excludes deleted by default
   - Restored calls become eligible for analysis again

### Files Created:
- `backend/__tests__/softDelete.test.js` - 23 tests for soft delete feature

### Files Modified:
- `backend/services/dbAdapter.js` - Added deleted_at/deleted_reason columns + migration
- `backend/services/transcriptDb.js` - Added soft delete functions, auto-delete rules
- `backend/routes/bulkActions.js` - Changed delete to soft delete, added restore
- `backend/routes/admin.js` - Added deleted list and restore endpoints
- `backend/public/admin/index.html` - Added deleted view toggle, restore UI

### Test Results:
- 23 new tests in softDelete.test.js (all passing)
- 154 related tests pass (softDelete, bulkActions, transcriptDb, syncService)
- No lint errors in modified files

### Verification Steps (Local Testing):
1. Start server: `cd backend && node server.js`
2. Open http://localhost:3001/admin/
3. Select a call, click "Delete Selected" → should move to Deleted
4. Switch View dropdown to "Deleted Calls" → should see deleted call
5. Click "Restore" button → should move back to Active
6. Verify auto-delete: Sync a call with "weekly" in title → should auto-delete
7. Verify persistence: Delete a call, re-sync → should stay deleted

---

## Changelog Feature (2026-01-27)

### SUMMARY
Added a Changelog feature allowing admins to publish product updates visible to all users.

### Features Implemented:
1. **Database Schema** - New `changelog_entries` table with fields:
   - id, title, summary, details, tag (new/improvement/fix)
   - is_published, show_as_new_until, created_at, published_at

2. **API Routes** (`/api/changelog`):
   - GET / - Published entries only (all authenticated users)
   - GET /all - All entries including drafts (admin only)
   - POST / - Create entry (admin only)
   - PUT /:id - Update entry (admin only)
   - DELETE /:id - Delete entry (admin only)
   - POST /:id/publish - Publish draft (admin only)
   - POST /:id/unpublish - Unpublish entry (admin only)

3. **UI Page** (`/admin/changelog.html`):
   - Card-based layout for entries
   - Search filter by title/summary
   - Tag filters (All/New/Improvement/Fix)
   - "New" badge for recent entries (until show_as_new_until date)
   - Admin-only create/edit form with:
     - Title, Summary (bullet points), Details, Tag
     - Publish toggle (Draft/Published)
     - Show as New until date picker
   - Edit modal for updating entries
   - Publish/Unpublish quick actions

4. **Navigation**:
   - Added "Changelog" link in user dropdown menu (below Settings)
   - Visible to all users (admin and regular)
   - Updated in all 10 admin HTML pages

5. **Security**:
   - XSS prevention via input sanitization
   - Role-based access control (admin vs user)
   - Input validation on all fields

6. **Tests** (`changelogRoutes.test.js`):
   - 20 tests covering CRUD, access control, persistence
   - All tests passing

### Files Created:
- `backend/routes/changelog.js` - API routes
- `backend/public/admin/changelog.html` - UI page
- `backend/__tests__/changelogRoutes.test.js` - Tests

### Files Modified:
- `backend/services/transcriptDb.js` - Added changelog table + CRUD functions
- `backend/server.js` - Mounted changelog routes
- All 10 admin HTML files - Added Changelog link to user dropdown

---

## Smoke Test Results (2026-01-27)

### SUMMARY
Performed smoke tests on key features and cleaned up test data:
1. **Closing Rate Status Change** - PASSED
2. **Token Usage & Costs** - WORKING AS DESIGNED
3. **Calls Sorted by Date (Newest First)** - PASSED
4. **Test Account Cleanup** - COMPLETED
5. **Test Call Data Cleanup** - COMPLETED

### TEST CALL DATA CLEANUP - COMPLETED

**Issue Found:** Database contained 29 test calls from automated tests mixed with 349 real calls.
- Test calls had IDs like `mock-ff-*`, `test-ff-*`, `ff-route-*`, `ff-agg-*`
- Test calls had fake dates in January 2025 (over a year old)
- Real calls are from October 2025 - January 2026

**Actions Taken:**
1. Stopped running server
2. Deleted all test calls: `DELETE FROM transcripts WHERE fireflies_id LIKE 'mock-%' OR fireflies_id LIKE 'test-%' OR fireflies_id LIKE 'ff-%'`
3. Restarted server

**Database After Cleanup:**
```sql
SELECT COUNT(*) FROM transcripts;  -- Returns: 349 (real calls only)

-- Date range of remaining calls:
MIN(call_datetime): 2025-10-27  (about 3 months ago)
MAX(call_datetime): 2026-01-27  (today)

-- Calls by month:
2026-01: 93 calls
2025-12: 84 calls
2025-11: 130 calls
2025-10: 42 calls

-- Calls by rep:
Jamie: 281 calls
Phil: 46 calls
michelle: 15 calls (internal meetings)
Both: 7 calls (joint calls)
```

**Result:** All test data removed. Only real calls from the last ~4 months remain.

### CALLS DATE SORTING - SMOKE TEST PASSED

**Test Steps:**
1. Navigated to Calls page (/admin/index.html)
2. Scrolled through entire call list (349 real calls)
3. Verified dates are sorted from newest to oldest

**Results:**
- Top of list: Jan 27, 2026
- Middle: Jan 26 → Jan 24 → Jan 21 → ... → Dec 2025 → Nov 2025 → Oct 2025
- Bottom of list: Oct 27, 2025
- All 349 calls correctly sorted newest to oldest

### TEST ACCOUNT CLEANUP - COMPLETED

**Task:** Remove all test accounts from Access Requests & User Management, keep only Michelle's account.

**Actions Taken:**
1. Stopped running server (to prevent in-memory database from overwriting changes)
2. Deleted all users except michelle@affiliatefinder.ai from `users` table
3. Deleted all records from `access_requests` table
4. Removed jamie@affiliatefinder.ai from internal users seed list in `transcriptDb.js`
5. Restarted server

**Code Change:**
```javascript
// backend/services/transcriptDb.js - Line 1876
// Before:
const internalUsers = [
  { email: 'michelle@affiliatefinder.ai', name: 'Michelle', role: 'admin' },
  { email: 'jamie@affiliatefinder.ai', name: 'Jamie', role: 'admin' }
];

// After:
const internalUsers = [
  { email: 'michelle@affiliatefinder.ai', name: 'Michelle', role: 'admin' }
];
```

**Database Verification:**
```sql
SELECT COUNT(*) FROM users;        -- Returns: 1
SELECT email FROM users;           -- Returns: michelle@affiliatefinder.ai
SELECT COUNT(*) FROM access_requests;  -- Returns: 0
```

**Result:** Only Michelle's account remains. New users can be added via the Access Request workflow.

### CLOSING RATE STATUS CHANGE - SMOKE TEST PASSED

**Test Steps:**
1. Navigated to Closing Rate page (/admin/founder.html)
2. Scrolled to "Analyzed Calls" table
3. Clicked three-dot menu on first row ("John Smith and Phil Norris")
4. Clicked "Mark as Signed Up"
5. Verified API call successful (201 status, data returned with status: "signed_up")
6. Refreshed page (F5)
7. Enabled "Include manual lifecycle overrides" toggle in Manual Adjustments
8. Verified row now shows "Manual: Signed Up" badge

**Results:**
- Before toggle: 7% closing rate (2 signups from 27 sales calls)
- After toggle: 15% closing rate (4 signups from 27 sales calls)
- Status badge shows "Manual: Signed Up" with teal dashed border
- Another row shows "Manual: Active" confirming multiple status types work
- Changes persist after page refresh

**API Verification:**
```javascript
// Direct API call returned:
{
  "status": 201,
  "data": {
    "success": true,
    "data": {
      "id": "fb10040f-79f2-46c8-b0b4-e24894cee2e5",
      "call_id": "test-sales-001",
      "status": "signed_up",
      "updated_at": "2026-01-27T16:40:24.586Z"
    }
  }
}
```

### TOKEN USAGE & COSTS - WORKING AS DESIGNED

**Test Steps:**
1. Navigated to Settings page (/admin/settings.html)
2. Located "Token Usage & Costs" section
3. Verified it shows "No LLM Analyses Yet"
4. Checked API endpoint: `curl http://localhost:3001/api/settings/usage`

**Results:**
- API returns correct structure with 0 values (no LLM analyses have token data yet)
- OpenAI is configured with `gpt-5-nano` model
- The feature is fully implemented and working
- "No LLM Analyses Yet" message is correct because:
  - Existing analyses were created with heuristic mode (before LLM tracking)
  - Token usage is only tracked when LLM analysis mode is used
  - New analyses will populate the token usage data

**API Response:**
```json
{
  "success": true,
  "data": {
    "totalCalls": 0,
    "totalInputTokens": 0,
    "totalOutputTokens": 0,
    "totalTokens": 0,
    "totalCostCents": 0,
    "byModel": {},
    "byDay": {},
    "recentAnalyses": [],
    "lastUpdated": "2026-01-27T16:48:23.323Z",
    "modelCosts": {
      "gpt-5-nano": {"input": 0.0001, "output": 0.0004},
      "gpt-5-mini": {"input": 0.001, "output": 0.004},
      "gpt-4o": {"input": 0.0025, "output": 0.01},
      ...
    }
  }
}
```

**Code Verification:**
- `callAnalysisService.js` lines 340-384: Token usage is stored in `analysis.tokenUsage` when LLM mode is used
- `transcriptDb.js` lines 1688-1747: `getTokenUsageStats()` aggregates token data from `analysis_json` containing `tokenUsage`
- Database query confirmed: `SELECT COUNT(*) FROM transcripts WHERE analysis_json LIKE '%tokenUsage%';` returns 0

**Conclusion:** Feature is working correctly. Token usage will appear when new calls are analyzed using LLM mode.

---

## User Management Page Fix (2026-01-27)

### SUMMARY
Fixed User Management page not loading - was redirecting to Calls page due to null reference error.

### ROOT CAUSE
JavaScript reference to non-existent DOM element. The `currentUserName` element was removed during UI redesign but still referenced in checkAuth():
```javascript
// Line 841 - tried to set textContent on null element
currentUserName.textContent = currentUser.name;  // Throws error, redirects
```

### FIX APPLIED
Removed the obsolete reference since user info is now displayed in the header menu.

**File:** `backend/public/admin/users.html`

### VERIFICATION
1. Navigate to http://localhost:3001/admin/users.html
2. Page loads with full user list
3. All CRUD actions work: Edit, Deactivate, Reactivate, Reset Password
4. Role changes persist after page reload
5. Non-admin users are denied access (tested via User View mode)
6. Self-protection works (cannot deactivate/demote yourself)

### TEST RESULTS
18 user management tests pass:
- GET /api/auth/users (list users)
- GET /api/auth/users/:id (get single user)
- PUT /api/auth/users/:id (update user name/role)
- DELETE /api/auth/users/:id (deactivate user)
- POST /api/auth/users/:id/reactivate
- POST /api/auth/users/:id/resend-invite

---

## Closing Rate Status Change Persistence Fix (2026-01-27)

### SUMMARY
Fixed the Closing Rate page status changes (Mark as Signed Up/Active/Churned/Team/No Close) that were not persisting after clicking.

### ROOT CAUSE
**Frontend-backend response format mismatch.** The backend correctly stores and returns lifecycle overrides, but the frontend was accessing wrong property names in the JSON response:

| API Endpoint | Backend Returns | Frontend Expected | Fixed |
|-------------|-----------------|-------------------|-------|
| GET /lifecycle-overrides | `{ data: [...] }` | `{ overrides: [...] }` | → `data` |
| GET /inclusions | `{ data: [...] }` | `{ inclusions: [...] }` | → `data` |
| GET /manual-closes | `{ data: [...] }` | `{ closes: [...] }` | → `data` |
| POST /lifecycle-overrides | `{ data: {...} }` | `{ override: {...} }` | → `data` |

This caused:
1. Status overrides saved to DB but not loaded into the `lifecycleOverrides` Map on page load
2. After clicking "Mark as X", override created but local Map stored `undefined`
3. UI didn't show the override, and on refresh it was lost from the Map

### FIXES APPLIED

**1. founder.html - Fixed response property names (lines 1832-1847):**
```javascript
// Before (broken):
(inclData.inclusions || []).forEach(...)
(overData.overrides || []).forEach(...)
manualCloses = closesData.closes || []

// After (working):
(inclData.data || []).forEach(...)
(overData.data || []).forEach(...)
manualCloses = closesData.data || []
```

**2. founder.html - Fixed setLifecycleOverride handler (line 2497):**
```javascript
// Before (broken):
lifecycleOverrides.set(callId, data.override);

// After (working):
lifecycleOverrides.set(callId, data.data);
```

### FILES MODIFIED
- `backend/public/admin/founder.html` - Fixed 4 response property references
- `backend/__tests__/closingRateAdjustmentsRoutes.test.js` - Added 3 persistence tests

### VERIFICATION
```bash
# Run tests
npm test -- --testPathPattern="closingRateAdjustments" --no-coverage
# Result: 34 tests pass (31 existing + 3 new)

# Manual verification:
# 1. Go to Closing Rate page
# 2. Click three-dot menu on any row
# 3. Click "Mark as Signed Up"
# 4. Verify status badge appears
# 5. Refresh page (F5)
# 6. Verify status badge still shows
```

### TEST COVERAGE
Added 3 new tests in `closingRateAdjustmentsRoutes.test.js`:
- `setLifecycleOverride returns override object in data field`
- `getAllLifecycleOverrides returns array in data field for reload`
- `supports all valid status values including team and no_close`

---

## Closing Rate Page Fix (2026-01-27)

### SUMMARY
Fixed the Closing Rate (Founder Snapshot) page showing 0 sales calls and 0% closing rate.

### ROOT CAUSE
Two issues combined:
1. **Date filter comparison failure:** The `founderSnapshotService.js` was comparing dates using numeric timestamps (`new Date(startDate).getTime()`) but the database stores ISO strings (`'2025-01-20T14:00:00Z'`). SQLite string vs number comparison always fails.
2. **Default filter excluded all data:** Default was "Last 3 months" (Oct 2025 - Jan 2026) but calls are from Jan 2025.

### FIXES APPLIED

**1. founderSnapshotService.js - Fixed date filtering:**
```javascript
// Before (broken - comparing ISO strings with timestamps):
if (filters.startDate) {
  query += ' AND call_datetime >= ?';
  const startTs = new Date(filters.startDate).getTime();  // Returns 1735344000000
  params.push(startTs);
}

// After (working - using SQLite date() function):
if (filters.startDate) {
  query += ' AND date(call_datetime) >= ?';
  params.push(filters.startDate);  // '2024-01-01' compared properly
}
```

**2. founder.html - Changed default filter to "All time":**
- Changed HTML `<option selected>` from "Last 3 months" to "All time"
- Updated `currentDatePreset` variable default from `'last_3_months'` to `'all'`
- Updated URL persistence logic accordingly

**3. founder.html - Fixed Refresh button:**
- Changed from calling external services (Stripe/Slack) to just reloading data from database
- Added feedback: "Loading..." → "Done!" → "Refresh"
- Updated tooltip: "Reload analyzed calls from the database"

### FILES MODIFIED
- `backend/services/founderSnapshotService.js` - Fixed date comparison query
- `backend/public/admin/founder.html` - Default filter, refresh button behavior
- `backend/__tests__/founderSnapshotService.test.js` - Updated test for new query format

### VERIFICATION
```
# API now returns Phil's SALES calls:
curl "http://localhost:3456/api/founder/phil?start_date=2020-01-01&end_date=2026-12-31"
→ callCount: 34, signupCount: 0 (no Stripe data configured)

# All reps endpoint:
curl "http://localhost:3456/api/founder/all?start_date=2020-01-01&end_date=2026-12-31"
→ callCount: 57 SALES calls

# Tests pass:
npm test -- --testPathPattern="founder"
→ 66 tests passed
```

---

## Date Sorting Complete Fix (2026-01-27)

### SUMMARY
Fixed critical date sorting bug where calls were being "separated by rep" instead of sorted by date.

### ROOT CAUSE
The `call_datetime` column had **mixed data types**:
- 66 rows with TEXT (ISO strings like "2026-01-26T10:30:00.000Z")
- 53 rows with INTEGER (timestamps like 1769439600000)

When SQLite sorts mixed types, integers sort before text strings, causing Phil's calls (integers) to be grouped separately from Jamie's calls (text).

### FIX APPLIED
1. **Database Migration:** Converted all 53 integer timestamps to ISO strings
2. **Sync Service:** Added explicit datetime normalization in `transformTranscript()` to prevent future mixed formats

### CODE CHANGES

**syncService.js - Added datetime normalization:**
```javascript
// Normalize call datetime to ISO string for consistent sorting
let callDatetime = ffTranscript.date;
if (typeof callDatetime === 'number') {
  const ms = callDatetime > 10000000000 ? callDatetime : callDatetime * 1000;
  callDatetime = new Date(ms).toISOString();
}
```

**Database Migration Script:**
```javascript
db.run('UPDATE transcripts SET call_datetime = ? WHERE id = ?', [isoDate, id]);
```

### VERIFICATION
- All 119 rows now have TEXT type datetime
- Calls properly sorted by date regardless of rep
- Top 20 calls show: Phil 11, Jamie 8, michelle 1 (mixed, sorted by time)

---

## Duration Fix & Refresh Buttons (2026-01-27)

### SUMMARY
Fixed call duration display (was showing wrong values), fixed date sorting, and added refresh buttons to DFY and Copy pages.

### ISSUES FIXED

**1. Duration Display Showing "< 1 min" for all calls**
- **Root Cause:** Fireflies API returns duration in MINUTES, but we were storing it as seconds
- Real calls had durations like 19.5, 31.1, 26.4 (minutes) stored as seconds
- Fix: Convert Fireflies duration from minutes to seconds on sync
- Also ran database migration to fix all 113 existing records

**2. Date Sorting Not Working (Mixed Types)**
- **Root Cause:** Database had mixed types - integers for Phil's calls, text for Jamie's calls
- Fix: Migrated all integers to ISO strings, added normalization in syncService
- Calls now properly sorted by datetime DESC regardless of rep

**3. Refresh Buttons Added**
- Added "Refresh" button to DFY page (phil.html) in KPI strip
- Updated Copy page refresh button to just reload data (no sync)
- Both buttons have tooltips: "Reload analyzed calls from the database"

### FILES MODIFIED

**Backend:**
- `backend/services/syncService.js` - Convert Fireflies duration (minutes) to seconds
- `backend/database.sqlite` - Migrated 113 records to fix duration values

**Frontend:**
- `backend/public/admin/phil.html` - Added Refresh button with icon
- `backend/public/admin/copy.html` - Changed refresh to just reload data

### CODE CHANGES

**syncService.js - Duration conversion:**
```javascript
// Fireflies API returns duration in MINUTES, convert to seconds
const rawDuration = ffTranscript.duration || 0;
// If duration > 100, it's likely already in seconds (test data)
// If duration <= 100, it's likely in minutes (real Fireflies data)
const durationSeconds = rawDuration > 100 ? rawDuration : rawDuration * 60;
```

**Database migration:**
```sql
UPDATE transcripts SET duration_seconds = duration_seconds * 60
WHERE duration_seconds > 0 AND duration_seconds <= 100
```

### VERIFICATION

- Calls now show proper durations (20 mins, 31 mins, 26 mins, etc.)
- Calls sorted correctly by date (Jan 26 → Jan 22 → Jan 20 → etc.)
- Refresh buttons work on both DFY and Copy pages

---

## Date Filter Fix & Re-analyze Feature (2026-01-27)

### SUMMARY
Fixed date range filters and added re-analyze functionality for call detail pages.

### ISSUES INVESTIGATED

**1. Duration Display Showing "1 min"**
- **Status:** FIXED (see above)
- Was a data issue, not display issue

**2. Token Usage / Cost Calculation**
- **Status:** WORKING AS DESIGNED
- Shows "No LLM Analyses Yet" because no calls have been analyzed with LLM
- Old analyses don't have `tokenUsage` data (added in later version)
- The API endpoint `/api/settings/usage` returns correct stats

**3. Missing DFY Breakdown on Call Detail**
- **Root Cause:** Old analyses were done before DFY qualification was implemented
- They only contain `{version, insights, repName}` - no `dfyQualification` field
- Added "Re-analyze Call" button to update old analyses

### FIXES IMPLEMENTED

**1. Date Filter SQL Queries Fixed**
- Files: `backend/services/transcriptDb.js`
- Database had mixed formats: ISO strings AND numeric timestamps (milliseconds)
- SQLite's `date()` function returns NULL for numeric timestamps
- Added CASE expression to handle both formats:
  ```sql
  CASE
    WHEN typeof(call_datetime) = 'integer' THEN date(call_datetime / 1000, 'unixepoch') >= ?
    ELSE date(call_datetime) >= ?
  END
  ```
- Applied to both `getRecentTranscripts()` and `getTranscriptCount()`

**2. Data Ingestion Now Normalizes Datetimes**
- File: `backend/services/transcriptDb.js`
- Added `normalizeDatetime()` function to convert any format to ISO string
- All new transcripts saved with ISO string format

**3. API Response Normalizes Datetimes**
- File: `backend/routes/admin.js`
- Added `normalizeDateTime()` to convert numeric timestamps in API responses
- Frontend now always receives proper ISO strings

**4. Re-analyze Call Button Added**
- File: `backend/public/admin/call.html`
- Added "Re-analyze Call" button to Analysis Details panel
- Calls `POST /api/analysis/analyze/:id` with `{ force: true }`
- Allows users to update old analyses to get DFY qualification data
- Updated note text: "Click 'Re-analyze Call' to update"

### FILES MODIFIED

**Backend:**
- `backend/services/transcriptDb.js` - Date filter SQL, datetime normalization
- `backend/routes/admin.js` - Response datetime normalization
- `backend/public/admin/call.html` - Re-analyze button

### TEST RESULTS

```
# Date filters now return correct results:
Last 3 months: 53 calls (was 0)
This week: 2 calls
January 2026: 50 calls
January 2025: 6 calls

# Re-analyze endpoint works:
POST /api/analysis/analyze/agg-test-003 with force=true
→ Analysis now includes dfyQualification, dfyPitches, keyMoments

# Relevant tests pass:
npm test -- --testPathPattern="callAnalysis|admin"
→ 51 tests passed
```

---

## Call Analysis Pipeline Hardening (2026-01-27)

### SUMMARY
Deep-tested and hardened the call analysis path end-to-end to ensure:
- Calls appear after syncing (fixed filter defaults)
- Analysis persists across reload
- Dashboards show "Updating..." when analysis is in progress
- Bulk analysis uses 5-second delay between calls (verified)

### INVESTIGATION FINDINGS

**Root Cause of "No Calls After Sync":**
The calls WERE in the database (59 transcripts), but the default filter "Last 3 months" excluded them because:
- Calls were from January 2025
- Current date is January 2026
- "Last 3 months" = October 2025 - January 2026 (excludes all calls)

**5-Second Throttling:** ALREADY IMPLEMENTED
- File: `backend/routes/bulkActions.js:12`
- `ANALYSIS_DELAY_MS = 5000` (5 seconds between analyses)
- Exponential backoff on rate limits: 10s, 20s, 40s
- Max 3 retry attempts per call

**Analysis Persistence:** CONFIRMED WORKING
- Analysis stored in `transcripts.analysis_json` column
- `saveAnalysis()` calls `saveDatabase()` to persist to disk
- Sync does NOT overwrite analysis fields (only updates metadata)

### FIXES IMPLEMENTED

**1. Default Filters Changed to "All Time" / "All Reps"**
- File: `backend/public/admin/index.html`
- Changed default `datePreset` from `'last_3_months'` to `'all'`
- Changed default `repFilter` from `'Phil'` to `'all'`
- Updated HTML `<option selected>` attributes
- Updated URL persistence defaults

**2. Sync Now Handles "All Time" Date Range**
- File: `backend/public/admin/index.html` (triggerSync function)
- When preset is "All time", sync uses a 5-year date range
- Other presets correctly use getSyncDatePresetRange()

**3. "Updating..." Banner for All Dashboard Pages**
- New file: `backend/public/admin/js/analysis-status.js`
- Polls `/api/bulk/analyze/status` every 3 seconds
- Shows fixed banner when bulk analysis is in progress
- Auto-hides when analysis completes
- Added to: dashboard.html, copy.html, phil.html, founder.html, call.html
- NOT added to index.html (has its own detailed progress UI)

**4. E2E Test Harness Created**
- New file: `backend/__tests__/callAnalysisPipeline.test.js`
- 19 tests covering:
  - Calls appear after sync
  - Single call analysis
  - Analysis persistence across reload
  - Bulk analysis status endpoint
  - Filter functionality
  - Rate limit configuration
  - Sync doesn't overwrite analysis

### FILES MODIFIED

**Frontend (UI Changes):**
- `backend/public/admin/index.html` - Default filters, sync handling
- `backend/public/admin/dashboard.html` - Analysis status script
- `backend/public/admin/copy.html` - Analysis status script
- `backend/public/admin/phil.html` - Analysis status script
- `backend/public/admin/founder.html` - Analysis status script
- `backend/public/admin/call.html` - Analysis status script

**New Files:**
- `backend/public/admin/js/analysis-status.js` - Shared analysis status banner
- `backend/__tests__/callAnalysisPipeline.test.js` - E2E tests

**Backend (No Changes Required):**
- Bulk analysis throttling was already correctly implemented
- Analysis persistence was already working

### MANUAL VERIFICATION STEPS

1. **Calls Appear After Sync:**
   - Open /admin/index.html (Calls page)
   - Default filters should be "All time" and "All reps"
   - Calls should be visible immediately (59 calls)
   - Click "Sync Calls" - new calls appear after sync

2. **Analysis Persists:**
   - Select calls and click "Analyze Selected"
   - Wait for analysis to complete
   - Refresh page (F5)
   - Analyzed calls still show analysis status

3. **"Updating..." Banner:**
   - Start bulk analysis from Calls page
   - Navigate to Dashboard (/admin/dashboard.html)
   - Blue banner appears at top: "Analysis in progress... X / Y"
   - Banner disappears when analysis completes

4. **5-Second Throttling:**
   - Start bulk analysis with 5+ calls
   - Watch server console logs
   - Verify ~5 second gap between analysis jobs

### TEST RESULTS

```
npm test -- --testPathPattern="callAnalysisPipeline" --verbose

Test Suites: 1 passed, 1 total
Tests:       19 passed, 19 total
```

---

## UI Consistency & Bug Fixes Complete

---

## UI Consistency & Bug Fixes (2026-01-27)

### FEATURE: User View Toggle (Admin Preview Mode) - COMPLETE
**Purpose:** Allow admins to preview the app as a regular user without logging out.

**Implementation:**
- Frontend-only feature (no backend changes)
- Uses localStorage for persistence across page reloads
- Provides `getEffectiveRole(actualRole)` helper for permission checks

**New Files Created:**
- `backend/public/admin/js/view-mode.js` - Shared JavaScript module
- `backend/__tests__/viewMode.test.js` - 22 unit tests

**Files Modified:**
- `backend/public/admin/design-system.css` - Added view mode indicator and toggle button styles
- `backend/public/admin/index.html` - View mode support
- `backend/public/admin/call.html` - View mode support
- `backend/public/admin/copy.html` - View mode support
- `backend/public/admin/founder.html` - View mode support
- `backend/public/admin/phil.html` - View mode support
- `backend/public/admin/settings.html` - View mode support (with read-only notice)
- `backend/public/admin/dashboard.html` - View mode support
- `backend/public/admin/account.html` - View mode support
- `backend/public/admin/users.html` - View mode support + effectiveRole access check
- `backend/public/admin/access-requests.html` - View mode support + effectiveRole access check

**UI Elements:**
1. **Settings Dropdown Toggle:** "User view" / "Back to admin" button with eye icon
2. **Header Indicator:** Yellow badge showing "User view" when in user view mode (right side of header)
3. **Admin-only Element Hiding:** All `.ds-admin-only` elements hidden when in user view
4. **Admin Page Redirect:** users.html and access-requests.html redirect to /admin/ when in user view

**JavaScript API (ViewMode module):**
```javascript
ViewMode.getViewMode()       // Returns 'admin' or 'user'
ViewMode.setViewMode(mode)   // Sets view mode
ViewMode.isUserView()        // Returns true if in user view mode
ViewMode.getEffectiveRole(actualRole)  // Returns 'user' for admins in user view
ViewMode.toggleViewMode()    // Toggles mode and reloads page
ViewMode.initViewMode(actualRole)      // Initializes UI based on role
ViewMode.checkAdminPageAccess()        // Redirects if effectiveRole != 'admin'
```

**Manual Verification:**
1. Log in as admin
2. Click user menu dropdown → see "User view" option
3. Click "User view" → page reloads
4. Verify header shows yellow "User view" indicator
5. Verify dropdown now shows "Back to admin"
6. Navigate to Users page → should redirect to /admin/
7. Navigate to Settings page → should show read-only notice
8. Click "Back to admin" → returns to normal admin mode

**Test Coverage:** 22 tests passing
- ViewMode Module: getViewMode, setViewMode, isUserView, getEffectiveRole, toggleViewMode, persistence
- ViewMode UI Integration: dropdown toggle label, header indicator visibility, admin-only elements
- Admin Page Access Control: role-based access with effectiveRole

---

### BUG FIX 1: User Menu Dropdown Consistency Across All Pages - COMPLETE
**Problem:** User menu button showed different content across pages. Calls page (index.html) showed "Michelle Admin" with chevron, but Settings, Users, Access Requests, Phil pages showed only initials "MI".

**Root Cause:** Pages had inconsistent HTML structure. Index.html had the full ds-user-info section with ds-user-name and ds-user-role elements, while other pages were missing this structure.

**Solution:** Updated HTML structure and JavaScript across all affected pages to match index.html.

**Files Modified:**
- `backend/public/admin/settings.html` - Added ds-user-info structure, updated initUserMenu()
- `backend/public/admin/access-requests.html` - Added ds-user-info structure, updated initUserMenu()
- `backend/public/admin/users.html` - Added ds-user-info structure, updated initUserMenu()
- `backend/public/admin/phil.html` - Added ds-user-info structure, updated initUserMenu()
- `backend/public/admin/copy.html` - Added ds-user-info structure, updated initUserMenu()
- `backend/public/admin/founder.html` - Added ds-user-info structure, updated initUserMenu()
- `backend/public/admin/account.html` - Added ds-user-info structure, updated initUserMenu()
- `backend/public/admin/call.html` - Added ds-user-info structure, updated initUserMenu()
- `backend/public/admin/dashboard.html` - Added ds-user-info structure, updated initUserMenu()

**HTML Structure (standardized):**
```html
<button class="ds-user-button" id="user-menu-button">
  <div class="ds-user-avatar" id="user-avatar">--</div>
  <div class="ds-user-info">
    <span class="ds-user-name" id="user-display-name">Loading...</span>
    <span class="ds-user-role" id="user-display-role">-</span>
  </div>
  <svg class="ds-user-chevron">...</svg>
</button>
```

**JavaScript Updates:**
- `initUserMenu()` now populates user-display-name and user-display-role elements
- Dropdown structure updated from ds-user-info to ds-dropdown-header for consistency

---

### BUG FIX 2: Calls Data Inconsistency - COMPLETE
**Problem:** Calls page showed "6 TOTAL CALLS" in the stat card but "Showing all 0 calls" in the table - data mismatch between dashboard stats and filtered call list.

**Root Cause:** `loadDashboard()` fetched unfiltered stats from `/api/admin/dashboard` (showing all 6 calls), while `loadCalls()` fetched filtered results from `/api/admin/calls` (showing 0 after filters applied). The TOTAL CALLS stat card never updated after filters were applied.

**Solution:** Added a line to update the totalCalls display element after loadCalls() returns the filtered count.

**File Modified:** `backend/public/admin/index.html`

**Code Change:**
```javascript
// Update pagination state
paginationState.totalCalls = data.data.pagination.total;
paginationState.totalPages = isShowAll ? 1 : Math.ceil(data.data.pagination.total / limit);

// Update the TOTAL CALLS stat card to show filtered count
document.getElementById('totalCalls').textContent = paginationState.totalCalls;
```

---

### BUG FIX 3: Comprehensive Tooltips for All Buttons - COMPLETE
**Problem:** Tooltips were only partially implemented across admin pages - missing on most action buttons.

**Solution:** Added comprehensive tooltips to ALL 130 buttons across all admin pages using CSS [data-tooltip] attribute. Each tooltip describes the action, includes API endpoint where applicable, and notes any constraints (admin-only, irreversible, etc.).

**Files Modified:**
- `backend/public/admin/design-system.css` - Updated tooltip CSS for text wrapping
- `backend/public/admin/index.html` - 14 buttons with tooltips (user menu, logout, pagination, bulk actions, modals)
- `backend/public/admin/call.html` - 10 buttons with tooltips (analyze, re-analyze DFY, tabs)
- `backend/public/admin/copy.html` - 12 buttons with tooltips (filters, export, wording tabs, context drawer)
- `backend/public/admin/founder.html` - 20 buttons with tooltips (filters, modals, bulk actions, row actions, export)
- `backend/public/admin/phil.html` - 4 buttons with tooltips (filters)
- `backend/public/admin/settings.html` - 31 buttons with tooltips (all integration buttons)
- `backend/public/admin/users.html` - 15 buttons with tooltips (modals)
- `backend/public/admin/access-requests.html` - 12 buttons with tooltips (status tabs)
- `backend/public/admin/account.html` - 3 buttons with tooltips (password change)
- `backend/public/admin/dashboard.html` - 9 buttons with tooltips (filters, modals)

**CSS Updates to design-system.css:**
```css
[data-tooltip]::before {
  white-space: normal;  /* Changed from nowrap to allow wrapping */
  max-width: 280px;     /* Added max width for longer tooltips */
  text-align: center;   /* Center-align wrapped text */
}
```

**Tooltip Examples with API Endpoints:**
- Analyze Now → "Run AI analysis via POST /api/analysis/analyze"
- Re-analyze DFY → "Rerun DFY evidence analysis via POST /api/dfy/quality/reanalyze"
- Sync Calls → "Import new calls via POST /api/sync"
- Test OpenAI → "Verify API key works"
- Delete Calls → "Permanently delete calls via DELETE /api/calls"
- Logout → "End session via POST /api/auth/logout"
- Approve User → "Grant access via POST /api/auth/access-requests/:id/approve"

**Automated Test:**
- `backend/scripts/test-tooltip-coverage.js` - Scans all HTML files
- npm script: `npm run test:tooltips`
- Reports per-file coverage and fails if any button missing tooltip
- Skips login.html (uses different styling system)

**Coverage Results:**
```
✅ access-requests.html      12/12 buttons (100%)
✅ account.html              3/3 buttons (100%)
✅ call.html                 10/10 buttons (100%)
✅ copy.html                 12/12 buttons (100%)
✅ dashboard.html            9/9 buttons (100%)
✅ founder.html              20/20 buttons (100%)
✅ index.html                14/14 buttons (100%)
✅ phil.html                 4/4 buttons (100%)
✅ settings.html             31/31 buttons (100%)
✅ users.html                15/15 buttons (100%)

Summary: 130/130 buttons have tooltips (100%)
```

---

## QA Audit P0/P1 Implementation (2026-01-27)

### FEATURE 1 (P0): Per-call LLM Model Attribution - COMPLETE
Added Analysis Details panel to Call Detail page showing model, tokens, cost, and timestamp.

**Files Modified:**
- `backend/public/admin/call.html` - Added Analysis Details panel

**UI Changes:**
- New "Analysis Details" card after Analysis Status section
- 4-metric grid: Model, Tokens Used, Cost, Analyzed At
- Handles edge cases:
  - LLM analysis with tokenUsage: Shows model name, token count, cost, timestamp
  - Heuristic analysis: Shows "Heuristic", "N/A", "$0.00"
  - Legacy/unknown: Shows "Unknown" with explanatory note
- Premium styling with accent border, consistent with design system

**CSS Added:**
```css
.analysis-info-panel { border-left: 3px solid var(--color-accent); }
.analysis-info-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); }
.analysis-info-item { background: var(--color-surface-alt); padding; border-radius; text-align: center; }
.analysis-info-value.unknown { color: var(--color-text-muted); font-style: italic; }
```

**JavaScript Added:**
- `renderAnalysisInfo(analysis)` - Populates panel with analysis metadata
- Integration: Called from `renderAnalysis()`, hidden in `showAnalysisNeeded()`

---

### FEATURE 2 (P1): URL Filter Persistence for All 4 Pages - COMPLETE
Added URL filter persistence using history.replaceState to preserve filter state across page refreshes and enable shareable filtered URLs.

**Files Modified:**
- `backend/public/admin/index.html` - Calls page
- `backend/public/admin/copy.html` - Copy page
- `backend/public/admin/phil.html` - DFY page
- `backend/public/admin/founder.html` - Closing Rate page

**URL Parameters:**
- `preset` - Date preset (this_week, last_week, last_month, last_3_months, last_6_months, custom)
- `start`, `end` - Custom date range (only when preset=custom)
- `rep` - Rep filter (varies by page)
- Page-specific: `keyword` (Copy), `quality`/`score` (DFY)

**JavaScript Functions Added (per page):**
- `getFiltersFromURL()` - Read filter state from URL params
- `updateURLWithFilters()` - Update URL without page reload
- `syncUIWithFilters()` - Sync UI controls with filter state
- `initFiltersFromURL()` - Initialize from URL on page load
- `popstate` event handler - Support browser back/forward

**Behavior:**
- Page load: Restores filters from URL if present, otherwise uses defaults
- Apply Filters: Updates URL with current filter state
- Clear Filters: Removes URL parameters
- Browser navigation: Syncs filters when using back/forward buttons
- Shareable: Copy URL to share exact filter state with others

---

### FEATURE 3 (P1): Wording + Metaphors Sections Fully Implemented - COMPLETE
Implemented heuristic extraction of wording and metaphors from existing call analysis data.

**Backend Files Modified:**
- `backend/services/dashboardAggregationService.js` - Added wording and metaphor extraction functions
- `backend/routes/dashboard.js` - Added /wording and /metaphors API endpoints

**Frontend Files Modified:**
- `backend/public/admin/copy.html` - Updated to display wording and metaphors data

**Wording Extraction (3 categories):**
1. **Industry Terms** - Domain-specific vocabulary (affiliate, commission, conversion, tracking, etc.)
2. **Problem Language** - Colloquial expressions of frustration (nightmare, headache, drowning in, wasting time)
3. **Power Words** - High-impact emotional vocabulary (transform, urgent, critical, save, profit)

**Metaphors Extraction:**
- Identifies phrases with comparison markers ("it's like", "feels like", "similar to", "as if")
- Extracts context around metaphor markers
- Groups similar metaphors with occurrence counts

**New API Endpoints:**
- `GET /api/dashboard/wording` - Returns industryTerms, problemLanguage, powerWords arrays
- `GET /api/dashboard/metaphors` - Returns metaphors/analogies with excerpts and sources

**UI Changes:**
- Wording section now shows actual data with subtabs for each category
- Each item shows: term/phrase, count, call count, sample quote, source link
- Metaphors section shows extracted metaphors with type badges and source links
- Items ranked by frequency, top 3 highlighted

**Data Flow:**
- Extracts from existing `analysis_json` quotes (pains, goals, questions, dislikes, excitement)
- No re-analysis required - works with existing call analyses
- Filters out sales rep quotes to show only prospect language

---

## QA Testing & Bug Fixes (2026-01-27)

### Comprehensive End-to-End QA Testing

Performed full manual QA testing of all application pages based on PRD documentation.

**Pages Tested:**
- ✓ Calls page (index.html) - Filters, search, table display, sync history
- ✓ Call Detail page (call.html) - Transcript, analysis tabs, prospect profile
- ✓ Copy page (copy.html) - Customer Language Intelligence, 8 sections, KPIs
- ✓ Closing Rate page (founder.html) - Metrics, deduplication, manual adjustments
- ✓ DFY Quality page (phil.html) - KPIs, quality funnel, scoring explanation
- ✓ Settings page (settings.html) - API integrations, model config, token usage
- ✓ Account page (account.html) - User info, password change
- ✓ Users page (users.html) - User management, invite forms, modals
- ✓ Access Requests page (access-requests.html) - Request filtering, approve/deny

### Bugs Found & Fixed

**BUG 1: Duplicate Logout Button Handler in users.html**
- **File:** `backend/public/admin/users.html`
- **Issue:** TypeError: Cannot read properties of null (reading 'addEventListener') at line 1162
- **Cause:** Duplicate logout handler using wrong element ID (`logoutBtn` instead of `logout-button`)
- **Fix:** Removed redundant logout handler code (lines 1161-1172)

**BUG 2: Duplicate Logout Button Handler in access-requests.html**
- **File:** `backend/public/admin/access-requests.html`
- **Issue:** TypeError at line 792 - same issue as users.html
- **Fix:** Removed redundant logout handler code (lines 791-802)

**BUG 3: Invalid userName Element Reference in access-requests.html**
- **File:** `backend/public/admin/access-requests.html`
- **Issue:** TypeError: Cannot set properties of null (setting 'textContent') at line 782
- **Cause:** `document.getElementById('userName')` referenced non-existent element
- **Fix:** Removed redundant line - user display already handled by `initUserMenu()`

**BUG 4: dateRange Type Error in copy.html**
- **File:** `backend/public/admin/copy.html`
- **Issue:** TypeError: data.data.dateRange.earliest.split is not a function
- **Cause:** `dateRange.earliest` could be non-string type (null/number)
- **Fix:** Added `typeof === 'string'` check before calling `.split()`

### Regression Testing Results
All pages re-tested after fixes - no JavaScript errors on any page.

---

## UI Fixes (2026-01-26)

### FIX 1: Call Duration Display Format
Changed call duration display from time format (0:30, 1:00:00) to human-readable text.

**Changes:**
- `backend/public/admin/index.html` - Updated formatDuration()
- `backend/public/admin/call.html` - Updated formatDuration()
- `backend/public/admin/dashboard.html` - Updated formatDuration()
- `backend/__tests__/durationFormatting.test.js` - Updated tests for new format

**New Format:**
- "< 1 min" for very short calls (< 30 seconds)
- "1 min" for exactly 1 minute
- "30 mins", "60 mins", "90 mins" etc. for longer calls
- Always shows total minutes (no hours)

**Test Coverage:** 21 tests passing

### FIX 2: Remove Sales Rep Mentions from Copy View
Filtered out sales rep quotes from the Copy/Copywriting dashboard to show only customer language.

**Changes:**
- `backend/services/dashboardAggregationService.js` - Added rep quote filtering
  - New `isRepQuote()` function detects rep pitching/selling language
  - New `filterProspectInsights()` helper for filtering arrays
  - Applied filtering to: aggregatePains, aggregateGoals, aggregateQuestions, aggregateDislikes, aggregateExcitement

**Filtering Logic:**
- Detects rep pitching phrases ("our solution", "we can help", "let me show you")
- Detects rep discovery questions ("what are you currently using", "tell me about your")
- Keeps legitimate prospect quotes and questions

**Test Coverage:** 5 new tests + 21 existing = 26 total dashboard aggregation tests passing

---

## Internal Brain Premium Login UI (2026-01-26)

### Changes Made
Redesigned login page as "Internal Brain" with AffiliateFinder branding and premium executive styling.

### UI Changes (backend/public/admin/login.html)
- **Header**: AffiliateFinder logo (left) + "Internal Brain" title
- **Colors**: Primary #073b55, Accent #067280, gradient background
- **Styling**: Premium SaaS look with soft shadows, rounded cards, refined typography
- **Footer**: "Powered by Michelle - Made for the best team in the word"
- **Form**: Upgraded inputs with brand-colored focus states and CTA button

### Authentication Changes
- **Password-only**: Email + password authentication only (no magic links)
- **Domain restriction**: @affiliatefinder.ai only
- **Seeded users**: michelle@affiliatefinder.ai and jamie@affiliatefinder.ai
- **Password**: Both users seeded with "secrettool12345" (bcrypt hashed)
- **Seed function**: seedInternalUsers() in transcriptDb.js, called on server startup

### Backend Changes (backend/services/transcriptDb.js)
- Added seedInternalUsers() function
- Seeds michelle and jamie as admin users on startup
- Idempotent: skips if users already exist, updates password if not set

### Test Coverage
- 7 new tests in authService.test.js for internal users
- Tests: michelle login, jamie login, incorrect password rejection, domain validation
- All 91 auth tests passing

---

## Audit Results (2026-01-26)

### Summary
Full codebase audit completed. App is end-to-end functional with all core PRD features implemented.

### Verified Working (with test/code evidence)
- PRD Feature 1: Authentication - 20 routes, 174 tests (migrated to email+password)
- PRD Feature 2: Fireflies Sync - 5 routes, 22+ tests, rep filter
- PRD Feature 3: AI Call Analysis - 16 routes, 32 tests
- PRD Feature 3B: Call Classification - 47 tests
- PRD Feature 4-9: Dashboard & Insights - 7 routes, 34 tests
- PRD Feature 10: DFY Pitch Detection - 5 routes, 58 tests
- PRD Feature 11: Stripe Enrichment - 6 routes, 53 tests
- PRD Feature 13: Full-text Search - 3 routes, 49 tests (FTS4)
- PRD Feature 15: Admin Settings - 15+ routes, 66 tests

### Partial Implementation
- PRD Feature 14: Export - Closing Rate CSV export added (2026-01-26)

### Completed This Session
- PRD Feature 15: Token/Cost Tracking - COMPLETE
- Phil DFY Quality Tab Redesign - COMPLETE
- Decision Rationale & Evidence Drilldown - COMPLETE (NEW)
- Closing Rate CSV Export - COMPLETE (NEW)
- Email+Password Authentication Migration - COMPLETE
- **User Menu & Role-Based Access Control - COMPLETE**
- **Internal Brain Premium Login UI - COMPLETE (NEW)**

### Additional Features (not in PRD)
- Insight Snapshot Generator - 3 routes, 65 tests
- Founder Closing Rate - 2 routes, 25+ tests
- Bulk Actions - 4 routes, 21 tests
- Rep Filter for Sync - tests included in sync service
- Duration Auto-Format - 23 tests
- Phil DFY Quality Tab - 3 new routes, 61+ tests
- Decision Rationale & Evidence Drilldown - 24 new tests (NEW)
- Closing Rate CSV Export - 43 unit tests + 4 integration tests (NEW)
- Internal Brain Premium Login UI - 7 new tests (NEW)

### User Priority Decision
- Next task: Token/Cost Tracking (P1.1)
- No deadline constraints
- Polish as needed approach

---

## User Menu & Role-Based Access Control (2026-01-26)

### Changes Made
Added consistent user menu to all admin pages with role-based access control for Settings.

### Frontend Changes
- **All admin pages**: Added user menu dropdown in header (right side)
  - Shows email with initials avatar
  - Role badge (Admin/Rep)
  - Dropdown menu: Account, Settings, Sign Out
  - Admin-only items: Access Requests, Users
- **account.html (NEW)**: Self-service Account page
  - User information display (email, name, role, member since)
  - Change Password form (current password + new password + confirm)
  - Success/error feedback
- **settings.html**: Updated for role-based access
  - All users can VIEW settings (read-only for non-admins)
  - Non-admins see read-only notice banner
  - All edit/save/delete buttons hidden for non-admins via CSS
  - Admin-only forms: API key management, OpenAI config, re-analysis, integrations

### Backend Changes
- **auth.js**: Added POST /api/auth/change-password endpoint
  - Requires current password verification
  - Password validation (min 12 characters)
  - Session preserved after password change
- **authService.js**: Added changePassword() function
  - Verifies current password before allowing change
  - Returns appropriate error codes (USER_NOT_FOUND, INVALID_PASSWORD)
- **settings.js**: Added requireAuth, requireAdmin middleware to all write endpoints
  - POST /integrations/fireflies, /stripe, /openai, /slack, /calendly
  - PUT /integrations/openai/config
  - DELETE /integrations/* (all integration delete endpoints)
  - POST /reanalysis/trigger, /cancel, /resume/:id
  - POST /integrations/slack/sync

### Test Coverage
- 4 new tests in authService.test.js for changePassword
- 18 new tests in settingsRoutes.test.js for role-based permissions
  - Tests for 403 Forbidden when non-admin attempts write operations
  - Tests for admin access still working correctly

### Role-Based Access Summary
| Feature | Admin | Rep/User |
|---------|-------|----------|
| View Settings | Yes | Yes (read-only) |
| Edit API Keys | Yes | No (403) |
| Manage Integrations | Yes | No (403) |
| Trigger Re-analysis | Yes | No (403) |
| Access Requests Page | Yes | Hidden |
| Users Page | Yes | Hidden |
| Account Page | Yes | Yes |
| Change Own Password | Yes | Yes |

---

## Authentication Migration (2026-01-26)

### Changes Made
Migrated from Magic Link authentication to Email+Password authentication.

### Backend Changes
- **authService.js**: Added password functions (validatePassword, hashPassword, verifyPassword, requestAccess, loginWithPassword, adminResetPassword)
- **transcriptDb.js**: Added password_hash column to users and access_requests tables, added updateUserPassword function
- **auth.js routes**: Added 3 new endpoints (POST /request-access, POST /login-password, POST /admin/reset-password)
- **package.json**: Added bcrypt dependency

### Frontend Changes
- **login.html**: Complete redesign with tabbed Sign In / Request Access flow
- **users.html**: Added Reset Password button and modal for admin password reset

### Password Policy
- Minimum 12 characters
- Hashed with bcrypt (12 rounds)
- Password set during access request, copied to user on admin approval
- Admin-only password reset (no forgot password feature)
- All sessions invalidated on password reset

### Test Coverage
- 29 new password authentication tests added to authService.test.js
- Total auth tests: 174 (80 service + 76 routes + 18 middleware)

### Migration Notes
- Legacy magic link endpoints retained for backward compatibility (deprecated)
- Existing users without password_hash will see "PASSWORD_NOT_SET" error
- Admin can reset password for existing users via User Management page

---

## Summary

**Fully Implemented & Tested:**
- Feature 1: Fireflies Sync (PRD Feature 2)
- Feature 2: Per-Call Analysis (PRD Feature 3)
- Feature 3: Dashboard Aggregation (PRD Feature 4)
- Feature 3B: Call Classification Heuristics (PRD Feature 3B)
- Feature 4: DFY Pitch Detection (PRD Feature 10)
- Feature 5: Stripe Enrichment (PRD Feature 11)
- Feature 7: Secure API Key Management (PRD Feature 15 - partial)
- Feature 8: OpenAI Model Configuration (PRD Feature 15 - LLM settings)
- Feature 9: Controlled Re-analysis Pipeline (PRD Feature 15 - re-analysis)
- PRD Feature 1: Authentication - COMPLETE
- PRD Feature 13: Full-text Search - COMPLETE
- NEW: Insight Snapshot Generator - COMPLETE
- NEW: Founder Closing Rate - COMPLETE
- NEW: Bulk Actions - COMPLETE
- NEW: Rep Filter for Sync - COMPLETE
- NEW: Duration Auto-Format - COMPLETE

**Partial:**
- Feature 14: CSV Export (Markdown only)

**Test Status:** 789 total tests (789 passing, 0 failing)

---

## Completed Features

### Feature 1: Fireflies Sync - COMPLETE
- SQLite database schema for transcripts table
- Sync log table for tracking sync operations
- TranscriptDb service (CRUD operations)
- SyncService (coordinates Fireflies → DB sync)
- Sync routes (POST /api/sync, GET /api/sync/status, GET /api/sync/history)
- Admin routes (GET /api/admin/dashboard, GET /api/admin/calls)
- Admin HTML page with sync button and call list
- Tests: syncService.test.js (13), transcriptDb.test.js (20), routes.test.js (18)

### Feature 2: Per-Call Analysis - COMPLETE
- Analysis service (callAnalysisService.js) with LLM integration
- Analysis routes (POST /api/analysis/analyze/:id, GET /api/analysis/:id)
- Call detail page (call.html) with transcript and insights tabs
- Skip-if-already-analyzed logic with version tracking
- Tests: callAnalysisService.test.js (22), callAnalysisRoutes.test.js (10)

### Feature 3: Dashboard Aggregation - COMPLETE
- Aggregation service (dashboardAggregationService.js)
- Dashboard routes with filters (date range, rep, keyword)
- Dashboard HTML page with ranked lists
- Pain points, goals, questions, dislikes, excitement aggregation
- Tests: dashboardAggregation.test.js (21), dashboardRoutes.test.js (13)

### Feature 3B: Call Classification - COMPLETE
- CLASSIFICATION enum (SALES, NOT_SALES, REVIEW_NEEDED)
- NOT_SALES denylist with 20+ regex patterns
- Name-and-Name pattern recognition
- Priority order: Denylist → Name-and-Name → Sales Keywords → REVIEW_NEEDED
- Tests: callClassifier.test.js (47)

### Feature 4: DFY Pitch Detection - COMPLETE
- DFY pitch service (dfyPitchService.js)
- Trigger categories (PAIN, OBJECTION, TIME, BUDGET, RESOURCE, CAPABILITY)
- Confidence scoring (0-100)
- Phil's rep page (phil.html)
- DFY tab in call detail page
- Tests: dfyPitchService.test.js (45), dfyRoutes.test.js (13)

### Feature 5: Stripe Enrichment - COMPLETE
- Stripe enrichment service (stripeEnrichmentService.js)
- Email-only matching (no guessing)
- Subscription status tracking
- Conversion metrics calculation
- Stripe panel in call detail page
- Tests: stripeEnrichmentService.test.js (37), stripeEnrichmentRoutes.test.js (16)

### Feature 7: Secure API Key Management - COMPLETE
- Secret manager service (secretManager.js)
- Settings routes for integrations
- Settings UI page (settings.html)
- API keys never exposed via API responses
- Tests: secretManager.test.js (12), settingsRoutes.test.js (18)

### Feature 8: OpenAI Model Configuration - COMPLETE
- Extended secretManager.js with OpenAI API key support
- Added model configuration storage (model selection, apply mode)
- Added OpenAI routes to settings.js (GET, POST, PUT, DELETE, test endpoints)
- Extended settings.html UI with OpenAI integration card
- Masked API key input with validation
- Model selector dropdown (GPT-4o, GPT-4o Mini, GPT-4 Turbo, GPT-3.5 Turbo)
- Apply mode selection (future calls only vs re-analyze all)
- Does NOT trigger re-analysis (storage only)
- Tests: 16 new tests in settingsRoutes.test.js

### Feature 9: Controlled Re-analysis Pipeline - COMPLETE
- Created reanalysisService.js with batch processing
- Added reanalysis_jobs table for tracking jobs
- Triggers re-analysis only when apply_mode == rerun_all
- Processes ONLY SALES calls (skips internal meetings)
- Uses currently selected OpenAI model
- Batch processing with progress tracking
- Resumable if interrupted (tracks last_processed_id)
- Job statuses: pending, running, paused, completed, failed, cancelled
- Added re-analysis routes to settings.js:
  - GET /api/settings/reanalysis/status
  - GET /api/settings/reanalysis/job/:id
  - POST /api/settings/reanalysis/trigger
  - POST /api/settings/reanalysis/cancel
  - POST /api/settings/reanalysis/resume/:id
- Tests: reanalysisService.test.js (18), reanalysisRoutes.test.js (20)

### PRD Feature 1: Authentication with Access Request Workflow - COMPLETE
- Users table, Magic links table, Sessions table, Access requests table
- Auth service with magic link + access request workflow
- Domain restriction: @affiliatefinder.ai only
- Admin approval workflow (request -> approve/deny -> access)
- Email service (Mailchimp Transactional / Mandrill)
- Rate limiting middleware (login, verify, access requests, general)
- Auth middleware (requireAuth, requireAdmin, optionalAuth)
- Auth routes (login, status, magic-link, verify, logout, me, setup, invite, users, access-requests/*)
- Login page UI with combined flow (public/admin/login.html)
- Access requests admin page (public/admin/access-requests.html)
- User management page UI (public/admin/users.html)
- Magic link expiry: 60 minutes, Session duration: 30 days
- Tests: authService.test.js (51), authMiddleware.test.js (18), authRoutes.test.js (76)

### PRD Feature 13: Full-text Search - COMPLETE
- Created FTS4 virtual table `transcripts_fts` with Porter stemmer tokenization
- Implemented searchService.js with:
  - `initSearchTable()` - initializes FTS4 table
  - `rebuildSearchIndex()` - rebuilds index from transcripts
  - `indexTranscript()` - indexes single transcript
  - `removeFromIndex()` - removes from index
  - `searchTranscripts()` - full-text search with filters (rep, date range)
  - `sanitizeFtsQuery()` - sanitizes query for FTS4 special characters
  - `highlightMatches()` - highlights search terms in results
  - `getSearchSuggestions()` - returns autocomplete suggestions
- Created search routes (search.js):
  - GET /api/search - search transcripts with query, limit, offset, filters
  - GET /api/search/suggestions - get autocomplete suggestions
  - POST /api/search/reindex - rebuild search index
- Added search bar UI to all admin pages
- Tests: searchService.test.js (31), searchRoutes.test.js (18)

### NEW: Insight Snapshot Generator - COMPLETE (2026-01-26)
- **Service:** `backend/services/insightSnapshotService.js`
  - `generateSnapshot(filters)` - Main entry point, requires startDate/endDate
  - `calculateConversionDelta(itemKey, itemType, transcripts)` - Compares conversion WITH vs WITHOUT
  - `classifyDFYPitch(pitch)` - Returns 'justified'|'avoidable'|'premature'
  - `analyzeDFYPitches(transcripts)` - Phil's DFY pitch analysis with classification
  - `identifyChurnSignals(transcripts)` - Finds patterns disproportionately in churned users
  - `formatForNotion(snapshot)` - Returns Notion-flavored Markdown
  - `formatForSlack(snapshot)` - Returns Slack Block Kit JSON
  - `generateSummaryBullets()` - Auto-generates executive summary
  - `generateRecommendations()` - Generates actionable recommendations
- **Routes:** `backend/routes/snapshot.js`
  - `GET /api/insights/snapshot` - Returns JSON snapshot
  - `GET /api/insights/snapshot/notion` - Returns Markdown for Notion
  - `GET /api/insights/snapshot/slack` - Returns Slack Block Kit blocks
  - All require startDate and endDate query params (YYYY-MM-DD)
  - Optional rep filter
- **UI:** Dashboard button "📊 Snapshot" in filter actions
  - Modal with 4 tabs: Summary, Details, Notion, Slack
  - Summary tab: Executive summary bullets, conversion metrics, recommendations
  - Details tab: Top pains, goals, questions, triggers, DFY analysis, churn signals
  - Notion tab: Raw Markdown with copy button
  - Slack tab: Raw JSON with copy button
- **Tests:**
  - insightSnapshotService.test.js: 47 tests (97.94% coverage)
  - insightSnapshotRoutes.test.js: 18 tests (98.11% coverage)
- **NOTE:** Server must be restarted after code changes to pick up new routes

---

## Not Started Features

### PRD Feature 14: CSV Export
- Export endpoint (/api/export)
- Export modal UI
- Calls export schema
- Pain points export schema
- Questions export schema
- DFY mentions export schema

---

## Partially Implemented

### PRD Feature 15: Admin Settings (Remaining)
- NOT DONE: Token usage tracking
- NOT DONE: Cost tracking display

---

## Test Summary

| Test File | Tests | Status |
|-----------|-------|--------|
| syncService.test.js | 13 | PASS |
| transcriptDb.test.js | 20 | PASS |
| routes.test.js | 18 | PASS |
| callAnalysisService.test.js | 22 | PASS |
| callAnalysisRoutes.test.js | 10 | PASS |
| dashboardAggregation.test.js | 21 | PASS |
| dashboardRoutes.test.js | 13 | PASS |
| dfyPitchService.test.js | 45 | PASS |
| dfyQualificationService.test.js | 63 | PASS |
| dfyRoutes.test.js | 14 | PASS |
| dfyQualityRoutes.test.js | 22 | PASS |
| stripeEnrichmentService.test.js | 37 | PASS |
| stripeEnrichmentRoutes.test.js | 16 | PASS |
| callClassifier.test.js | 47 | PASS |
| secretManager.test.js | 12 | PASS |
| settingsRoutes.test.js | 34 | PASS |
| reanalysisService.test.js | 18 | PASS |
| reanalysisRoutes.test.js | 20 | PASS |
| transcriptDb.test.js (users) | 17 | PASS |
| transcriptDb.test.js (magic links) | 17 | PASS |
| transcriptDb.test.js (sessions) | 19 | PASS |
| authService.test.js | 51 | PASS |
| authMiddleware.test.js | 18 | PASS |
| authRoutes.test.js | 76 | PASS |
| searchService.test.js | 31 | PASS |
| searchRoutes.test.js | 18 | PASS |
| insightSnapshotService.test.js | 47 | PASS |
| insightSnapshotRoutes.test.js | 18 | PASS |
| founderSnapshotService.test.js | 25+ | PASS |
| founderRoutes.test.js | 26 | PASS |
| csvExportService.test.js | 43 | PASS |
| bulkActions.test.js | 21 | PASS |
| durationFormatting.test.js | 23 | PASS |
| llmService.test.js | 25 | PASS |
| llmAnalysisPrompts.test.js | 21 | PASS |
| tokenUsage.test.js | 8 | PASS |

**Total: 976+ tests (all tests passing)**

---

## Recent Changes

### 2026-01-26: Closing Rate CSV Export - COMPLETE
- **Added:** `services/csvExportService.js` - CSV generation utility
  - `escapeCSVValue()` - Escapes commas, quotes, and newlines for CSV safety
  - `generateCSV()` - Generic CSV generation from array of objects
  - `generateClosingRateCSV()` - Specialized for Closing Rate table data
  - `generateClosingRateFilename()` - Deterministic filename with date range
  - UTF-8 encoded with BOM for Excel compatibility
- **Updated:** `public/admin/founder.html` - Added Export CSV button
  - Button in Analyzed Calls header with download icon
  - Frontend CSV generation (no backend endpoint needed)
  - Button disabled when no data to export
  - Respects current filters (date range, rep)
  - Filename includes date range: `closing-rate-calls-YYYY-MM-DD-to-YYYY-MM-DD.csv`
- **CSV columns:** Rep, Call Title, Date, Prospect Email, Status
- **Tests:**
  - csvExportService.test.js: 43 unit tests
  - founderRoutes.test.js: 4 new integration tests for CSV data structure
- **Result:** All 47 new tests passing

### 2026-01-26: Decision Rationale & Evidence Drilldown - COMPLETE
- **Updated:** `services/dfyQualificationService.js`
  - `generateDecisionRationale()` - Generates human-readable explanation for flag assignment
  - `mapEvidenceToRules()` - Maps evidence objects to 10-rule breakdown array
  - Updated `analyzeDFYQualification()` to include rationale and ruleBreakdown
  - Deterministic logic: clean/risky/unclear based on score threshold and patterns
- **Updated:** `public/admin/call.html` - Enhanced DFY Qualification panel:
  - **Decision Summary section** (top): Flag badge (Clean/Risky/Unclear), Score (X/4), one-line explanation
  - **Rule Breakdown panel** (middle): Scannable table with 10 rules
    - Result column (Yes/No/Unknown with color coding)
    - Importance label (Primary signal, Qualification criteria, etc.)
    - Evidence quote with truncation (expandable)
    - "View in transcript" action with fuzzy match fallback
  - **Flag Logic section** (bottom): Human-readable definitions showing exact thresholds
    - Clean: DFY not pitched OR (score >= 3 AND no risky patterns)
    - Risky: DFY pitched AND (proposal without discovery OR score < 2)
    - Unclear: DFY pitched AND score = 2 (insufficient qualification signals)
  - **Re-analyze button**: Per-call "Re-analyze DFY Evidence" action
- **Updated:** Transcript highlighting with fuzzy match fallback
  - `scrollToTranscriptLine()` - Now accepts optional quoteText parameter
  - `findFuzzyMatchLine()` - 60% word match threshold for fuzzy matching
  - `scrollToTranscriptQuote()` - Wrapper function for quote-based scrolling
  - Fuzzy match indicator: "[~]" shown when exact match not found
- **Tests:**
  - dfyQualificationService.test.js: 15 new tests (7 rationale, 4 evidence mapping, 4 integration)
  - dfyQualityRoutes.test.js: 9 new tests (rationale API, ruleBreakdown, flags)
- **Result:** 63 unit tests + 22 integration tests (all passing)

### 2026-01-26: Phil DFY Quality Tab Redesign - COMPLETE
- **Added:** `services/dfyQualificationService.js` - DFY qualification scoring service
  - `analyzeDFYQualification()` - Extracts 15+ qualification metrics per call
  - `calculateQualificationScore()` - Scores 0-4 based on: no_time, buyer_intent, budget_validated, next_step_quality
  - `determineQualityFlag()` - Returns 'clean', 'risky', or 'unclear' based on criteria
  - `aggregateDFYQualificationStats()` - Generates summary statistics
  - `buildDFYFunnel()` - Builds conversion funnel data
  - Evidence extraction with transcript quotes and line references
- **Added:** New API endpoints in `routes/dfy.js`:
  - `GET /api/dfy/quality` - List view with KPIs, funnel, and call list
  - `GET /api/dfy/quality/call/:id` - Detailed qualification for a call
  - `POST /api/dfy/quality/reanalyze/:id` - Re-analyze specific call
- **Updated:** `services/callAnalysisService.js`
  - Now integrates `addDFYQualificationToAnalysis()` during call analysis
  - Stores dfyQualification in analysis_json alongside existing dfyPitches
- **Updated:** `public/admin/phil.html` - Complete UI redesign:
  - KPI strip: Calls Analyzed, DFY Pitched %, Properly Qualified %, Proposals, Discovery, Software Close %
  - DFY Quality Funnel (left sidebar): DFY Mentioned -> Met Criteria -> Budget Confirmed -> Discovery -> Proposal
  - Call List Table: Score pips, budget status, next step, software close, quality flag
  - Filter controls: Date range, quality flag, min score
  - Horizontal filter layout matching other pages
- **Updated:** `public/admin/call.html` - DFY Qualification panel:
  - Qualification score (0-4) with quality flag badge
  - Checklist with evidence quotes: No Time, Buyer Intent, Budget, Discovery, Proposal
  - "View in transcript" links that highlight relevant text
  - Software discipline section showing pitch and close attempt status
- **Tests:**
  - dfyQualificationService.test.js: 48 tests
  - dfyQualityRoutes.test.js: 13 tests
- **Data Model:** Per-call extraction includes:
  - dfy_pitched, dfy_offer_type (none|primary|upgrade|fallback)
  - proposal_promised, discovery_booked_for_dfy
  - software_pitched, software_close_attempted
  - budget_asked, budget_provided, budget_fit_for_dfy (min $1,000/mo)
  - criteria_no_time, criteria_buyer_intent, criteria_budget_validated
  - dfy_qualification_score (0-4), dfy_quality_flag (clean|risky|unclear)
  - evidence object with transcript quotes and line references
- **Configuration:**
  - Score threshold for "properly qualified": 3+ out of 4
  - Proposal without discovery = always "risky"
  - DFY budget minimum: $1,000/month
  - Phil calls only (no rep switching)

### 2026-01-26: Slack Lifecycle Events & UI Improvements - COMPLETE
- **Added:** `services/slackIngestionService.js` - Ingests Slack lifecycle events for signup detection
  - Parses Slack messages for user events (registered, trialing, active, canceled, etc.)
  - Stores events in `slack_lifecycle_events` table
  - `getLatestStatusForEmail()` - Returns latest status for a prospect email
- **Updated:** `services/founderSnapshotService.js`
  - Integrated Slack lifecycle events as fallback data source (Stripe priority, Slack fallback)
  - Added support for "all" reps filter (Phil, Jamie, or All)
  - Added `repName` to call details for display
  - `getCombinedStatus()` - Merges Stripe and Slack data with priority
- **Updated:** `routes/founder.js` - Rep metrics now support "all" reps
- **Updated:** Date range filters across all pages (Dashboard style)
  - Phil DFY page (`phil.html`) - Date preset dropdown added
  - Calls page (`index.html`) - Unified date presets
  - Closing Rate page (`founder.html`) - Unified date presets
  - Presets: All time, This week, Last week, Last month, Last 3 months, Last 6 months, Custom range
- **Updated:** Closing Rate page (`founder.html`)
  - Added Rep column (first column) with color-coded badges
  - Phil badge: Yellow (rgba(251, 191, 36, 0.15))
  - Jamie badge: Pink (rgba(236, 72, 153, 0.15))
  - `getRepClass()` and `getRepDisplayName()` helper functions
- **Result:** Unified filter experience across all pages, multi-rep support with visual distinction

### 2026-01-26: Token/Cost Tracking (P1.1) - COMPLETE
- **Added:** `services/llmService.js` - OpenAI wrapper with token tracking
  - `chatCompletion()` - Makes OpenAI API calls with token counting
  - `calculateCost()` - Calculates cost per model (GPT-4o, GPT-4o-mini, GPT-4-turbo, GPT-3.5-turbo)
  - `parseJsonResponse()` - Handles JSON extraction from LLM responses
- **Added:** `services/llmAnalysisPrompts.js` - Prompt templates for LLM analysis
  - `buildAnalysisPrompt()` - Full analysis prompt with structured JSON output
  - `validateAnalysisResponse()` - Validates LLM response structure
  - `transformToExistingFormat()` - Converts LLM output to existing format
- **Updated:** `services/callAnalysisService.js` - Now supports both heuristic and LLM modes
  - `getAnalysisMode()` - Determines whether to use LLM or heuristic
  - `analyzeWithLLM()` - LLM-based analysis with token tracking
  - `performHeuristicAnalysis()` - Original rule-based analysis
  - Token usage stored in `analysis_json.tokenUsage`
- **Updated:** `services/transcriptDb.js`
  - `getTokenUsageStats()` - Aggregates token usage from all LLM analyses
- **Added:** Token usage endpoints to `routes/settings.js`
  - `GET /api/settings/usage` - Full usage stats with model breakdown
  - `GET /api/settings/usage/summary` - Quick summary for dashboard
- **Updated:** `public/admin/settings.html`
  - Token usage card with summary stats
  - Usage by model table
  - Recent analyses list
- **Tests:** 54 new tests (llmService: 25, llmAnalysisPrompts: 21, tokenUsage: 8)
- **Result:** 789 tests pass (was 735)

### 2026-01-26: Full Codebase Audit
- **Performed:** Comprehensive feature audit against PRD
- **Result:** All core features verified working (P0 complete)
- **Identified gaps:** CSV export (Markdown only), Token/Cost tracking
- **User decision:** Next priority is Token/Cost Tracking (P1.1)
- **Updated:** prd.md (Implementation Status section), todo.md (Priority Plan), progress.txt
- **Test count increased:** 620 to 735 tests

### 2026-01-26: Bulk Actions, Rep Filter, Duration Format
- **Added:** Bulk delete/analyze with throttling (routes/bulkActions.js)
- **Added:** Rep filter for Fireflies sync (default: Phil only)
- **Added:** Duration auto-format (MM:SS vs HH:MM:SS)
- **Tests:** 66 new tests (21 bulk + 22 sync + 23 duration)

### 2026-01-26: Insight Snapshot Generator (NEW FEATURE)
- **Added:** insightSnapshotService.js with snapshot generation
- **Added:** routes/snapshot.js with 3 endpoints (JSON, Notion, Slack)
- **Added:** Snapshot button and modal to dashboard.html
- **Features:**
  - Executive summary with auto-generated bullets
  - Conversion delta calculation (WITH vs WITHOUT items)
  - DFY pitch classification (justified/avoidable/premature)
  - Churn signal identification
  - Actionable recommendations
  - Notion Markdown export
  - Slack Block Kit export
- **Added:** 65 new tests (47 service + 18 routes)
- **Result:** All 620 tests pass
- **Coverage:** Service 97.94%, Routes 98.11%

---

## Files Structure

### Backend Services
- `services/transcriptDb.js` - Database operations (includes token usage stats)
- `services/syncService.js` - Fireflies sync (with rep filter)
- `services/callAnalysisService.js` - Call analysis (heuristic + LLM modes)
- `services/analyzer.js` - Call classification (heuristics)
- `services/llmService.js` - OpenAI API wrapper with token tracking
- `services/llmAnalysisPrompts.js` - LLM prompt templates
- `services/dashboardAggregationService.js` - Aggregation
- `services/dfyPitchService.js` - DFY detection
- `services/dfyQualificationService.js` - DFY qualification scoring (NEW)
- `services/stripeEnrichmentService.js` - Stripe enrichment
- `services/secretManager.js` - API key management
- `services/reanalysisService.js` - Controlled re-analysis pipeline
- `services/authService.js` - Authentication workflow
- `services/searchService.js` - Full-text search
- `services/insightSnapshotService.js` - Insight snapshot generation
- `services/founderSnapshotService.js` - Founder closing rate metrics (Stripe + Slack combined)
- `services/slackIngestionService.js` - Slack lifecycle event ingestion (NEW)

### Backend Routes
- `routes/sync.js` - Sync endpoints (with rep filter)
- `routes/admin.js` - Admin endpoints
- `routes/callAnalysis.js` - Analysis endpoints
- `routes/dashboard.js` - Dashboard endpoints
- `routes/dfy.js` - DFY endpoints
- `routes/stripeEnrichment.js` - Stripe endpoints
- `routes/bulkActions.js` - Bulk delete/analyze endpoints
- `routes/settings.js` - Settings endpoints
- `routes/auth.js` - Authentication endpoints
- `routes/search.js` - Search endpoints
- `routes/snapshot.js` - Insight snapshot endpoints (NEW)

### Backend Middleware
- `middleware/auth.js` - Authentication middleware

### Frontend Pages
- `public/admin/index.html` - Calls list (with date preset dropdown)
- `public/admin/call.html` - Call detail
- `public/admin/dashboard.html` - Insights dashboard (with Snapshot button)
- `public/admin/phil.html` - Phil's DFY Quality page (REDESIGNED: KPIs, funnel, qualification table)
- `public/admin/founder.html` - Founder Closing Rate page (Rep column with badges)
- `public/admin/settings.html` - Settings page
- `public/admin/login.html` - Login page
- `public/admin/users.html` - User management page

---

## How to Run

```bash
# Start server
cd backend && npm start

# Run tests
cd backend && npm test

# Run linting
cd backend && npm run lint
```

**Admin URL:** http://localhost:3001/admin
**Copy URL:** http://localhost:3001/admin/copy.html
**Settings URL:** http://localhost:3001/admin/settings.html

---

## Recent Changes

### 2026-01-26: Enhanced Authentication with Access Request Workflow - COMPLETE
- **Added:** Access request workflow with admin approval
  - New `access_requests` table for storing pending/approved/denied requests
  - `authenticateOrRequestAccess()` combined flow function
  - `approveAccessRequest()` and `denyAccessRequest()` admin functions
  - `getAccessStatus()` for checking email status
  - Re-request allowed after denial (resets to pending)
- **Added:** Domain restriction
  - Only @affiliatefinder.ai emails accepted
  - `isAllowedDomain()` validation function
  - Admin emails configured via ADMIN_EMAILS env var
- **Added:** Email service (emailService.js)
  - Mailchimp Transactional (Mandrill) integration
  - Magic link emails, access request notifications, approval/denial notifications
  - Dev mode logs to console instead of sending
- **Added:** Rate limiting middleware (rateLimit.js)
  - Login: 5 requests per 15 min per email
  - Token verification: 10 requests per 5 min per IP
  - Access requests: 3 requests per hour per IP
  - General API: 100 requests per minute per IP
- **Updated:** Auth routes with new endpoints
  - `POST /api/auth/login` - combined login/access request flow
  - `GET /api/auth/status` - check access status for email
  - `GET /api/auth/access-requests` - list requests (admin)
  - `GET /api/auth/access-requests/:id` - get specific request (admin)
  - `POST /api/auth/access-requests/:id/approve` - approve request (admin)
  - `POST /api/auth/access-requests/:id/deny` - deny request (admin)
  - `DELETE /api/auth/access-requests/:id` - delete request (admin)
- **Updated:** Session and token durations
  - Magic link expiry: 60 minutes (was 15)
  - Session duration: 30 days (was 7)
- **Updated:** Login page UI (login.html)
  - Combined flow showing appropriate state (approved, pending, denied)
  - Domain hint showing @affiliatefinder.ai required
  - Name field for new access requests
  - Pending status card when access request is pending
- **Added:** Access requests admin page (access-requests.html)
  - Tabs for pending/approved/denied/all
  - Approve modal with name, role, notes inputs
  - Deny modal with reason input
  - Delete functionality for cleanup
- **Tests:** 145 auth tests (51 unit + 76 integration + 18 middleware)
  - Domain validation tests
  - Combined flow tests (approved, pending, denied states)
  - Access request approval/denial tests
  - Full workflow integration tests
- **Result:** All 145 auth tests passing

### 2026-01-26: Copy - Customer Language Intelligence Page - COMPLETE
- **Renamed:** Dashboard to "Copy" with subheader "Customer Language Intelligence across analyzed calls"
- **Updated:** Navigation across all pages from "Dashboard" to "Copy"
- **Implemented:** New 8-section layout:
  1. Pain Points (Challenges & Frustrations)
  2. Goals (Desired Outcomes & Wins)
  3. Wording (subtabs: Industry Terms, Colloquial Problem Language, Power Words) - placeholder for future enrichment
  4. Metaphors & Analogies - placeholder for future enrichment
  5. Emotional Triggers (Emotion Map) - derived from dislikes.emotions
  6. Customer Questions
  7. Positive Reactions (all positive emotional responses)
  8. Objections & Criticism (grouped with type badges: price, trust, complexity, time)
- **UI Improvements:**
  - Each item shows: ranked label, quote snippet, source call reference (title + date + rep), mentions count
  - Top 3 items highlighted with primary color rank badges
  - Collapsible sections with smooth transitions
  - Compact KPI strip (reduced visual weight)
  - Premium styling with brand colors (#073b55, #067280) as accents
- **Context Drawer:**
  - Right-side drawer showing full quote, source call metadata
  - 10-line transcript context around the quote
  - Fuzzy matching with "[~] closest match" indicator when exact match fails
  - "Open in Transcript" button passes highlight parameter to call.html
- **Transcript Highlighting:**
  - call.html now reads `highlight` URL parameter and scrolls to/highlights the quote
  - Fuzzy matching fallback for better reliability
- **Label Normalization:**
  - Client-side label improvement to reduce generic buckets
  - Known generic labels rewritten (e.g., "Manual Time Sink" -> "Time Wasted on Manual Outreach")
  - "Needs review" badge for truly generic labels that couldn't be improved
  - Quote-based label extraction for fallback
- **Export MD:** Button unchanged (same label, placement, behavior, styling)
- **Tests:** 14 new tests in copyPage.test.js (all passing)
  - Quote highlight matcher (exact + fuzzy)
  - Context drawer rendering
  - Section mapping and sorting (ranked)
  - API endpoint integration tests

---

## Important Notes for Next Session

1. **Server Restart Required:** After any code changes, restart the server with:
   ```bash
   cd backend && kill $(lsof -t -i:3001) 2>/dev/null; npm start
   ```

2. **Snapshot Feature Usage:**
   - Go to Dashboard page
   - Select Start Date and End Date in filters
   - Click "📊 Snapshot" button
   - Modal shows summary, details, and export options

3. **Known Issues:** None currently

4. **Token Usage:** Settings page now shows LLM token usage and costs

5. **Next Recommended Task:** PRD Feature 14 (CSV Export)

6. **Recent Additions:**
   - Slack lifecycle events integrated into Founder Snapshot
   - Combined data source: Stripe (priority) + Slack (fallback)
   - Rep column in Closing Rate with color-coded badges (Phil=Yellow, Jamie=Pink)
   - Unified date preset dropdowns across all pages

7. **Phil DFY Quality Tab:**
   - Go to Phil DFY page (/admin/phil.html)
   - View KPI strip with: calls, DFY pitched %, qualified %, proposals, discovery, software close %
   - View funnel showing qualification drop-off
   - Click any call to see detailed qualification with evidence quotes
   - Use "View in transcript" to highlight exact evidence in transcript

8. **Decision Rationale Drilldown (NEW):**
   - Click any call from Phil DFY page to see enhanced drilldown
   - Decision Summary: Flag badge, score, one-line explanation
   - Rule Breakdown: 10 rules with Yes/No/Unknown results, evidence quotes
   - Flag Logic: Transparent definitions of clean/risky/unclear thresholds
   - "View in transcript" uses fuzzy match fallback ([~] indicator)
   - "Re-analyze DFY Evidence" button for per-call reanalysis

---

## DFY Detection Improvements (2026-01-26)

### Problem Solved
Fixed false positives in DFY pitch detection and budget_asked qualification.

### Changes Made

#### 1. Stricter DFY Pitch Detection (dfyPitchService.js, dfyDetector.js)
**Problem:** "I own an agency" credibility intros were incorrectly flagged as DFY pitches.

**Solution:**
- Removed bare `'agency'` keyword from dfyKeywords (too generic)
- Added offer-oriented agency phrases: `'agency service'`, `'agency package'`, `'our agency can'`, etc.
- Added explicit DFY offer phrases: `'we can do this for you'`, `'we handle everything'`, etc.
- New `isCredibilityIntroOnly()` function excludes:
  - "I own an agency", "I have an agency", "I run an agency"
  - "we also do services", "my agency background"
  - UNLESS followed by offer transition phrases: "we can do this for you", "we offer a package where", etc.

**Files Changed:**
- `backend/utils/dfyDetector.js` - Updated dfyKeywords array
- `backend/services/dfyPitchService.js` - Added isCredibilityIntroOnly(), isSalesRep(), isJamie()

#### 2. DFY-Contextual Budget Ask (dfyQualificationService.js)
**Problem:** General business budget questions marked as "budget_asked" when not about DFY/managed service.

**Solution:**
- New `DFY_BUDGET_CONTEXT_KEYWORDS` array for DFY-specific budget patterns
- New `isBudgetAskDFYContextual()` function checks surrounding context
- `budget_asked` only TRUE when budget question is in DFY context:
  - Line mentions "done for you", "managed service", "agency", "proposal", etc.
  - OR surrounding 3 lines before/after contain DFY context keywords

**Files Changed:**
- `backend/services/dfyQualificationService.js` - Added isBudgetAskDFYContextual(), DFY_BUDGET_CONTEXT_KEYWORDS

#### 3. Evidence Validation (dfyQualificationService.js)
**Problem:** Evidence quotes could be attached to rules they don't actually support.

**Solution:**
- New `validateEvidence()` function checks if quote contains expected keywords
- `mapEvidenceToRules()` now includes `evidenceValid` and `evidenceValidationReason` for each rule
- Each rule has associated keywords array for validation

**Files Changed:**
- `backend/services/dfyQualificationService.js` - Added validateEvidence(), updated mapEvidenceToRules()

### Test Coverage
- `backend/__tests__/dfyDetection.test.js` - 24 new tests covering:
  - isCredibilityIntroOnly() - 6 tests
  - detectDFYPitches() - 5 tests
  - isBudgetAskDFYContextual() - 5 tests
  - analyzeDFYQualification budget_asked - 2 tests
  - Speaker detection (isPhil, isJamie, isSalesRep) - 6 tests

**Result:** 71 tests passing (24 DFY + 26 dashboard + 21 duration)

---

## Prospect Enrichment Pipeline (2026-01-27)

### SUMMARY
Created a complete prospect enrichment pipeline that uses Slack, Calendly, and Stripe to match sales calls with customer signup status. This enables the Closing Rate page to show actual conversion data.

### BACKGROUND
The Closing Rate page was showing "0 signups from 0 sales calls" because:
1. The `stripe_data` column was NULL for all 97 calls (enrichment never ran)
2. The `slack_lifecycle_events` table didn't exist (never synced)
3. Real calls had prospect emails in `participants` but weren't being extracted

### NEW ENRICHMENT FLOW
The enrichment now follows this priority order:
1. **Extract prospect email** from call participants (excluding sales rep emails)
2. **Check Slack** lifecycle events for signup status (registered, trialing, active, canceled)
3. **Check Calendly** for meeting details and form responses (website, company info)
4. **Check Stripe** for customer status (highest priority for final status)
5. **Store combined enrichment** in `stripe_data` column

### FILES CREATED

**1. backend/services/prospectEnrichmentService.js**
New service that orchestrates the complete enrichment pipeline:
- `extractProspectEmail()` - Extracts non-sales-rep emails from participants
- `extractProspectName()` - Extracts prospect names from participants or call title
- `enrichCall()` - Enriches a single call with all data sources
- `batchEnrich()` - Batch enriches multiple calls
- `runEnrichmentPipeline()` - Full pipeline: sync Slack → enrich calls → store results
- `reEnrichCall()` - Force re-enrich a specific call
- `getEnrichmentStats()` - Get enrichment statistics

**2. backend/routes/enrichment.js**
New API routes for the enrichment service:
- `GET /api/enrichment/status` - Check configuration status of all sources
- `GET /api/enrichment/stats` - Get enrichment statistics
- `POST /api/enrichment/run` - Run full enrichment pipeline
- `POST /api/enrichment/batch` - Batch enrich without Slack sync
- `POST /api/enrichment/slack/sync` - Sync Slack events only
- `GET /api/enrichment/slack/events` - Get Slack lifecycle events
- `GET /api/enrichment/call/:callId` - Get enrichment for specific call
- `POST /api/enrichment/call/:callId/refresh` - Force re-enrich a call

### FILES MODIFIED

**1. backend/server.js**
- Added `enrichmentRouter` and mounted at `/api/enrichment`

**2. backend/services/founderSnapshotService.js**
- Updated `refreshSignupStatus()` to use the new enrichment pipeline
- First syncs Slack events, then runs full enrichment on all calls
- Now tracks Slack, Calendly, and Stripe matches separately

**3. backend/public/admin/founder.html**
- Updated Refresh button to call `/api/enrichment/run` endpoint
- Shows enrichment progress: "Enriching..." → "Found X matches!" → "Done!"
- Updated tooltip: "Sync Slack events and enrich calls with Stripe/Calendly data"

### ENRICHMENT RESULTS

After running the pipeline on 95 analyzed calls:
- **82 calls enriched** (stored with enrichment data)
- **70 calls matched** (found as signups)
- **13 calls not enriched** (test data or no prospect email)

Breakdown by data source:
- Slack matches: ~15 calls with lifecycle events
- Calendly matches: ~5 calls with meeting details
- Stripe matches: ~70 calls with customer data

### CLOSING RATE PAGE NOW SHOWS

**Phil's Metrics:**
- 34 SALES calls
- 31 signups (91% closing rate!)
- 2 active customers
- 28 churned customers

**Jamie's Metrics:**
- 18 SALES calls
- 10 signups (56% closing rate)
- 8 active customers
- 0 churned customers

### API ENDPOINTS

```bash
# Check enrichment configuration status
curl http://localhost:3456/api/enrichment/status

# Get enrichment statistics
curl http://localhost:3456/api/enrichment/stats

# Run full enrichment pipeline
curl -X POST http://localhost:3456/api/enrichment/run \
  -H "Content-Type: application/json" \
  -d '{"limit": 100, "syncSlackFirst": true, "storeResults": true}'

# Batch enrich (no Slack sync)
curl -X POST http://localhost:3456/api/enrichment/batch \
  -H "Content-Type: application/json" \
  -d '{"limit": 50, "storeResults": true}'

# Get Phil's closing rate
curl "http://localhost:3456/api/founder/phil?start_date=2024-01-01&end_date=2026-12-31"
```

### SALES REP EMAIL EXCLUSIONS

The enrichment correctly excludes these emails from prospect matching:
- `phil@affiliatefinder.ai`, `phil@affiliatefinder.io`, `phil@kniroo.com`
- `jamie@increasing.com`, `jamie@affiliatefinder.io`, `jamie@kniroo.com`

And these domains:
- `affiliatefinder.io`, `affiliatefinder.ai`, `kniroo.com`

---
