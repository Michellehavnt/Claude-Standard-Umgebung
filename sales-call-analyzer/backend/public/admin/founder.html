<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Closing Rate - Sales Call Analyzer</title>
  <link rel="stylesheet" href="design-system.css">
  <style>
    /* Page-specific styles */

    /* Filter row layout - matching Calls page style */
    .ds-filters-row {
      display: flex;
      flex-wrap: wrap;
      gap: var(--space-4);
      align-items: flex-end;
    }

    .ds-filter-group {
      display: flex;
      flex-direction: column;
      gap: var(--space-1);
    }

    .ds-filter-label {
      font-size: var(--text-xs);
      font-weight: 500;
      color: var(--color-text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .ds-filter-actions {
      display: flex;
      gap: var(--space-2);
      margin-left: auto;
    }

    @media (max-width: 768px) {
      .ds-filters-row {
        flex-direction: column;
        align-items: stretch;
      }

      .ds-filter-group {
        width: 100%;
      }

      .ds-filter-actions {
        margin-left: 0;
        margin-top: var(--space-3);
      }
    }

    /* Big Number Card - Premium Hero Style */
    .headline-card {
      background: var(--color-surface);
      border-radius: var(--radius-xl);
      padding: var(--space-7) var(--space-6);
      margin-bottom: var(--space-6);
      border: 1px solid var(--color-border);
      text-align: center;
      position: relative;
      overflow: hidden;
    }

    .headline-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, var(--color-primary), var(--color-accent));
    }

    .headline-label {
      font-size: var(--text-xs);
      color: var(--color-text-muted);
      text-transform: uppercase;
      letter-spacing: 1.5px;
      font-weight: var(--weight-medium);
      margin-bottom: var(--space-3);
    }

    .headline-value {
      font-size: 72px;
      font-weight: 700;
      color: var(--color-primary);
      line-height: 1;
      letter-spacing: -2px;
    }

    .headline-suffix {
      font-size: 36px;
      color: var(--color-primary);
      opacity: 0.7;
      font-weight: 600;
    }

    .headline-subtitle {
      font-size: var(--text-sm);
      color: var(--color-text-secondary);
      margin-top: var(--space-4);
      line-height: var(--leading-relaxed);
    }

    /* Metrics Grid - Balanced 4-column */
    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: var(--space-4);
      margin-bottom: var(--space-6);
    }

    .metric-card {
      background: var(--color-surface);
      border-radius: var(--radius-lg);
      padding: var(--space-5);
      border: 1px solid var(--color-border);
      text-align: center;
      transition: border-color 0.15s ease;
    }

    .metric-card:hover {
      border-color: var(--color-text-muted);
    }

    .metric-value {
      font-size: var(--text-2xl);
      font-weight: 700;
      color: var(--color-text-primary);
      line-height: 1;
    }

    .metric-value.success {
      color: var(--color-success);
    }

    .metric-value.warning {
      color: #f59e0b;
    }

    .metric-value.danger {
      color: var(--color-danger);
    }

    .metric-label {
      font-size: var(--text-xs);
      color: var(--color-text-secondary);
      text-transform: uppercase;
      margin-top: var(--space-2);
      letter-spacing: 0.5px;
      font-weight: var(--weight-medium);
    }

    .metric-sublabel {
      font-size: var(--text-xs);
      color: var(--color-text-muted);
      margin-top: 4px;
    }

    /* Rates Row - Balanced 3-column */
    .rates-row {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: var(--space-4);
      margin-bottom: var(--space-6);
    }

    .rate-card {
      background: var(--color-surface);
      border-radius: var(--radius-lg);
      padding: var(--space-4);
      border: 1px solid var(--color-border);
    }

    .rate-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: var(--space-3);
    }

    .rate-label {
      font-size: var(--text-sm);
      color: var(--color-text-secondary);
      font-weight: var(--weight-medium);
    }

    .rate-value {
      font-size: var(--text-lg);
      font-weight: 600;
      color: var(--color-text-primary);
    }

    .rate-bar {
      height: 6px;
      background: var(--color-surface-alt);
      border-radius: 3px;
      overflow: hidden;
    }

    .rate-bar-inner {
      height: 100%;
      border-radius: 3px;
      transition: width 0.5s ease;
    }

    .rate-bar-inner.success {
      background: var(--color-success);
    }

    .rate-bar-inner.primary {
      background: var(--color-primary);
    }

    .rate-bar-inner.danger {
      background: var(--color-danger);
    }

    /* Days to Signup Card */
    .days-card {
      background: var(--color-surface);
      border-radius: var(--radius-lg);
      padding: var(--space-5);
      margin-bottom: var(--space-6);
      border: 1px solid var(--color-border);
    }

    .days-content {
      display: flex;
      align-items: center;
      gap: var(--space-5);
    }

    .days-icon {
      width: 48px;
      height: 48px;
      background: rgba(7, 59, 85, 0.1);
      border-radius: var(--radius-md);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: var(--text-xl);
    }

    .days-info {
      flex: 1;
    }

    .days-value {
      font-size: var(--text-2xl);
      font-weight: 700;
      color: var(--color-text-primary);
    }

    .days-label {
      font-size: var(--text-sm);
      color: var(--color-text-secondary);
      margin-top: 4px;
    }

    /* Dedup Info */
    .dedup-info {
      background: rgba(59, 130, 246, 0.08);
      border-radius: var(--radius-md);
      padding: var(--space-4);
      border: 1px solid rgba(59, 130, 246, 0.2);
      display: flex;
      align-items: center;
      gap: var(--space-3);
      margin-bottom: var(--space-6);
    }

    .dedup-icon {
      font-size: var(--text-lg);
    }

    .dedup-text {
      font-size: var(--text-sm);
      color: #3b82f6;
    }

    .dedup-text strong {
      font-weight: 600;
    }

    /* Loading & Error States */
    .loading, .error-state {
      text-align: center;
      padding: var(--space-8);
    }

    .loading-spinner {
      width: 50px;
      height: 50px;
      border: 4px solid var(--color-border);
      border-top-color: var(--color-primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto var(--space-5);
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .loading-text {
      color: var(--color-text-secondary);
      font-size: var(--text-base);
    }

    .error-state {
      background: var(--color-error-bg);
      border: 1px solid rgba(239, 68, 68, 0.3);
      border-radius: var(--radius-lg);
      color: var(--color-error);
    }

    .error-icon {
      font-size: 48px;
      margin-bottom: var(--space-4);
    }

    /* Generated At */
    .generated-at {
      text-align: center;
      font-size: var(--text-xs);
      color: var(--color-text-tertiary);
      margin-top: var(--space-5);
    }

    /* Tooltip */
    .headline-tooltip {
      position: relative;
      display: inline-block;
      cursor: help;
    }

    .headline-tooltip .tooltip-icon {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: var(--color-border);
      color: var(--color-text-secondary);
      font-size: 12px;
      font-weight: 600;
      margin-left: var(--space-2);
      vertical-align: middle;
    }

    .headline-tooltip .tooltip-content {
      visibility: hidden;
      opacity: 0;
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      background: var(--color-text-primary);
      color: var(--color-surface);
      padding: var(--space-3) var(--space-4);
      border-radius: var(--radius-md);
      font-size: var(--text-xs);
      white-space: nowrap;
      z-index: 100;
      transition: opacity 0.2s, visibility 0.2s;
      margin-bottom: 8px;
    }

    .headline-tooltip .tooltip-content::after {
      content: '';
      position: absolute;
      top: 100%;
      left: 50%;
      transform: translateX(-50%);
      border: 6px solid transparent;
      border-top-color: var(--color-text-primary);
    }

    .headline-tooltip:hover .tooltip-content {
      visibility: visible;
      opacity: 1;
    }

    /* Calls Table */
    .calls-section {
      background: var(--color-surface);
      border-radius: var(--radius-lg);
      border: 1px solid var(--color-border);
      margin-top: var(--space-6);
      overflow: hidden;
    }

    .calls-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: var(--space-4) var(--space-5);
      border-bottom: 1px solid var(--color-border);
      background: var(--color-surface-alt);
    }

    .calls-title {
      font-size: var(--text-base);
      font-weight: 600;
      color: var(--color-text-primary);
    }

    .calls-count {
      font-size: var(--text-sm);
      color: var(--color-text-secondary);
    }

    .calls-table {
      width: 100%;
      border-collapse: collapse;
    }

    .calls-table th {
      text-align: left;
      padding: var(--space-3) var(--space-4);
      font-size: var(--text-xs);
      font-weight: 600;
      color: var(--color-text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      background: var(--color-surface);
      border-bottom: 1px solid var(--color-border);
    }

    .calls-table td {
      padding: var(--space-3) var(--space-4);
      font-size: var(--text-sm);
      color: var(--color-text-primary);
      border-bottom: 1px solid var(--color-border);
    }

    .calls-table tr:last-child td {
      border-bottom: none;
    }

    .calls-table tr:hover td {
      background: var(--color-surface-alt);
    }

    .status-badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: var(--text-xs);
      font-weight: 500;
    }

    .status-badge.active {
      background: rgba(16, 185, 129, 0.1);
      color: var(--color-success);
    }

    .status-badge.churned {
      background: rgba(239, 68, 68, 0.1);
      color: var(--color-danger);
    }

    .status-badge.signed-up {
      background: rgba(59, 130, 246, 0.1);
      color: #3b82f6;
    }

    .status-badge.not-matched {
      background: var(--color-surface-alt);
      color: var(--color-text-secondary);
    }

    .status-badge.team {
      background: rgba(139, 92, 246, 0.1);
      color: #8b5cf6;
    }

    .status-badge.no-close {
      background: rgba(107, 114, 128, 0.1);
      color: #6b7280;
    }

    /* Rep name badges */
    .rep-badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: var(--text-xs);
      font-weight: 500;
    }

    .rep-badge.phil {
      background: rgba(251, 191, 36, 0.15);
      color: #b45309;
    }

    .rep-badge.jamie {
      background: rgba(236, 72, 153, 0.15);
      color: #be185d;
    }

    .rep-badge.both {
      background: rgba(59, 130, 246, 0.15);
      color: #2563eb;
    }

    .rep-badge.unknown {
      background: var(--color-surface-alt);
      color: var(--color-text-secondary);
    }

    /* Date badge styles */
    .date-badge {
      display: inline-flex;
      align-items: center;
      gap: var(--space-1);
      padding: var(--space-1) var(--space-2);
      border-radius: var(--radius-md);
      font-size: var(--text-xs);
      font-weight: 500;
      background: rgba(59, 130, 246, 0.1);
      color: #3b82f6;
    }

    .call-title-link {
      color: var(--color-primary);
      text-decoration: none;
    }

    .call-title-link:hover {
      text-decoration: underline;
    }

    .no-calls-message {
      padding: var(--space-6);
      text-align: center;
      color: var(--color-text-secondary);
    }

    /* Export Button */
    .export-btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      font-size: var(--text-xs);
      font-weight: 500;
      color: var(--color-text-secondary);
      background: var(--color-surface);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .export-btn:hover:not(:disabled) {
      background: var(--color-surface-alt);
      border-color: var(--color-text-muted);
      color: var(--color-text-primary);
    }

    .export-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .export-btn svg {
      width: 14px;
      height: 14px;
    }

    .calls-header-actions {
      display: flex;
      align-items: center;
      gap: var(--space-3);
    }

    /* Manual Adjustments Card */
    .adjustments-card {
      background: var(--color-surface);
      border-radius: var(--radius-lg);
      border: 1px solid var(--color-border);
      margin-bottom: var(--space-6);
      overflow: hidden;
    }

    .adjustments-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: var(--space-4) var(--space-5);
      background: var(--color-surface-alt);
      border-bottom: 1px solid var(--color-border);
      cursor: pointer;
      transition: background 0.15s ease;
    }

    .adjustments-header:hover {
      background: rgba(6, 114, 128, 0.05);
    }

    .adjustments-title {
      font-size: var(--text-sm);
      font-weight: 600;
      color: var(--color-text-primary);
      display: flex;
      align-items: center;
      gap: var(--space-2);
    }

    .adjustments-chevron {
      transition: transform 0.2s ease;
    }

    .adjustments-card.expanded .adjustments-chevron {
      transform: rotate(180deg);
    }

    .adjustments-body {
      display: none;
      padding: var(--space-5);
    }

    .adjustments-card.expanded .adjustments-body {
      display: block;
    }

    .toggle-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: var(--space-3) 0;
      border-bottom: 1px solid var(--color-border);
    }

    .toggle-row:last-child {
      border-bottom: none;
    }

    .toggle-label {
      font-size: var(--text-sm);
      color: var(--color-text-primary);
    }

    .toggle-sublabel {
      font-size: var(--text-xs);
      color: var(--color-text-muted);
      margin-top: 2px;
    }

    /* Toggle Switch */
    .toggle-switch {
      position: relative;
      width: 44px;
      height: 24px;
    }

    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: var(--color-border);
      border-radius: 12px;
      transition: 0.3s;
    }

    .toggle-slider:before {
      position: absolute;
      content: "";
      height: 18px;
      width: 18px;
      left: 3px;
      bottom: 3px;
      background: white;
      border-radius: 50%;
      transition: 0.3s;
    }

    .toggle-switch input:checked + .toggle-slider {
      background: #067280;
    }

    .toggle-switch input:checked + .toggle-slider:before {
      transform: translateX(20px);
    }

    /* Add DFY Close Button */
    .add-close-btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 8px 16px;
      font-size: var(--text-sm);
      font-weight: 500;
      color: white;
      background: #067280;
      border: none;
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: background 0.15s ease;
      margin-top: var(--space-4);
    }

    .add-close-btn:hover {
      background: #055560;
    }

    /* Modal Styles */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .modal-overlay.active {
      display: flex;
    }

    .modal {
      background: var(--color-surface);
      border-radius: var(--radius-lg);
      width: 100%;
      max-width: 500px;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: var(--space-5);
      border-bottom: 1px solid var(--color-border);
    }

    .modal-title {
      font-size: var(--text-lg);
      font-weight: 600;
      color: var(--color-text-primary);
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 24px;
      color: var(--color-text-muted);
      cursor: pointer;
      line-height: 1;
    }

    .modal-body {
      padding: var(--space-5);
    }

    .form-group {
      margin-bottom: var(--space-4);
    }

    .form-label {
      display: block;
      font-size: var(--text-sm);
      font-weight: 500;
      color: var(--color-text-primary);
      margin-bottom: var(--space-2);
    }

    .form-label .required {
      color: var(--color-danger);
    }

    .form-input {
      width: 100%;
      padding: 10px 12px;
      font-size: var(--text-sm);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-md);
      background: var(--color-surface);
      color: var(--color-text-primary);
    }

    .form-input:focus {
      outline: none;
      border-color: #067280;
      box-shadow: 0 0 0 3px rgba(6, 114, 128, 0.1);
    }

    .modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: var(--space-3);
      padding: var(--space-5);
      border-top: 1px solid var(--color-border);
      background: var(--color-surface-alt);
    }

    /* Include/Exclude Checkbox */
    .include-checkbox {
      width: 18px;
      height: 18px;
      cursor: pointer;
      accent-color: #067280;
    }

    /* Row Action Menu */
    .row-actions {
      position: relative;
    }

    .row-action-btn {
      background: none;
      border: none;
      padding: 4px 8px;
      cursor: pointer;
      color: var(--color-text-muted);
      border-radius: var(--radius-sm);
      transition: all 0.15s ease;
    }

    .row-action-btn:hover {
      background: var(--color-surface-alt);
      color: var(--color-text-primary);
    }

    .row-action-menu {
      display: none;
      position: absolute;
      right: 0;
      top: 100%;
      background: var(--color-surface);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-md);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      z-index: 100;
      min-width: 180px;
    }

    .row-action-menu.active {
      display: block;
    }

    .row-action-item {
      display: block;
      width: 100%;
      padding: 10px 14px;
      text-align: left;
      font-size: var(--text-sm);
      color: var(--color-text-primary);
      background: none;
      border: none;
      cursor: pointer;
      transition: background 0.15s ease;
    }

    .row-action-item:hover {
      background: var(--color-surface-alt);
    }

    .row-action-item.danger {
      color: var(--color-danger);
    }

    .row-action-divider {
      height: 1px;
      background: var(--color-border);
      margin: var(--space-1) 0;
    }

    /* Proof Modal */
    .proof-modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.2s ease, visibility 0.2s ease;
    }

    .proof-modal-overlay.active {
      opacity: 1;
      visibility: visible;
    }

    .proof-modal {
      background: var(--color-surface);
      border-radius: var(--radius-lg);
      width: 90%;
      max-width: 600px;
      max-height: 80vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
      transform: translateY(-20px);
      transition: transform 0.2s ease;
    }

    .proof-modal-overlay.active .proof-modal {
      transform: translateY(0);
    }

    .proof-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: var(--space-4) var(--space-5);
      border-bottom: 1px solid var(--color-border);
    }

    .proof-modal-title {
      font-size: var(--text-lg);
      font-weight: 600;
      color: var(--color-text-primary);
    }

    .proof-modal-close {
      background: none;
      border: none;
      padding: var(--space-2);
      cursor: pointer;
      color: var(--color-text-secondary);
      border-radius: var(--radius-md);
      transition: background 0.15s ease;
    }

    .proof-modal-close:hover {
      background: var(--color-surface-alt);
    }

    .proof-modal-body {
      padding: var(--space-5);
      overflow-y: auto;
      flex: 1;
    }

    .proof-summary {
      background: var(--color-surface-alt);
      padding: var(--space-4);
      border-radius: var(--radius-md);
      margin-bottom: var(--space-5);
      border-left: 4px solid var(--color-primary);
    }

    .proof-summary-label {
      font-size: var(--text-xs);
      text-transform: uppercase;
      color: var(--color-text-muted);
      letter-spacing: 0.5px;
      margin-bottom: var(--space-2);
    }

    .proof-summary-text {
      font-size: var(--text-sm);
      color: var(--color-text-primary);
      line-height: var(--leading-relaxed);
    }

    .proof-sources {
      display: flex;
      gap: var(--space-2);
      margin-bottom: var(--space-4);
    }

    .proof-source-badge {
      padding: var(--space-1) var(--space-3);
      border-radius: var(--radius-full);
      font-size: var(--text-xs);
      font-weight: 500;
      text-transform: uppercase;
    }

    .proof-source-badge.slack {
      background: rgba(74, 21, 75, 0.1);
      color: #4a154b;
    }

    .proof-source-badge.stripe {
      background: rgba(99, 91, 255, 0.1);
      color: #635bff;
    }

    .proof-source-badge.calendly {
      background: rgba(0, 107, 255, 0.1);
      color: #006bff;
    }

    .proof-source-badge.manual {
      background: rgba(6, 114, 128, 0.1);
      color: #067280;
    }

    .proof-section {
      margin-bottom: var(--space-5);
    }

    .proof-section-title {
      font-size: var(--text-sm);
      font-weight: 600;
      color: var(--color-text-primary);
      margin-bottom: var(--space-3);
      display: flex;
      align-items: center;
      gap: var(--space-2);
    }

    .proof-section-content {
      background: var(--color-background);
      border-radius: var(--radius-md);
      padding: var(--space-4);
      font-size: var(--text-sm);
    }

    .proof-event {
      padding: var(--space-3);
      border-bottom: 1px solid var(--color-border);
    }

    .proof-event:last-child {
      border-bottom: none;
    }

    .proof-event-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--space-2);
    }

    .proof-event-type {
      font-weight: 500;
      color: var(--color-text-primary);
    }

    .proof-event-date {
      font-size: var(--text-xs);
      color: var(--color-text-muted);
    }

    .proof-event-message {
      font-size: var(--text-xs);
      color: var(--color-text-secondary);
      background: var(--color-surface);
      padding: var(--space-2);
      border-radius: var(--radius-sm);
      margin-top: var(--space-2);
      font-family: monospace;
      white-space: pre-wrap;
      word-break: break-word;
    }

    .proof-field {
      display: flex;
      padding: var(--space-2) 0;
      border-bottom: 1px solid var(--color-border);
    }

    .proof-field:last-child {
      border-bottom: none;
    }

    .proof-field-label {
      flex: 0 0 120px;
      font-weight: 500;
      color: var(--color-text-secondary);
    }

    .proof-field-value {
      color: var(--color-text-primary);
      word-break: break-word;
    }

    .proof-loading {
      text-align: center;
      padding: var(--space-6);
      color: var(--color-text-muted);
    }

    /* Manual badge */
    .status-badge.manual {
      background: rgba(6, 114, 128, 0.1);
      color: #067280;
      border: 1px dashed #067280;
    }

    /* Bulk Actions */
    .bulk-actions {
      display: flex;
      align-items: center;
      gap: var(--space-3);
      padding: var(--space-3) var(--space-4);
      background: rgba(6, 114, 128, 0.05);
      border-bottom: 1px solid var(--color-border);
    }

    .bulk-actions-label {
      font-size: var(--text-sm);
      color: var(--color-text-secondary);
    }

    .bulk-btn {
      padding: 6px 12px;
      font-size: var(--text-xs);
      font-weight: 500;
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .bulk-btn-include {
      background: rgba(16, 185, 129, 0.1);
      color: var(--color-success);
      border: 1px solid var(--color-success);
    }

    .bulk-btn-include:hover {
      background: rgba(16, 185, 129, 0.2);
    }

    .bulk-btn-exclude {
      background: rgba(239, 68, 68, 0.1);
      color: var(--color-danger);
      border: 1px solid var(--color-danger);
    }

    .bulk-btn-exclude:hover {
      background: rgba(239, 68, 68, 0.2);
    }

    /* Inclusion Summary */
    .inclusion-summary {
      font-size: var(--text-xs);
      color: var(--color-text-muted);
      margin-left: auto;
    }

    /* Excluded row styling */
    .excluded-row td {
      opacity: 0.5;
      background: rgba(0, 0, 0, 0.02);
    }

    .excluded-row:hover td {
      opacity: 0.7;
    }

    /* Responsive */
    @media (max-width: 900px) {
      .metrics-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media (max-width: 768px) {
      .headline-value {
        font-size: 56px;
      }

      .metrics-grid {
        grid-template-columns: 1fr;
      }

      .rates-row {
        grid-template-columns: 1fr;
      }

      .quick-range-btns {
        flex-wrap: wrap;
      }

      .ds-filters-grid {
        grid-template-columns: 1fr !important;
      }
    }
  </style>
  <script src="/admin/js/view-mode.js"></script>
</head>
<body>
  <header class="ds-header">
    <div class="ds-header-inner">
      <a href="/admin/" class="ds-header-logo">
        <img src="/admin/logo.svg" alt="AffiliateFinder">
      </a>
      <div class="ds-header-divider"></div>
      <nav class="ds-header-nav">
        <a href="/admin/mrr.html">MRR</a>
        <a href="/admin/">Calls</a>
        <a href="/admin/lead-quality.html">Lead Quality</a>
        <a href="/admin/copy.html">Copy</a>
        <a href="/admin/phil.html">DFY</a>
        <a href="/admin/founder.html" class="active">Closing Rate</a>
      </nav>

      <!-- View Mode Indicator (shown when in user view) -->
      <div class="view-mode-indicator" id="viewModeIndicator" data-tooltip="You are viewing as a regular user">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
          <circle cx="12" cy="12" r="3"></circle>
        </svg>
        <span>User view</span>
      </div>

      <div class="ds-header-user">
        <button class="ds-user-button" id="user-menu-button" aria-expanded="false" aria-haspopup="true" data-tooltip="Open user menu" data-tooltip-position="left">
          <div class="ds-user-avatar" id="user-avatar">--</div>
          <div class="ds-user-info">
            <span class="ds-user-name" id="user-display-name">Loading...</span>
            <span class="ds-user-role" id="user-display-role">-</span>
          </div>
          <svg class="ds-user-chevron" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="6 9 12 15 18 9"></polyline>
          </svg>
        </button>
        <div class="ds-user-dropdown" id="user-dropdown">
          <div class="ds-dropdown-header">
            <div class="ds-dropdown-email" id="user-email">-</div>
            <span class="ds-dropdown-role user" id="user-role-badge">User</span>
          </div>

          <div class="ds-dropdown-section">
            <a href="/admin/account.html" class="ds-dropdown-item">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                <circle cx="12" cy="7" r="4"></circle>
              </svg>
              Account
            </a>
            <a href="/admin/settings.html" class="ds-dropdown-item">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="3"></circle>
                <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
              </svg>
              Settings
            </a>
            <a href="/admin/changelog.html" class="ds-dropdown-item">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                <polyline points="14 2 14 8 20 8"></polyline>
                <line x1="16" y1="13" x2="8" y2="13"></line>
                <line x1="16" y1="17" x2="8" y2="17"></line>
                <polyline points="10 9 9 9 8 9"></polyline>
              </svg>
              Changelog
            </a>
          </div>

          <div class="ds-dropdown-divider ds-admin-only" style="display: none;"></div>

          <div class="ds-dropdown-section ds-admin-only" style="display: none;">
            <div class="ds-dropdown-label">Admin</div>
            <a href="/admin/access-requests.html" class="ds-dropdown-item">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                <circle cx="8.5" cy="7" r="4"></circle>
                <line x1="20" y1="8" x2="20" y2="14"></line>
                <line x1="23" y1="11" x2="17" y2="11"></line>
              </svg>
              Access Requests
            </a>
            <a href="/admin/users.html" class="ds-dropdown-item">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                <circle cx="9" cy="7" r="4"></circle>
                <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
              </svg>
              User Management
            </a>
          </div>

          <!-- View Mode Toggle (admin only) -->
          <div class="ds-dropdown-divider ds-admin-only" id="viewModeSection" style="display: none;"></div>
          <div class="ds-dropdown-section ds-admin-only" id="viewModeToggleContainer" style="display: none;">
            <button class="view-mode-toggle" id="viewModeToggle" onclick="ViewMode.toggleViewMode()" data-tooltip="Preview app as a regular user">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                <circle cx="12" cy="12" r="3"></circle>
              </svg>
              <span class="view-mode-label">User view</span>
            </button>
          </div>

          <div class="ds-dropdown-divider"></div>

          <div class="ds-dropdown-section">
            <button class="ds-dropdown-item danger" id="logout-button" data-tooltip="End session via POST /api/auth/logout">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                <polyline points="16 17 21 12 16 7"></polyline>
                <line x1="21" y1="12" x2="9" y2="12"></line>
              </svg>
              Sign Out
            </button>
          </div>
        </div>
      </div>
    </div>
  </header>

  <main class="ds-container ds-page">
    <div class="ds-page-header">
      <h1 class="ds-page-title">Closing Rate</h1>
      <p class="ds-page-subtitle">Closing rate may be inaccurate if users sign up with a different email than used in the call. You can update the status manually.</p>
    </div>

    <!-- Filter Bar - Matching Calls page style -->
    <div class="ds-filters ds-mb-5">
      <div class="ds-filters-row">
        <div class="ds-filter-group">
          <label class="ds-filter-label">Date Range</label>
          <select class="ds-input" id="date-preset" onchange="handleDatePresetChange()">
            <option value="all" selected>All time</option>
            <option value="this_week">This week</option>
            <option value="last_week">Last week</option>
            <option value="last_month">Last month</option>
            <option value="last_3_months">Last 3 months</option>
            <option value="last_6_months">Last 6 months</option>
            <option value="custom">Custom range</option>
          </select>
        </div>
        <div class="ds-filter-group date-custom-group" id="customDateGroup" style="display: none;">
          <label class="ds-filter-label">From</label>
          <input type="date" class="ds-input" id="start-date">
        </div>
        <div class="ds-filter-group date-custom-group" id="customDateGroupEnd" style="display: none;">
          <label class="ds-filter-label">To</label>
          <input type="date" class="ds-input" id="end-date">
        </div>
        <div class="ds-filter-group">
          <label class="ds-filter-label">Sales Rep</label>
          <select class="ds-input" id="rep-filter">
            <option value="Phil" selected>Phil</option>
            <option value="Jamie">Jamie</option>
            <option value="all">All reps</option>
          </select>
        </div>
        <div class="ds-filter-actions">
          <button class="ds-btn ds-btn-primary" onclick="loadMetrics()" data-tooltip="Filter metrics by date range and rep">Apply</button>
          <button class="ds-btn ds-btn-secondary" id="refreshBtn" onclick="refreshMetrics()" data-tooltip="Sync Slack events and enrich calls with Stripe/Calendly data">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 4px;">
              <path d="M23 4v6h-6M1 20v-6h6M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/>
            </svg>
            Refresh
          </button>
        </div>
      </div>
    </div>

    <!-- Content (filled dynamically) -->
    <div id="content">
      <div class="loading">
        <div class="loading-spinner"></div>
        <div class="loading-text">Loading Phil's closing metrics...</div>
      </div>
    </div>

    <!-- Generated At -->
    <div class="generated-at" id="generated-at"></div>
  </main>

  <!-- Add DFY Close Modal -->
  <div class="modal-overlay" id="addCloseModal">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">Add Manual DFY Close</h3>
        <button class="modal-close" onclick="closeAddCloseModal()" data-tooltip="Close modal">&times;</button>
      </div>
      <div class="modal-body">
        <form id="addCloseForm">
          <div class="form-group">
            <label class="form-label">Email <span class="required">*</span></label>
            <input type="email" class="form-input" id="closeEmail" required placeholder="customer@example.com">
          </div>
          <div class="form-group">
            <label class="form-label">Company</label>
            <input type="text" class="form-input" id="closeCompany" placeholder="Company name">
          </div>
          <div class="form-group">
            <label class="form-label">Website</label>
            <input type="url" class="form-input" id="closeWebsite" placeholder="https://example.com">
          </div>
          <div class="form-group">
            <label class="form-label">Sales Rep <span class="required">*</span></label>
            <select class="form-input" id="closeRep" required>
              <option value="Phil">Phil</option>
              <option value="Jamie">Jamie</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Close Date <span class="required">*</span></label>
            <input type="date" class="form-input" id="closeDate" required>
          </div>
          <div class="form-group">
            <label class="form-label">Amount (Monthly)</label>
            <input type="number" class="form-input" id="closeAmount" placeholder="0.00" step="0.01" min="0">
          </div>
          <div class="form-group">
            <label class="form-label">Notes</label>
            <textarea class="form-input" id="closeNotes" rows="3" placeholder="Optional notes about this close"></textarea>
          </div>
          <div class="form-group">
            <label class="form-label">Link to Call (optional)</label>
            <select class="form-input" id="closeLinkedCall">
              <option value="">-- None --</option>
            </select>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="ds-btn ds-btn-secondary" onclick="closeAddCloseModal()" data-tooltip="Cancel and close modal">Cancel</button>
        <button class="ds-btn ds-btn-primary" onclick="submitAddClose()" data-tooltip="Save close via POST /api/closing-rate-adjustments">Add Close</button>
      </div>
    </div>
  </div>

  <!-- Manual Closes List Modal -->
  <div class="modal-overlay" id="manualClosesModal">
    <div class="modal" style="max-width: 700px;">
      <div class="modal-header">
        <h3 class="modal-title">Manual DFY Closes</h3>
        <button class="modal-close" onclick="closeManualClosesModal()" data-tooltip="Close modal">&times;</button>
      </div>
      <div class="modal-body" id="manualClosesContent">
        <div class="loading">
          <div class="loading-spinner"></div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="ds-btn ds-btn-secondary" onclick="closeManualClosesModal()" data-tooltip="Close modal">Close</button>
      </div>
    </div>
  </div>

  <script>
    let currentRange = 30;
    let currentRep = 'Phil';
    let currentCalls = []; // Store current calls data for CSV export
    let currentDateRange = { startDate: null, endDate: null }; // Store current date range for filename
    let currentDatePreset = 'all'; // Store current date preset for URL persistence
    let callInclusions = new Map(); // Map of call_id -> included (boolean)
    let lifecycleOverrides = new Map(); // Map of call_id -> override object
    let manualCloses = []; // List of manual DFY closes
    let selectedCallIds = new Set(); // Selected calls for bulk actions

    // Toggle state (default OFF to preserve existing behavior)
    let toggleState = {
      includeManualCloses: false,
      includeManualOverrides: false,
      includeExcludedCalls: false
    };

    // ============================================
    // URL Filter Persistence
    // ============================================
    function getFiltersFromURL() {
      const params = new URLSearchParams(window.location.search);
      const filters = {};

      if (params.has('preset')) filters.datePreset = params.get('preset');
      if (params.has('start')) filters.startDate = params.get('start');
      if (params.has('end')) filters.endDate = params.get('end');
      if (params.has('rep')) filters.rep = params.get('rep');

      return Object.keys(filters).length > 0 ? filters : null;
    }

    function updateURLWithFilters(filters, preset) {
      const params = new URLSearchParams();

      if (preset && preset !== 'all') {
        params.set('preset', preset);
      }
      if (preset === 'custom') {
        if (filters.startDate) params.set('start', filters.startDate);
        if (filters.endDate) params.set('end', filters.endDate);
      }
      if (filters.rep && filters.rep !== 'Phil') {
        params.set('rep', filters.rep);
      }

      const newURL = params.toString()
        ? `${window.location.pathname}?${params.toString()}`
        : window.location.pathname;

      window.history.replaceState({ filters, preset }, '', newURL);
    }

    function syncUIWithFilters(filters, preset) {
      const presetSelect = document.getElementById('date-preset');
      if (presetSelect && preset) {
        presetSelect.value = preset;
      }

      const startGroup = document.getElementById('custom-start-group');
      const endGroup = document.getElementById('custom-end-group');

      if (preset === 'custom') {
        startGroup.style.display = '';
        endGroup.style.display = '';
        if (filters.startDate) document.getElementById('start-date').value = filters.startDate;
        if (filters.endDate) document.getElementById('end-date').value = filters.endDate;
      } else {
        startGroup.style.display = 'none';
        endGroup.style.display = 'none';
      }

      const repSelect = document.getElementById('rep-filter');
      if (repSelect && filters.rep) {
        repSelect.value = filters.rep;
      }
    }

    function initFiltersFromURL() {
      const urlFilters = getFiltersFromURL();
      if (urlFilters) {
        currentDatePreset = urlFilters.datePreset || 'all';
        currentRep = urlFilters.rep || 'Phil';

        if (urlFilters.datePreset === 'custom') {
          currentDateRange.startDate = urlFilters.startDate || null;
          currentDateRange.endDate = urlFilters.endDate || null;
        } else {
          const dateRange = getDatePresetRange(currentDatePreset);
          currentDateRange.startDate = dateRange.startDate;
          currentDateRange.endDate = dateRange.endDate;
        }

        syncUIWithFilters({ ...currentDateRange, rep: currentRep }, currentDatePreset);
        return true;
      }
      return false;
    }

    // Handle browser back/forward navigation
    window.addEventListener('popstate', (event) => {
      if (event.state && event.state.filters) {
        currentDateRange = {
          startDate: event.state.filters.startDate,
          endDate: event.state.filters.endDate
        };
        currentRep = event.state.filters.rep || 'Phil';
        currentDatePreset = event.state.preset || 'last_3_months';
        syncUIWithFilters(event.state.filters, currentDatePreset);
        loadMetrics();
      }
    });

    // User Menu
    async function initUserMenu() {
      try {
        const response = await fetch('/api/auth/me', { credentials: 'include' });
        if (!response.ok) {
          window.location.href = '/admin/login.html';
          return;
        }
        const data = await response.json();
        const user = data.user;

        // Update avatar with initials
        const avatar = document.getElementById('user-avatar');
        if (avatar) {
          const initials = (user.name || user.email || '?')
            .split(/[\s@]+/)
            .map(part => part[0])
            .join('')
            .substring(0, 2)
            .toUpperCase();
          avatar.textContent = initials;
        }

        // Update user display name in header button
        const displayName = document.getElementById('user-display-name');
        if (displayName) {
          displayName.textContent = user.name || user.email.split('@')[0];
        }

        // Update user display role in header button
        const displayRole = document.getElementById('user-display-role');
        if (displayRole) {
          displayRole.textContent = user.role === 'admin' ? 'Admin' : 'User';
        }

        // Update email in dropdown
        const emailEl = document.getElementById('user-email');
        if (emailEl) emailEl.textContent = user.email;

        // Update role badge in dropdown
        const roleBadge = document.getElementById('user-role-badge');
        if (roleBadge) {
          roleBadge.textContent = user.role === 'admin' ? 'Admin' : 'User';
          roleBadge.className = 'ds-dropdown-role ' + (user.role === 'admin' ? 'admin' : 'user');
        }

        if (user.role === 'admin') {
          document.querySelectorAll('.ds-admin-only').forEach(el => el.style.display = '');
        }

        // Initialize view mode (must be after admin-only elements are shown)
        if (window.ViewMode) {
          ViewMode.initViewMode(user.role);
        }
      } catch (err) {
        console.error('Failed to load user info:', err);
      }
    }

    function setupUserMenu() {
      const button = document.getElementById('user-menu-button');
      const dropdown = document.getElementById('user-dropdown');
      const logoutBtn = document.getElementById('logout-button');

      if (button && dropdown) {
        button.addEventListener('click', (e) => {
          e.stopPropagation();
          const isOpen = dropdown.classList.contains('open');
          dropdown.classList.toggle('open', !isOpen);
          button.setAttribute('aria-expanded', !isOpen);
        });

        document.addEventListener('click', (e) => {
          if (!e.target.closest('.ds-header-user')) {
            dropdown.classList.remove('open');
            button.setAttribute('aria-expanded', 'false');
          }
        });
      }

      if (logoutBtn) {
        logoutBtn.addEventListener('click', async () => {
          try {
            await fetch('/api/auth/logout', { method: 'POST', credentials: 'include' });
          } catch (err) {
            console.error('Logout error:', err);
          }
          window.location.href = '/admin/login.html';
        });
      }
    }

    // Date preset computation utilities (uses browser timezone, week starts Monday)
    function getDatePresetRange(preset) {
      const now = new Date();
      const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());

      switch (preset) {
        case 'all':
          // Use a very early start date and today as end date
          return { startDate: '2020-01-01', endDate: formatDateForInput(today) };

        case 'this_week': {
          const dayOfWeek = today.getDay();
          const daysFromMonday = dayOfWeek === 0 ? 6 : dayOfWeek - 1;
          const monday = new Date(today);
          monday.setDate(today.getDate() - daysFromMonday);
          const sunday = new Date(monday);
          sunday.setDate(monday.getDate() + 6);
          return { startDate: formatDateForInput(monday), endDate: formatDateForInput(sunday) };
        }

        case 'last_week': {
          const dayOfWeek = today.getDay();
          const daysFromMonday = dayOfWeek === 0 ? 6 : dayOfWeek - 1;
          const thisMonday = new Date(today);
          thisMonday.setDate(today.getDate() - daysFromMonday);
          const lastMonday = new Date(thisMonday);
          lastMonday.setDate(thisMonday.getDate() - 7);
          const lastSunday = new Date(lastMonday);
          lastSunday.setDate(lastMonday.getDate() + 6);
          return { startDate: formatDateForInput(lastMonday), endDate: formatDateForInput(lastSunday) };
        }

        case 'last_month': {
          const firstOfThisMonth = new Date(today.getFullYear(), today.getMonth(), 1);
          const lastOfLastMonth = new Date(firstOfThisMonth);
          lastOfLastMonth.setDate(lastOfLastMonth.getDate() - 1);
          const firstOfLastMonth = new Date(lastOfLastMonth.getFullYear(), lastOfLastMonth.getMonth(), 1);
          return { startDate: formatDateForInput(firstOfLastMonth), endDate: formatDateForInput(lastOfLastMonth) };
        }

        case 'last_3_months': {
          const threeMonthsAgo = new Date(today.getFullYear(), today.getMonth() - 3, today.getDate());
          return { startDate: formatDateForInput(threeMonthsAgo), endDate: formatDateForInput(today) };
        }

        case 'last_6_months': {
          const sixMonthsAgo = new Date(today.getFullYear(), today.getMonth() - 6, today.getDate());
          return { startDate: formatDateForInput(sixMonthsAgo), endDate: formatDateForInput(today) };
        }

        case 'custom':
          return {
            startDate: document.getElementById('start-date').value || null,
            endDate: document.getElementById('end-date').value || null
          };

        default:
          return { startDate: null, endDate: null };
      }
    }

    // Handle date preset dropdown change
    function handleDatePresetChange() {
      const preset = document.getElementById('date-preset').value;
      const customGroup = document.getElementById('customDateGroup');
      const customGroupEnd = document.getElementById('customDateGroupEnd');

      if (preset === 'custom') {
        customGroup.style.display = 'flex';
        customGroupEnd.style.display = 'flex';
      } else {
        customGroup.style.display = 'none';
        customGroupEnd.style.display = 'none';

        const range = getDatePresetRange(preset);
        document.getElementById('start-date').value = range.startDate || '';
        document.getElementById('end-date').value = range.endDate || '';
      }
    }

    // Format date for input field (YYYY-MM-DD)
    function formatDateForInput(date) {
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }

    // Format date for display
    function formatDateDisplay(dateStr, asBadge = true) {
      if (!dateStr) return '-';
      const date = new Date(dateStr);
      const formatted = date.toLocaleString('en-US', {
        month: 'short',
        day: 'numeric',
        hour: 'numeric',
        minute: '2-digit',
        hour12: true
      });
      if (asBadge) {
        return `<span class="date-badge">${formatted}</span>`;
      }
      return formatted;
    }

    // Refresh metrics - run enrichment pipeline then reload data
    async function refreshMetrics() {
      const btn = document.getElementById('refreshBtn');
      const refreshIcon = `
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 4px;">
          <path d="M23 4v6h-6M1 20v-6h6M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/>
        </svg>
      `;

      btn.disabled = true;
      btn.innerHTML = refreshIcon + 'Enriching...';

      try {
        // First, run the enrichment pipeline to sync Slack and enrich calls
        const enrichRes = await fetch('/api/enrichment/run', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ limit: 200, syncSlackFirst: true, storeResults: true })
        });

        if (enrichRes.ok) {
          const enrichData = await enrichRes.json();
          console.log('Enrichment complete:', enrichData.results);

          // Show brief enrichment stats
          const slackSync = enrichData.results?.slackSync;
          const enrichment = enrichData.results?.enrichment;
          if (slackSync?.imported > 0 || enrichment?.enriched > 0) {
            btn.innerHTML = refreshIcon + `Found ${enrichment?.enriched || 0} matches!`;
            await new Promise(r => setTimeout(r, 1500));
          }
        }

        btn.innerHTML = refreshIcon + 'Loading...';

        // Now reload the metrics with fresh data
        await loadMetrics();
        btn.innerHTML = refreshIcon + 'Done!';
        setTimeout(() => {
          btn.innerHTML = refreshIcon + 'Refresh';
        }, 1500);
      } catch (error) {
        console.error('Error refreshing metrics:', error);
        btn.innerHTML = refreshIcon + 'Error';
        setTimeout(() => {
          btn.innerHTML = refreshIcon + 'Refresh';
        }, 2000);
      } finally {
        btn.disabled = false;
      }
    }

    // Load metrics from API
    async function loadMetrics() {
      const startDate = document.getElementById('start-date').value;
      const endDate = document.getElementById('end-date').value;
      const repFilter = document.getElementById('rep-filter').value;
      const preset = document.getElementById('date-preset').value;

      if (!startDate || !endDate) {
        showError('Please select both start and end dates');
        return;
      }

      currentRep = repFilter;
      currentDatePreset = preset;
      currentDateRange.startDate = startDate;
      currentDateRange.endDate = endDate;

      // Update URL with current filter state
      updateURLWithFilters({ startDate, endDate, rep: repFilter }, preset);
      const repLabel = repFilter === 'all' ? 'all reps' : repFilter;

      document.getElementById('content').innerHTML = `
        <div class="loading">
          <div class="loading-spinner"></div>
          <div class="loading-text">Loading ${repLabel}'s closing metrics...</div>
        </div>
      `;

      try {
        // Load inclusions and overrides data in parallel
        const [inclusionsRes, overridesRes, closesRes] = await Promise.all([
          fetch('/api/closing-rate/inclusions'),
          fetch('/api/closing-rate/lifecycle-overrides'),
          fetch('/api/closing-rate/manual-closes')
        ]);

        if (inclusionsRes.ok) {
          const inclData = await inclusionsRes.json();
          callInclusions.clear();
          (inclData.data || []).forEach(inc => {
            callInclusions.set(inc.call_id, inc.included === 1);
          });
        }

        if (overridesRes.ok) {
          const overData = await overridesRes.json();
          lifecycleOverrides.clear();
          (overData.data || []).forEach(ov => {
            lifecycleOverrides.set(ov.call_id, ov);
          });
        }

        if (closesRes.ok) {
          const closesData = await closesRes.json();
          manualCloses = closesData.data || [];
        }

        // Build query string with toggle state
        const toggleParams = new URLSearchParams({
          start_date: startDate,
          end_date: endDate,
          includeManualCloses: toggleState.includeManualCloses,
          includeManualOverrides: toggleState.includeManualOverrides,
          includeExcludedCalls: toggleState.includeExcludedCalls
        });

        // Use the generic /:rep endpoint for all reps, or /phil for Phil
        const endpoint = repFilter === 'all' ? 'all' : repFilter.toLowerCase();
        const response = await fetch(`/api/founder/${endpoint}?${toggleParams}`);
        const data = await response.json();

        if (!response.ok) {
          showError(data.message || 'Failed to load metrics');
          return;
        }

        renderMetrics(data);
      } catch (error) {
        console.error('Error loading metrics:', error);
        showError('Failed to connect to server');
      }
    }

    // Show error state
    function showError(message) {
      document.getElementById('content').innerHTML = `
        <div class="error-state">
          <div class="error-icon">!</div>
          <div>${escapeHtml(message)}</div>
        </div>
      `;
    }

    // Render metrics
    function renderMetrics(data) {
      const { metrics, dateRange, rawCallsBeforeDedup, callsDeduped, calls, generatedAt, rep, dataSources } = data;
      const repLabel = rep === 'all' ? 'All Reps' : rep;

      // Store calls data and date range for CSV export
      currentCalls = calls || [];
      currentDateRange = dateRange || { startDate: null, endDate: null };
      selectedCallIds.clear();

      // Page subtitle is now static - no longer updates with rep filter

      // Calculate inclusion stats
      const includedCount = currentCalls.filter(c => getCallIncluded(c.id)).length;
      const totalCount = currentCalls.length;

      const html = `
        <!-- Manual Adjustments Card -->
        <div class="adjustments-card" id="adjustmentsCard">
          <div class="adjustments-header" onclick="toggleAdjustmentsCard()">
            <span class="adjustments-title">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 5v14M5 12h14"/>
              </svg>
              Manual Adjustments
            </span>
            <svg class="adjustments-chevron" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M6 9l6 6 6-6"/>
            </svg>
          </div>
          <div class="adjustments-body">
            <div class="toggle-row">
              <div>
                <div class="toggle-label">Include manual DFY closes</div>
                <div class="toggle-sublabel">Add manually tracked won deals to signup count</div>
              </div>
              <label class="toggle-switch">
                <input type="checkbox" id="toggleManualCloses" ${toggleState.includeManualCloses ? 'checked' : ''} onchange="handleToggleChange('includeManualCloses', this.checked)">
                <span class="toggle-slider"></span>
              </label>
            </div>
            <div class="toggle-row">
              <div>
                <div class="toggle-label">Include manual lifecycle overrides</div>
                <div class="toggle-sublabel">Use manual status overrides when Stripe matching fails</div>
              </div>
              <label class="toggle-switch">
                <input type="checkbox" id="toggleManualOverrides" ${toggleState.includeManualOverrides ? 'checked' : ''} onchange="handleToggleChange('includeManualOverrides', this.checked)">
                <span class="toggle-slider"></span>
              </label>
            </div>
            <div class="toggle-row">
              <div>
                <div class="toggle-label">Include excluded calls in metrics</div>
                <div class="toggle-sublabel">Count excluded calls in the denominator</div>
              </div>
              <label class="toggle-switch">
                <input type="checkbox" id="toggleExcludedCalls" ${toggleState.includeExcludedCalls ? 'checked' : ''} onchange="handleToggleChange('includeExcludedCalls', this.checked)">
                <span class="toggle-slider"></span>
              </label>
            </div>
            <button class="add-close-btn" onclick="openAddCloseModal()" data-tooltip="Add manual DFY close record">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 5v14M5 12h14"/>
              </svg>
              Add DFY Close
            </button>
            ${manualCloses.length > 0 ? `
              <button class="ds-btn ds-btn-secondary" style="margin-top: var(--space-2); margin-left: var(--space-2);" onclick="openManualClosesModal()" data-tooltip="View and manage manual close records">
                View ${manualCloses.length} Manual Close${manualCloses.length !== 1 ? 's' : ''}
              </button>
            ` : ''}
          </div>
        </div>

        <!-- Headline: Signup Rate (Closing Rate) -->
        <div class="headline-card">
          <div class="headline-label">
            ${repLabel}'s Closing Rate
            <span class="headline-tooltip">
              <span class="tooltip-icon">?</span>
              <span class="tooltip-content">
                Based on ${metrics.callCount} sales calls from ${formatDateDisplay(dateRange.startDate, false)} to ${formatDateDisplay(dateRange.endDate, false)}
              </span>
            </span>
          </div>
          <div class="headline-value">${metrics.signupRate}<span class="headline-suffix">%</span></div>
          <div class="headline-subtitle">
            ${metrics.signupCount} signups from ${metrics.callCount} sales calls
            (${formatDateDisplay(dateRange.startDate, false)} - ${formatDateDisplay(dateRange.endDate, false)})
            ${dataSources ? `<br><small style="color: var(--color-text-muted);">Sources: ${dataSources.stripeMatches} Stripe, ${dataSources.slackMatches} Slack${toggleState.includeManualCloses && metrics.manualClosesCount ? `, ${metrics.manualClosesCount} Manual` : ''}</small>` : ''}
          </div>
        </div>

        <!-- Deduplication Info -->
        ${callsDeduped > 0 ? `
          <div class="dedup-info">
            <span class="dedup-icon">i</span>
            <span class="dedup-text">
              <strong>${rawCallsBeforeDedup} total calls</strong> deduplicated to <strong>${metrics.callCount} unique prospects</strong>
              (first call per prospect counted)
            </span>
          </div>
        ` : ''}

        <!-- Primary Metrics -->
        <div class="metrics-grid">
          <div class="metric-card">
            <div class="metric-value">${metrics.callCount}</div>
            <div class="metric-label">Sales Calls</div>
            <div class="metric-sublabel">Unique prospects</div>
          </div>
          <div class="metric-card">
            <div class="metric-value success">${metrics.signupCount}</div>
            <div class="metric-label">Signed Up</div>
            <div class="metric-sublabel">Stripe customer created</div>
          </div>
          <div class="metric-card">
            <div class="metric-value success">${metrics.activeCount}</div>
            <div class="metric-label">Active</div>
            <div class="metric-sublabel">Currently subscribed</div>
          </div>
          <div class="metric-card">
            <div class="metric-value danger">${metrics.churnedCount}</div>
            <div class="metric-label">Churned</div>
            <div class="metric-sublabel">Subscription canceled</div>
          </div>
        </div>

        <!-- Rate Bars -->
        <div class="rates-row">
          <div class="rate-card">
            <div class="rate-header">
              <span class="rate-label">Signup Rate</span>
              <span class="rate-value">${metrics.signupRate}%</span>
            </div>
            <div class="rate-bar">
              <div class="rate-bar-inner primary" style="width: ${metrics.signupRate}%"></div>
            </div>
          </div>
          <div class="rate-card">
            <div class="rate-header">
              <span class="rate-label">Active Rate</span>
              <span class="rate-value">${metrics.activeRate}%</span>
            </div>
            <div class="rate-bar">
              <div class="rate-bar-inner success" style="width: ${metrics.activeRate}%"></div>
            </div>
          </div>
          <div class="rate-card">
            <div class="rate-header">
              <span class="rate-label">Churned Rate</span>
              <span class="rate-value">${metrics.churnedRate}%</span>
            </div>
            <div class="rate-bar">
              <div class="rate-bar-inner danger" style="width: ${metrics.churnedRate}%"></div>
            </div>
          </div>
        </div>

        <!-- Days to Signup -->
        ${metrics.avgDaysToSignup !== null ? `
          <div class="days-card">
            <div class="days-content">
              <div class="days-icon">Cal</div>
              <div class="days-info">
                <div class="days-value">${metrics.avgDaysToSignup} days</div>
                <div class="days-label">Average time from call to signup</div>
              </div>
            </div>
          </div>
        ` : ''}

        <!-- Calls List -->
        <div class="calls-section">
          <div class="calls-header">
            <span class="calls-title">Analyzed Calls</span>
            <div class="calls-header-actions">
              <span class="calls-count">${includedCount} included / ${totalCount} total</span>
              <button class="export-btn" onclick="exportCallsToCSV()" ${!calls || calls.length === 0 ? 'disabled' : ''} data-tooltip="Download calls data as CSV file">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                  <polyline points="7 10 12 15 17 10"/>
                  <line x1="12" y1="15" x2="12" y2="3"/>
                </svg>
                Export CSV
              </button>
            </div>
          </div>
          <div class="bulk-actions" id="bulkActions" style="display: none;">
            <span class="bulk-actions-label"><span id="selectedCount">0</span> selected</span>
            <button class="bulk-btn bulk-btn-include" onclick="bulkSetInclusion(true)" data-tooltip="Include selected calls in metrics">Include Selected</button>
            <button class="bulk-btn bulk-btn-exclude" onclick="bulkSetInclusion(false)" data-tooltip="Exclude selected calls from metrics">Exclude Selected</button>
          </div>
          ${calls && calls.length > 0 ? `
            <table class="calls-table">
              <thead>
                <tr>
                  <th style="width: 40px;">
                    <input type="checkbox" class="include-checkbox" onchange="toggleSelectAll(this.checked)" title="Select all">
                  </th>
                  <th style="width: 70px;">Include</th>
                  <th>Rep</th>
                  <th>Call Title</th>
                  <th>Date</th>
                  <th>Prospect</th>
                  <th>URL</th>
                  <th>Status</th>
                  <th style="width: 50px;"></th>
                </tr>
              </thead>
              <tbody>
                ${calls.map(call => {
                  const isIncluded = getCallIncluded(call.id);
                  const override = lifecycleOverrides.get(call.id);
                  const displayStatus = override && toggleState.includeManualOverrides ? formatOverrideStatus(override.status) : call.stripeStatus;
                  const statusClass = override && toggleState.includeManualOverrides ? getOverrideStatusClass(override.status) : getStatusClass(call.stripeStatus);
                  const isManualStatus = override && toggleState.includeManualOverrides;
                  return `
                  <tr data-call-id="${call.id}" class="${!isIncluded ? 'excluded-row' : ''}">
                    <td>
                      <input type="checkbox" class="include-checkbox row-select" data-call-id="${call.id}" onchange="handleRowSelect('${call.id}', this.checked)">
                    </td>
                    <td>
                      <input type="checkbox" class="include-checkbox" ${isIncluded ? 'checked' : ''} onchange="setCallInclusion('${call.id}', this.checked)" title="${isIncluded ? 'Included in metrics' : 'Excluded from metrics'}">
                    </td>
                    <td>
                      <span class="rep-badge ${getRepClass(call.repName)}">${getRepDisplayName(call.repName)}</span>
                    </td>
                    <td>
                      <a href="/admin/call.html?id=${call.id}&from=founder" class="call-title-link">${escapeHtml(call.title)}</a>
                    </td>
                    <td>${formatDateDisplay(call.date)}</td>
                    <td>${call.prospectEmail ? escapeHtml(call.prospectEmail) : '<span style="color: var(--color-text-muted);">No email</span>'}</td>
                    <td>${getProspectDomain(call.prospectEmail)}</td>
                    <td>
                      <span class="status-badge ${statusClass} ${isManualStatus ? 'manual' : ''}" ${isManualStatus ? `title="Manual override by ${override.created_by || 'admin'}"` : ''}>
                        ${isManualStatus ? 'Manual: ' : ''}${displayStatus}
                      </span>
                    </td>
                    <td>
                      <div class="row-actions">
                        <button class="row-action-btn" onclick="toggleRowMenu('${call.id}')" data-tooltip="Open actions menu">
                          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="1"/><circle cx="12" cy="5" r="1"/><circle cx="12" cy="19" r="1"/>
                          </svg>
                        </button>
                        <div class="row-action-menu" id="menu-${call.id}">
                          <button class="row-action-item" onclick="setLifecycleOverride('${call.id}', '${call.prospectEmail || ''}', 'signed_up')" data-tooltip="Override status to Signed Up">Mark as Signed Up</button>
                          <button class="row-action-item" onclick="setLifecycleOverride('${call.id}', '${call.prospectEmail || ''}', 'active')" data-tooltip="Override status to Active">Mark as Active</button>
                          <button class="row-action-item" onclick="setLifecycleOverride('${call.id}', '${call.prospectEmail || ''}', 'churned')" data-tooltip="Override status to Churned">Mark as Churned</button>
                          <button class="row-action-item" onclick="setLifecycleOverride('${call.id}', '${call.prospectEmail || ''}', 'team')" data-tooltip="Mark as internal team member - excluded from closing rate">Mark as Team</button>
                          <button class="row-action-item" onclick="setLifecycleOverride('${call.id}', '${call.prospectEmail || ''}', 'no_close')" data-tooltip="Mark as no close - not a real sales opportunity">Mark as No Close</button>
                          <div class="row-action-divider"></div>
                          <button class="row-action-item" onclick="showProof('${call.id}')" data-tooltip="View data sources and reasoning for this status">Show Proof</button>
                          ${override ? `<button class="row-action-item danger" onclick="clearLifecycleOverride('${call.id}')" data-tooltip="Remove manual override">Clear Override</button>` : ''}
                        </div>
                      </div>
                    </td>
                  </tr>
                `}).join('')}
              </tbody>
            </table>
          ` : `
            <div class="no-calls-message">No sales calls found in this date range</div>
          `}
        </div>
      `;

      document.getElementById('content').innerHTML = html;

      // Update generated at timestamp
      if (generatedAt) {
        const genDate = new Date(generatedAt);
        document.getElementById('generated-at').textContent =
          `Generated: ${genDate.toLocaleString()}`;
      }
    }

    // Escape HTML
    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Extract domain from email address for URL column
    function getProspectDomain(email) {
      if (!email || !email.includes('@')) {
        return '<span style="color: var(--color-text-muted);">-</span>';
      }
      const domain = email.split('@')[1];
      if (!domain) {
        return '<span style="color: var(--color-text-muted);">-</span>';
      }
      return `<a href="https://${domain}" target="_blank" rel="noopener" style="color: var(--color-primary); text-decoration: none;">${domain}</a>`;
    }

    // Get CSS class for Stripe status badge
    function getStatusClass(status) {
      switch (status) {
        case 'Active': return 'active';
        case 'Churned': return 'churned';
        case 'Signed Up': return 'signed-up';
        default: return 'not-matched';
      }
    }

    // Get CSS class for rep badge
    function getRepClass(repName) {
      if (!repName) return 'unknown';
      const name = repName.toLowerCase();
      if (name === 'both') return 'both';
      if (name.includes('phil')) return 'phil';
      if (name.includes('jamie')) return 'jamie';
      return 'unknown';
    }

    // Get display name for rep badge
    function getRepDisplayName(repName) {
      if (!repName) return 'Unknown';
      const name = repName.toLowerCase();
      if (name === 'both') return 'Both';
      if (name.includes('phil')) return 'Phil';
      if (name.includes('jamie')) return 'Jamie';
      return repName;
    }

    // CSV Export Functions

    /**
     * Escape a value for CSV format
     * @param {any} value - Value to escape
     * @returns {string} - CSV-safe string
     */
    function escapeCSVValue(value) {
      if (value === null || value === undefined) {
        return '';
      }
      const stringValue = String(value);
      const needsQuoting = stringValue.includes(',') ||
                           stringValue.includes('"') ||
                           stringValue.includes('\n') ||
                           stringValue.includes('\r');
      if (needsQuoting) {
        return '"' + stringValue.replace(/"/g, '""') + '"';
      }
      return stringValue;
    }

    /**
     * Format date for CSV (YYYY-MM-DD)
     * @param {string} dateStr - Date string
     * @returns {string} - Formatted date
     */
    function formatDateForCSV(dateStr) {
      if (!dateStr) return '';
      try {
        const date = new Date(dateStr);
        if (isNaN(date.getTime())) return dateStr;
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
      } catch {
        return dateStr;
      }
    }

    /**
     * Generate CSV content from calls data
     * @param {Object[]} calls - Array of call objects
     * @returns {string} - CSV content
     */
    function generateCallsCSV(calls) {
      if (!Array.isArray(calls) || calls.length === 0) {
        return '';
      }

      const lines = [];

      // Header row with new fields
      lines.push('Rep,Call Title,Date,Prospect Email,URL,Status,Included,Manual Override');

      // Data rows
      for (const call of calls) {
        const isIncluded = getCallIncluded(call.id);
        const override = lifecycleOverrides.get(call.id);
        const hasManualOverride = override ? 'Yes' : 'No';
        const displayStatus = override && toggleState.includeManualOverrides
          ? `Manual: ${formatOverrideStatus(override.status)}`
          : (call.stripeStatus || 'Not Matched');

        // Extract domain from email for URL column
        const domain = call.prospectEmail && call.prospectEmail.includes('@')
          ? call.prospectEmail.split('@')[1]
          : '';

        const row = [
          escapeCSVValue(getRepDisplayName(call.repName)),
          escapeCSVValue(call.title || ''),
          escapeCSVValue(formatDateForCSV(call.date)),
          escapeCSVValue(call.prospectEmail || ''),
          escapeCSVValue(domain),
          escapeCSVValue(displayStatus),
          escapeCSVValue(isIncluded ? 'Yes' : 'No'),
          escapeCSVValue(hasManualOverride)
        ];
        lines.push(row.join(','));
      }

      return lines.join('\n');
    }

    /**
     * Generate filename for CSV export
     * @returns {string} - Filename
     */
    function generateCSVFilename() {
      const today = new Date().toISOString().split('T')[0];
      if (currentDateRange.startDate && currentDateRange.endDate) {
        return `closing-rate-calls-${currentDateRange.startDate}-to-${currentDateRange.endDate}.csv`;
      }
      return `closing-rate-calls-${today}.csv`;
    }

    /**
     * Trigger CSV download
     */
    function exportCallsToCSV() {
      if (!currentCalls || currentCalls.length === 0) {
        return;
      }

      const csvContent = generateCallsCSV(currentCalls);
      if (!csvContent) {
        return;
      }

      // Create blob with UTF-8 BOM for Excel compatibility
      const BOM = '\uFEFF';
      const blob = new Blob([BOM + csvContent], { type: 'text/csv;charset=utf-8;' });

      // Create download link
      const link = document.createElement('a');
      const url = URL.createObjectURL(blob);
      link.setAttribute('href', url);
      link.setAttribute('download', generateCSVFilename());
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
    }

    // ==================== MANUAL ADJUSTMENTS FUNCTIONS ====================

    // Toggle adjustments card expansion
    function toggleAdjustmentsCard() {
      const card = document.getElementById('adjustmentsCard');
      if (card) {
        card.classList.toggle('expanded');
      }
    }

    // Handle toggle state changes
    function handleToggleChange(toggleName, checked) {
      toggleState[toggleName] = checked;
      loadMetrics();
    }

    // Get call inclusion status (default to true if not set)
    function getCallIncluded(callId) {
      if (callInclusions.has(callId)) {
        return callInclusions.get(callId);
      }
      // Default: included
      return true;
    }

    // Set call inclusion status
    async function setCallInclusion(callId, included) {
      try {
        const response = await fetch(`/api/closing-rate/inclusions/${callId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ included })
        });

        if (!response.ok) {
          const data = await response.json();
          alert(data.error || 'Failed to update inclusion');
          return;
        }

        callInclusions.set(callId, included);
        loadMetrics();
      } catch (error) {
        console.error('Error setting inclusion:', error);
        alert('Failed to update inclusion');
      }
    }

    // Bulk set inclusion for selected calls
    async function bulkSetInclusion(included) {
      if (selectedCallIds.size === 0) return;

      try {
        const callIdsArray = Array.from(selectedCallIds);
        const response = await fetch('/api/closing-rate/inclusions/bulk', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ call_ids: callIdsArray, included })
        });

        if (!response.ok) {
          const data = await response.json();
          alert(data.error || 'Failed to update inclusions');
          return;
        }

        callIdsArray.forEach(id => callInclusions.set(id, included));
        selectedCallIds.clear();
        loadMetrics();
      } catch (error) {
        console.error('Error bulk setting inclusions:', error);
        alert('Failed to update inclusions');
      }
    }

    // Handle row selection
    function handleRowSelect(callId, checked) {
      if (checked) {
        selectedCallIds.add(callId);
      } else {
        selectedCallIds.delete(callId);
      }
      updateBulkActionsVisibility();
    }

    // Toggle select all rows
    function toggleSelectAll(checked) {
      const checkboxes = document.querySelectorAll('.row-select');
      checkboxes.forEach(cb => {
        cb.checked = checked;
        const callId = cb.getAttribute('data-call-id');
        if (checked) {
          selectedCallIds.add(callId);
        } else {
          selectedCallIds.delete(callId);
        }
      });
      updateBulkActionsVisibility();
    }

    // Update bulk actions bar visibility
    function updateBulkActionsVisibility() {
      const bulkActions = document.getElementById('bulkActions');
      const selectedCount = document.getElementById('selectedCount');
      if (bulkActions && selectedCount) {
        bulkActions.style.display = selectedCallIds.size > 0 ? 'flex' : 'none';
        selectedCount.textContent = selectedCallIds.size;
      }
    }

    // Toggle row action menu
    function toggleRowMenu(callId) {
      // Close all other menus first
      document.querySelectorAll('.row-action-menu').forEach(menu => {
        if (menu.id !== `menu-${callId}`) {
          menu.classList.remove('active');
        }
      });

      const menu = document.getElementById(`menu-${callId}`);
      if (menu) {
        menu.classList.toggle('active');
      }
    }

    // Close all row menus when clicking elsewhere
    document.addEventListener('click', (e) => {
      if (!e.target.closest('.row-actions')) {
        document.querySelectorAll('.row-action-menu').forEach(menu => {
          menu.classList.remove('active');
        });
      }
    });

    // Set lifecycle override for a call
    async function setLifecycleOverride(callId, prospectEmail, status) {
      try {
        const response = await fetch('/api/closing-rate/lifecycle-overrides', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            call_id: callId,
            prospect_email: prospectEmail,
            status: status
          })
        });

        if (!response.ok) {
          const data = await response.json();
          alert(data.error || 'Failed to set override');
          return;
        }

        const data = await response.json();
        lifecycleOverrides.set(callId, data.data);

        // Close the menu
        document.querySelectorAll('.row-action-menu').forEach(menu => menu.classList.remove('active'));

        loadMetrics();
      } catch (error) {
        console.error('Error setting override:', error);
        alert('Failed to set override');
      }
    }

    // Clear lifecycle override
    async function clearLifecycleOverride(callId) {
      try {
        const response = await fetch(`/api/closing-rate/lifecycle-overrides/${callId}`, {
          method: 'DELETE'
        });

        if (!response.ok) {
          const data = await response.json();
          alert(data.error || 'Failed to clear override');
          return;
        }

        lifecycleOverrides.delete(callId);

        // Close the menu
        document.querySelectorAll('.row-action-menu').forEach(menu => menu.classList.remove('active'));

        loadMetrics();
      } catch (error) {
        console.error('Error clearing override:', error);
        alert('Failed to clear override');
      }
    }

    // Format override status for display
    function formatOverrideStatus(status) {
      switch (status) {
        case 'signed_up': return 'Signed Up';
        case 'active': return 'Active';
        case 'churned': return 'Churned';
        case 'team': return 'Team';
        case 'no_close': return 'No Close';
        default: return status;
      }
    }

    // Get CSS class for override status
    function getOverrideStatusClass(status) {
      switch (status) {
        case 'signed_up': return 'signed-up';
        case 'active': return 'active';
        case 'churned': return 'churned';
        case 'team': return 'team';
        case 'no_close': return 'no-close';
        default: return 'not-matched';
      }
    }

    // ==================== MANUAL DFY CLOSES MODAL ====================

    // Open add close modal
    function openAddCloseModal() {
      const modal = document.getElementById('addCloseModal');
      if (modal) {
        modal.classList.add('active');
        // Set default date to today
        document.getElementById('closeDate').value = formatDateForInput(new Date());
        // Populate linked calls dropdown
        populateLinkedCallsDropdown();
      }
    }

    // Close add close modal
    function closeAddCloseModal() {
      const modal = document.getElementById('addCloseModal');
      if (modal) {
        modal.classList.remove('active');
        document.getElementById('addCloseForm').reset();
      }
    }

    // Populate linked calls dropdown with current calls
    function populateLinkedCallsDropdown() {
      const select = document.getElementById('closeLinkedCall');
      if (!select) return;

      // Clear existing options except the first
      select.innerHTML = '<option value="">-- None --</option>';

      // Add current calls as options
      currentCalls.forEach(call => {
        const option = document.createElement('option');
        option.value = call.id;
        option.textContent = `${call.title} (${formatDateDisplay(call.date, false)})`;
        select.appendChild(option);
      });
    }

    // Submit add close form
    async function submitAddClose() {
      const email = document.getElementById('closeEmail').value.trim();
      const company = document.getElementById('closeCompany').value.trim();
      const website = document.getElementById('closeWebsite').value.trim();
      const rep = document.getElementById('closeRep').value;
      const closeDate = document.getElementById('closeDate').value;
      const amount = document.getElementById('closeAmount').value;
      const notes = document.getElementById('closeNotes').value.trim();
      const linkedCallId = document.getElementById('closeLinkedCall').value;

      if (!email || !rep || !closeDate) {
        alert('Please fill in all required fields');
        return;
      }

      try {
        const response = await fetch('/api/closing-rate/manual-closes', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            email,
            company: company || null,
            website: website || null,
            rep,
            close_date: closeDate,
            amount: amount ? parseFloat(amount) : null,
            notes: notes || null,
            linked_call_id: linkedCallId || null
          })
        });

        if (!response.ok) {
          const data = await response.json();
          alert(data.error || 'Failed to add close');
          return;
        }

        const data = await response.json();
        manualCloses.push(data.close);
        closeAddCloseModal();
        loadMetrics();
      } catch (error) {
        console.error('Error adding close:', error);
        alert('Failed to add close');
      }
    }

    // Open manual closes list modal
    async function openManualClosesModal() {
      const modal = document.getElementById('manualClosesModal');
      const content = document.getElementById('manualClosesContent');

      if (modal) {
        modal.classList.add('active');
        content.innerHTML = '<div class="loading"><div class="loading-spinner"></div></div>';

        try {
          const response = await fetch('/api/closing-rate/manual-closes');
          if (!response.ok) throw new Error('Failed to load');

          const data = await response.json();
          manualCloses = data.closes || [];

          if (manualCloses.length === 0) {
            content.innerHTML = '<p style="text-align: center; color: var(--color-text-muted);">No manual closes recorded yet.</p>';
            return;
          }

          content.innerHTML = `
            <table class="calls-table" style="margin: 0;">
              <thead>
                <tr>
                  <th>Email</th>
                  <th>Company</th>
                  <th>Rep</th>
                  <th>Date</th>
                  <th>Amount</th>
                  <th></th>
                </tr>
              </thead>
              <tbody>
                ${manualCloses.map(c => `
                  <tr>
                    <td>${escapeHtml(c.email)}</td>
                    <td>${c.company ? escapeHtml(c.company) : '-'}</td>
                    <td><span class="rep-badge ${getRepClass(c.rep)}">${c.rep}</span></td>
                    <td>${formatDateDisplay(c.close_date)}</td>
                    <td>${c.amount ? '$' + c.amount.toFixed(2) : '-'}</td>
                    <td>
                      <button class="row-action-btn" onclick="deleteManualClose('${c.id}')" data-tooltip="Delete this manual close record">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                          <path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/>
                        </svg>
                      </button>
                    </td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          `;
        } catch (error) {
          console.error('Error loading manual closes:', error);
          content.innerHTML = '<p style="text-align: center; color: var(--color-danger);">Failed to load manual closes</p>';
        }
      }
    }

    // Close manual closes modal
    function closeManualClosesModal() {
      const modal = document.getElementById('manualClosesModal');
      if (modal) {
        modal.classList.remove('active');
      }
    }

    // Delete manual close
    async function deleteManualClose(id) {
      if (!confirm('Are you sure you want to delete this manual close?')) return;

      try {
        const response = await fetch(`/api/closing-rate/manual-closes/${id}`, {
          method: 'DELETE'
        });

        if (!response.ok) {
          const data = await response.json();
          alert(data.error || 'Failed to delete');
          return;
        }

        manualCloses = manualCloses.filter(c => c.id !== id);
        openManualClosesModal(); // Refresh the modal
        loadMetrics();
      } catch (error) {
        console.error('Error deleting manual close:', error);
        alert('Failed to delete');
      }
    }

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', () => {
      initUserMenu();
      setupUserMenu();

      // Try to restore filters from URL, otherwise use defaults
      if (!initFiltersFromURL()) {
        // Set initial date range based on default preset (last_3_months)
        handleDatePresetChange();
      }

      // Load initial metrics
      loadMetrics();
    });
  </script>
  <script src="js/analysis-status.js"></script>

  <!-- Proof Modal -->
  <div class="proof-modal-overlay" id="proofModal" onclick="closeProofModal(event)">
    <div class="proof-modal" onclick="event.stopPropagation()">
      <div class="proof-modal-header">
        <span class="proof-modal-title">Status Proof</span>
        <button class="proof-modal-close" onclick="closeProofModal(event)">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
          </svg>
        </button>
      </div>
      <div class="proof-modal-body" id="proofModalBody">
        <div class="proof-loading">Loading proof details...</div>
      </div>
    </div>
  </div>

  <script>
    // Show proof modal for a call
    async function showProof(callId) {
      const modal = document.getElementById('proofModal');
      const body = document.getElementById('proofModalBody');

      // Close row menu
      document.querySelectorAll('.row-action-menu').forEach(menu => menu.classList.remove('active'));

      // Show modal with loading state
      modal.classList.add('active');
      body.innerHTML = '<div class="proof-loading">Loading proof details...</div>';

      try {
        const response = await fetch(`/api/enrichment/call/${callId}/proof`);
        const result = await response.json();

        if (!result.success) {
          body.innerHTML = `<div class="proof-loading" style="color: var(--color-danger);">Error: ${result.error}</div>`;
          return;
        }

        const proof = result.data;
        body.innerHTML = renderProofContent(proof);
      } catch (error) {
        console.error('Error fetching proof:', error);
        body.innerHTML = `<div class="proof-loading" style="color: var(--color-danger);">Error loading proof details</div>`;
      }
    }

    // Render proof content
    function renderProofContent(proof) {
      let html = '';

      // Sources badges
      if (proof.sources && proof.sources.length > 0) {
        html += '<div class="proof-sources">';
        proof.sources.forEach(source => {
          html += `<span class="proof-source-badge ${source}">${source}</span>`;
        });
        html += '</div>';
      }

      // Summary
      html += `
        <div class="proof-summary">
          <div class="proof-summary-label">Summary</div>
          <div class="proof-summary-text">${escapeHtml(proof.summary)}</div>
        </div>
      `;

      // Prospect info
      html += `
        <div class="proof-section">
          <div class="proof-section-title">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
              <circle cx="12" cy="7" r="4"/>
            </svg>
            Prospect Info
          </div>
          <div class="proof-section-content">
            <div class="proof-field">
              <span class="proof-field-label">Email</span>
              <span class="proof-field-value">${proof.prospectEmail || 'Not found'}</span>
            </div>
            <div class="proof-field">
              <span class="proof-field-label">Call</span>
              <span class="proof-field-value">${escapeHtml(proof.callTitle || 'Untitled')}</span>
            </div>
          </div>
        </div>
      `;

      // Manual override details
      if (proof.details.manual) {
        html += `
          <div class="proof-section">
            <div class="proof-section-title">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/>
              </svg>
              Manual Override
            </div>
            <div class="proof-section-content">
              <div class="proof-field">
                <span class="proof-field-label">Status</span>
                <span class="proof-field-value">${proof.details.manual.status}</span>
              </div>
              <div class="proof-field">
                <span class="proof-field-label">Set by</span>
                <span class="proof-field-value">${proof.details.manual.createdBy || 'Admin'}</span>
              </div>
              <div class="proof-field">
                <span class="proof-field-label">Date</span>
                <span class="proof-field-value">${proof.details.manual.createdAt ? new Date(proof.details.manual.createdAt).toLocaleString() : '-'}</span>
              </div>
              ${proof.details.manual.notes ? `
              <div class="proof-field">
                <span class="proof-field-label">Notes</span>
                <span class="proof-field-value">${escapeHtml(proof.details.manual.notes)}</span>
              </div>
              ` : ''}
            </div>
          </div>
        `;
      }

      // Slack events
      if (proof.details.slack && proof.details.slack.events && proof.details.slack.events.length > 0) {
        html += `
          <div class="proof-section">
            <div class="proof-section-title">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M14.5 2c-0.828 0-1.5 0.672-1.5 1.5v6c0 0.828 0.672 1.5 1.5 1.5s1.5-0.672 1.5-1.5v-6c0-0.828-0.672-1.5-1.5-1.5z"/>
                <path d="M20.5 10h-6c-0.828 0-1.5-0.672-1.5-1.5s0.672-1.5 1.5-1.5h6c0.828 0 1.5 0.672 1.5 1.5s-0.672 1.5-1.5 1.5z"/>
                <path d="M9.5 13c0.828 0 1.5 0.672 1.5 1.5v6c0 0.828-0.672 1.5-1.5 1.5s-1.5-0.672-1.5-1.5v-6c0-0.828 0.672-1.5 1.5-1.5z"/>
                <path d="M3.5 14h6c0.828 0 1.5 0.672 1.5 1.5s-0.672 1.5-1.5 1.5h-6c-0.828 0-1.5-0.672-1.5-1.5s0.672-1.5 1.5-1.5z"/>
              </svg>
              Slack Events (${proof.details.slack.totalEvents} total)
            </div>
            <div class="proof-section-content" style="padding: 0;">
        `;

        proof.details.slack.events.forEach(event => {
          html += `
            <div class="proof-event">
              <div class="proof-event-header">
                <span class="proof-event-type">${event.type}</span>
                <span class="proof-event-date">${event.timestamp ? new Date(event.timestamp).toLocaleString() : '-'}</span>
              </div>
              ${event.channel ? `<div style="font-size: 11px; color: var(--color-text-muted);">Channel: ${event.channel}</div>` : ''}
              ${event.plan ? `<div style="font-size: 11px; color: var(--color-text-muted);">Plan: ${event.plan}</div>` : ''}
              ${event.cancellationReason ? `<div style="font-size: 11px; color: var(--color-text-muted);">Reason: ${event.cancellationReason}</div>` : ''}
              ${event.message ? `<div class="proof-event-message">${escapeHtml(event.message)}</div>` : ''}
            </div>
          `;
        });

        html += '</div></div>';
      }

      // Stripe data
      if (proof.details.stripe) {
        html += `
          <div class="proof-section">
            <div class="proof-section-title">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="1" y="4" width="22" height="16" rx="2" ry="2"/>
                <line x1="1" y1="10" x2="23" y2="10"/>
              </svg>
              Stripe Data
            </div>
            <div class="proof-section-content">
              <div class="proof-field">
                <span class="proof-field-label">Customer ID</span>
                <span class="proof-field-value">${proof.details.stripe.customerId || '-'}</span>
              </div>
              <div class="proof-field">
                <span class="proof-field-label">Name</span>
                <span class="proof-field-value">${proof.details.stripe.customerName || '-'}</span>
              </div>
              <div class="proof-field">
                <span class="proof-field-label">Email</span>
                <span class="proof-field-value">${proof.details.stripe.email || '-'}</span>
              </div>
              <div class="proof-field">
                <span class="proof-field-label">Status</span>
                <span class="proof-field-value">${proof.details.stripe.status || '-'}</span>
              </div>
              <div class="proof-field">
                <span class="proof-field-label">Signup Date</span>
                <span class="proof-field-value">${proof.details.stripe.signupDate ? new Date(proof.details.stripe.signupDate).toLocaleDateString() : '-'}</span>
              </div>
              ${proof.details.stripe.mrr ? `
              <div class="proof-field">
                <span class="proof-field-label">MRR</span>
                <span class="proof-field-value">$${proof.details.stripe.mrr}</span>
              </div>
              ` : ''}
            </div>
          </div>
        `;
      }

      // Calendly data
      if (proof.details.calendly) {
        html += `
          <div class="proof-section">
            <div class="proof-section-title">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                <line x1="16" y1="2" x2="16" y2="6"/>
                <line x1="8" y1="2" x2="8" y2="6"/>
                <line x1="3" y1="10" x2="21" y2="10"/>
              </svg>
              Calendly Data
            </div>
            <div class="proof-section-content">
              ${proof.details.calendly.eventName ? `
              <div class="proof-field">
                <span class="proof-field-label">Event</span>
                <span class="proof-field-value">${proof.details.calendly.eventName}</span>
              </div>
              ` : ''}
              ${proof.details.calendly.invitee?.name ? `
              <div class="proof-field">
                <span class="proof-field-label">Invitee</span>
                <span class="proof-field-value">${proof.details.calendly.invitee.name}</span>
              </div>
              ` : ''}
              ${proof.details.calendly.scheduledAt ? `
              <div class="proof-field">
                <span class="proof-field-label">Scheduled</span>
                <span class="proof-field-value">${new Date(proof.details.calendly.scheduledAt).toLocaleString()}</span>
              </div>
              ` : ''}
            </div>
          </div>
        `;
      }

      // No data message
      if (!proof.sources || proof.sources.length === 0) {
        html += `
          <div class="proof-section">
            <div class="proof-section-content" style="text-align: center; color: var(--color-text-muted);">
              No enrichment data available for this call.
            </div>
          </div>
        `;
      }

      return html;
    }

    // Close proof modal
    function closeProofModal(event) {
      if (event) {
        event.stopPropagation();
      }
      const modal = document.getElementById('proofModal');
      modal.classList.remove('active');
    }

    // Close modal on escape key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        closeProofModal();
      }
    });
  </script>
</body>
</html>
