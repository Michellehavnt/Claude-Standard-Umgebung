<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Account - Sales Call Analyzer</title>
  <link rel="stylesheet" href="design-system.css">
  <style>
    /* Page-specific styles */
    .account-section {
      background: var(--color-surface);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-lg);
      padding: var(--space-6);
      margin-bottom: var(--space-5);
    }

    .account-section-title {
      font-size: var(--text-lg);
      font-weight: 600;
      color: var(--color-text-primary);
      margin-bottom: var(--space-4);
      padding-bottom: var(--space-3);
      border-bottom: 1px solid var(--color-border-light);
    }

    .account-info-row {
      display: flex;
      align-items: center;
      padding: var(--space-3) 0;
      border-bottom: 1px solid var(--color-border-light);
    }

    .account-info-row:last-child {
      border-bottom: none;
    }

    .account-info-label {
      font-size: var(--text-sm);
      color: var(--color-text-secondary);
      width: 120px;
      flex-shrink: 0;
    }

    .account-info-value {
      font-size: var(--text-sm);
      color: var(--color-text-primary);
      flex: 1;
    }

    .account-role-badge {
      display: inline-flex;
      align-items: center;
      padding: 2px 10px;
      border-radius: 12px;
      font-size: var(--text-xs);
      font-weight: 500;
      text-transform: capitalize;
    }

    .account-role-badge.admin {
      background: rgba(139, 92, 246, 0.1);
      color: #8b5cf6;
    }

    .account-role-badge.rep,
    .account-role-badge.user {
      background: rgba(59, 130, 246, 0.1);
      color: #3b82f6;
    }

    /* Form styling */
    .form-group {
      margin-bottom: var(--space-4);
    }

    .form-group:last-child {
      margin-bottom: 0;
    }

    .form-label {
      display: block;
      font-size: var(--text-sm);
      font-weight: 500;
      color: var(--color-text-secondary);
      margin-bottom: var(--space-2);
    }

    .form-input {
      width: 100%;
      max-width: 320px;
      padding: var(--space-2) var(--space-3);
      font-size: var(--text-sm);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-md);
      background: var(--color-bg);
      color: var(--color-text-primary);
      transition: border-color 0.15s, box-shadow 0.15s;
    }

    .form-input:focus {
      outline: none;
      border-color: var(--color-accent);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .form-hint {
      font-size: var(--text-xs);
      color: var(--color-text-muted);
      margin-top: var(--space-1);
    }

    .form-actions {
      margin-top: var(--space-5);
      padding-top: var(--space-4);
      border-top: 1px solid var(--color-border-light);
    }

    /* Alert styling */
    .account-alert {
      padding: var(--space-3) var(--space-4);
      border-radius: var(--radius-md);
      font-size: var(--text-sm);
      margin-bottom: var(--space-4);
      display: none;
    }

    .account-alert.show {
      display: block;
    }

    .account-alert.success {
      background: rgba(34, 197, 94, 0.1);
      border: 1px solid rgba(34, 197, 94, 0.2);
      color: #16a34a;
    }

    .account-alert.error {
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid rgba(239, 68, 68, 0.2);
      color: #dc2626;
    }

    /* Spinner */
    .btn-spinner {
      display: inline-block;
      width: 14px;
      height: 14px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 0.8s linear infinite;
      margin-right: var(--space-2);
      vertical-align: middle;
    }

    .btn-spinner.hidden {
      display: none;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <header class="ds-header">
    <div class="ds-header-inner">
      <a href="/admin/" class="ds-header-logo">
        <img src="/admin/logo.svg" alt="AffiliateFinder">
      </a>
      <div class="ds-header-divider"></div>
      <nav class="ds-header-nav">
        <a href="/admin/">Calls</a>
        <a href="/admin/copy.html">Copy</a>
        <a href="/admin/phil.html">DFY</a>
        <a href="/admin/founder.html">Closing Rate</a>
        <a href="/admin/settings.html">Settings</a>
      </nav>
      <div class="ds-header-user">
        <button class="ds-user-button" id="user-menu-button" aria-expanded="false" aria-haspopup="true">
          <div class="ds-user-avatar" id="user-avatar">--</div>
          <div class="ds-user-info">
            <span class="ds-user-name" id="user-display-name">Loading...</span>
            <span class="ds-user-role" id="user-display-role">-</span>
          </div>
          <svg class="ds-user-chevron" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="6 9 12 15 18 9"></polyline>
          </svg>
        </button>
        <div class="ds-user-dropdown" id="user-dropdown">
          <div class="ds-dropdown-header">
            <div class="ds-dropdown-email" id="user-email">-</div>
            <span class="ds-dropdown-role user" id="user-role-badge">User</span>
          </div>

          <div class="ds-dropdown-section">
            <a href="/admin/account.html" class="ds-dropdown-item">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                <circle cx="12" cy="7" r="4"></circle>
              </svg>
              Account
            </a>
            <a href="/admin/settings.html" class="ds-dropdown-item">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="3"></circle>
                <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
              </svg>
              Settings
            </a>
          </div>

          <div class="ds-dropdown-divider ds-admin-only" style="display: none;"></div>

          <div class="ds-dropdown-section ds-admin-only" style="display: none;">
            <div class="ds-dropdown-label">Admin</div>
            <a href="/admin/access-requests.html" class="ds-dropdown-item">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                <circle cx="8.5" cy="7" r="4"></circle>
                <line x1="20" y1="8" x2="20" y2="14"></line>
                <line x1="23" y1="11" x2="17" y2="11"></line>
              </svg>
              Access Requests
            </a>
            <a href="/admin/users.html" class="ds-dropdown-item">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                <circle cx="9" cy="7" r="4"></circle>
                <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
              </svg>
              User Management
            </a>
          </div>

          <div class="ds-dropdown-divider"></div>

          <div class="ds-dropdown-section">
            <button class="ds-dropdown-item danger" id="logout-button">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                <polyline points="16 17 21 12 16 7"></polyline>
                <line x1="21" y1="12" x2="9" y2="12"></line>
              </svg>
              Sign Out
            </button>
          </div>
        </div>
      </div>
    </div>
  </header>

  <main class="ds-main">
    <div class="ds-page-header">
      <h1 class="ds-page-title">Account</h1>
      <p class="ds-page-subtitle">Manage your account settings</p>
    </div>

    <!-- Account Information -->
    <div class="account-section">
      <h2 class="account-section-title">Account Information</h2>
      <div class="account-info-row">
        <span class="account-info-label">Email</span>
        <span class="account-info-value" id="account-email">Loading...</span>
      </div>
      <div class="account-info-row">
        <span class="account-info-label">Name</span>
        <span class="account-info-value" id="account-name">Loading...</span>
      </div>
      <div class="account-info-row">
        <span class="account-info-label">Role</span>
        <span class="account-info-value">
          <span class="account-role-badge" id="account-role">user</span>
        </span>
      </div>
      <div class="account-info-row">
        <span class="account-info-label">Member since</span>
        <span class="account-info-value" id="account-created">Loading...</span>
      </div>
    </div>

    <!-- Change Password -->
    <div class="account-section">
      <h2 class="account-section-title">Change Password</h2>

      <div id="password-alert" class="account-alert"></div>

      <form id="password-form" onsubmit="handlePasswordChange(event)">
        <div class="form-group">
          <label class="form-label" for="current-password">Current Password</label>
          <input type="password" id="current-password" class="form-input" required autocomplete="current-password">
        </div>

        <div class="form-group">
          <label class="form-label" for="new-password">New Password</label>
          <input type="password" id="new-password" class="form-input" required autocomplete="new-password" minlength="12">
          <p class="form-hint">Minimum 12 characters</p>
        </div>

        <div class="form-group">
          <label class="form-label" for="confirm-password">Confirm New Password</label>
          <input type="password" id="confirm-password" class="form-input" required autocomplete="new-password" minlength="12">
        </div>

        <div class="form-actions">
          <button type="submit" class="ds-btn ds-btn-primary" id="change-password-btn">
            <span class="btn-spinner hidden" id="password-spinner"></span>
            Change Password
          </button>
        </div>
      </form>
    </div>
  </main>

  <script>
    let currentUser = null;

    // User Menu
    async function initUserMenu() {
      try {
        const response = await fetch('/api/auth/me', { credentials: 'include' });
        if (!response.ok) {
          window.location.href = '/admin/login.html';
          return;
        }
        const data = await response.json();
        currentUser = data.user;

        // Update avatar with initials
        const avatar = document.getElementById('user-avatar');
        if (avatar) {
          const initials = (currentUser.name || currentUser.email || '?')
            .split(/[\s@]+/)
            .map(part => part[0])
            .join('')
            .substring(0, 2)
            .toUpperCase();
          avatar.textContent = initials;
        }

        // Update user display name in header button
        const displayName = document.getElementById('user-display-name');
        if (displayName) {
          displayName.textContent = currentUser.name || currentUser.email.split('@')[0];
        }

        // Update user display role in header button
        const displayRole = document.getElementById('user-display-role');
        if (displayRole) {
          displayRole.textContent = currentUser.role === 'admin' ? 'Admin' : 'User';
        }

        // Update email in dropdown
        const emailEl = document.getElementById('user-email');
        if (emailEl) emailEl.textContent = currentUser.email;

        // Update role badge in dropdown
        const roleBadge = document.getElementById('user-role-badge');
        if (roleBadge) {
          roleBadge.textContent = currentUser.role === 'admin' ? 'Admin' : 'User';
          roleBadge.className = 'ds-dropdown-role ' + (currentUser.role === 'admin' ? 'admin' : 'user');
        }

        if (currentUser.role === 'admin') {
          document.querySelectorAll('.ds-admin-only').forEach(el => el.style.display = '');
        }

        // Update account info
        updateAccountInfo(currentUser);
      } catch (err) {
        console.error('Failed to load user info:', err);
      }
    }

    function setupUserMenu() {
      const button = document.getElementById('user-menu-button');
      const dropdown = document.getElementById('user-dropdown');
      const logoutBtn = document.getElementById('logout-button');

      if (button && dropdown) {
        button.addEventListener('click', (e) => {
          e.stopPropagation();
          const isOpen = dropdown.classList.contains('open');
          dropdown.classList.toggle('open', !isOpen);
          button.setAttribute('aria-expanded', !isOpen);
        });

        document.addEventListener('click', (e) => {
          if (!e.target.closest('.ds-header-user')) {
            dropdown.classList.remove('open');
            button.setAttribute('aria-expanded', 'false');
          }
        });
      }

      if (logoutBtn) {
        logoutBtn.addEventListener('click', async () => {
          try {
            await fetch('/api/auth/logout', { method: 'POST', credentials: 'include' });
          } catch (err) {
            console.error('Logout error:', err);
          }
          window.location.href = '/admin/login.html';
        });
      }
    }

    function updateAccountInfo(user) {
      document.getElementById('account-email').textContent = user.email || '-';
      document.getElementById('account-name').textContent = user.name || '-';

      const roleEl = document.getElementById('account-role');
      roleEl.textContent = user.role || 'user';
      roleEl.className = 'account-role-badge ' + (user.role || 'user');

      if (user.created_at) {
        const date = new Date(user.created_at);
        document.getElementById('account-created').textContent = date.toLocaleDateString('en-US', {
          month: 'long',
          day: 'numeric',
          year: 'numeric'
        });
      } else {
        document.getElementById('account-created').textContent = '-';
      }
    }

    function showAlert(message, type) {
      const alert = document.getElementById('password-alert');
      alert.textContent = message;
      alert.className = 'account-alert show ' + type;

      if (type === 'success') {
        setTimeout(() => {
          alert.classList.remove('show');
        }, 5000);
      }
    }

    function hideAlert() {
      const alert = document.getElementById('password-alert');
      alert.classList.remove('show');
    }

    async function handlePasswordChange(event) {
      event.preventDefault();
      hideAlert();

      const currentPassword = document.getElementById('current-password').value;
      const newPassword = document.getElementById('new-password').value;
      const confirmPassword = document.getElementById('confirm-password').value;

      // Validate passwords match
      if (newPassword !== confirmPassword) {
        showAlert('New passwords do not match', 'error');
        return;
      }

      // Validate minimum length
      if (newPassword.length < 12) {
        showAlert('Password must be at least 12 characters', 'error');
        return;
      }

      const btn = document.getElementById('change-password-btn');
      const spinner = document.getElementById('password-spinner');

      btn.disabled = true;
      spinner.classList.remove('hidden');

      try {
        const response = await fetch('/api/auth/change-password', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ currentPassword, newPassword })
        });

        const data = await response.json();

        if (data.success) {
          showAlert('Password changed successfully', 'success');
          document.getElementById('password-form').reset();
        } else {
          showAlert(data.message || 'Failed to change password', 'error');
        }
      } catch (err) {
        console.error('Password change error:', err);
        showAlert('An error occurred. Please try again.', 'error');
      } finally {
        btn.disabled = false;
        spinner.classList.add('hidden');
      }
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      initUserMenu();
      setupUserMenu();
    });
  </script>
</body>
</html>
