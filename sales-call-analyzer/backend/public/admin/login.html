<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Internal Brain - AffiliateFinder</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      background: linear-gradient(135deg, #073b55 0%, #0a4d6e 50%, #067280 100%);
      color: #333;
      line-height: 1.6;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .login-container {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 40px 20px;
    }

    .login-card {
      background: white;
      border-radius: 16px;
      box-shadow: 0 25px 50px -12px rgba(0,0,0,0.35), 0 12px 24px -8px rgba(0,0,0,0.2);
      width: 100%;
      max-width: 440px;
      overflow: hidden;
    }

    .login-header {
      background: #073b55;
      color: white;
      padding: 32px 30px;
      text-align: left;
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .login-header .logo-container {
      flex-shrink: 0;
    }

    .login-header .logo-container img {
      height: 32px;
      width: auto;
    }

    .login-header .header-text {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .login-header h1 {
      font-size: 20px;
      font-weight: 600;
      margin: 0;
      letter-spacing: -0.02em;
    }

    .login-header p {
      opacity: 0.85;
      font-size: 13px;
      margin: 0;
    }

    .login-body {
      padding: 30px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      font-size: 14px;
      font-weight: 500;
      color: #374151;
      margin-bottom: 6px;
    }

    .form-group input {
      width: 100%;
      padding: 12px 14px;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      font-size: 14px;
      transition: border-color 0.2s, box-shadow 0.2s;
    }

    .form-group input:focus {
      outline: none;
      border-color: #067280;
      box-shadow: 0 0 0 3px rgba(6, 114, 128, 0.15);
    }

    .form-group input::placeholder {
      color: #9ca3af;
    }

    .form-group input:disabled {
      background: #f3f4f6;
      cursor: not-allowed;
    }

    .password-wrapper {
      position: relative;
    }

    .password-toggle {
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      background: none;
      border: none;
      color: #6b7280;
      cursor: pointer;
      padding: 4px;
      font-size: 13px;
    }

    .password-toggle:hover {
      color: #374151;
    }

    .password-requirements {
      font-size: 12px;
      color: #6b7280;
      margin-top: 6px;
    }

    .btn {
      width: 100%;
      background: linear-gradient(135deg, #073b55 0%, #067280 100%);
      color: white;
      border: none;
      padding: 14px 24px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.2s ease;
      letter-spacing: 0.01em;
    }

    .btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(7, 59, 85, 0.3);
    }

    .btn:disabled {
      background: #9ca3af;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .btn-secondary {
      background: #6b7280;
    }

    .btn-secondary:hover {
      background: #4b5563;
    }

    .btn-outline {
      background: white;
      color: #073b55;
      border: 1px solid #073b55;
    }

    .btn-outline:hover {
      background: #f0f7fa;
    }

    .alert {
      padding: 14px 16px;
      border-radius: 6px;
      font-size: 14px;
      margin-bottom: 20px;
    }

    .alert-success {
      background: #dcfce7;
      color: #166534;
      border: 1px solid #bbf7d0;
    }

    .alert-error {
      background: #fef2f2;
      color: #991b1b;
      border: 1px solid #fecaca;
    }

    .alert-info {
      background: #eff6ff;
      color: #1e40af;
      border: 1px solid #bfdbfe;
    }

    .alert-warning {
      background: #fffbeb;
      color: #92400e;
      border: 1px solid #fde68a;
    }

    .hidden {
      display: none;
    }

    /* Tab navigation */
    .tabs {
      display: flex;
      border-bottom: 1px solid #e5e7eb;
      margin-bottom: 24px;
    }

    .tab {
      flex: 1;
      padding: 12px 16px;
      text-align: center;
      font-size: 14px;
      font-weight: 500;
      color: #6b7280;
      background: none;
      border: none;
      cursor: pointer;
      border-bottom: 2px solid transparent;
      margin-bottom: -1px;
      transition: color 0.2s, border-color 0.2s;
    }

    .tab:hover {
      color: #374151;
    }

    .tab.active {
      color: #067280;
      border-bottom-color: #067280;
    }

    /* Status card styles */
    .status-card {
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      padding: 20px;
      text-align: center;
      margin-bottom: 20px;
    }

    .status-card.pending {
      background: #fffbeb;
      border-color: #fde68a;
    }

    .status-card.denied {
      background: #fef2f2;
      border-color: #fecaca;
    }

    .status-icon {
      width: 48px;
      height: 48px;
      margin: 0 auto 12px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
    }

    .status-icon.pending {
      background: #fef3c7;
      color: #d97706;
    }

    .status-icon.denied {
      background: #fee2e2;
      color: #dc2626;
    }

    .status-icon.approved {
      background: #dcfce7;
      color: #16a34a;
    }

    .status-card h3 {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 8px;
      color: #1f2937;
    }

    .status-card p {
      font-size: 13px;
      color: #6b7280;
      margin-bottom: 0;
    }

    .status-card .timestamp {
      font-size: 12px;
      color: #9ca3af;
      margin-top: 8px;
    }

    /* Setup form styles */
    .setup-section {
      border-top: 1px solid #e5e7eb;
      padding-top: 20px;
      margin-top: 20px;
    }

    .setup-section h3 {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 12px;
      color: #374151;
    }

    .setup-section p {
      font-size: 13px;
      color: #6b7280;
      margin-bottom: 16px;
    }

    /* Domain hint */
    .domain-hint {
      font-size: 12px;
      color: #6b7280;
      margin-top: 6px;
    }

    /* Back link */
    .back-link {
      display: block;
      text-align: center;
      margin-top: 16px;
      color: #067280;
      font-size: 13px;
      text-decoration: none;
    }

    .back-link:hover {
      text-decoration: underline;
    }

    /* Card footer */
    .card-footer {
      text-align: center;
      padding: 16px 30px 20px;
      border-top: 1px solid #e5e7eb;
      margin-top: 8px;
    }

    .card-footer p {
      color: #9ca3af;
      font-size: 11px;
      margin: 0;
    }

    footer {
      text-align: center;
      padding: 20px;
      color: rgba(255,255,255,0.6);
      font-size: 12px;
    }
  </style>
</head>
<body>
  <div class="login-container">
    <div class="login-card">
      <div class="login-header">
        <div class="logo-container">
          <img src="logo.svg" alt="AffiliateFinder">
        </div>
        <div class="header-text">
          <h1>Internal Brain</h1>
          <p>Sign in to access the dashboard</p>
        </div>
      </div>

      <div class="login-body">
        <!-- Alert messages -->
        <div id="alertBox" class="alert hidden"></div>

        <!-- Main auth view with tabs -->
        <div id="authView">
          <!-- Tab navigation -->
          <div class="tabs">
            <button type="button" class="tab active" id="loginTab" data-tab="login">Sign In</button>
            <button type="button" class="tab" id="requestTab" data-tab="request">Request Access</button>
          </div>

          <!-- Login form -->
          <form id="loginForm">
            <div class="form-group">
              <label for="loginEmail">Email Address</label>
              <input
                type="email"
                id="loginEmail"
                name="email"
                placeholder="you@affiliatefinder.ai"
                required
                autocomplete="email"
              >
              <p class="domain-hint">Only @affiliatefinder.ai email addresses are allowed</p>
            </div>
            <div class="form-group">
              <label for="loginPassword">Password</label>
              <div class="password-wrapper">
                <input
                  type="password"
                  id="loginPassword"
                  name="password"
                  placeholder="Enter your password"
                  required
                  autocomplete="current-password"
                >
                <button type="button" class="password-toggle" onclick="togglePassword('loginPassword', this)">Show</button>
              </div>
            </div>
            <button type="submit" class="btn" id="loginBtn">
              Sign In
            </button>
          </form>

          <!-- Request Access form -->
          <form id="requestForm" class="hidden">
            <div class="form-group">
              <label for="requestEmail">Email Address</label>
              <input
                type="email"
                id="requestEmail"
                name="email"
                placeholder="you@affiliatefinder.ai"
                required
                autocomplete="email"
              >
              <p class="domain-hint">Only @affiliatefinder.ai email addresses are allowed</p>
            </div>
            <div class="form-group">
              <label for="requestName">Your Name</label>
              <input
                type="text"
                id="requestName"
                name="name"
                placeholder="Your full name"
                autocomplete="name"
              >
            </div>
            <div class="form-group">
              <label for="requestPassword">Create Password</label>
              <div class="password-wrapper">
                <input
                  type="password"
                  id="requestPassword"
                  name="password"
                  placeholder="Create a secure password"
                  required
                  autocomplete="new-password"
                  minlength="12"
                >
                <button type="button" class="password-toggle" onclick="togglePassword('requestPassword', this)">Show</button>
              </div>
              <p class="password-requirements">Minimum 12 characters</p>
            </div>
            <div class="form-group">
              <label for="confirmPassword">Confirm Password</label>
              <div class="password-wrapper">
                <input
                  type="password"
                  id="confirmPassword"
                  name="confirmPassword"
                  placeholder="Confirm your password"
                  required
                  autocomplete="new-password"
                  minlength="12"
                >
                <button type="button" class="password-toggle" onclick="togglePassword('confirmPassword', this)">Show</button>
              </div>
            </div>
            <button type="submit" class="btn" id="requestBtn">
              Request Access
            </button>
          </form>

          <!-- Setup section (shown when no admin exists) -->
          <div id="setupSection" class="setup-section hidden">
            <h3>First Time Setup</h3>
            <p>No administrator has been configured yet. Create the first admin account to get started.</p>
            <form id="setupForm">
              <div class="form-group">
                <label for="setupEmail">Admin Email</label>
                <input
                  type="email"
                  id="setupEmail"
                  name="setupEmail"
                  placeholder="admin@affiliatefinder.ai"
                  required
                >
              </div>
              <div class="form-group">
                <label for="setupName">Admin Name</label>
                <input
                  type="text"
                  id="setupName"
                  name="setupName"
                  placeholder="John Smith"
                  required
                >
              </div>
              <div class="form-group">
                <label for="setupPassword">Admin Password</label>
                <div class="password-wrapper">
                  <input
                    type="password"
                    id="setupPassword"
                    name="setupPassword"
                    placeholder="Create a secure password"
                    required
                    minlength="12"
                  >
                  <button type="button" class="password-toggle" onclick="togglePassword('setupPassword', this)">Show</button>
                </div>
                <p class="password-requirements">Minimum 12 characters</p>
              </div>
              <button type="submit" class="btn" id="setupBtn">
                Create Admin Account
              </button>
            </form>
          </div>
        </div>

        <!-- Pending approval view -->
        <div id="pendingView" class="hidden">
          <div class="status-card pending">
            <div class="status-icon pending">&#9203;</div>
            <h3>Access Request Pending</h3>
            <p>Your access request is awaiting admin approval.</p>
            <p class="timestamp" id="pendingTimestamp"></p>
          </div>
          <p style="font-size: 13px; color: #6b7280; text-align: center; margin-bottom: 16px;">
            An administrator will review your request shortly. Once approved, you can sign in with your email and password.
          </p>
          <a href="#" class="back-link" id="backToLogin">Back to Sign In</a>
        </div>

        <!-- Denied view -->
        <div id="deniedView" class="hidden">
          <div class="status-card denied">
            <div class="status-icon denied">&#10005;</div>
            <h3>Access Denied</h3>
            <p>Your access request was not approved.</p>
          </div>
          <p style="font-size: 13px; color: #6b7280; text-align: center; margin-bottom: 16px;">
            If you believe this is an error, please contact an administrator.
          </p>
          <a href="#" class="back-link" id="backFromDenied">Back to Sign In</a>
        </div>

        <!-- Success view (shown after successful login) -->
        <div id="successView" class="hidden">
          <div class="alert alert-success">
            <strong>Login successful!</strong> Redirecting to dashboard...
          </div>
        </div>
      </div>

      <div class="card-footer">
        <p>Powered by Michelle - Made for the best team in the word</p>
      </div>
    </div>
  </div>

  <footer>
    Internal Brain - AffiliateFinder.ai
  </footer>

  <script>
    // DOM elements
    const alertBox = document.getElementById('alertBox');
    const authView = document.getElementById('authView');
    const pendingView = document.getElementById('pendingView');
    const deniedView = document.getElementById('deniedView');
    const successView = document.getElementById('successView');
    const loginForm = document.getElementById('loginForm');
    const requestForm = document.getElementById('requestForm');
    const setupSection = document.getElementById('setupSection');
    const setupForm = document.getElementById('setupForm');
    const loginBtn = document.getElementById('loginBtn');
    const requestBtn = document.getElementById('requestBtn');
    const setupBtn = document.getElementById('setupBtn');
    const pendingTimestamp = document.getElementById('pendingTimestamp');
    const backToLogin = document.getElementById('backToLogin');
    const backFromDenied = document.getElementById('backFromDenied');
    const loginTab = document.getElementById('loginTab');
    const requestTab = document.getElementById('requestTab');

    // Toggle password visibility
    function togglePassword(inputId, button) {
      const input = document.getElementById(inputId);
      if (input.type === 'password') {
        input.type = 'text';
        button.textContent = 'Hide';
      } else {
        input.type = 'password';
        button.textContent = 'Show';
      }
    }

    // Show alert message
    function showAlert(message, type = 'info') {
      alertBox.textContent = message;
      alertBox.className = `alert alert-${type}`;
      alertBox.classList.remove('hidden');
    }

    // Hide alert
    function hideAlert() {
      alertBox.classList.add('hidden');
    }

    // Show a specific view
    function showView(viewName) {
      authView.classList.add('hidden');
      pendingView.classList.add('hidden');
      deniedView.classList.add('hidden');
      successView.classList.add('hidden');

      switch (viewName) {
        case 'auth':
          authView.classList.remove('hidden');
          break;
        case 'pending':
          pendingView.classList.remove('hidden');
          break;
        case 'denied':
          deniedView.classList.remove('hidden');
          break;
        case 'success':
          successView.classList.remove('hidden');
          break;
      }
    }

    // Switch between login and request tabs
    function switchTab(tabName) {
      hideAlert();

      if (tabName === 'login') {
        loginTab.classList.add('active');
        requestTab.classList.remove('active');
        loginForm.classList.remove('hidden');
        requestForm.classList.add('hidden');
      } else {
        loginTab.classList.remove('active');
        requestTab.classList.add('active');
        loginForm.classList.add('hidden');
        requestForm.classList.remove('hidden');
      }
    }

    // Tab click handlers
    loginTab.addEventListener('click', () => switchTab('login'));
    requestTab.addEventListener('click', () => switchTab('request'));

    // Format date for display
    function formatDate(dateString) {
      const date = new Date(dateString);
      return date.toLocaleDateString('en-US', {
        month: 'short',
        day: 'numeric',
        year: 'numeric',
        hour: 'numeric',
        minute: '2-digit'
      });
    }

    // Check if user is already logged in
    async function checkAuth() {
      try {
        const response = await fetch('/api/auth/me', {
          credentials: 'include'
        });

        if (response.ok) {
          // Already logged in, redirect to MRR dashboard
          window.location.href = '/admin/mrr.html';
          return true;
        }
      } catch (error) {
        // Not logged in, continue
      }
      return false;
    }

    // Check if initial setup is needed
    async function checkSetupStatus() {
      try {
        const response = await fetch('/api/auth/setup-status');
        const data = await response.json();

        if (data.success && data.needsSetup) {
          setupSection.classList.remove('hidden');
          // Hide tab navigation and forms when setup is needed
          document.querySelector('.tabs').classList.add('hidden');
          loginForm.classList.add('hidden');
          requestForm.classList.add('hidden');
        }
      } catch (error) {
        console.error('Error checking setup status:', error);
      }
    }

    // Handle login form submission
    loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      hideAlert();

      const email = document.getElementById('loginEmail').value;
      const password = document.getElementById('loginPassword').value;

      loginBtn.disabled = true;
      loginBtn.textContent = 'Signing in...';

      try {
        const response = await fetch('/api/auth/login-password', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          credentials: 'include',
          body: JSON.stringify({ email, password })
        });

        const data = await response.json();

        if (data.success) {
          showView('success');
          // Redirect to MRR dashboard after a short delay
          setTimeout(() => {
            window.location.href = '/admin/mrr.html';
          }, 1000);
        } else if (data.error === 'ACCESS_PENDING') {
          // User's access request is still pending
          if (data.requestedAt) {
            pendingTimestamp.textContent = `Requested: ${formatDate(data.requestedAt)}`;
          }
          showView('pending');
        } else if (data.error === 'ACCESS_DENIED') {
          showView('denied');
        } else if (data.error === 'INVALID_DOMAIN') {
          showAlert('Only @affiliatefinder.ai email addresses are allowed.', 'error');
        } else if (data.error === 'USER_DEACTIVATED') {
          showAlert('Your account has been deactivated. Please contact an administrator.', 'error');
        } else {
          // Generic error for invalid credentials (security: don't reveal if email exists)
          showAlert(data.message || 'Invalid email or password.', 'error');
        }
      } catch (error) {
        console.error('Login error:', error);
        showAlert('An error occurred. Please try again.', 'error');
      } finally {
        loginBtn.disabled = false;
        loginBtn.textContent = 'Sign In';
      }
    });

    // Handle request access form submission
    requestForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      hideAlert();

      const email = document.getElementById('requestEmail').value;
      const name = document.getElementById('requestName').value;
      const password = document.getElementById('requestPassword').value;
      const confirmPassword = document.getElementById('confirmPassword').value;

      // Validate passwords match
      if (password !== confirmPassword) {
        showAlert('Passwords do not match.', 'error');
        return;
      }

      // Validate password length
      if (password.length < 12) {
        showAlert('Password must be at least 12 characters.', 'error');
        return;
      }

      requestBtn.disabled = true;
      requestBtn.textContent = 'Submitting...';

      try {
        const response = await fetch('/api/auth/request-access', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ email, password, name: name || undefined })
        });

        const data = await response.json();

        if (data.success && data.status === 'pending') {
          // Access request submitted
          if (data.requestedAt) {
            pendingTimestamp.textContent = `Requested: ${formatDate(data.requestedAt)}`;
          }
          showView('pending');
        } else if (data.status === 'approved') {
          // User already exists and is approved - redirect to login
          showAlert('An account with this email already exists. Please sign in.', 'info');
          switchTab('login');
          document.getElementById('loginEmail').value = email;
        } else if (data.status === 'invalid_domain') {
          showAlert(data.message || 'Only @affiliatefinder.ai email addresses are allowed.', 'error');
        } else if (data.status === 'deactivated') {
          showAlert(data.message || 'Your account has been deactivated. Please contact an administrator.', 'error');
        } else if (data.error === 'INVALID_PASSWORD') {
          showAlert(data.message || 'Password must be at least 12 characters.', 'error');
        } else {
          showAlert(data.message || 'An error occurred. Please try again.', 'error');
        }
      } catch (error) {
        console.error('Request access error:', error);
        showAlert('An error occurred. Please try again.', 'error');
      } finally {
        requestBtn.disabled = false;
        requestBtn.textContent = 'Request Access';
      }
    });

    // Handle setup form submission
    setupForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      hideAlert();

      const email = document.getElementById('setupEmail').value;
      const name = document.getElementById('setupName').value;
      const password = document.getElementById('setupPassword').value;

      // Validate password length
      if (password.length < 12) {
        showAlert('Password must be at least 12 characters.', 'error');
        return;
      }

      setupBtn.disabled = true;
      setupBtn.textContent = 'Creating...';

      try {
        const response = await fetch('/api/auth/setup', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ email, name, password })
        });

        const data = await response.json();

        if (data.success) {
          showAlert('Admin account created! Please sign in.', 'success');
          setupSection.classList.add('hidden');
          document.querySelector('.tabs').classList.remove('hidden');
          loginForm.classList.remove('hidden');
          document.getElementById('loginEmail').value = email;
        } else {
          showAlert(data.message || 'Failed to create admin account', 'error');
        }
      } catch (error) {
        console.error('Setup error:', error);
        showAlert('An error occurred. Please try again.', 'error');
      } finally {
        setupBtn.disabled = false;
        setupBtn.textContent = 'Create Admin Account';
      }
    });

    // Back to login link handlers
    backToLogin.addEventListener('click', (e) => {
      e.preventDefault();
      hideAlert();
      showView('auth');
      switchTab('login');
    });

    backFromDenied.addEventListener('click', (e) => {
      e.preventDefault();
      hideAlert();
      showView('auth');
      switchTab('login');
    });

    // Initialize
    async function init() {
      // Check if already logged in
      const isLoggedIn = await checkAuth();
      if (isLoggedIn) return;

      // Check if setup is needed
      await checkSetupStatus();
    }

    // Run initialization
    init();
  </script>
</body>
</html>
