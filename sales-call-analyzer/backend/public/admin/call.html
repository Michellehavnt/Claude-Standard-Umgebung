<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Call Detail - Sales Call Analyzer</title>
  <link rel="stylesheet" href="design-system.css?v=2">
  <style>
    .back-link {
      color: rgba(255, 255, 255, 0.7);
      text-decoration: none;
      font-size: var(--text-sm);
      display: inline-flex;
      align-items: center;
      gap: var(--space-1);
      margin-bottom: var(--space-2);
    }

    .back-link:hover {
      color: var(--color-text-inverse);
      text-decoration: none;
    }

    .call-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      flex-wrap: wrap;
      gap: var(--space-4);
    }

    .call-meta {
      display: flex;
      gap: var(--space-5);
      flex-wrap: wrap;
      font-size: var(--text-sm);
      color: var(--color-text-secondary);
      margin-top: var(--space-3);
    }

    .call-meta-item {
      display: flex;
      align-items: center;
      gap: var(--space-2);
    }

    .call-meta-label {
      font-weight: var(--weight-medium);
      color: var(--color-text-muted);
    }

    /* Rep name badge styles */
    .rep-badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: var(--text-xs);
      font-weight: 500;
    }

    .rep-badge.phil {
      background: rgba(251, 191, 36, 0.15);
      color: #b45309;
    }

    .rep-badge.jamie {
      background: rgba(236, 72, 153, 0.15);
      color: #be185d;
    }

    .rep-badge.both {
      background: rgba(59, 130, 246, 0.15);
      color: #2563eb;
    }

    .rep-badge.unknown {
      background: var(--color-surface-alt);
      color: var(--color-text-secondary);
    }

    .score-badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 36px;
      height: 28px;
      padding: 0 var(--space-3);
      border-radius: var(--radius-md);
      font-weight: var(--weight-semibold);
      font-size: var(--text-sm);
    }

    .score-high { background: var(--color-success-bg); color: var(--color-success); }
    .score-medium { background: var(--color-warning-bg); color: var(--color-warning); }
    .score-low { background: var(--color-danger-bg); color: var(--color-danger); }

    /* Stripe Panel */
    .stripe-panel {
      border-left: 3px solid #635bff;
    }

    .stripe-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: var(--space-3);
    }

    .stripe-item {
      background: var(--color-surface-alt);
      padding: var(--space-3);
      border-radius: var(--radius-md);
      text-align: center;
    }

    .stripe-item-label {
      font-size: var(--text-xs);
      color: var(--color-text-muted);
      text-transform: uppercase;
      margin-bottom: var(--space-1);
    }

    .stripe-item-value {
      font-size: var(--text-base);
      font-weight: var(--weight-semibold);
      color: var(--color-text-primary);
    }

    .stripe-unmatched {
      text-align: center;
      padding: var(--space-5);
      color: var(--color-text-muted);
    }

    /* Analysis Status */
    .analysis-status {
      display: flex;
      align-items: center;
      gap: var(--space-3);
    }

    /* Analysis Info Panel */
    .analysis-info-panel {
      border-left: 3px solid var(--color-accent);
    }

    .analysis-info-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: var(--space-3);
    }

    .analysis-info-item {
      background: var(--color-surface-alt);
      padding: var(--space-3);
      border-radius: var(--radius-md);
      text-align: center;
    }

    .analysis-info-label {
      font-size: var(--text-xs);
      color: var(--color-text-muted);
      text-transform: uppercase;
      margin-bottom: var(--space-1);
    }

    .analysis-info-value {
      font-size: var(--text-sm);
      font-weight: var(--weight-semibold);
      color: var(--color-text-primary);
    }

    .analysis-info-value.unknown {
      color: var(--color-text-muted);
      font-style: italic;
    }

    .analysis-info-note {
      font-size: var(--text-xs);
      color: var(--color-text-muted);
      text-align: center;
      padding-top: var(--space-2);
      border-top: 1px solid var(--color-border);
      margin-top: var(--space-3);
    }

    /* Profile Grid */
    .profile-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: var(--space-3);
    }

    .profile-item {
      background: var(--color-surface-alt);
      padding: var(--space-3);
      border-radius: var(--radius-md);
    }

    .profile-item-label {
      font-size: var(--text-xs);
      color: var(--color-text-muted);
      margin-bottom: var(--space-1);
    }

    .profile-item-value {
      font-size: var(--text-sm);
      font-weight: var(--weight-medium);
      color: var(--color-text-primary);
    }

    /* DFY Qualification Panel */
    .dfy-qual-panel {
      border-left: 3px solid var(--color-primary);
    }

    /* Decision Summary Section */
    .dfy-decision-summary {
      background: var(--color-surface-alt);
      border-radius: var(--radius-lg);
      padding: var(--space-4);
      margin-bottom: var(--space-5);
    }

    .dfy-decision-header {
      display: flex;
      gap: var(--space-4);
      align-items: center;
      flex-wrap: wrap;
      margin-bottom: var(--space-3);
    }

    .dfy-qual-score {
      font-size: var(--text-2xl);
      font-weight: var(--weight-bold);
      color: var(--color-primary);
    }

    .dfy-qual-flag {
      font-size: var(--text-sm);
      padding: 4px 12px;
      border-radius: var(--radius-md);
      font-weight: var(--weight-semibold);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .dfy-qual-flag.clean {
      background: var(--color-success-bg);
      color: var(--color-success);
    }

    .dfy-qual-flag.risky {
      background: var(--color-error-bg);
      color: var(--color-error);
    }

    .dfy-qual-flag.unclear {
      background: rgba(245, 158, 11, 0.1);
      color: #f59e0b;
    }

    .dfy-decision-rationale {
      font-size: var(--text-sm);
      color: var(--color-text-primary);
      line-height: 1.5;
      padding: var(--space-3);
      background: var(--color-surface);
      border-radius: var(--radius-md);
      border-left: 3px solid var(--color-primary);
    }

    /* Rule Breakdown Section */
    .dfy-section-header {
      font-size: var(--text-sm);
      font-weight: var(--weight-semibold);
      color: var(--color-text-primary);
      margin-bottom: var(--space-3);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .dfy-rule-breakdown {
      margin-bottom: var(--space-5);
    }

    .dfy-rule-table {
      width: 100%;
      border-collapse: collapse;
    }

    .dfy-rule-table th {
      font-size: var(--text-xs);
      font-weight: var(--weight-semibold);
      color: var(--color-text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      text-align: left;
      padding: var(--space-2) var(--space-3);
      border-bottom: 1px solid var(--color-border);
    }

    .dfy-rule-table td {
      font-size: var(--text-sm);
      padding: var(--space-3);
      border-bottom: 1px solid var(--color-border);
      vertical-align: top;
    }

    .dfy-rule-table tr:last-child td {
      border-bottom: none;
    }

    .dfy-rule-table tr:hover {
      background: var(--color-surface-alt);
    }

    .dfy-rule-label {
      font-weight: var(--weight-medium);
      color: var(--color-text-primary);
    }

    .dfy-rule-result {
      display: inline-flex;
      align-items: center;
      gap: var(--space-2);
      font-weight: var(--weight-medium);
    }

    .dfy-rule-result.yes {
      color: var(--color-success);
    }

    .dfy-rule-result.no {
      color: var(--color-text-muted);
    }

    .dfy-rule-result.unknown {
      color: #f59e0b;
    }

    .dfy-rule-result-icon {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      font-weight: bold;
    }

    .dfy-rule-result-icon.yes {
      background: var(--color-success);
      color: white;
    }

    .dfy-rule-result-icon.no {
      background: var(--color-border);
      color: var(--color-text-muted);
    }

    .dfy-rule-result-icon.unknown {
      background: rgba(245, 158, 11, 0.2);
      color: #f59e0b;
    }

    .dfy-rule-importance {
      font-size: var(--text-xs);
      padding: 2px 8px;
      border-radius: var(--radius-sm);
      background: var(--color-surface-alt);
      color: var(--color-text-secondary);
    }

    .dfy-rule-importance.risk {
      background: var(--color-error-bg);
      color: var(--color-error);
    }

    .dfy-rule-importance.qualification {
      background: var(--color-primary-bg);
      color: var(--color-primary);
    }

    .dfy-rule-evidence {
      max-width: 300px;
    }

    .dfy-evidence-quote {
      font-size: var(--text-xs);
      color: var(--color-text-secondary);
      font-style: italic;
      line-height: 1.4;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .dfy-evidence-quote.expanded {
      -webkit-line-clamp: unset;
    }

    .dfy-evidence-expand {
      font-size: var(--text-xs);
      color: var(--color-primary);
      cursor: pointer;
      margin-top: var(--space-1);
    }

    .dfy-evidence-expand:hover {
      text-decoration: underline;
    }

    .dfy-qual-view-link {
      font-size: var(--text-xs);
      color: var(--color-primary);
      cursor: pointer;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .dfy-qual-view-link:hover {
      text-decoration: underline;
      color: var(--color-accent);
    }

    .dfy-no-evidence {
      font-size: var(--text-xs);
      color: var(--color-text-muted);
      font-style: italic;
    }

    /* Flag Logic Section */
    .dfy-flag-logic {
      background: var(--color-surface-alt);
      border-radius: var(--radius-md);
      padding: var(--space-4);
      margin-bottom: var(--space-5);
    }

    .dfy-flag-logic-title {
      font-size: var(--text-xs);
      font-weight: var(--weight-semibold);
      color: var(--color-text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: var(--space-3);
    }

    .dfy-flag-logic-item {
      display: flex;
      gap: var(--space-3);
      margin-bottom: var(--space-2);
      font-size: var(--text-sm);
      line-height: 1.5;
    }

    .dfy-flag-logic-item:last-child {
      margin-bottom: 0;
    }

    .dfy-flag-logic-label {
      font-weight: var(--weight-semibold);
      min-width: 60px;
    }

    .dfy-flag-logic-label.clean {
      color: var(--color-success);
    }

    .dfy-flag-logic-label.risky {
      color: var(--color-error);
    }

    .dfy-flag-logic-label.unclear {
      color: #f59e0b;
    }

    .dfy-flag-logic-def {
      color: var(--color-text-secondary);
      font-family: monospace;
      font-size: var(--text-xs);
    }

    .dfy-flag-logic-active {
      background: var(--color-surface);
      border-radius: var(--radius-sm);
      padding: var(--space-1) var(--space-2);
    }

    /* Software Discipline Section */
    .software-section {
      padding-top: var(--space-4);
      border-top: 1px solid var(--color-border);
    }

    .software-items {
      display: flex;
      gap: var(--space-4);
      flex-wrap: wrap;
    }

    .software-item {
      display: flex;
      align-items: center;
      gap: var(--space-2);
      font-size: var(--text-sm);
      background: var(--color-surface-alt);
      padding: var(--space-2) var(--space-3);
      border-radius: var(--radius-md);
    }

    .software-item .indicator {
      font-weight: var(--weight-medium);
    }

    .software-item .indicator.yes {
      color: var(--color-success);
    }

    .software-item .indicator.no {
      color: var(--color-text-muted);
    }

    /* Re-analyze button */
    .dfy-reanalyze-btn {
      margin-top: var(--space-4);
      padding-top: var(--space-4);
      border-top: 1px solid var(--color-border);
    }

    /* Transcript highlighting */
    .transcript-highlight {
      background: rgba(59, 130, 246, 0.2);
      border-left: 3px solid var(--color-primary);
      padding-left: var(--space-2);
      margin-left: calc(-1 * var(--space-2));
      animation: highlight-flash 1.5s ease-out;
    }

    @keyframes highlight-flash {
      0% { background: rgba(59, 130, 246, 0.4); }
      100% { background: rgba(59, 130, 246, 0.2); }
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="ds-header">
    <div class="ds-header-inner">
      <a href="/admin/" class="ds-header-logo">
        <img src="/admin/logo.svg" alt="AffiliateFinder">
      </a>
      <div class="ds-header-divider"></div>
      <nav class="ds-header-nav">
        <a href="/admin/">Calls</a>
        <a href="/admin/copy.html">Copy</a>
        <a href="/admin/phil.html">DFY</a>
        <a href="/admin/founder.html">Closing Rate</a>
      </nav>
      <div class="ds-header-user">
        <button class="ds-user-button" id="user-menu-button" aria-expanded="false" aria-haspopup="true">
          <div class="ds-user-avatar" id="user-avatar">--</div>
          <div class="ds-user-info">
            <span class="ds-user-name" id="user-display-name">Loading...</span>
            <span class="ds-user-role" id="user-display-role">-</span>
          </div>
          <svg class="ds-user-chevron" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="6 9 12 15 18 9"></polyline>
          </svg>
        </button>
        <div class="ds-user-dropdown" id="user-dropdown">
          <div class="ds-dropdown-header">
            <div class="ds-dropdown-email" id="user-email">-</div>
            <span class="ds-dropdown-role user" id="user-role-badge">User</span>
          </div>

          <div class="ds-dropdown-section">
            <a href="/admin/account.html" class="ds-dropdown-item">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                <circle cx="12" cy="7" r="4"></circle>
              </svg>
              Account
            </a>
            <a href="/admin/settings.html" class="ds-dropdown-item">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="3"></circle>
                <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
              </svg>
              Settings
            </a>
          </div>

          <div class="ds-dropdown-divider ds-admin-only" style="display: none;"></div>

          <div class="ds-dropdown-section ds-admin-only" style="display: none;">
            <div class="ds-dropdown-label">Admin</div>
            <a href="/admin/access-requests.html" class="ds-dropdown-item">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                <circle cx="8.5" cy="7" r="4"></circle>
                <line x1="20" y1="8" x2="20" y2="14"></line>
                <line x1="23" y1="11" x2="17" y2="11"></line>
              </svg>
              Access Requests
            </a>
            <a href="/admin/users.html" class="ds-dropdown-item">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                <circle cx="9" cy="7" r="4"></circle>
                <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
              </svg>
              User Management
            </a>
          </div>

          <div class="ds-dropdown-divider"></div>

          <div class="ds-dropdown-section">
            <button class="ds-dropdown-item danger" id="logout-button">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                <polyline points="16 17 21 12 16 7"></polyline>
                <line x1="21" y1="12" x2="9" y2="12"></line>
              </svg>
              Sign Out
            </button>
          </div>
        </div>
      </div>
    </div>
  </header>

  <main class="ds-container ds-page">
    <!-- Breadcrumb -->
    <div class="ds-mb-4">
      <a href="/admin/" class="back-link" style="color: var(--color-accent);">Back to Calls</a>
    </div>
    <!-- Loading State -->
    <div id="loadingState" class="ds-loading">
      <div class="ds-spinner"></div>
      <div class="ds-loading-text">Loading call data...</div>
    </div>

    <!-- Main Content -->
    <div id="mainContent" class="ds-hidden">
      <!-- Call Header Card -->
      <div class="ds-card ds-mb-5">
        <div class="call-header">
          <div>
            <h1 id="callTitle" style="font-size: var(--text-xl); margin-bottom: var(--space-2);">-</h1>
            <div class="call-meta">
              <div class="call-meta-item">
                <span class="call-meta-label">Date</span>
                <span id="callDate">-</span>
              </div>
              <div class="call-meta-item">
                <span class="call-meta-label">Duration</span>
                <span id="callDuration">-</span>
              </div>
              <div class="call-meta-item">
                <span class="call-meta-label">Rep</span>
                <span id="callRep">-</span>
              </div>
            </div>
          </div>
          <div>
            <span id="callScore" class="score-badge">-</span>
          </div>
        </div>
      </div>

      <!-- Analysis Status -->
      <div id="analysisStatus" class="ds-alert ds-alert-warning ds-mb-5 ds-hidden">
        <div class="analysis-status">
          <span id="analysisStatusText"></span>
          <button id="analyzeBtn" class="ds-btn ds-btn-primary ds-btn-sm" onclick="analyzeCall()">Analyze Now</button>
        </div>
      </div>

      <!-- Analysis Info Panel -->
      <div id="analysisInfoPanel" class="ds-card analysis-info-panel ds-mb-5 ds-hidden">
        <div class="ds-card-header">
          <div class="ds-card-title">Analysis Details</div>
        </div>
        <div id="analysisInfoContent">
          <div class="analysis-info-grid">
            <div class="analysis-info-item">
              <div class="analysis-info-label">Model</div>
              <div class="analysis-info-value" id="analysisModel">-</div>
            </div>
            <div class="analysis-info-item">
              <div class="analysis-info-label">Tokens Used</div>
              <div class="analysis-info-value" id="analysisTokens">-</div>
            </div>
            <div class="analysis-info-item">
              <div class="analysis-info-label">Cost</div>
              <div class="analysis-info-value" id="analysisCost">-</div>
            </div>
            <div class="analysis-info-item">
              <div class="analysis-info-label">Analyzed At</div>
              <div class="analysis-info-value" id="analysisTimestamp">-</div>
            </div>
          </div>
          <div id="analysisInfoNote" class="analysis-info-note ds-hidden">
            Model not recorded for older analyses.
          </div>
        </div>
      </div>

      <!-- Stripe Panel -->
      <div id="stripePanel" class="ds-card stripe-panel ds-mb-5 ds-hidden">
        <div class="ds-card-header">
          <div class="ds-card-title">Customer Status</div>
        </div>
        <div id="stripeContent">
          <div class="stripe-unmatched">Loading Stripe data...</div>
        </div>
      </div>

      <!-- DFY Qualification Panel (Phil calls only) -->
      <div id="dfyQualPanel" class="ds-card dfy-qual-panel ds-mb-5 ds-hidden">
        <div class="ds-card-header">
          <div class="ds-card-title">DFY Sales Quality</div>
        </div>
        <div id="dfyQualContent">
          <!-- Decision Summary -->
          <div class="dfy-decision-summary">
            <div class="dfy-decision-header">
              <div>
                <span class="dfy-qual-score" id="dfyQualScore">-/4</span>
                <span style="font-size: var(--text-xs); color: var(--color-text-secondary);"> Qualification Score</span>
              </div>
              <span class="dfy-qual-flag" id="dfyQualFlag">-</span>
              <span id="dfyOfferType" style="font-size: var(--text-sm); color: var(--color-text-secondary);"></span>
            </div>
            <div class="dfy-decision-rationale" id="dfyDecisionRationale">
              Loading rationale...
            </div>
          </div>

          <!-- Rule Breakdown -->
          <div class="dfy-rule-breakdown">
            <div class="dfy-section-header">Rule Breakdown</div>
            <table class="dfy-rule-table" id="dfyRuleTable">
              <thead>
                <tr>
                  <th>Rule</th>
                  <th>Result</th>
                  <th>Importance</th>
                  <th>Evidence</th>
                  <th></th>
                </tr>
              </thead>
              <tbody id="dfyRuleTableBody">
                <!-- Filled by JS -->
              </tbody>
            </table>
          </div>

          <!-- Flag Logic -->
          <div class="dfy-flag-logic">
            <div class="dfy-flag-logic-title">Flag Logic (Thresholds)</div>
            <div id="dfyFlagLogicContent">
              <!-- Filled by JS -->
            </div>
          </div>

          <!-- Software Discipline -->
          <div class="software-section">
            <div class="dfy-section-header">Software Discipline</div>
            <div class="software-items" id="softwareItems">
              <!-- Filled by JS -->
            </div>
          </div>

          <!-- Re-analyze Button -->
          <div class="dfy-reanalyze-btn">
            <button class="ds-btn ds-btn-secondary ds-btn-sm" onclick="reanalyzeDFYEvidence()">
              Re-analyze DFY Evidence
            </button>
          </div>
        </div>
      </div>

      <!-- Two Column Layout -->
      <div class="ds-two-col">
        <!-- Transcript -->
        <div class="ds-card">
          <div class="ds-card-header">
            <div class="ds-card-title">Transcript</div>
          </div>
          <div id="transcriptBox" class="ds-transcript">
            No transcript available
          </div>
        </div>

        <!-- Insights -->
        <div>
          <div class="ds-card ds-mb-5">
            <div class="ds-tabs">
              <button class="ds-tab active" data-tab="pains">Pains</button>
              <button class="ds-tab" data-tab="goals">Goals</button>
              <button class="ds-tab" data-tab="questions">Questions</button>
              <button class="ds-tab" data-tab="dislikes">Dislikes</button>
              <button class="ds-tab" data-tab="excitement">Excitement</button>
              <button class="ds-tab ds-hidden" data-tab="dfy" id="dfyTab">DFY</button>
            </div>

            <div id="painsTab" class="ds-tab-content active">
              <div id="painsList" class="ds-empty"><div class="ds-empty-text">No pains identified</div></div>
            </div>

            <div id="goalsTab" class="ds-tab-content">
              <div id="goalsList" class="ds-empty"><div class="ds-empty-text">No goals identified</div></div>
            </div>

            <div id="questionsTab" class="ds-tab-content">
              <div id="questionsList" class="ds-empty"><div class="ds-empty-text">No questions captured</div></div>
            </div>

            <div id="dislikesTab" class="ds-tab-content">
              <div id="dislikesList" class="ds-empty"><div class="ds-empty-text">No dislikes identified</div></div>
            </div>

            <div id="excitementTab" class="ds-tab-content">
              <div id="excitementList" class="ds-empty"><div class="ds-empty-text">No excitement triggers</div></div>
            </div>

            <div id="dfyTabContent" class="ds-tab-content">
              <div id="dfyList" class="ds-empty"><div class="ds-empty-text">No DFY pitches</div></div>
            </div>
          </div>

          <!-- Prospect Profile -->
          <div class="ds-card ds-mb-5 ds-hidden" id="profileSection">
            <div class="ds-card-header">
              <div class="ds-card-title">Prospect Profile</div>
            </div>
            <div id="profileGrid" class="profile-grid"></div>
          </div>

          <!-- Key Moments -->
          <div class="ds-card ds-hidden" id="momentsSection">
            <div class="ds-card-header">
              <div class="ds-card-title">Key Moments</div>
            </div>
            <div id="momentsList"></div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <script>
    const API_BASE = '/api';
    let callId = null;
    let callData = null;

    // User Menu
    async function initUserMenu() {
      try {
        const response = await fetch('/api/auth/me', { credentials: 'include' });
        if (!response.ok) {
          window.location.href = '/admin/login.html';
          return;
        }
        const data = await response.json();
        const user = data.user;

        // Update avatar with initials
        const avatar = document.getElementById('user-avatar');
        if (avatar) {
          const initials = (user.name || user.email || '?')
            .split(/[\s@]+/)
            .map(part => part[0])
            .join('')
            .substring(0, 2)
            .toUpperCase();
          avatar.textContent = initials;
        }

        // Update user display name in header button
        const displayName = document.getElementById('user-display-name');
        if (displayName) {
          displayName.textContent = user.name || user.email.split('@')[0];
        }

        // Update user display role in header button
        const displayRole = document.getElementById('user-display-role');
        if (displayRole) {
          displayRole.textContent = user.role === 'admin' ? 'Admin' : 'User';
        }

        // Update email in dropdown
        const emailEl = document.getElementById('user-email');
        if (emailEl) emailEl.textContent = user.email;

        // Update role badge in dropdown
        const roleBadge = document.getElementById('user-role-badge');
        if (roleBadge) {
          roleBadge.textContent = user.role === 'admin' ? 'Admin' : 'User';
          roleBadge.className = 'ds-dropdown-role ' + (user.role === 'admin' ? 'admin' : 'user');
        }

        if (user.role === 'admin') {
          document.querySelectorAll('.ds-admin-only').forEach(el => el.style.display = '');
        }
      } catch (err) {
        console.error('Failed to load user info:', err);
      }
    }

    function setupUserMenu() {
      const button = document.getElementById('user-menu-button');
      const dropdown = document.getElementById('user-dropdown');
      const logoutBtn = document.getElementById('logout-button');

      if (button && dropdown) {
        button.addEventListener('click', (e) => {
          e.stopPropagation();
          const isOpen = dropdown.classList.contains('open');
          dropdown.classList.toggle('open', !isOpen);
          button.setAttribute('aria-expanded', !isOpen);
        });

        document.addEventListener('click', (e) => {
          if (!e.target.closest('.ds-header-user')) {
            dropdown.classList.remove('open');
            button.setAttribute('aria-expanded', 'false');
          }
        });
      }

      if (logoutBtn) {
        logoutBtn.addEventListener('click', async () => {
          try {
            await fetch('/api/auth/logout', { method: 'POST', credentials: 'include' });
          } catch (err) {
            console.error('Logout error:', err);
          }
          window.location.href = '/admin/login.html';
        });
      }
    }

    function getCallIdFromUrl() {
      const params = new URLSearchParams(window.location.search);
      return params.get('id');
    }

    function formatDuration(seconds) {
      if (!seconds && seconds !== 0) return '-';
      if (seconds === 0) return '0 mins';

      // Convert to total minutes (rounded)
      const totalMins = Math.round(seconds / 60);

      if (totalMins === 0) return '< 1 min';
      if (totalMins === 1) return '1 min';
      return `${totalMins} mins`;
    }

    function formatDate(dateStr) {
      if (!dateStr) return '-';
      const date = new Date(dateStr);
      return date.toLocaleDateString('en-US', {
        weekday: 'short',
        month: 'short',
        day: 'numeric',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
    }

    function escapeHtml(str) {
      if (!str) return '';
      return str.replace(/[&<>"']/g, char => ({
        '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
      })[char]);
    }

    // Get CSS class for rep badge
    function getRepClass(repName) {
      if (!repName) return 'unknown';
      const name = repName.toLowerCase();
      if (name === 'both') return 'both';
      if (name.includes('phil')) return 'phil';
      if (name.includes('jamie')) return 'jamie';
      return 'unknown';
    }

    // Get display name for rep badge
    function getRepDisplayName(repName) {
      if (!repName) return 'Unknown';
      const name = repName.toLowerCase();
      if (name === 'both') return 'Both';
      if (name.includes('phil')) return 'Phil';
      if (name.includes('jamie')) return 'Jamie';
      return repName;
    }

    async function loadCallData() {
      callId = getCallIdFromUrl();
      console.log('[CallDetail] Loading call:', callId);
      if (!callId) {
        document.getElementById('loadingState').innerHTML = '<div class="ds-empty"><div class="ds-empty-text">No call ID provided</div></div>';
        return;
      }

      try {
        const response = await fetch(`${API_BASE}/admin/calls/${callId}`);
        const result = await response.json();
        console.log('[CallDetail] API response:', result);

        if (!result.success) {
          throw new Error(result.error || 'Failed to load call');
        }

        callData = result.data;
        console.log('[CallDetail] Call data:', {
          title: callData.title,
          datetime: callData.datetime,
          duration: callData.duration,
          rep: callData.rep,
          hasTranscript: !!callData.transcript,
          transcriptLength: (callData.transcript || '').length
        });
        renderCallData();

      } catch (error) {
        console.error('Error loading call:', error);
        document.getElementById('loadingState').innerHTML = `<div class="ds-empty"><div class="ds-empty-text">Error: ${escapeHtml(error.message)}</div></div>`;
      }
    }

    function renderCallData() {
      document.getElementById('loadingState').classList.add('ds-hidden');
      document.getElementById('mainContent').classList.remove('ds-hidden');

      document.getElementById('callTitle').textContent = callData.title || 'Untitled Call';
      // Update page title
      document.title = (callData.title || 'Call Detail') + ' - Sales Call Analyzer';
      document.getElementById('callDate').textContent = formatDate(callData.datetime || callData.call_datetime);
      document.getElementById('callDuration').textContent = formatDuration(callData.duration || callData.duration_seconds);

      // Render rep as colored badge
      const repName = callData.rep || callData.rep_name || 'Unknown';
      const repClass = getRepClass(repName);
      const repDisplayName = getRepDisplayName(repName);
      document.getElementById('callRep').innerHTML = `<span class="rep-badge ${repClass}">${repDisplayName}</span>`;

      renderTranscript(callData.transcript || callData.transcript_text);

      if (callData.analysis) {
        renderAnalysis(callData.analysis);
      } else {
        showAnalysisNeeded();
      }

      loadStripeData();

      // Check for highlight parameter in URL and scroll to it
      const params = new URLSearchParams(window.location.search);
      const highlightQuote = params.get('highlight');
      if (highlightQuote) {
        // Wait for transcript to render, then highlight
        setTimeout(() => {
          scrollToTranscriptQuote(decodeURIComponent(highlightQuote));
          // Switch to transcript tab
          document.querySelector('[data-tab="transcript"]')?.click();
        }, 200);
      }
    }

    function renderTranscript(transcript) {
      if (!transcript) {
        document.getElementById('transcriptBox').textContent = 'No transcript available';
        return;
      }

      const lines = transcript.split('\n');
      const highlighted = lines.map(line => {
        const match = line.match(/^([^:]+):\s*(.+)$/);
        if (match) {
          const speaker = match[1].trim().toLowerCase();
          const isRep = speaker.includes('phil') || speaker.includes('jamie');
          const className = isRep ? 'speaker-rep' : 'speaker-prospect';
          return `<span class="${className}">${escapeHtml(match[1])}:</span> ${escapeHtml(match[2])}`;
        }
        return escapeHtml(line);
      }).join('\n');

      document.getElementById('transcriptBox').innerHTML = highlighted;
    }

    function showAnalysisNeeded() {
      const status = document.getElementById('analysisStatus');
      status.classList.remove('ds-hidden');
      document.getElementById('analysisStatusText').textContent = 'This call has not been analyzed yet.';
      document.getElementById('callScore').textContent = '-';
      document.getElementById('callScore').className = 'score-badge';
      // Hide analysis info panel when no analysis
      document.getElementById('analysisInfoPanel').classList.add('ds-hidden');
    }

    function renderAnalysis(analysis) {
      document.getElementById('analysisStatus').classList.add('ds-hidden');

      const score = analysis.overallScore || 0;
      const scoreEl = document.getElementById('callScore');
      scoreEl.textContent = score;
      if (score >= 70) {
        scoreEl.className = 'score-badge score-high';
      } else if (score >= 40) {
        scoreEl.className = 'score-badge score-medium';
      } else {
        scoreEl.className = 'score-badge score-low';
      }

      // Render analysis info (model, tokens, cost, timestamp)
      renderAnalysisInfo(analysis);

      if (analysis.insights) {
        renderPains(analysis.insights.pains);
        renderGoals(analysis.insights.goals);
        renderQuestions(analysis.insights.questions);
        renderDislikes(analysis.insights.dislikes);
        renderExcitement(analysis.insights.excitement_triggers);
      }

      if (analysis.prospectProfile) {
        renderProfile(analysis.prospectProfile);
      }

      if (analysis.keyMoments && analysis.keyMoments.length > 0) {
        renderMoments(analysis.keyMoments);
      }

      if (analysis.dfyPitches && analysis.dfyPitches.detected) {
        renderDFYPitches(analysis.dfyPitches);
      }

      // Render DFY Qualification (Phil calls only)
      if (analysis.dfyQualification) {
        renderDFYQualification(analysis.dfyQualification);
      }
    }

    function renderAnalysisInfo(analysis) {
      const panel = document.getElementById('analysisInfoPanel');
      const tokenUsage = analysis.tokenUsage;
      const analyzedAt = analysis.analyzedAt;
      const analysisMode = analysis.analysisMode;

      // Always show the panel when analysis exists
      panel.classList.remove('ds-hidden');

      // Model
      const modelEl = document.getElementById('analysisModel');
      if (tokenUsage && tokenUsage.model) {
        modelEl.textContent = tokenUsage.model;
        modelEl.classList.remove('unknown');
      } else if (analysisMode === 'heuristic') {
        modelEl.textContent = 'Heuristic';
        modelEl.classList.remove('unknown');
      } else {
        modelEl.textContent = 'Unknown';
        modelEl.classList.add('unknown');
        document.getElementById('analysisInfoNote').classList.remove('ds-hidden');
      }

      // Tokens
      const tokensEl = document.getElementById('analysisTokens');
      if (tokenUsage && tokenUsage.totalTokens) {
        tokensEl.textContent = tokenUsage.totalTokens.toLocaleString();
        tokensEl.classList.remove('unknown');
      } else if (analysisMode === 'heuristic') {
        tokensEl.textContent = 'N/A';
        tokensEl.classList.add('unknown');
      } else {
        tokensEl.textContent = '-';
        tokensEl.classList.add('unknown');
      }

      // Cost
      const costEl = document.getElementById('analysisCost');
      if (tokenUsage && tokenUsage.cost !== undefined && tokenUsage.cost !== null) {
        costEl.textContent = '$' + tokenUsage.cost.toFixed(4);
        costEl.classList.remove('unknown');
      } else if (analysisMode === 'heuristic') {
        costEl.textContent = '$0.00';
        costEl.classList.remove('unknown');
      } else {
        costEl.textContent = '-';
        costEl.classList.add('unknown');
      }

      // Timestamp
      const timestampEl = document.getElementById('analysisTimestamp');
      if (analyzedAt) {
        const date = new Date(analyzedAt);
        timestampEl.textContent = date.toLocaleDateString('en-GB', {
          day: '2-digit',
          month: 'short',
          year: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        });
        timestampEl.classList.remove('unknown');
      } else {
        timestampEl.textContent = '-';
        timestampEl.classList.add('unknown');
      }
    }

    function renderDFYQualification(qual) {
      // Only show for Phil calls
      if (!callData.rep?.toLowerCase().includes('phil') && !callData.rep_name?.toLowerCase().includes('phil')) {
        return;
      }

      const panel = document.getElementById('dfyQualPanel');
      panel.classList.remove('ds-hidden');

      // Score
      document.getElementById('dfyQualScore').textContent = `${qual.dfy_qualification_score}/4`;

      // Flag
      const flagEl = document.getElementById('dfyQualFlag');
      flagEl.textContent = capitalize(qual.dfy_quality_flag);
      flagEl.className = `dfy-qual-flag ${qual.dfy_quality_flag}`;

      // Offer type
      const offerTypeLabels = {
        'none': '',
        'dfy_primary': 'DFY pitched as primary',
        'dfy_upgrade': 'DFY pitched as upgrade',
        'dfy_fallback': 'DFY pitched as fallback'
      };
      document.getElementById('dfyOfferType').textContent = offerTypeLabels[qual.dfy_offer_type] || '';

      // Decision Rationale (from new rationale object)
      if (qual.rationale && qual.rationale.summary) {
        document.getElementById('dfyDecisionRationale').textContent = qual.rationale.summary;
      } else {
        // Fallback: generate summary from existing data
        document.getElementById('dfyDecisionRationale').textContent = generateFallbackRationale(qual);
      }

      // Rule Breakdown Table
      renderRuleBreakdownTable(qual);

      // Flag Logic
      renderFlagLogic(qual);

      // Software discipline
      const softwareHtml = `
        <div class="software-item">
          <span style="color: var(--color-text-secondary);">Software Pitched:</span>
          <span class="indicator ${qual.software_pitched ? 'yes' : 'no'}">
            ${qual.software_pitched ? 'Yes' : 'No'}
          </span>
          ${qual.evidence?.software_pitch_quote ? `
            <span class="dfy-qual-view-link" onclick="scrollToTranscriptLine(${qual.evidence.software_pitch_quote.lineIndex})">View</span>
          ` : ''}
        </div>
        <div class="software-item">
          <span style="color: var(--color-text-secondary);">Close Attempted:</span>
          <span class="indicator ${qual.software_close_attempted ? 'yes' : 'no'}">
            ${qual.software_close_attempted ? 'Yes' : 'No'}
          </span>
          ${qual.evidence?.software_close_quote ? `
            <span class="dfy-qual-view-link" onclick="scrollToTranscriptLine(${qual.evidence.software_close_quote.lineIndex})">View</span>
          ` : ''}
        </div>
      `;

      document.getElementById('softwareItems').innerHTML = softwareHtml;
    }

    function generateFallbackRationale(qual) {
      if (!qual.dfy_pitched) {
        return 'DFY was not pitched on this call. Software-only approach.';
      }
      if (qual.proposal_promised && !qual.discovery_booked_for_dfy) {
        const missing = [];
        if (!qual.criteria_no_time) missing.push('time constraint');
        if (!qual.criteria_buyer_intent) missing.push('buyer intent');
        if (!qual.criteria_budget_validated) missing.push('validated budget');
        return `DFY was pitched and proposal promised without booking discovery.${missing.length > 0 ? ' Missing: ' + missing.join(', ') + '.' : ''}`;
      }
      if (qual.dfy_qualification_score >= 3) {
        const met = [];
        if (qual.criteria_no_time) met.push('time constraint');
        if (qual.criteria_buyer_intent) met.push('buyer intent');
        if (qual.criteria_budget_validated) met.push('validated budget');
        if (qual.discovery_booked_for_dfy) met.push('discovery booked');
        return `DFY properly qualified (${qual.dfy_qualification_score}/4 criteria). Met: ${met.join(', ')}.`;
      }
      if (qual.dfy_qualification_score < 2) {
        const missing = [];
        if (!qual.criteria_no_time) missing.push('time constraint');
        if (!qual.criteria_buyer_intent) missing.push('buyer intent');
        if (!qual.criteria_budget_validated) missing.push('validated budget');
        return `DFY pitched with low qualification score (${qual.dfy_qualification_score}/4). Missing: ${missing.join(', ')}.`;
      }
      return `DFY pitched with moderate qualification score (${qual.dfy_qualification_score}/4). More discovery needed to validate fit.`;
    }

    function renderRuleBreakdownTable(qual) {
      // Use ruleBreakdown from API if available, otherwise build from evidence
      const rules = qual.ruleBreakdown || buildRuleBreakdownFromEvidence(qual);

      const tbody = document.getElementById('dfyRuleTableBody');
      tbody.innerHTML = rules.map((rule, idx) => {
        const resultClass = rule.result === 'yes' ? 'yes' :
                           rule.result === 'no' ? 'no' : 'unknown';
        const resultIcon = rule.result === 'yes' ? '&#10003;' :
                          rule.result === 'no' ? '&#10005;' : '?';
        const resultText = rule.result === 'yes' ? 'Yes' :
                          rule.result === 'no' ? 'No' :
                          rule.result === 'unknown' ? 'Unknown' : rule.result;

        // Determine importance styling
        const importanceClass = rule.importance?.toLowerCase().includes('risk') ? 'risk' :
                               rule.importance?.toLowerCase().includes('qualification') ? 'qualification' : '';

        // Evidence cell
        let evidenceHtml = '<span class="dfy-no-evidence">No evidence</span>';
        if (rule.evidence && rule.evidence.text) {
          const quoteId = `evidence-quote-${idx}`;
          evidenceHtml = `
            <div class="dfy-evidence-quote" id="${quoteId}">"${escapeHtml(rule.evidence.text)}"</div>
            ${rule.evidence.text.length > 100 ? `<span class="dfy-evidence-expand" onclick="toggleEvidenceExpand('${quoteId}', this)">Expand</span>` : ''}
          `;
        } else if (rule.evidence && rule.evidence.computed) {
          evidenceHtml = `<span style="font-size: var(--text-xs); color: var(--color-text-secondary);">${escapeHtml(rule.evidence.text || 'Computed')}</span>`;
        }

        // View link cell
        let viewHtml = '';
        if (rule.evidence && rule.evidence.lineIndex !== undefined && rule.evidence.lineIndex !== null) {
          viewHtml = `<span class="dfy-qual-view-link" onclick="scrollToTranscriptLine(${rule.evidence.lineIndex})">View in transcript</span>`;
        }

        return `
          <tr>
            <td><span class="dfy-rule-label">${escapeHtml(rule.label)}</span></td>
            <td>
              <span class="dfy-rule-result ${resultClass}">
                <span class="dfy-rule-result-icon ${resultClass}">${resultIcon}</span>
                ${resultText}
              </span>
            </td>
            <td><span class="dfy-rule-importance ${importanceClass}">${escapeHtml(rule.importance || '-')}</span></td>
            <td class="dfy-rule-evidence">${evidenceHtml}</td>
            <td>${viewHtml}</td>
          </tr>
        `;
      }).join('');
    }

    function buildRuleBreakdownFromEvidence(qual) {
      // Fallback: build rule breakdown from existing evidence structure
      return [
        {
          rule: 'dfy_pitched',
          label: 'DFY Pitched',
          result: qual.dfy_pitched ? 'yes' : 'no',
          importance: 'Primary signal',
          evidence: qual.evidence?.dfy_pitch_quote
        },
        {
          rule: 'criteria_no_time',
          label: 'Lead stated no time / wants someone to run it',
          result: qual.criteria_no_time ? 'yes' : 'no',
          importance: 'Qualification signal',
          evidence: qual.evidence?.no_time_quote
        },
        {
          rule: 'criteria_buyer_intent',
          label: 'Serious buyer intent for DFY',
          result: qual.criteria_buyer_intent ? 'yes' : 'no',
          importance: 'Qualification signal',
          evidence: qual.evidence?.buyer_intent_quote
        },
        {
          rule: 'budget_asked',
          label: 'Budget asked',
          result: qual.budget_asked ? 'yes' : 'no',
          importance: 'Qualification signal',
          evidence: qual.evidence?.budget_quote
        },
        {
          rule: 'budget_provided',
          label: 'Budget provided',
          result: qual.budget_provided ? 'yes' : 'no',
          importance: 'Qualification signal',
          evidence: qual.budget_amount ? { text: `$${qual.budget_amount}/month` } : null
        },
        {
          rule: 'budget_fit_for_dfy',
          label: 'Budget fits DFY range (>= $1,000/mo)',
          result: qual.budget_fit_for_dfy,
          importance: 'Qualification signal',
          evidence: qual.budget_amount ? { text: `$${qual.budget_amount}/month ${qual.budget_fit_for_dfy === 'yes' ? 'meets' : 'below'} minimum`, computed: true } : null
        },
        {
          rule: 'discovery_booked_for_dfy',
          label: 'Discovery booked for DFY (preferred)',
          result: qual.discovery_booked_for_dfy ? 'yes' : 'no',
          importance: 'Next step quality',
          evidence: qual.evidence?.discovery_quote
        },
        {
          rule: 'proposal_promised',
          label: 'Proposal promised without discovery (risk signal)',
          result: qual.proposal_promised && !qual.discovery_booked_for_dfy ? 'yes' : qual.proposal_promised ? 'no (with discovery)' : 'no',
          importance: qual.proposal_promised && !qual.discovery_booked_for_dfy ? 'Risk signal' : 'Next step quality',
          evidence: qual.evidence?.proposal_quote
        },
        {
          rule: 'software_pitched',
          label: 'Software pitched',
          result: qual.software_pitched ? 'yes' : 'no',
          importance: 'Software discipline',
          evidence: qual.evidence?.software_pitch_quote
        },
        {
          rule: 'software_close_attempted',
          label: 'Software close attempted',
          result: qual.software_close_attempted ? 'yes' : 'no',
          importance: 'Software discipline',
          evidence: qual.evidence?.software_close_quote
        }
      ];
    }

    function toggleEvidenceExpand(quoteId, toggleEl) {
      const quoteEl = document.getElementById(quoteId);
      if (quoteEl) {
        quoteEl.classList.toggle('expanded');
        toggleEl.textContent = quoteEl.classList.contains('expanded') ? 'Collapse' : 'Expand';
      }
    }

    function renderFlagLogic(qual) {
      const flagLogic = qual.rationale?.flagLogic || {
        clean: 'DFY not pitched OR (score >= 3 AND no risky patterns)',
        risky: 'DFY pitched AND (proposal without discovery OR score < 2)',
        unclear: 'DFY pitched AND score = 2 (insufficient qualification signals)'
      };

      const currentFlag = qual.dfy_quality_flag;

      const html = Object.entries(flagLogic).map(([flag, logic]) => {
        const isActive = flag === currentFlag;
        return `
          <div class="dfy-flag-logic-item ${isActive ? 'dfy-flag-logic-active' : ''}">
            <span class="dfy-flag-logic-label ${flag}">${capitalize(flag)}:</span>
            <span class="dfy-flag-logic-def">${escapeHtml(logic)}</span>
          </div>
        `;
      }).join('');

      document.getElementById('dfyFlagLogicContent').innerHTML = html;
    }

    async function reanalyzeDFYEvidence() {
      if (!callId) return;

      const btn = event.target;
      btn.disabled = true;
      btn.textContent = 'Re-analyzing...';

      try {
        const response = await fetch(`${API_BASE}/dfy/quality/reanalyze/${callId}`, {
          method: 'POST'
        });
        const data = await response.json();

        if (data.success && data.data.qualification) {
          // Update the panel with fresh data
          renderDFYQualification(data.data.qualification);
          btn.textContent = 'Re-analyzed!';
          setTimeout(() => {
            btn.textContent = 'Re-analyze DFY Evidence';
            btn.disabled = false;
          }, 2000);
        } else {
          throw new Error(data.error || 'Re-analysis failed');
        }
      } catch (error) {
        console.error('Re-analysis error:', error);
        btn.textContent = 'Error - Try Again';
        btn.disabled = false;
      }
    }

    function scrollToTranscriptLine(lineIndex, quoteText = null) {
      const transcriptBox = document.getElementById('transcriptBox');
      if (!transcriptBox) return;

      // Remove previous highlights
      transcriptBox.querySelectorAll('.transcript-highlight').forEach(el => {
        el.classList.remove('transcript-highlight');
      });

      // Get transcript text and split into lines
      const transcript = callData.transcript || callData.transcript_text;
      if (!transcript) return;

      const lines = transcript.split('\n');

      // Determine which line to highlight
      let targetLineIndex = lineIndex;
      let matchType = 'exact';

      // If lineIndex is invalid or out of range, try fuzzy matching
      if (lineIndex === null || lineIndex === undefined || lineIndex >= lines.length) {
        if (quoteText) {
          // Try fuzzy match
          const fuzzyResult = findFuzzyMatchLine(lines, quoteText);
          if (fuzzyResult.found) {
            targetLineIndex = fuzzyResult.lineIndex;
            matchType = fuzzyResult.matchType;
          } else {
            console.warn('Could not find transcript line for quote:', quoteText);
            return;
          }
        } else {
          return;
        }
      }

      // Re-render transcript with highlight
      const highlighted = lines.map((line, idx) => {
        const match = line.match(/^([^:]+):\s*(.+)$/);
        const isHighlighted = idx === targetLineIndex;
        const highlightClass = isHighlighted ? ' transcript-highlight' : '';
        const lineId = `transcript-line-${idx}`;

        // Add fuzzy match indicator if applicable
        const fuzzyIndicator = isHighlighted && matchType === 'fuzzy' ?
          '<span style="font-size: 10px; color: var(--color-warning); margin-left: 4px;" title="Closest match">[~]</span>' : '';

        if (match) {
          const speaker = match[1].trim().toLowerCase();
          const isRep = speaker.includes('phil') || speaker.includes('jamie');
          const className = isRep ? 'speaker-rep' : 'speaker-prospect';
          return `<span id="${lineId}" class="${className}${highlightClass}"><span class="${className}">${escapeHtml(match[1])}:</span> ${escapeHtml(match[2])}${fuzzyIndicator}</span>`;
        }
        return `<span id="${lineId}" class="${highlightClass}">${escapeHtml(line)}${fuzzyIndicator}</span>`;
      }).join('\n');

      transcriptBox.innerHTML = highlighted;

      // Scroll to highlighted line
      const targetLine = document.getElementById(`transcript-line-${targetLineIndex}`);
      if (targetLine) {
        targetLine.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }
    }

    function findFuzzyMatchLine(lines, quoteText) {
      if (!quoteText || !lines.length) {
        return { found: false };
      }

      const quoteLower = quoteText.toLowerCase().trim();
      let bestMatch = { lineIndex: -1, score: 0, matchType: 'fuzzy' };

      for (let i = 0; i < lines.length; i++) {
        const lineLower = lines[i].toLowerCase();

        // Exact substring match
        if (lineLower.includes(quoteLower)) {
          return { found: true, lineIndex: i, matchType: 'exact' };
        }

        // Check for partial matches (first N words)
        const quoteWords = quoteLower.split(/\s+/).slice(0, 5);
        const lineWords = lineLower.split(/\s+/);

        let matchedWords = 0;
        for (const qWord of quoteWords) {
          if (lineWords.some(lWord => lWord.includes(qWord) || qWord.includes(lWord))) {
            matchedWords++;
          }
        }

        const score = matchedWords / quoteWords.length;
        if (score > bestMatch.score) {
          bestMatch = { lineIndex: i, score, matchType: 'fuzzy' };
        }
      }

      // Only return fuzzy match if confidence is reasonable (> 60%)
      if (bestMatch.score >= 0.6) {
        return { found: true, lineIndex: bestMatch.lineIndex, matchType: 'fuzzy' };
      }

      return { found: false };
    }

    function scrollToTranscriptQuote(quoteText) {
      // Wrapper to scroll by quote text when lineIndex is unknown
      scrollToTranscriptLine(null, quoteText);
    }

    function truncateText(text, maxLength) {
      if (!text) return '';
      if (text.length <= maxLength) return text;
      return text.substring(0, maxLength) + '...';
    }

    function capitalize(str) {
      if (!str) return '';
      return str.charAt(0).toUpperCase() + str.slice(1);
    }

    function renderPains(pains) {
      if (!pains || pains.length === 0) {
        document.getElementById('painsList').innerHTML = '<div class="ds-empty"><div class="ds-empty-text">No pains identified</div></div>';
        return;
      }

      const html = pains.map(pain => {
        const intensityClass = pain.intensity === 'High' ? 'ds-insight-high' : pain.intensity === 'Medium' ? 'ds-insight-medium' : 'ds-insight-low';
        return `
          <div class="ds-insight ${intensityClass}">
            <div class="ds-insight-header">
              <span class="ds-insight-category">${escapeHtml(pain.category)}</span>
              <span class="ds-badge ${pain.intensity === 'High' ? 'ds-badge-danger' : pain.intensity === 'Medium' ? 'ds-badge-warning' : 'ds-badge-success'}">${escapeHtml(pain.intensity || 'Medium')}</span>
            </div>
            <div class="ds-insight-quote">"${escapeHtml(pain.quote?.substring(0, 200))}${pain.quote?.length > 200 ? '...' : ''}"</div>
            <div class="ds-insight-meta">${pain.timestamp ? `@ ${pain.timestamp}` : ''}</div>
          </div>
        `;
      }).join('');

      document.getElementById('painsList').innerHTML = html;
    }

    function renderGoals(goals) {
      if (!goals || goals.length === 0) {
        document.getElementById('goalsList').innerHTML = '<div class="ds-empty"><div class="ds-empty-text">No goals identified</div></div>';
        return;
      }

      const html = goals.map(goal => `
        <div class="ds-insight">
          <div class="ds-insight-header">
            <span class="ds-insight-category">${escapeHtml(goal.goal)}</span>
            <span class="ds-badge ${goal.priority === 'high' ? 'ds-badge-danger' : 'ds-badge-info'}">${escapeHtml(goal.priority || 'medium')}</span>
          </div>
          ${goal.evidence ? `<div class="ds-insight-quote">"${escapeHtml(goal.evidence)}"</div>` : ''}
        </div>
      `).join('');

      document.getElementById('goalsList').innerHTML = html;
    }

    function renderQuestions(questions) {
      if (!questions || questions.length === 0) {
        document.getElementById('questionsList').innerHTML = '<div class="ds-empty"><div class="ds-empty-text">No questions captured</div></div>';
        return;
      }

      const html = questions.map(q => `
        <div class="ds-insight">
          <div class="ds-insight-quote">"${escapeHtml(q.question)}"</div>
          <div class="ds-insight-meta">${q.timestamp ? `@ ${q.timestamp}` : ''}</div>
        </div>
      `).join('');

      document.getElementById('questionsList').innerHTML = html;
    }

    function renderDislikes(dislikes) {
      if (!dislikes || dislikes.length === 0) {
        document.getElementById('dislikesList').innerHTML = '<div class="ds-empty"><div class="ds-empty-text">No dislikes identified</div></div>';
        return;
      }

      const html = dislikes.map(d => `
        <div class="ds-insight ${d.emotion === 'Frustration' ? 'ds-insight-high' : ''}">
          <div class="ds-insight-header">
            <span class="ds-insight-category">${escapeHtml(d.type)}</span>
            <span class="ds-badge ${d.resolved ? 'ds-badge-success' : ''}">${d.resolved ? 'Resolved' : 'Unresolved'}</span>
          </div>
          <div class="ds-insight-quote">"${escapeHtml(d.quote?.substring(0, 200))}${d.quote?.length > 200 ? '...' : ''}"</div>
        </div>
      `).join('');

      document.getElementById('dislikesList').innerHTML = html;
    }

    function renderExcitement(triggers) {
      if (!triggers || triggers.length === 0) {
        document.getElementById('excitementList').innerHTML = '<div class="ds-empty"><div class="ds-empty-text">No excitement triggers</div></div>';
        return;
      }

      const html = triggers.map(t => `
        <div class="ds-insight ds-insight-low">
          <div class="ds-insight-category">${escapeHtml(t.trigger)}</div>
          <div class="ds-insight-quote">"${escapeHtml(t.quote)}"</div>
          <div class="ds-insight-meta">${t.timestamp ? `@ ${t.timestamp}` : ''}</div>
        </div>
      `).join('');

      document.getElementById('excitementList').innerHTML = html;
    }

    function renderProfile(profile) {
      document.getElementById('profileSection').classList.remove('ds-hidden');

      const items = [
        { label: 'Industry', value: profile.industry || 'Unknown' },
        { label: 'Role', value: profile.role || 'Unknown' },
        { label: 'Team Size', value: profile.teamSize || 'Unknown' },
        { label: 'Budget', value: profile.budgetAuthority || 'Unknown' },
        { label: 'Pain Level', value: `${profile.painLevel || 5}/10` },
        { label: 'Tools', value: (profile.currentTools || []).join(', ') || 'None' }
      ];

      const html = items.map(item => `
        <div class="profile-item">
          <div class="profile-item-label">${item.label}</div>
          <div class="profile-item-value">${escapeHtml(item.value)}</div>
        </div>
      `).join('');

      document.getElementById('profileGrid').innerHTML = html;
    }

    function renderMoments(moments) {
      document.getElementById('momentsSection').classList.remove('ds-hidden');

      const html = moments.map(m => `
        <div class="ds-insight" style="margin: var(--space-4);">
          <div class="ds-insight-header">
            <span class="ds-insight-category">${escapeHtml(m.event)}</span>
            <span class="ds-badge ${m.impact === 'High' ? 'ds-badge-danger' : 'ds-badge-info'}">${escapeHtml(m.impact)} impact</span>
          </div>
          <div class="ds-insight-quote">"${escapeHtml(m.quote)}"</div>
          <div class="ds-insight-meta">@ ${m.timestamp || 'unknown'}</div>
        </div>
      `).join('');

      document.getElementById('momentsList').innerHTML = html;
    }

    function renderDFYPitches(dfyPitches) {
      if (!dfyPitches || !dfyPitches.detected || !dfyPitches.pitches || dfyPitches.pitches.length === 0) {
        return;
      }

      document.getElementById('dfyTab').classList.remove('ds-hidden');

      const html = dfyPitches.pitches.map(pitch => `
        <div class="ds-insight">
          <div class="ds-insight-header">
            <span class="ds-badge ds-badge-accent">${escapeHtml(pitch.trigger?.category || 'PROACTIVE')}</span>
            <span class="ds-text-muted">${pitch.confidence || 60}% confidence</span>
          </div>
          <div class="ds-insight-quote">"${escapeHtml(pitch.snippet?.substring(0, 200))}${pitch.snippet?.length > 200 ? '...' : ''}"</div>
          <div class="ds-insight-meta">${pitch.timestamp ? `@ ${pitch.timestamp}` : ''}</div>
        </div>
      `).join('');

      document.getElementById('dfyList').innerHTML = html;
    }

    async function analyzeCall() {
      const btn = document.getElementById('analyzeBtn');
      btn.disabled = true;
      btn.innerHTML = '<span class="ds-spinner ds-spinner-sm"></span> Analyzing...';

      try {
        const response = await fetch(`${API_BASE}/analysis/analyze/${callId}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ force: false })
        });

        const result = await response.json();

        if (!result.success) {
          throw new Error(result.error || 'Analysis failed');
        }

        const status = document.getElementById('analysisStatus');
        status.classList.remove('ds-alert-warning');
        status.classList.add('ds-alert-success');
        document.getElementById('analysisStatusText').textContent = 'Analysis complete!';
        btn.classList.add('ds-hidden');

        if (result.analysis) {
          renderAnalysis(result.analysis);
        }

      } catch (error) {
        console.error('Analysis error:', error);
        alert('Error: ' + error.message);
        btn.disabled = false;
        btn.textContent = 'Analyze Now';
      }
    }

    async function loadStripeData() {
      const stripePanel = document.getElementById('stripePanel');
      const stripeContent = document.getElementById('stripeContent');

      try {
        const statusResponse = await fetch(`${API_BASE}/stripe/status`);
        const statusResult = await statusResponse.json();

        if (!statusResult.configured) {
          stripePanel.classList.add('ds-hidden');
          return;
        }

        stripePanel.classList.remove('ds-hidden');

        const response = await fetch(`${API_BASE}/stripe/call/${callId}`);
        const result = await response.json();

        if (!result.success) {
          stripeContent.innerHTML = '<div class="stripe-unmatched">Error loading Stripe data</div>';
          return;
        }

        renderStripePanel(result.data);

      } catch (error) {
        console.error('Error loading Stripe data:', error);
        stripePanel.classList.add('ds-hidden');
      }
    }

    function renderStripePanel(data) {
      const stripeContent = document.getElementById('stripeContent');

      if (!data.matched) {
        stripeContent.innerHTML = '<div class="stripe-unmatched">No matching customer in Stripe</div>';
        return;
      }

      const statusLabels = {
        'active': 'Active',
        'trialing': 'Trial',
        'canceled': 'Canceled',
        'past_due': 'Past Due',
        'never_subscribed': 'Never Subscribed'
      };

      const statusColors = {
        'active': 'ds-badge-success',
        'trialing': 'ds-badge-info',
        'canceled': 'ds-badge-danger',
        'past_due': 'ds-badge-warning'
      };

      stripeContent.innerHTML = `
        <div class="stripe-grid" style="padding: var(--space-4);">
          <div class="stripe-item">
            <div class="stripe-item-label">Status</div>
            <span class="ds-badge ${statusColors[data.status] || ''}">${statusLabels[data.status] || data.status}</span>
          </div>
          <div class="stripe-item">
            <div class="stripe-item-label">Customer</div>
            <div class="stripe-item-value">${escapeHtml(data.customerName || data.email || '-')}</div>
          </div>
          <div class="stripe-item">
            <div class="stripe-item-label">Signup</div>
            <div class="stripe-item-value">${data.signupDate ? formatDate(data.signupDate).split(',')[0] : '-'}</div>
          </div>
          ${data.mrr > 0 ? `
          <div class="stripe-item">
            <div class="stripe-item-label">MRR</div>
            <div class="stripe-item-value" style="color: var(--color-success);">$${data.mrr.toFixed(2)}</div>
          </div>
          ` : ''}
        </div>
      `;
    }

    // Tab switching
    document.querySelectorAll('.ds-tab').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.ds-tab').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');

        document.querySelectorAll('.ds-tab-content').forEach(c => c.classList.remove('active'));
        const tabId = btn.dataset.tab === 'dfy' ? 'dfyTabContent' : btn.dataset.tab + 'Tab';
        document.getElementById(tabId).classList.add('active');
      });
    });

    document.addEventListener('DOMContentLoaded', () => {
      initUserMenu();
      setupUserMenu();
      loadCallData();
    });
  </script>
</body>
</html>
