<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Calls - Sales Call Analyzer</title>
  <link rel="stylesheet" href="design-system.css">
  <style>
    /* Page-specific styles */

    /* Filter row layout - matching dashboard style */
    .ds-filters-row {
      display: flex;
      flex-wrap: wrap;
      gap: var(--space-4);
      align-items: flex-end;
    }

    .ds-filter-group {
      display: flex;
      flex-direction: column;
      gap: var(--space-1);
      min-width: 150px;
    }

    .ds-filter-label {
      font-size: var(--text-xs);
      font-weight: 500;
      color: var(--color-text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .ds-filter-actions {
      display: flex;
      gap: var(--space-2);
      margin-left: auto;
    }

    @media (max-width: 768px) {
      .ds-filters-row {
        flex-direction: column;
        align-items: stretch;
      }

      .ds-filter-group {
        width: 100%;
      }

      .ds-filter-actions {
        margin-left: 0;
        margin-top: var(--space-2);
      }
    }

    .sync-status {
      display: none;
    }

    .sync-status.active {
      display: block;
    }

    .sync-status.error {
      background: var(--color-danger-bg);
      color: var(--color-danger);
      border-left-color: var(--color-danger);
    }

    .sync-status.success {
      background: var(--color-success-bg);
      color: var(--color-success);
      border-left-color: var(--color-success);
    }

    .call-link {
      color: var(--color-accent);
      font-weight: var(--weight-medium);
    }

    .call-link:hover {
      text-decoration: underline;
    }

    .duration {
      font-family: var(--font-mono);
      color: var(--color-text-secondary);
    }

    .view-link {
      color: var(--color-accent);
      font-size: var(--text-xs);
    }

    /* Classification badge styles */
    .badge-sales {
      background: var(--color-success-bg);
      color: var(--color-success);
    }

    .badge-not-sales {
      background: var(--color-text-muted);
      background: rgba(156, 163, 175, 0.15);
      color: var(--color-text-muted);
    }

    .badge-review {
      background: rgba(245, 158, 11, 0.1);
      color: #f59e0b;
    }

    .badge-override {
      position: relative;
    }

    .badge-override::after {
      content: '✎';
      font-size: 10px;
      margin-left: 4px;
      opacity: 0.7;
    }

    /* Rep name badge styles */
    .rep-badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: var(--text-xs);
      font-weight: 500;
    }

    .rep-badge.phil {
      background: rgba(251, 191, 36, 0.15);
      color: #b45309;
    }

    .rep-badge.jamie {
      background: rgba(236, 72, 153, 0.15);
      color: #be185d;
    }

    .rep-badge.both {
      background: rgba(59, 130, 246, 0.15);
      color: #2563eb;
    }

    .rep-badge.unknown {
      background: var(--color-surface-alt);
      color: var(--color-text-secondary);
    }

    /* Classification dropdown */
    .classification-select {
      padding: 4px 8px;
      font-size: var(--text-xs);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-sm);
      background: var(--color-surface);
      cursor: pointer;
      min-width: 100px;
    }

    .classification-select:hover {
      border-color: var(--color-primary);
    }

    .classification-select:focus {
      outline: none;
      border-color: var(--color-primary);
      box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.1);
    }

    /* Search specific styles */
    .search-container {
      position: relative;
    }

    .search-results {
      position: absolute;
      top: calc(100% + 8px);
      left: 0;
      width: 320px;
      background: var(--color-surface);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-lg);
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
      max-height: 400px;
      overflow-y: auto;
      z-index: 1000;
      display: none;
    }

    .search-results.active {
      display: block;
    }

    .search-result-item {
      display: block;
      padding: var(--space-3) var(--space-4);
      border-bottom: 1px solid var(--color-border-light);
      text-decoration: none;
      transition: background var(--transition-fast);
    }

    .search-result-item:last-child {
      border-bottom: none;
    }

    .search-result-item:hover {
      background: var(--color-surface-alt);
    }

    .search-result-title {
      font-size: var(--text-sm);
      font-weight: var(--weight-medium);
      color: var(--color-text-primary);
      margin-bottom: 2px;
    }

    .search-result-meta {
      font-size: var(--text-xs);
      color: var(--color-text-muted);
    }

    .search-result-snippet {
      font-size: var(--text-xs);
      color: var(--color-text-secondary);
      margin-top: 4px;
    }

    .search-no-results,
    .search-loading {
      padding: var(--space-5);
      text-align: center;
      color: var(--color-text-muted);
      font-size: var(--text-sm);
    }

    .search-footer {
      padding: var(--space-3) var(--space-4);
      background: var(--color-surface-alt);
      border-top: 1px solid var(--color-border-light);
      font-size: var(--text-xs);
      color: var(--color-text-muted);
      text-align: center;
    }

    /* Bulk Selection Styles */
    .bulk-checkbox {
      width: 18px;
      height: 18px;
      cursor: pointer;
      accent-color: var(--color-primary);
    }

    .bulk-action-bar {
      display: none;
      background: var(--color-primary);
      color: var(--color-text-inverse);
      padding: var(--space-3) var(--space-4);
      border-radius: var(--radius-md);
      margin-bottom: var(--space-4);
      align-items: center;
      justify-content: space-between;
      gap: var(--space-4);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .bulk-action-bar.active {
      display: flex;
    }

    /* Sticky bulk action bar */
    .bulk-action-bar.sticky {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 1000;
      border-radius: 0;
      margin-bottom: 0;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
      animation: slideInFromTop 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    /* Animation when bar becomes sticky */
    @keyframes slideInFromTop {
      from {
        transform: translateY(-100%);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    /* Placeholder to prevent content jump when bar becomes fixed */
    .bulk-action-bar-placeholder {
      display: none;
      height: 52px;
      margin-bottom: var(--space-4);
    }

    .bulk-action-bar-placeholder.active {
      display: block;
    }

    .bulk-action-bar .selected-count {
      font-weight: var(--weight-medium);
    }

    .bulk-action-bar .bulk-actions {
      display: flex;
      gap: var(--space-2);
    }

    .bulk-action-bar .ds-btn {
      padding: 6px 12px;
      font-size: var(--text-sm);
    }

    .bulk-action-bar .ds-btn-danger {
      background: #dc2626;
      color: white;
      border: none;
    }

    .bulk-action-bar .ds-btn-danger:hover {
      background: #b91c1c;
    }

    /* Bulk Progress */
    .bulk-progress {
      display: none;
      background: var(--color-surface);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-md);
      padding: var(--space-4);
      margin-bottom: var(--space-4);
    }

    .bulk-progress.active {
      display: block;
    }

    .bulk-progress-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--space-3);
    }

    .bulk-progress-title {
      font-weight: var(--weight-medium);
      color: var(--color-text-primary);
    }

    .bulk-progress-bar {
      height: 8px;
      background: var(--color-bg);
      border-radius: 4px;
      overflow: hidden;
      margin-bottom: var(--space-2);
    }

    .bulk-progress-fill {
      height: 100%;
      background: var(--color-primary);
      border-radius: 4px;
      transition: width 0.3s ease;
    }

    .bulk-progress-stats {
      display: flex;
      gap: var(--space-4);
      font-size: var(--text-sm);
      color: var(--color-text-secondary);
    }

    /* Confirmation Modal */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .modal-overlay.active {
      display: flex;
    }

    .modal {
      background: var(--color-surface);
      border-radius: var(--radius-lg);
      padding: var(--space-6);
      max-width: 400px;
      width: 90%;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
    }

    .modal-title {
      font-size: var(--text-lg);
      font-weight: var(--weight-semibold);
      color: var(--color-text-primary);
      margin-bottom: var(--space-3);
    }

    .modal-body {
      color: var(--color-text-secondary);
      margin-bottom: var(--space-5);
    }

    .modal-actions {
      display: flex;
      justify-content: flex-end;
      gap: var(--space-3);
    }
  </style>
  <script src="/admin/js/view-mode.js"></script>
</head>
<body>
  <!-- Header -->
  <header class="ds-header">
    <div class="ds-header-inner">
      <a href="/admin/" class="ds-header-logo">
        <img src="/admin/logo.svg" alt="AffiliateFinder">
      </a>
      <div class="ds-header-divider"></div>
      <nav class="ds-header-nav">
        <a href="/admin/mrr.html">MRR</a>
        <a href="/admin/" class="active">Calls</a>
        <a href="/admin/lead-quality.html">Lead Quality</a>
        <a href="/admin/copy.html">Copy</a>
        <a href="/admin/phil.html">DFY</a>
        <a href="/admin/founder.html">Closing Rate</a>
      </nav>

      <!-- View Mode Indicator (shown when in user view) -->
      <div class="view-mode-indicator" id="viewModeIndicator" data-tooltip="You are viewing as a regular user">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
          <circle cx="12" cy="12" r="3"></circle>
        </svg>
        <span>User view</span>
      </div>

      <!-- User Menu -->
      <div class="ds-header-user">
        <button class="ds-user-button" id="userMenuBtn" aria-expanded="false" aria-haspopup="true" data-tooltip="Open user menu" data-tooltip-position="left">
          <div class="ds-user-avatar" id="userAvatar">-</div>
          <div class="ds-user-info">
            <span class="ds-user-name" id="userDisplayName">Loading...</span>
            <span class="ds-user-role" id="userDisplayRole">-</span>
          </div>
          <svg class="ds-user-chevron" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="6 9 12 15 18 9"></polyline>
          </svg>
        </button>

        <div class="ds-user-dropdown" id="userDropdown">
          <div class="ds-dropdown-header">
            <div class="ds-dropdown-email" id="userEmail">-</div>
            <span class="ds-dropdown-role user" id="userRoleBadge">User</span>
          </div>

          <div class="ds-dropdown-section">
            <a href="/admin/account.html" class="ds-dropdown-item">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                <circle cx="12" cy="7" r="4"></circle>
              </svg>
              Account
            </a>
            <a href="/admin/settings.html" class="ds-dropdown-item">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="3"></circle>
                <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
              </svg>
              Settings
            </a>
            <a href="/admin/changelog.html" class="ds-dropdown-item">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                <polyline points="14 2 14 8 20 8"></polyline>
                <line x1="16" y1="13" x2="8" y2="13"></line>
                <line x1="16" y1="17" x2="8" y2="17"></line>
                <polyline points="10 9 9 9 8 9"></polyline>
              </svg>
              Changelog
            </a>
          </div>

          <div class="ds-dropdown-divider ds-admin-only" style="display: none;"></div>

          <div class="ds-dropdown-section ds-admin-only" style="display: none;">
            <div class="ds-dropdown-label">Admin</div>
            <a href="/admin/access-requests.html" class="ds-dropdown-item">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                <circle cx="8.5" cy="7" r="4"></circle>
                <line x1="20" y1="8" x2="20" y2="14"></line>
                <line x1="23" y1="11" x2="17" y2="11"></line>
              </svg>
              Access Requests
            </a>
            <a href="/admin/users.html" class="ds-dropdown-item">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                <circle cx="9" cy="7" r="4"></circle>
                <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
              </svg>
              User Management
            </a>
          </div>

          <!-- View Mode Toggle (admin only) -->
          <div class="ds-dropdown-divider ds-admin-only" id="viewModeSection" style="display: none;"></div>
          <div class="ds-dropdown-section ds-admin-only" id="viewModeToggleContainer" style="display: none;">
            <button class="view-mode-toggle" id="viewModeToggle" onclick="ViewMode.toggleViewMode()" data-tooltip="Preview app as a regular user">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                <circle cx="12" cy="12" r="3"></circle>
              </svg>
              <span class="view-mode-label">User view</span>
            </button>
          </div>

          <div class="ds-dropdown-divider"></div>

          <div class="ds-dropdown-section">
            <button class="ds-dropdown-item danger" id="logoutBtn" data-tooltip="End session via POST /api/auth/logout">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                <polyline points="16 17 21 12 16 7"></polyline>
                <line x1="21" y1="12" x2="9" y2="12"></line>
              </svg>
              Sign Out
            </button>
          </div>
        </div>
      </div>
    </div>
  </header>

  <main class="ds-container ds-page">
    <!-- Page Header with Stats and Search -->
    <div class="ds-flex-between ds-mb-5">
      <div class="ds-grid ds-grid-2" style="max-width: 400px; gap: var(--space-4);">
        <div class="ds-stat-card">
          <div class="ds-stat-value" id="totalCalls">-</div>
          <div class="ds-stat-label">Total Calls</div>
        </div>
        <div class="ds-stat-card">
          <div class="ds-stat-value" id="lastSync" style="font-size: var(--text-lg);">Never</div>
          <div class="ds-stat-label">Last Sync</div>
          <div class="ds-stat-sublabel" id="lastSyncAgo"></div>
        </div>
      </div>
      <!-- Search moved to page level -->
      <div class="search-container" style="position: relative;">
        <svg class="search-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--color-text-muted);">
          <circle cx="11" cy="11" r="8"></circle>
          <path d="M21 21l-4.35-4.35"></path>
        </svg>
        <input type="text" class="ds-input" id="searchInput" placeholder="Search calls..." autocomplete="off" style="width: 280px; padding-left: 40px;">
        <div class="search-results" id="searchResults"></div>
      </div>
    </div>

    <!-- Sync Options - Dashboard Style -->
    <div class="ds-filters ds-mb-5">
      <div class="ds-filters-row">
        <div class="ds-filter-group">
          <label class="ds-filter-label">Date Range</label>
          <select class="ds-input" id="sync-date-preset" onchange="handleSyncDatePresetChange()">
            <option value="all" selected>All time</option>
            <option value="this_week">This week</option>
            <option value="last_week">Last week</option>
            <option value="last_month">Last month</option>
            <option value="last_3_months">Last 3 months</option>
            <option value="last_6_months">Last 6 months</option>
            <option value="custom">Custom range</option>
          </select>
        </div>
        <div class="ds-filter-group sync-custom-date" id="sync-start-group" style="display: none;">
          <label class="ds-filter-label">Start Date</label>
          <input type="date" class="ds-input" id="sync-start-date">
        </div>
        <div class="ds-filter-group sync-custom-date" id="sync-end-group" style="display: none;">
          <label class="ds-filter-label">End Date</label>
          <input type="date" class="ds-input" id="sync-end-date">
        </div>
        <div class="ds-filter-group">
          <label class="ds-filter-label">Sales Rep</label>
          <select class="ds-input" id="sync-rep-filter" onchange="handleRepFilterChange()">
            <option value="all" selected>All reps</option>
            <option value="Phil">Phil only</option>
            <option value="Jamie">Jamie only</option>
          </select>
        </div>
        <div class="ds-filter-group">
          <label class="ds-filter-label">View</label>
          <select class="ds-input" id="view-mode-filter" onchange="handleViewModeChange()">
            <option value="active" selected>Active Calls</option>
            <option value="deleted">Deleted Calls</option>
          </select>
        </div>
        <div class="ds-filter-actions">
          <button class="ds-btn ds-btn-primary" id="applyFiltersBtn" onclick="applyFilters()" data-tooltip="Filter calls by date and rep">Apply Filters</button>
          <button class="ds-btn ds-btn-secondary" id="syncBtn" onclick="triggerSync()" data-tooltip="Import new calls from Fireflies">Sync Calls</button>
          <button class="ds-btn ds-btn-secondary" id="refreshBtn" onclick="refreshFromLastSync()" data-tooltip="Fetch calls since last sync">Refresh</button>
        </div>
      </div>
    </div>

    <!-- Sync Status -->
    <div class="ds-alert ds-alert-info sync-status" id="syncStatus">
      <span id="syncStatusText"></span>
    </div>

    <!-- Bulk Action Bar -->
    <div class="bulk-action-bar-placeholder" id="bulkActionBarPlaceholder"></div>
    <div class="bulk-action-bar" id="bulkActionBar">
      <span class="selected-count"><span id="selectedCount">0</span> calls selected</span>
      <div class="bulk-actions" id="activeBulkActions">
        <button class="ds-btn ds-btn-secondary" onclick="bulkAnalyze()" data-tooltip="Run AI analysis on selected calls">Analyze Selected</button>
        <button class="ds-btn ds-btn-danger" onclick="showDeleteModal()" data-tooltip="Move selected calls to Deleted. Can be restored later.">Delete Selected</button>
        <button class="ds-btn ds-btn-secondary" onclick="clearSelection()" data-tooltip="Deselect all calls">Clear</button>
      </div>
      <div class="bulk-actions" id="deletedBulkActions" style="display: none;">
        <button class="ds-btn ds-btn-primary" onclick="bulkRestore()" data-tooltip="Restore selected calls back to Active Calls list">Restore Selected</button>
        <button class="ds-btn ds-btn-secondary" onclick="clearSelection()" data-tooltip="Deselect all calls">Clear</button>
      </div>
    </div>

    <!-- Bulk Analysis Progress -->
    <div class="bulk-progress" id="bulkProgress">
      <div class="bulk-progress-header">
        <span class="bulk-progress-title">Analyzing calls...</span>
        <button class="ds-btn ds-btn-secondary" style="padding: 4px 8px; font-size: var(--text-xs);" onclick="cancelBulkAnalysis()" data-tooltip="Stop bulk analysis in progress">Cancel</button>
      </div>
      <div class="bulk-progress-bar">
        <div class="bulk-progress-fill" id="bulkProgressFill" style="width: 0%"></div>
      </div>
      <div class="bulk-progress-stats">
        <span><span id="bulkProcessed">0</span> / <span id="bulkTotal">0</span> processed</span>
        <span><span id="bulkAnalyzed">0</span> analyzed</span>
        <span><span id="bulkAlreadyAnalyzed">0</span> already analyzed</span>
        <span><span id="bulkNotSales">0</span> not sales</span>
        <span><span id="bulkErrors">0</span> errors</span>
      </div>
    </div>

    <!-- Recent Calls -->
    <div class="ds-card ds-mb-5">
      <div class="ds-card-header" style="display: flex; justify-content: space-between; align-items: center;">
        <div class="ds-card-title">Calls</div>
        <div class="pagination-controls" style="display: flex; align-items: center; gap: var(--space-3);">
          <label style="font-size: var(--text-sm); color: var(--color-text-secondary);">Show:</label>
          <select id="pageSizeSelect" class="ds-input" style="width: auto; padding: 6px 12px; font-size: var(--text-sm);" onchange="changePageSize()">
            <option value="20">20</option>
            <option value="50">50</option>
            <option value="100">100</option>
            <option value="all" selected>All</option>
          </select>
        </div>
      </div>
      <div id="callsTable">
        <div class="ds-loading">
          <div class="ds-spinner"></div>
          <div class="ds-loading-text">Loading calls...</div>
        </div>
      </div>
      <!-- Pagination Footer -->
      <div id="paginationFooter" class="pagination-footer" style="padding: var(--space-4); border-top: 1px solid var(--color-border); justify-content: space-between; align-items: center; display: none;">
        <div id="paginationInfo" style="font-size: var(--text-sm); color: var(--color-text-secondary);">
          Showing 1-20 of 79 calls
        </div>
        <div class="pagination-buttons" style="display: flex; gap: var(--space-2);">
          <button class="ds-btn ds-btn-secondary" id="prevPageBtn" onclick="prevPage()" disabled style="padding: 6px 12px;" data-tooltip="Go to previous page of calls">
            ← Previous
          </button>
          <button class="ds-btn ds-btn-secondary" id="nextPageBtn" onclick="nextPage()" style="padding: 6px 12px;" data-tooltip="Go to next page of calls">
            Next →
          </button>
        </div>
      </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal-overlay" id="deleteModal">
      <div class="modal">
        <div class="modal-title">Delete Calls</div>
        <div class="modal-body">
          Move <strong id="deleteCount">0</strong> calls to Deleted? These calls will be hidden from the active list and excluded from analysis. You can restore them later from the "Deleted Calls" view.
        </div>
        <div class="modal-actions">
          <button class="ds-btn ds-btn-secondary" onclick="hideDeleteModal()" data-tooltip="Close modal without deleting">Cancel</button>
          <button class="ds-btn ds-btn-danger" onclick="confirmDelete()" data-tooltip="Move calls to Deleted">Delete</button>
        </div>
      </div>
    </div>

    <!-- Sync History (collapsible) -->
    <details class="ds-card">
      <summary class="ds-card-header" style="cursor: pointer; list-style: none;">
        <div class="ds-card-title">Sync History</div>
        <span class="ds-text-muted" style="font-size: var(--text-xs);">Click to expand</span>
      </summary>
      <div id="syncHistory" style="padding: var(--space-4);">
        <div class="ds-loading">
          <div class="ds-spinner"></div>
        </div>
      </div>
    </details>
  </main>

  <script>
    const API_BASE = '/api';
    let lastSyncTime = null; // Track the last sync time for refresh functionality
    let currentUser = null;

    // ========================================
    // Filter State Management
    // ========================================
    // Applied filters = what's currently active (used for data fetching)
    // Draft filters = what user is editing in the UI (not yet applied)
    let appliedFilters = {
      datePreset: 'all',
      startDate: null,
      endDate: null,
      repFilter: 'all',
      viewMode: 'active'  // 'active' or 'deleted'
    };

    // ========================================
    // URL Filter Persistence
    // ========================================
    // Read filter state from URL parameters
    function getFiltersFromURL() {
      const params = new URLSearchParams(window.location.search);
      const filters = {};

      if (params.has('preset')) filters.datePreset = params.get('preset');
      if (params.has('start')) filters.startDate = params.get('start');
      if (params.has('end')) filters.endDate = params.get('end');
      if (params.has('rep')) filters.repFilter = params.get('rep');
      if (params.has('view')) filters.viewMode = params.get('view');

      return Object.keys(filters).length > 0 ? filters : null;
    }

    // Update URL with current filter state (without page reload)
    function updateURLWithFilters(filters) {
      const params = new URLSearchParams();

      if (filters.datePreset && filters.datePreset !== 'all') {
        params.set('preset', filters.datePreset);
      }
      if (filters.datePreset === 'custom') {
        if (filters.startDate) params.set('start', filters.startDate);
        if (filters.endDate) params.set('end', filters.endDate);
      }
      if (filters.repFilter && filters.repFilter !== 'all') {
        params.set('rep', filters.repFilter);
      }
      if (filters.viewMode && filters.viewMode !== 'active') {
        params.set('view', filters.viewMode);
      }

      const newURL = params.toString()
        ? `${window.location.pathname}?${params.toString()}`
        : window.location.pathname;

      window.history.replaceState({ filters }, '', newURL);
    }

    // Sync UI controls with filter state
    function syncUIWithFilters(filters) {
      // Set date preset
      const presetSelect = document.getElementById('sync-date-preset');
      if (presetSelect && filters.datePreset) {
        presetSelect.value = filters.datePreset;
      }

      // Handle custom date visibility and values
      const startGroup = document.getElementById('sync-start-group');
      const endGroup = document.getElementById('sync-end-group');

      if (filters.datePreset === 'custom') {
        startGroup.style.display = '';
        endGroup.style.display = '';
        if (filters.startDate) document.getElementById('sync-start-date').value = filters.startDate;
        if (filters.endDate) document.getElementById('sync-end-date').value = filters.endDate;
      } else {
        startGroup.style.display = 'none';
        endGroup.style.display = 'none';
      }

      // Set rep filter
      const repSelect = document.getElementById('sync-rep-filter');
      if (repSelect && filters.repFilter) {
        repSelect.value = filters.repFilter;
      }

      // Set view mode
      const viewModeSelect = document.getElementById('view-mode-filter');
      if (viewModeSelect && filters.viewMode) {
        viewModeSelect.value = filters.viewMode;
        updateBulkActionsForViewMode(filters.viewMode);
      }
    }

    // Update bulk actions bar based on view mode
    function updateBulkActionsForViewMode(viewMode) {
      const activeBulkActions = document.getElementById('activeBulkActions');
      const deletedBulkActions = document.getElementById('deletedBulkActions');

      if (viewMode === 'deleted') {
        activeBulkActions.style.display = 'none';
        deletedBulkActions.style.display = 'flex';
      } else {
        activeBulkActions.style.display = 'flex';
        deletedBulkActions.style.display = 'none';
      }
    }

    // Handle view mode change
    function handleViewModeChange() {
      const viewMode = document.getElementById('view-mode-filter').value;
      appliedFilters.viewMode = viewMode;
      updateBulkActionsForViewMode(viewMode);
      clearSelection();
      loadDashboard();
      updateURLWithFilters(appliedFilters);
    }

    // Initialize applied filters from URL or default preset
    function initAppliedFilters() {
      const urlFilters = getFiltersFromURL();

      if (urlFilters) {
        // Restore from URL
        appliedFilters.datePreset = urlFilters.datePreset || 'all';
        appliedFilters.repFilter = urlFilters.repFilter || 'all';

        if (urlFilters.datePreset === 'custom') {
          appliedFilters.startDate = urlFilters.startDate || null;
          appliedFilters.endDate = urlFilters.endDate || null;
        } else {
          const range = getSyncDatePresetRange(appliedFilters.datePreset);
          appliedFilters.startDate = range.startDate;
          appliedFilters.endDate = range.endDate;
        }

        // Sync UI with restored filters
        syncUIWithFilters(appliedFilters);
      } else {
        // Use defaults (All time, All reps - shows all calls)
        const range = getSyncDatePresetRange('all');
        appliedFilters.startDate = range.startDate;
        appliedFilters.endDate = range.endDate;
      }
    }

    // Get current draft filter values from UI
    function getDraftFilters() {
      const preset = document.getElementById('sync-date-preset').value;
      const range = getSyncDatePresetRange(preset);
      return {
        datePreset: preset,
        startDate: range.startDate,
        endDate: range.endDate,
        repFilter: document.getElementById('sync-rep-filter').value
      };
    }

    // Apply filters: copy draft to applied and reload data
    function applyFilters() {
      const draft = getDraftFilters();
      appliedFilters = { ...draft };

      // Update URL with new filter state
      updateURLWithFilters(appliedFilters);

      // Reset pagination when filters change
      paginationState.currentPage = 1;

      // Reload calls with new filters
      loadCalls();

      // Show confirmation
      showSyncStatus('Filters applied', 'success');
    }

    // Handle browser back/forward navigation
    window.addEventListener('popstate', (event) => {
      if (event.state && event.state.filters) {
        appliedFilters = { ...event.state.filters };
        syncUIWithFilters(appliedFilters);
        paginationState.currentPage = 1;
        loadCalls();
      }
    });

    // ========================================
    // User Menu Functions
    // ========================================

    async function initUserMenu() {
      try {
        const response = await fetch('/api/auth/me', { credentials: 'include' });
        if (!response.ok) {
          window.location.href = '/admin/login.html';
          return;
        }
        const data = await response.json();
        currentUser = data.user;

        // Update user display
        const initials = (currentUser.name || currentUser.email || '?')
          .split(' ')
          .map(n => n[0])
          .join('')
          .substring(0, 2)
          .toUpperCase();

        document.getElementById('userAvatar').textContent = initials;
        document.getElementById('userDisplayName').textContent = currentUser.name || currentUser.email.split('@')[0];
        document.getElementById('userDisplayRole').textContent = currentUser.role === 'admin' ? 'Admin' : 'User';
        document.getElementById('userEmail').textContent = currentUser.email;

        const roleBadge = document.getElementById('userRoleBadge');
        roleBadge.textContent = currentUser.role === 'admin' ? 'Admin' : 'User';
        roleBadge.className = 'ds-dropdown-role ' + (currentUser.role === 'admin' ? 'admin' : 'user');

        // Show admin-only items
        if (currentUser.role === 'admin') {
          document.querySelectorAll('.ds-admin-only').forEach(el => {
            el.style.display = '';
          });
        }

        // Initialize view mode (must be after admin-only elements are shown)
        if (window.ViewMode) {
          ViewMode.initViewMode(currentUser.role);
        }
      } catch (error) {
        console.error('Error loading user:', error);
        window.location.href = '/admin/login.html';
      }
    }

    function setupUserMenu() {
      const userMenuBtn = document.getElementById('userMenuBtn');
      const userDropdown = document.getElementById('userDropdown');
      const logoutBtn = document.getElementById('logoutBtn');

      if (userMenuBtn && userDropdown) {
        userMenuBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          const isOpen = userDropdown.classList.toggle('open');
          userMenuBtn.setAttribute('aria-expanded', isOpen);
        });

        document.addEventListener('click', (e) => {
          if (!e.target.closest('.ds-header-user')) {
            userDropdown.classList.remove('open');
            userMenuBtn.setAttribute('aria-expanded', 'false');
          }
        });

        document.addEventListener('keydown', (e) => {
          if (e.key === 'Escape' && userDropdown.classList.contains('open')) {
            userDropdown.classList.remove('open');
            userMenuBtn.setAttribute('aria-expanded', 'false');
          }
        });
      }

      if (logoutBtn) {
        logoutBtn.addEventListener('click', async () => {
          try {
            await fetch('/api/auth/logout', {
              method: 'POST',
              credentials: 'include'
            });
          } catch (error) {
            console.error('Logout error:', error);
          }
          window.location.href = '/admin/login.html';
        });
      }
    }

    // Pagination state
    let paginationState = {
      pageSize: 'all',  // 20, 50, 100, or 'all'
      currentPage: 1,
      totalCalls: 0,
      totalPages: 1
    };

    // Initialize date range based on preset
    function initDateRange() {
      handleSyncDatePresetChange();
    }

    // Date preset computation utilities (uses browser timezone, week starts Monday)
    function getSyncDatePresetRange(preset) {
      const now = new Date();
      const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());

      switch (preset) {
        case 'all':
          return { startDate: null, endDate: null };

        case 'this_week': {
          const dayOfWeek = today.getDay();
          const daysFromMonday = dayOfWeek === 0 ? 6 : dayOfWeek - 1;
          const monday = new Date(today);
          monday.setDate(today.getDate() - daysFromMonday);
          const sunday = new Date(monday);
          sunday.setDate(monday.getDate() + 6);
          return { startDate: formatDateForInput(monday), endDate: formatDateForInput(sunday) };
        }

        case 'last_week': {
          const dayOfWeek = today.getDay();
          const daysFromMonday = dayOfWeek === 0 ? 6 : dayOfWeek - 1;
          const thisMonday = new Date(today);
          thisMonday.setDate(today.getDate() - daysFromMonday);
          const lastMonday = new Date(thisMonday);
          lastMonday.setDate(thisMonday.getDate() - 7);
          const lastSunday = new Date(lastMonday);
          lastSunday.setDate(lastMonday.getDate() + 6);
          return { startDate: formatDateForInput(lastMonday), endDate: formatDateForInput(lastSunday) };
        }

        case 'last_month': {
          const firstOfThisMonth = new Date(today.getFullYear(), today.getMonth(), 1);
          const lastOfLastMonth = new Date(firstOfThisMonth);
          lastOfLastMonth.setDate(lastOfLastMonth.getDate() - 1);
          const firstOfLastMonth = new Date(lastOfLastMonth.getFullYear(), lastOfLastMonth.getMonth(), 1);
          return { startDate: formatDateForInput(firstOfLastMonth), endDate: formatDateForInput(lastOfLastMonth) };
        }

        case 'last_3_months': {
          const threeMonthsAgo = new Date(today.getFullYear(), today.getMonth() - 3, today.getDate());
          return { startDate: formatDateForInput(threeMonthsAgo), endDate: formatDateForInput(today) };
        }

        case 'last_6_months': {
          const sixMonthsAgo = new Date(today.getFullYear(), today.getMonth() - 6, today.getDate());
          return { startDate: formatDateForInput(sixMonthsAgo), endDate: formatDateForInput(today) };
        }

        case 'custom':
          return {
            startDate: document.getElementById('sync-start-date').value || null,
            endDate: document.getElementById('sync-end-date').value || null
          };

        default:
          return { startDate: null, endDate: null };
      }
    }

    // Handle date preset change - auto-apply filters when preset changes
    function handleSyncDatePresetChange() {
      const preset = document.getElementById('sync-date-preset').value;
      const startGroup = document.getElementById('sync-start-group');
      const endGroup = document.getElementById('sync-end-group');

      if (preset === 'custom') {
        // Show custom date inputs
        startGroup.style.display = '';
        endGroup.style.display = '';
      } else {
        // Hide custom date inputs and set dates based on preset
        startGroup.style.display = 'none';
        endGroup.style.display = 'none';

        const range = getSyncDatePresetRange(preset);
        document.getElementById('sync-start-date').value = range.startDate || '';
        document.getElementById('sync-end-date').value = range.endDate || '';

        // Auto-apply filter when preset changes (except on initial load)
        if (document.readyState === 'complete') {
          applyFilters();
        }
      }
    }

    // Handle rep filter change - auto-apply
    function handleRepFilterChange() {
      if (document.readyState === 'complete') {
        applyFilters();
      }
    }

    // Refresh from last sync till now
    async function refreshFromLastSync() {
      if (!lastSyncTime) {
        showSyncStatus('No previous sync found. Please use "Sync Calls" first.', 'error');
        return;
      }

      // Use applied filters for refresh (not draft UI values)
      const repFilter = appliedFilters.repFilter;
      const startDate = new Date(lastSyncTime);
      const endDate = new Date();

      const btn = document.getElementById('refreshBtn');
      btn.disabled = true;
      btn.innerHTML = '<span class="ds-spinner ds-spinner-sm"></span> Refreshing...';

      const repLabel = repFilter === 'all' ? 'all reps' : `${repFilter} only`;
      showSyncStatus(`Refreshing calls from last sync (${formatDateForInput(startDate)}) to now (${repLabel})...`, 'active');

      try {
        const response = await fetch(`${API_BASE}/sync/date-range`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            startDate: formatDateForInput(startDate),
            endDate: formatDateForInput(endDate),
            fetchDetails: true,
            repFilter
          })
        });

        const data = await response.json();

        if (!data.success) {
          throw new Error(data.error || 'Refresh failed');
        }

        const skipped = data.stats.skipped || 0;
        const skippedByRep = data.stats.skipped_by_rep || 0;
        let message = `Refresh complete. ${data.stats.new} new calls added.`;
        if (skipped > 0) {
          message += ` ${skipped} already existed.`;
        }
        if (skippedByRep > 0) {
          message += ` ${skippedByRep} skipped by rep filter.`;
        }

        showSyncStatus(message, 'success');
        await loadDashboard();

      } catch (error) {
        console.error('Refresh error:', error);
        showSyncStatus('Refresh failed: ' + error.message, 'error');

      } finally {
        btn.disabled = false;
        btn.innerHTML = 'Refresh';
      }
    }

    function formatDateForInput(date) {
      return date.toISOString().split('T')[0];
    }

    function formatDuration(seconds) {
      if (!seconds && seconds !== 0) return '-';
      if (seconds === 0) return '0 mins';

      // Convert to total minutes (rounded)
      const totalMins = Math.round(seconds / 60);

      if (totalMins === 0) return '< 1 min';
      if (totalMins === 1) return '1 min';
      return `${totalMins} mins`;
    }

    function formatDateTime(dateStr) {
      if (!dateStr) return '-';
      const date = new Date(dateStr);
      return date.toLocaleString('en-US', {
        month: 'short',
        day: 'numeric',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
    }

    function timeAgo(dateStr) {
      if (!dateStr) return '';
      const date = new Date(dateStr);
      const now = new Date();
      const diffMs = now - date;
      const diffMins = Math.floor(diffMs / 60000);
      const diffHours = Math.floor(diffMs / 3600000);
      const diffDays = Math.floor(diffMs / 86400000);

      if (diffMins < 1) return 'Just now';
      if (diffMins < 60) return `${diffMins} min ago`;
      if (diffHours < 24) return `${diffHours} hours ago`;
      return `${diffDays} days ago`;
    }

    async function loadDashboard() {
      try {
        // First load dashboard stats and sync history
        const dashboardResponse = await fetch(`${API_BASE}/admin/dashboard`);
        const dashboardData = await dashboardResponse.json();

        if (!dashboardData.success) {
          throw new Error(dashboardData.error || 'Failed to load dashboard');
        }

        // Store total calls for pagination
        paginationState.totalCalls = dashboardData.data.stats.totalCalls || 0;
        document.getElementById('totalCalls').textContent = paginationState.totalCalls;

        const syncTime = dashboardData.data.stats.lastSyncTime;
        lastSyncTime = syncTime; // Store for refresh functionality
        if (syncTime) {
          document.getElementById('lastSync').textContent = formatDateTime(syncTime).split(',')[0];
          document.getElementById('lastSyncAgo').textContent = timeAgo(syncTime);
        } else {
          document.getElementById('lastSync').textContent = 'Never';
          document.getElementById('lastSyncAgo').textContent = '';
        }

        renderSyncHistory(dashboardData.data.syncHistory);

        if (dashboardData.data.syncStatus.inProgress) {
          showSyncStatus('Sync in progress...', 'active');
        }

        // Now load calls with pagination
        await loadCalls();

      } catch (error) {
        console.error('Error loading dashboard:', error);
        showSyncStatus('Error loading dashboard: ' + error.message, 'error');
      }
    }

    // Load calls with pagination and applied filters
    async function loadCalls() {
      try {
        const pageSize = paginationState.pageSize;
        const isShowAll = pageSize === 'all';
        const limit = isShowAll ? 1000 : parseInt(pageSize);
        const offset = isShowAll ? 0 : (paginationState.currentPage - 1) * limit;

        // Build query params using applied filters
        const params = new URLSearchParams({
          limit: limit.toString(),
          offset: offset.toString()
        });

        // Add applied filters to request
        if (appliedFilters.startDate) {
          params.append('startDate', appliedFilters.startDate);
        }
        if (appliedFilters.endDate) {
          params.append('endDate', appliedFilters.endDate);
        }
        if (appliedFilters.repFilter && appliedFilters.repFilter !== 'all') {
          params.append('rep', appliedFilters.repFilter);
        }

        // Determine endpoint based on view mode
        const isDeletedView = appliedFilters.viewMode === 'deleted';
        const endpoint = isDeletedView ? `${API_BASE}/admin/deleted` : `${API_BASE}/admin/calls`;

        console.log('[Calls] Loading with filters:', {
          preset: appliedFilters.datePreset,
          startDate: appliedFilters.startDate,
          endDate: appliedFilters.endDate,
          rep: appliedFilters.repFilter,
          viewMode: appliedFilters.viewMode,
          url: `${endpoint}?${params.toString()}`
        });

        const response = await fetch(`${endpoint}?${params.toString()}`);
        const data = await response.json();

        if (!data.success) {
          throw new Error(data.error || 'Failed to load calls');
        }

        // Update pagination state
        paginationState.totalCalls = data.data.pagination.total;
        paginationState.totalPages = isShowAll ? 1 : Math.ceil(data.data.pagination.total / limit);

        // Update the TOTAL CALLS stat card to show filtered count
        document.getElementById('totalCalls').textContent = paginationState.totalCalls;

        // Render calls
        renderCallsTable(data.data.calls);
        updatePaginationUI();

      } catch (error) {
        console.error('Error loading calls:', error);
        showSyncStatus('Error loading calls: ' + error.message, 'error');
      }
    }

    // Pagination control functions
    function changePageSize() {
      const select = document.getElementById('pageSizeSelect');
      paginationState.pageSize = select.value;
      paginationState.currentPage = 1;  // Reset to first page
      loadCalls();
    }

    function prevPage() {
      if (paginationState.currentPage > 1) {
        paginationState.currentPage--;
        loadCalls();
      }
    }

    function nextPage() {
      if (paginationState.currentPage < paginationState.totalPages) {
        paginationState.currentPage++;
        loadCalls();
      }
    }

    function updatePaginationUI() {
      const footer = document.getElementById('paginationFooter');
      const info = document.getElementById('paginationInfo');
      const prevBtn = document.getElementById('prevPageBtn');
      const nextBtn = document.getElementById('nextPageBtn');

      const isShowAll = paginationState.pageSize === 'all';
      const total = paginationState.totalCalls;

      if (isShowAll || paginationState.totalPages <= 1) {
        // Show all - hide pagination controls but show info
        footer.style.display = 'flex';
        info.textContent = `Showing all ${total} calls`;
        prevBtn.style.display = 'none';
        nextBtn.style.display = 'none';
      } else {
        // Show pagination
        footer.style.display = 'flex';
        prevBtn.style.display = 'inline-flex';
        nextBtn.style.display = 'inline-flex';

        const pageSize = parseInt(paginationState.pageSize);
        const start = (paginationState.currentPage - 1) * pageSize + 1;
        const end = Math.min(paginationState.currentPage * pageSize, total);

        info.textContent = `Showing ${start}-${end} of ${total} calls (Page ${paginationState.currentPage}/${paginationState.totalPages})`;

        // Update button states
        prevBtn.disabled = paginationState.currentPage <= 1;
        nextBtn.disabled = paginationState.currentPage >= paginationState.totalPages;
      }
    }

    // Track current calls for bulk selection
    let currentCalls = [];
    let selectedCallIds = new Set();

    function renderCallsTable(calls) {
      const container = document.getElementById('callsTable');
      currentCalls = calls || [];
      selectedCallIds.clear();
      updateBulkActionBar();

      const isDeletedView = appliedFilters.viewMode === 'deleted';

      if (!calls || calls.length === 0) {
        const emptyMessage = isDeletedView
          ? 'No deleted calls'
          : 'No calls synced yet';
        const emptyButton = isDeletedView
          ? ''
          : '<button class="ds-btn ds-btn-primary ds-mt-4" onclick="triggerSync()" data-tooltip="Import calls from Fireflies via POST /api/sync">Sync Now</button>';
        container.innerHTML = `
          <div class="ds-empty">
            <div class="ds-empty-text">${emptyMessage}</div>
            ${emptyButton}
          </div>
        `;
        return;
      }

      // Different table for deleted view
      if (isDeletedView) {
        container.innerHTML = `
          <div class="ds-table-container" style="border: none; box-shadow: none;">
            <table class="ds-table">
              <thead>
                <tr>
                  <th style="width: 40px;"><input type="checkbox" class="bulk-checkbox" id="selectAllCheckbox" onchange="toggleSelectAll(this)"></th>
                  <th>Call Title</th>
                  <th>Rep</th>
                  <th>Call Date</th>
                  <th>Deleted</th>
                  <th>Reason</th>
                  <th></th>
                </tr>
              </thead>
              <tbody>
                ${calls.map(call => {
                  const deletedReasonText = formatDeletedReason(call.deletedReason);
                  return `
                  <tr data-call-id="${call.id}">
                    <td><input type="checkbox" class="bulk-checkbox call-checkbox" data-id="${call.id}" onchange="toggleCallSelection('${call.id}', this)"></td>
                    <td><a href="/admin/call.html?id=${call.id}" class="call-link">${escapeHtml(call.title || 'Untitled')}</a></td>
                    <td><span class="rep-badge ${getRepClass(call.rep)}">${getRepDisplayName(call.rep)}</span></td>
                    <td>${formatDateTime(call.datetime)}</td>
                    <td>${formatDateTime(call.deletedAt)}</td>
                    <td><span class="ds-badge ds-badge-${deletedReasonText.badgeType}" data-tooltip="${escapeHtml(call.deletedReason || 'manual')}">${deletedReasonText.label}</span></td>
                    <td><button class="ds-btn ds-btn-secondary" style="padding: 4px 8px; font-size: var(--text-xs);" onclick="restoreSingleCall('${call.id}')" data-tooltip="Restore this call to the active list">Restore</button></td>
                  </tr>
                `;}).join('')}
              </tbody>
            </table>
          </div>
        `;
      } else {
        container.innerHTML = `
          <div class="ds-table-container" style="border: none; box-shadow: none;">
            <table class="ds-table">
              <thead>
                <tr>
                  <th style="width: 40px;"><input type="checkbox" class="bulk-checkbox" id="selectAllCheckbox" onchange="toggleSelectAll(this)"></th>
                  <th>Call Title</th>
                  <th>Rep</th>
                  <th>Date</th>
                  <th>Duration</th>
                  <th>Classification</th>
                  <th>Status</th>
                  <th></th>
                </tr>
              </thead>
              <tbody>
                ${calls.map(call => {
                  const effectiveClass = call.classificationOverride || call.classification;
                  const isOverridden = !!call.classificationOverride;
                  return `
                  <tr data-call-id="${call.id}">
                    <td><input type="checkbox" class="bulk-checkbox call-checkbox" data-id="${call.id}" onchange="toggleCallSelection('${call.id}', this)"></td>
                    <td><a href="/admin/call.html?id=${call.id}" class="call-link">${escapeHtml(call.title || 'Untitled')}</a></td>
                    <td><span class="rep-badge ${getRepClass(call.rep)}">${getRepDisplayName(call.rep)}</span></td>
                    <td>${formatDateTime(call.datetime)}</td>
                    <td class="duration">${formatDuration(call.duration)}</td>
                    <td>
                      <select class="classification-select" data-call-id="${call.id}" onchange="updateClassification('${call.id}', this.value)">
                        <option value="SALES" ${effectiveClass === 'SALES' ? 'selected' : ''}>Sales</option>
                        <option value="NOT_SALES" ${effectiveClass === 'NOT_SALES' ? 'selected' : ''}>Not Sales</option>
                        <option value="REVIEW_NEEDED" ${effectiveClass === 'REVIEW_NEEDED' ? 'selected' : ''}>Review</option>
                      </select>
                      ${isOverridden ? '<span style="font-size: 10px; color: var(--color-text-muted); margin-left: 4px;" title="Manually overridden">✎</span>' : ''}
                    </td>
                    <td>
                      ${call.hasAnalysis
                        ? '<span class="ds-badge ds-badge-success">Analyzed</span>'
                        : '<span class="ds-badge">Pending</span>'}
                    </td>
                    <td><a href="/admin/call.html?id=${call.id}" class="view-link">View</a></td>
                  </tr>
                `;}).join('')}
              </tbody>
            </table>
          </div>
        `;
      }
    }

    // Format deleted reason for display
    function formatDeletedReason(reason) {
      if (!reason) return { label: 'Manual', badgeType: '' };
      if (reason === 'manual') return { label: 'Manual', badgeType: '' };
      if (reason.startsWith('auto-filter:')) {
        const filterType = reason.replace('auto-filter:', '');
        if (filterType === 'weekly') return { label: 'Auto: Weekly', badgeType: 'info' };
        if (filterType === 'jour-fixe') return { label: 'Auto: Jour Fixe', badgeType: 'info' };
        if (filterType === 'dev') return { label: 'Auto: Dev', badgeType: 'info' };
        return { label: `Auto: ${filterType}`, badgeType: 'info' };
      }
      return { label: reason, badgeType: '' };
    }

    // Restore a single call
    async function restoreSingleCall(callId) {
      showSyncStatus('Restoring call...', 'active');
      try {
        const response = await fetch(`${API_BASE}/admin/calls/${callId}/restore`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });
        const data = await response.json();
        if (!data.success) {
          throw new Error(data.error || 'Restore failed');
        }
        showSyncStatus('Call restored successfully. It is now visible in "Active Calls".', 'success');
        await loadDashboard();
      } catch (error) {
        console.error('Restore error:', error);
        showSyncStatus('Restore failed: ' + error.message, 'error');
      }
    }

    // Bulk selection functions
    function toggleSelectAll(checkbox) {
      const isChecked = checkbox.checked;
      document.querySelectorAll('.call-checkbox').forEach(cb => {
        cb.checked = isChecked;
        const id = cb.dataset.id;
        if (isChecked) {
          selectedCallIds.add(id);
        } else {
          selectedCallIds.delete(id);
        }
      });
      updateBulkActionBar();
    }

    function toggleCallSelection(callId, checkbox) {
      if (checkbox.checked) {
        selectedCallIds.add(callId);
      } else {
        selectedCallIds.delete(callId);
      }
      updateSelectAllCheckbox();
      updateBulkActionBar();
    }

    function updateSelectAllCheckbox() {
      const selectAll = document.getElementById('selectAllCheckbox');
      if (!selectAll) return;
      const allCheckboxes = document.querySelectorAll('.call-checkbox');
      const checkedCount = document.querySelectorAll('.call-checkbox:checked').length;
      selectAll.checked = allCheckboxes.length > 0 && checkedCount === allCheckboxes.length;
      selectAll.indeterminate = checkedCount > 0 && checkedCount < allCheckboxes.length;
    }

    function updateBulkActionBar() {
      const bar = document.getElementById('bulkActionBar');
      const placeholder = document.getElementById('bulkActionBarPlaceholder');
      const count = document.getElementById('selectedCount');
      count.textContent = selectedCallIds.size;
      if (selectedCallIds.size > 0) {
        bar.classList.add('active');
        placeholder.classList.add('active');
        // Check if we need sticky state
        handleBulkBarSticky();
      } else {
        bar.classList.remove('active');
        bar.classList.remove('sticky');
        placeholder.classList.remove('active');
      }
    }

    // Handle sticky behavior for bulk action bar
    let bulkBarOriginalTop = null;

    function handleBulkBarSticky() {
      const bar = document.getElementById('bulkActionBar');
      const placeholder = document.getElementById('bulkActionBarPlaceholder');

      if (!bar.classList.contains('active')) return;

      // Get the placeholder position (original position of the bar)
      const placeholderRect = placeholder.getBoundingClientRect();

      // If the placeholder is above the viewport, make the bar sticky
      if (placeholderRect.top < 0) {
        if (!bar.classList.contains('sticky')) {
          bar.classList.add('sticky');
        }
      } else {
        bar.classList.remove('sticky');
      }
    }

    // Listen for scroll events with throttling for performance
    let scrollTimeout;
    window.addEventListener('scroll', () => {
      if (scrollTimeout) return;
      scrollTimeout = setTimeout(() => {
        handleBulkBarSticky();
        scrollTimeout = null;
      }, 10);
    }, { passive: true });

    function clearSelection() {
      selectedCallIds.clear();
      document.querySelectorAll('.call-checkbox').forEach(cb => cb.checked = false);
      const selectAll = document.getElementById('selectAllCheckbox');
      if (selectAll) selectAll.checked = false;
      updateBulkActionBar();
    }

    // Delete modal functions
    function showDeleteModal() {
      document.getElementById('deleteCount').textContent = selectedCallIds.size;
      document.getElementById('deleteModal').classList.add('active');
    }

    function hideDeleteModal() {
      document.getElementById('deleteModal').classList.remove('active');
    }

    async function confirmDelete() {
      hideDeleteModal();
      const ids = Array.from(selectedCallIds);

      showSyncStatus(`Deleting ${ids.length} calls...`, 'active');

      try {
        const response = await fetch(`${API_BASE}/bulk/delete`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ ids })
        });

        const data = await response.json();

        if (!data.success && data.deletedCount === 0) {
          throw new Error(data.error || 'Delete failed');
        }

        showSyncStatus(`Deleted ${data.deletedCount} calls. View them in "Deleted Calls" to restore.`, 'success');
        clearSelection();
        await loadDashboard();

      } catch (error) {
        console.error('Delete error:', error);
        showSyncStatus('Delete failed: ' + error.message, 'error');
      }
    }

    // Bulk restore function (for deleted calls view)
    async function bulkRestore() {
      const ids = Array.from(selectedCallIds);
      if (ids.length === 0) return;

      showSyncStatus(`Restoring ${ids.length} calls...`, 'active');

      try {
        const response = await fetch(`${API_BASE}/bulk/restore`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ ids })
        });

        const data = await response.json();

        if (!data.success && data.restoredCount === 0) {
          throw new Error(data.error || 'Restore failed');
        }

        showSyncStatus(`Restored ${data.restoredCount} calls. They are now visible in "Active Calls".`, 'success');
        clearSelection();
        await loadDashboard();

      } catch (error) {
        console.error('Restore error:', error);
        showSyncStatus('Restore failed: ' + error.message, 'error');
      }
    }

    // Bulk analysis functions
    let bulkAnalysisPolling = null;

    async function bulkAnalyze() {
      const ids = Array.from(selectedCallIds);
      if (ids.length === 0) return;

      try {
        const response = await fetch(`${API_BASE}/bulk/analyze`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ ids })
        });

        const data = await response.json();

        if (!data.success) {
          throw new Error(data.error || 'Analysis failed to start');
        }

        // Show progress bar
        document.getElementById('bulkProgress').classList.add('active');
        document.getElementById('bulkTotal').textContent = ids.length;
        clearSelection();

        // Start polling for progress
        startProgressPolling();

      } catch (error) {
        console.error('Bulk analyze error:', error);
        showSyncStatus('Bulk analysis failed: ' + error.message, 'error');
      }
    }

    function startProgressPolling() {
      bulkAnalysisPolling = setInterval(async () => {
        try {
          const response = await fetch(`${API_BASE}/bulk/analyze/status`);
          const data = await response.json();

          if (data.success && data.progress) {
            updateProgressUI(data.progress);

            if (!data.inProgress) {
              stopProgressPolling();
              document.getElementById('bulkProgress').classList.remove('active');

              if (data.progress.status === 'completed') {
                const alreadyAnalyzed = data.progress.alreadyAnalyzed || 0;
                const notSales = data.progress.notSalesCall || 0;
                let msg = `Analysis complete: ${data.progress.analyzed} analyzed`;
                if (alreadyAnalyzed > 0) msg += `, ${alreadyAnalyzed} already analyzed`;
                if (notSales > 0) msg += `, ${notSales} not sales`;
                if (data.progress.errors > 0) msg += `, ${data.progress.errors} errors`;
                showSyncStatus(msg, 'success');
              } else if (data.progress.status === 'cancelled') {
                showSyncStatus('Analysis cancelled', 'active');
              }

              await loadDashboard();
            }
          }
        } catch (error) {
          console.error('Progress polling error:', error);
        }
      }, 2000);
    }

    function stopProgressPolling() {
      if (bulkAnalysisPolling) {
        clearInterval(bulkAnalysisPolling);
        bulkAnalysisPolling = null;
      }
    }

    function updateProgressUI(progress) {
      const percent = progress.total > 0 ? Math.round((progress.processed / progress.total) * 100) : 0;
      document.getElementById('bulkProgressFill').style.width = `${percent}%`;
      document.getElementById('bulkProcessed').textContent = progress.processed;
      document.getElementById('bulkTotal').textContent = progress.total;
      document.getElementById('bulkAnalyzed').textContent = progress.analyzed;
      document.getElementById('bulkAlreadyAnalyzed').textContent = progress.alreadyAnalyzed || 0;
      document.getElementById('bulkNotSales').textContent = progress.notSalesCall || 0;
      document.getElementById('bulkErrors').textContent = progress.errors;
    }

    async function cancelBulkAnalysis() {
      try {
        await fetch(`${API_BASE}/bulk/analyze/cancel`, { method: 'POST' });
        showSyncStatus('Cancelling analysis...', 'active');
      } catch (error) {
        console.error('Cancel error:', error);
      }
    }

    // Update classification override
    async function updateClassification(callId, newClassification) {
      try {
        // Find original classification from currentCalls
        const call = currentCalls.find(c => c.id === callId);
        const originalClassification = call ? call.classification : null;

        // Determine what to save: null if reverting to original, otherwise the override value
        let classificationToSave = newClassification;
        if (newClassification === originalClassification) {
          // If user selects back to the original auto-classification, clear the override
          classificationToSave = null;
        }

        const response = await fetch(`${API_BASE}/admin/calls/${callId}/classification`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ classification: classificationToSave })
        });

        const data = await response.json();

        if (!data.success) {
          throw new Error(data.error || 'Failed to update classification');
        }

        // Update local data
        if (call) {
          call.classificationOverride = classificationToSave;
        }

        // Update the override indicator
        const select = document.querySelector(`select[data-call-id="${callId}"]`);
        if (select) {
          const overrideIndicator = select.nextElementSibling;
          if (classificationToSave) {
            // Show override indicator
            if (!overrideIndicator || overrideIndicator.tagName !== 'SPAN') {
              select.insertAdjacentHTML('afterend', '<span style="font-size: 10px; color: var(--color-text-muted); margin-left: 4px;" title="Manually overridden">✎</span>');
            }
          } else {
            // Remove override indicator
            if (overrideIndicator && overrideIndicator.tagName === 'SPAN') {
              overrideIndicator.remove();
            }
          }
        }

        console.log('Classification updated:', callId, classificationToSave);

      } catch (error) {
        console.error('Classification update error:', error);
        showSyncStatus('Failed to update classification: ' + error.message, 'error');
        // Revert the select to its previous value
        await loadCalls();
      }
    }

    function renderSyncHistory(history) {
      const container = document.getElementById('syncHistory');

      if (!history || history.length === 0) {
        container.innerHTML = `<div class="ds-empty"><div class="ds-empty-text">No sync history</div></div>`;
        return;
      }

      container.innerHTML = `
        <div class="ds-table-container" style="border: none; box-shadow: none;">
          <table class="ds-table">
            <thead>
              <tr>
                <th>Started</th>
                <th>Type</th>
                <th>Status</th>
                <th>Fetched</th>
                <th>New</th>
              </tr>
            </thead>
            <tbody>
              ${history.map(sync => `
                <tr>
                  <td>${formatDateTime(sync.started_at)}</td>
                  <td><span class="ds-badge">${escapeHtml(sync.sync_type)}</span></td>
                  <td>
                    <span class="ds-badge ${sync.status === 'completed' ? 'ds-badge-success' : sync.status === 'error' ? 'ds-badge-danger' : 'ds-badge-info'}">
                      ${escapeHtml(sync.status)}
                    </span>
                  </td>
                  <td>${sync.calls_fetched || 0}</td>
                  <td>${sync.calls_new || 0}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      `;
    }

    async function triggerSync() {
      const preset = document.getElementById('sync-date-preset').value;
      let startDate = document.getElementById('sync-start-date').value;
      let endDate = document.getElementById('sync-end-date').value;
      const repFilter = document.getElementById('sync-rep-filter').value;

      // For "All time", use a wide date range (last 5 years to today)
      if (preset === 'all') {
        const today = new Date();
        const fiveYearsAgo = new Date();
        fiveYearsAgo.setFullYear(fiveYearsAgo.getFullYear() - 5);
        startDate = fiveYearsAgo.toISOString().split('T')[0];
        endDate = today.toISOString().split('T')[0];
      } else if (!startDate || !endDate) {
        // For other presets, get dates from the range function
        const range = getSyncDatePresetRange(preset);
        startDate = range.startDate;
        endDate = range.endDate;
      }

      if (!startDate || !endDate) {
        showSyncStatus('Please select both start and end dates', 'error');
        return;
      }

      if (new Date(startDate) > new Date(endDate)) {
        showSyncStatus('Start date must be before end date', 'error');
        return;
      }

      const btn = document.getElementById('syncBtn');
      btn.disabled = true;
      btn.innerHTML = '<span class="ds-spinner ds-spinner-sm"></span> Syncing...';

      const repLabel = repFilter === 'all' ? 'all reps' : `${repFilter} only`;
      const dateLabel = preset === 'all' ? 'all time' : `${startDate} to ${endDate}`;
      showSyncStatus(`Syncing calls (${dateLabel}, ${repLabel})... Existing transcripts are skipped automatically.`, 'active');

      try {
        const response = await fetch(`${API_BASE}/sync/date-range`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ startDate, endDate, fetchDetails: true, repFilter })
        });

        const data = await response.json();

        if (!data.success) {
          throw new Error(data.error || 'Sync failed');
        }

        const skipped = data.stats.skipped || 0;
        const skippedByRep = data.stats.skipped_by_rep || 0;
        let message = `Sync completed. ${data.stats.new} new calls added.`;
        if (skipped > 0) {
          message += ` ${skipped} already existed.`;
        }
        if (skippedByRep > 0) {
          message += ` ${skippedByRep} skipped by rep filter.`;
        }

        showSyncStatus(message, 'success');
        await loadDashboard();

      } catch (error) {
        console.error('Sync error:', error);
        showSyncStatus('Sync failed: ' + error.message, 'error');

      } finally {
        btn.disabled = false;
        btn.innerHTML = 'Sync Calls';
      }
    }

    function showSyncStatus(message, type) {
      const status = document.getElementById('syncStatus');
      const text = document.getElementById('syncStatusText');

      status.className = 'ds-alert sync-status active';
      if (type === 'error') {
        status.classList.add('ds-alert-danger', 'error');
      } else if (type === 'success') {
        status.classList.add('ds-alert-success', 'success');
      } else {
        status.classList.add('ds-alert-info');
      }
      text.textContent = message;

      if (type === 'success') {
        setTimeout(() => { status.className = 'ds-alert sync-status'; }, 5000);
      }
    }

    function escapeHtml(str) {
      if (!str) return '';
      return str.replace(/[&<>"']/g, char => ({
        '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
      })[char]);
    }

    // Get CSS class for rep badge
    function getRepClass(repName) {
      if (!repName) return 'unknown';
      const name = repName.toLowerCase();
      if (name === 'both') return 'both';
      if (name.includes('phil')) return 'phil';
      if (name.includes('jamie')) return 'jamie';
      return 'unknown';
    }

    // Get display name for rep badge
    function getRepDisplayName(repName) {
      if (!repName) return 'Unknown';
      const name = repName.toLowerCase();
      if (name === 'both') return 'Both';
      if (name.includes('phil')) return 'Phil';
      if (name.includes('jamie')) return 'Jamie';
      return repName;
    }

    // Search functionality
    let searchTimeout = null;
    const searchInput = document.getElementById('searchInput');
    const searchResults = document.getElementById('searchResults');

    function handleSearchInput(e) {
      const query = e.target.value.trim();
      if (searchTimeout) clearTimeout(searchTimeout);

      if (query.length < 2) {
        searchResults.classList.remove('active');
        return;
      }

      searchResults.innerHTML = '<div class="search-loading"><span class="ds-spinner ds-spinner-sm"></span> Searching...</div>';
      searchResults.classList.add('active');

      searchTimeout = setTimeout(() => performSearch(query), 300);
    }

    async function performSearch(query) {
      try {
        const response = await fetch(`${API_BASE}/search?q=${encodeURIComponent(query)}&limit=10`);
        const data = await response.json();

        if (!data.success) throw new Error(data.error || 'Search failed');
        renderSearchResults(data.results, data.total, query);

      } catch (error) {
        console.error('Search error:', error);
        searchResults.innerHTML = `<div class="search-no-results">Search error: ${escapeHtml(error.message)}</div>`;
      }
    }

    function renderSearchResults(results, total, query) {
      if (!results || results.length === 0) {
        searchResults.innerHTML = `<div class="search-no-results">No results for "${escapeHtml(query)}"</div>`;
        return;
      }

      let html = results.map(result => `
        <a href="/admin/call.html?id=${result.id}" class="search-result-item">
          <div class="search-result-title">${escapeHtml(result.call_title || 'Untitled')}</div>
          <div class="search-result-meta">
            ${result.rep_name ? escapeHtml(result.rep_name) + ' - ' : ''}${formatDateTime(result.call_datetime)}
          </div>
          ${result.snippet ? `<div class="search-result-snippet">${result.snippet}</div>` : ''}
        </a>
      `).join('');

      if (total > results.length) {
        html += `<div class="search-footer">Showing ${results.length} of ${total}</div>`;
      }

      searchResults.innerHTML = html;
    }

    document.addEventListener('click', (e) => {
      if (!e.target.closest('.search-container')) {
        searchResults.classList.remove('active');
      }
    });

    searchInput.addEventListener('focus', () => {
      if (searchInput.value.trim().length >= 2) searchResults.classList.add('active');
    });

    searchInput.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        searchResults.classList.remove('active');
        searchInput.blur();
      }
    });

    searchInput.addEventListener('input', handleSearchInput);

    document.addEventListener('DOMContentLoaded', () => {
      initUserMenu();
      setupUserMenu();
      initDateRange();
      initAppliedFilters(); // Initialize applied filters from defaults
      loadDashboard();
    });
  </script>
</body>
</html>
