<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Copy - Customer Language Intelligence</title>
  <link rel="stylesheet" href="design-system.css">
  <style>
    /* Page-specific styles for Copy page */

    /* Filter row layout */
    .ds-filters-row {
      display: flex;
      flex-wrap: wrap;
      gap: var(--space-4);
      align-items: flex-end;
    }

    .ds-filter-group {
      display: flex;
      flex-direction: column;
      gap: var(--space-1);
      min-width: 150px;
    }

    .ds-filter-label {
      font-size: var(--text-xs);
      font-weight: 500;
      color: var(--color-text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .ds-filter-actions {
      display: flex;
      gap: var(--space-2);
      align-items: center;
    }

    .ds-filter-export {
      margin-left: auto;
    }

    @media (max-width: 768px) {
      .ds-filters-row {
        flex-direction: column;
        align-items: stretch;
      }

      .ds-filter-group {
        width: 100%;
      }
    }

    /* Compact KPI strip */
    .kpi-strip {
      display: flex;
      gap: var(--space-3);
      margin-top: var(--space-5);
      margin-bottom: var(--space-6);
      padding: var(--space-4);
      background: var(--color-surface);
      border: 1px solid var(--color-border-light);
      border-radius: var(--radius-lg);
    }

    .kpi-item {
      display: flex;
      align-items: baseline;
      gap: var(--space-2);
      padding-right: var(--space-4);
      border-right: 1px solid var(--color-border-light);
    }

    .kpi-item:last-child {
      border-right: none;
      padding-right: 0;
    }

    .kpi-value {
      font-size: var(--text-lg);
      font-weight: 600;
      color: var(--color-text-primary);
    }

    .kpi-label {
      font-size: var(--text-xs);
      color: var(--color-text-muted);
      text-transform: uppercase;
      letter-spacing: 0.3px;
    }

    /* Section container */
    .copy-sections {
      display: flex;
      flex-direction: column;
      gap: var(--space-6);
    }

    /* Section card - collapsible */
    .copy-section {
      background: var(--color-surface);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-lg);
      overflow: hidden;
    }

    .copy-section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: var(--space-4) var(--space-5);
      border-bottom: 1px solid var(--color-border-light);
      cursor: pointer;
      user-select: none;
      transition: background 0.15s;
    }

    .copy-section-header:hover {
      background: var(--color-surface-alt);
    }

    .copy-section-title {
      display: flex;
      align-items: center;
      gap: var(--space-3);
    }

    .copy-section-title h2 {
      font-size: var(--text-base);
      font-weight: 600;
      color: var(--color-text-primary);
      margin: 0;
    }

    .copy-section-count {
      font-size: var(--text-xs);
      color: var(--color-text-muted);
      background: var(--color-surface-alt);
      padding: 2px 8px;
      border-radius: 12px;
    }

    .copy-section-toggle {
      font-size: var(--text-sm);
      color: var(--color-text-muted);
      transition: transform 0.2s;
    }

    .copy-section.collapsed .copy-section-toggle {
      transform: rotate(-90deg);
    }

    .copy-section.collapsed .copy-section-body {
      display: none;
    }

    .copy-section-body {
      padding: 0;
      max-height: 500px;
      overflow-y: auto;
    }

    /* Subtabs for Wording section */
    .copy-subtabs {
      display: flex;
      gap: var(--space-1);
      padding: var(--space-3) var(--space-5);
      background: var(--color-surface-alt);
      border-bottom: 1px solid var(--color-border-light);
    }

    .copy-subtab {
      padding: var(--space-2) var(--space-3);
      font-size: var(--text-sm);
      font-weight: 500;
      color: var(--color-text-secondary);
      background: none;
      border: none;
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: all 0.15s;
    }

    .copy-subtab:hover {
      color: var(--color-text-primary);
      background: var(--color-surface);
    }

    .copy-subtab.active {
      color: var(--color-primary);
      background: var(--color-surface);
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    }

    /* Insight list */
    .copy-list {
      padding: 0;
    }

    .copy-item {
      display: flex;
      gap: var(--space-4);
      padding: var(--space-4) var(--space-5);
      border-bottom: 1px solid var(--color-border-light);
      cursor: pointer;
      transition: background 0.15s;
    }

    .copy-item:last-child {
      border-bottom: none;
    }

    .copy-item:hover {
      background: var(--color-surface-alt);
    }

    .copy-item:nth-child(odd) {
      background: rgba(0, 0, 0, 0.01);
    }

    .copy-item:nth-child(odd):hover {
      background: var(--color-surface-alt);
    }

    /* Rank indicator */
    .copy-rank {
      display: flex;
      align-items: center;
      justify-content: center;
      min-width: 28px;
      height: 28px;
      border-radius: 50%;
      background: rgba(7, 59, 85, 0.08);
      color: var(--color-primary);
      font-size: var(--text-xs);
      font-weight: 600;
      flex-shrink: 0;
    }

    .copy-rank.top-3 {
      background: var(--color-primary);
      color: white;
    }

    /* Item content */
    .copy-item-content {
      flex: 1;
      min-width: 0;
    }

    .copy-item-title {
      font-size: var(--text-sm);
      font-weight: 500;
      color: var(--color-text-primary);
      margin-bottom: var(--space-1);
      line-height: 1.4;
    }

    .copy-item-title.needs-review {
      color: var(--color-warning);
    }

    .copy-item-title .review-badge {
      font-size: var(--text-xs);
      font-weight: 500;
      color: var(--color-warning);
      background: var(--color-warning-bg);
      padding: 2px 6px;
      border-radius: var(--radius-sm);
      margin-left: var(--space-2);
    }

    .copy-item-quote {
      font-size: var(--text-sm);
      color: var(--color-text-secondary);
      font-style: italic;
      margin-bottom: var(--space-2);
      padding-left: var(--space-3);
      border-left: 2px solid var(--color-accent);
      line-height: 1.5;
    }

    .copy-item-meta {
      display: flex;
      flex-wrap: wrap;
      gap: var(--space-3);
      font-size: var(--text-xs);
      color: var(--color-text-muted);
    }

    .copy-item-meta span {
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .copy-item-source {
      color: var(--color-accent);
    }

    .copy-item-source:hover {
      text-decoration: underline;
    }

    /* Type badge for objections */
    .copy-type-badge {
      display: inline-block;
      font-size: var(--text-xs);
      font-weight: 500;
      padding: 2px 8px;
      border-radius: var(--radius-sm);
      background: var(--color-surface-alt);
      color: var(--color-text-secondary);
      margin-right: var(--space-2);
    }

    .copy-type-badge.price {
      background: rgba(239, 68, 68, 0.1);
      color: #dc2626;
    }

    .copy-type-badge.trust {
      background: rgba(245, 158, 11, 0.1);
      color: #d97706;
    }

    .copy-type-badge.complexity {
      background: rgba(59, 130, 246, 0.1);
      color: #2563eb;
    }

    .copy-type-badge.time {
      background: rgba(139, 92, 246, 0.1);
      color: #7c3aed;
    }

    /* Intensity indicator */
    .copy-intensity {
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      margin-right: 4px;
    }

    .copy-intensity.high {
      background: var(--color-danger);
    }

    .copy-intensity.medium {
      background: var(--color-warning);
    }

    .copy-intensity.low {
      background: var(--color-success);
    }

    /* Empty state */
    .copy-empty {
      padding: var(--space-8);
      text-align: center;
      color: var(--color-text-muted);
    }

    .copy-empty-text {
      font-size: var(--text-sm);
    }

    /* Loading state */
    .copy-loading {
      padding: var(--space-6);
      text-align: center;
      color: var(--color-text-muted);
    }

    .copy-loading-spinner {
      width: 24px;
      height: 24px;
      border: 2px solid var(--color-border);
      border-top-color: var(--color-primary);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin: 0 auto var(--space-3);
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Context Drawer (right panel) */
    .context-drawer-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.4);
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s;
    }

    .context-drawer-overlay.active {
      opacity: 1;
      visibility: visible;
    }

    .context-drawer {
      position: fixed;
      top: 0;
      right: 0;
      width: 560px;
      max-width: 90vw;
      height: 100vh;
      background: var(--color-surface);
      box-shadow: -4px 0 24px rgba(0, 0, 0, 0.15);
      z-index: 1001;
      transform: translateX(100%);
      transition: transform 0.3s ease;
      display: flex;
      flex-direction: column;
    }

    .context-drawer-overlay.active .context-drawer {
      transform: translateX(0);
    }

    .context-drawer-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: var(--space-4) var(--space-5);
      border-bottom: 1px solid var(--color-border);
      flex-shrink: 0;
    }

    .context-drawer-header h3 {
      font-size: var(--text-base);
      font-weight: 600;
      color: var(--color-text-primary);
      margin: 0;
    }

    .context-drawer-close {
      background: none;
      border: none;
      font-size: 20px;
      color: var(--color-text-muted);
      cursor: pointer;
      padding: 4px;
      line-height: 1;
      transition: color 0.15s;
    }

    .context-drawer-close:hover {
      color: var(--color-text-primary);
    }

    .context-drawer-body {
      flex: 1;
      overflow-y: auto;
      padding: var(--space-5);
    }

    .context-drawer-footer {
      padding: var(--space-4) var(--space-5);
      border-top: 1px solid var(--color-border);
      display: flex;
      gap: var(--space-2);
      flex-shrink: 0;
    }

    /* Context drawer sections */
    .context-section {
      margin-bottom: var(--space-5);
    }

    .context-section:last-child {
      margin-bottom: 0;
    }

    .context-section-title {
      font-size: var(--text-xs);
      font-weight: 600;
      color: var(--color-text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: var(--space-2);
    }

    .context-full-quote {
      font-size: var(--text-sm);
      color: var(--color-text-primary);
      font-style: italic;
      padding: var(--space-3) var(--space-4);
      background: rgba(6, 114, 128, 0.06);
      border-radius: var(--radius-md);
      border-left: 3px solid var(--color-accent);
      line-height: 1.6;
    }

    .context-meta {
      display: flex;
      flex-wrap: wrap;
      gap: var(--space-4);
      padding: var(--space-3);
      background: var(--color-surface-alt);
      border-radius: var(--radius-md);
      font-size: var(--text-sm);
      color: var(--color-text-secondary);
    }

    .context-meta-item {
      display: flex;
      align-items: center;
      gap: var(--space-2);
    }

    .context-meta-label {
      font-weight: 500;
      color: var(--color-text-muted);
    }

    /* Rep name badge styles */
    .rep-badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: var(--text-xs);
      font-weight: 500;
    }

    .rep-badge.phil {
      background: rgba(251, 191, 36, 0.15);
      color: #b45309;
    }

    .rep-badge.jamie {
      background: rgba(236, 72, 153, 0.15);
      color: #be185d;
    }

    .rep-badge.both {
      background: rgba(59, 130, 246, 0.15);
      color: #2563eb;
    }

    .rep-badge.unknown {
      background: var(--color-surface-alt);
      color: var(--color-text-secondary);
    }

    .context-summary {
      font-size: var(--text-sm);
      color: var(--color-text-secondary);
      line-height: 1.6;
      padding: var(--space-3);
      background: var(--color-surface-alt);
      border-radius: var(--radius-md);
    }

    .context-transcript {
      font-family: var(--font-mono);
      font-size: var(--text-xs);
      line-height: 1.7;
      background: var(--color-surface-alt);
      border-radius: var(--radius-md);
      padding: var(--space-4);
      max-height: 300px;
      overflow-y: auto;
      white-space: pre-wrap;
      word-break: break-word;
    }

    .context-transcript .highlight {
      background: rgba(245, 158, 11, 0.3);
      padding: 1px 2px;
      border-radius: 2px;
    }

    .context-transcript .highlight.fuzzy {
      background: rgba(139, 92, 246, 0.2);
    }

    .context-transcript .speaker-rep {
      color: var(--color-primary);
      font-weight: 600;
    }

    .context-transcript .speaker-prospect {
      color: var(--color-accent);
      font-weight: 600;
    }

    .fuzzy-indicator {
      font-size: var(--text-xs);
      color: var(--color-warning);
      margin-left: var(--space-2);
    }

    /* Responsive */
    @media (max-width: 768px) {
      .kpi-strip {
        flex-wrap: wrap;
      }

      .kpi-item {
        border-right: none;
        padding-right: 0;
        flex: 1 1 45%;
      }

      .context-drawer {
        width: 100vw;
        max-width: 100vw;
      }
    }

    /* Export button */
    .btn-export {
      background: rgba(7, 59, 85, 0.1);
      color: var(--color-primary);
      border: 1px solid rgba(7, 59, 85, 0.2);
    }

    .btn-export:hover {
      background: rgba(7, 59, 85, 0.15);
    }

    .btn-export.copied {
      background: var(--color-success-bg);
      color: var(--color-success);
      border-color: rgba(34, 197, 94, 0.3);
    }

    .btn-refresh {
      background: linear-gradient(135deg, #059669 0%, #34d399 100%);
      color: white;
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .btn-refresh:hover {
      background: linear-gradient(135deg, #10b981 0%, #6ee7b7 100%);
    }

    .btn-refresh:disabled {
      opacity: 0.7;
      cursor: not-allowed;
    }

    .refresh-spinner {
      width: 14px;
      height: 14px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    .refresh-spinner.hidden {
      display: none;
    }
  </style>
  <script src="/admin/js/view-mode.js"></script>
</head>
<body>
  <header class="ds-header">
    <div class="ds-header-inner">
      <a href="/admin/" class="ds-header-logo">
        <img src="/admin/logo.svg" alt="AffiliateFinder">
      </a>
      <div class="ds-header-divider"></div>
      <nav class="ds-header-nav">
        <a href="/admin/">Calls</a>
        <a href="/admin/lead-quality.html">Lead Quality</a>
        <a href="/admin/copy.html" class="active">Copy</a>
        <a href="/admin/phil.html">DFY</a>
        <a href="/admin/founder.html">Closing Rate</a>
      </nav>

      <!-- View Mode Indicator (shown when in user view) -->
      <div class="view-mode-indicator" id="viewModeIndicator" data-tooltip="You are viewing as a regular user">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
          <circle cx="12" cy="12" r="3"></circle>
        </svg>
        <span>User view</span>
      </div>

      <div class="ds-header-user">
        <button class="ds-user-button" id="user-menu-button" aria-expanded="false" aria-haspopup="true" data-tooltip="Open user menu" data-tooltip-position="left">
          <div class="ds-user-avatar" id="user-avatar">--</div>
          <div class="ds-user-info">
            <span class="ds-user-name" id="user-display-name">Loading...</span>
            <span class="ds-user-role" id="user-display-role">-</span>
          </div>
          <svg class="ds-user-chevron" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="6 9 12 15 18 9"></polyline>
          </svg>
        </button>
        <div class="ds-user-dropdown" id="user-dropdown">
          <div class="ds-dropdown-header">
            <div class="ds-dropdown-email" id="user-email">-</div>
            <span class="ds-dropdown-role user" id="user-role-badge">User</span>
          </div>

          <div class="ds-dropdown-section">
            <a href="/admin/account.html" class="ds-dropdown-item">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                <circle cx="12" cy="7" r="4"></circle>
              </svg>
              Account
            </a>
            <a href="/admin/settings.html" class="ds-dropdown-item">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="3"></circle>
                <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
              </svg>
              Settings
            </a>
            <a href="/admin/changelog.html" class="ds-dropdown-item">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                <polyline points="14 2 14 8 20 8"></polyline>
                <line x1="16" y1="13" x2="8" y2="13"></line>
                <line x1="16" y1="17" x2="8" y2="17"></line>
                <polyline points="10 9 9 9 8 9"></polyline>
              </svg>
              Changelog
            </a>
          </div>

          <div class="ds-dropdown-divider ds-admin-only" style="display: none;"></div>

          <div class="ds-dropdown-section ds-admin-only" style="display: none;">
            <div class="ds-dropdown-label">Admin</div>
            <a href="/admin/access-requests.html" class="ds-dropdown-item">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                <circle cx="8.5" cy="7" r="4"></circle>
                <line x1="20" y1="8" x2="20" y2="14"></line>
                <line x1="23" y1="11" x2="17" y2="11"></line>
              </svg>
              Access Requests
            </a>
            <a href="/admin/users.html" class="ds-dropdown-item">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                <circle cx="9" cy="7" r="4"></circle>
                <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
              </svg>
              User Management
            </a>
          </div>

          <!-- View Mode Toggle (admin only) -->
          <div class="ds-dropdown-divider ds-admin-only" id="viewModeSection" style="display: none;"></div>
          <div class="ds-dropdown-section ds-admin-only" id="viewModeToggleContainer" style="display: none;">
            <button class="view-mode-toggle" id="viewModeToggle" onclick="ViewMode.toggleViewMode()" data-tooltip="Preview app as a regular user">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                <circle cx="12" cy="12" r="3"></circle>
              </svg>
              <span class="view-mode-label">User view</span>
            </button>
          </div>

          <div class="ds-dropdown-divider"></div>

          <div class="ds-dropdown-section">
            <button class="ds-dropdown-item danger" id="logout-button" data-tooltip="End session via POST /api/auth/logout">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                <polyline points="16 17 21 12 16 7"></polyline>
                <line x1="21" y1="12" x2="9" y2="12"></line>
              </svg>
              Sign Out
            </button>
          </div>
        </div>
      </div>
    </div>
  </header>

  <main class="ds-main">
    <div class="ds-page-header">
      <h1 class="ds-page-title">Copy</h1>
      <p class="ds-page-subtitle">Customer Language Intelligence across analyzed calls</p>
    </div>

    <!-- Filters -->
    <div class="ds-filters">
      <div class="ds-filters-row">
        <div class="ds-filter-group">
          <label class="ds-filter-label">Date Range</label>
          <select class="ds-input" id="filter-date-preset" onchange="handleDatePresetChange()">
            <option value="all">All time</option>
            <option value="this_week">This week</option>
            <option value="last_week">Last week</option>
            <option value="last_month">Last month</option>
            <option value="last_3_months">Last 3 months</option>
            <option value="last_6_months">Last 6 months</option>
            <option value="custom">Custom range</option>
          </select>
        </div>
        <div class="ds-filter-group custom-date-field" id="custom-start-group" style="display: none;">
          <label class="ds-filter-label">Start Date</label>
          <input type="date" class="ds-input" id="filter-start-date">
        </div>
        <div class="ds-filter-group custom-date-field" id="custom-end-group" style="display: none;">
          <label class="ds-filter-label">End Date</label>
          <input type="date" class="ds-input" id="filter-end-date">
        </div>
        <div class="ds-filter-group">
          <label class="ds-filter-label">Sales Rep</label>
          <select class="ds-input" id="filter-rep">
            <option value="">All Reps</option>
          </select>
        </div>
        <div class="ds-filter-group">
          <label class="ds-filter-label">Keyword Search</label>
          <input type="text" class="ds-input" id="filter-keyword" placeholder="Search in transcripts...">
        </div>
        <div class="ds-filter-actions">
          <button class="ds-btn ds-btn-primary" onclick="applyFilters()" data-tooltip="Filter copy insights by date and rep">Apply Filters</button>
          <button class="ds-btn ds-btn-secondary" onclick="clearFilters()" data-tooltip="Reset all filter selections">Clear</button>
          <button class="ds-btn btn-refresh" onclick="refreshData()" id="btn-refresh" data-tooltip="Reload analyzed calls from the database">
            <span id="refresh-spinner" class="refresh-spinner hidden"></span>
            <span id="refresh-text">Refresh</span>
          </button>
        </div>
        <div class="ds-filter-export">
          <button class="ds-btn btn-export" onclick="exportToMarkdown()" id="btn-export" data-tooltip="Copy insights as Markdown to clipboard">Export MD</button>
        </div>
      </div>
    </div>

    <!-- KPI Strip (compact) -->
    <div class="kpi-strip" id="kpi-strip">
      <div class="kpi-item">
        <span class="kpi-value" id="kpi-calls">-</span>
        <span class="kpi-label">Calls</span>
      </div>
      <div class="kpi-item">
        <span class="kpi-value" id="kpi-pains">-</span>
        <span class="kpi-label">Pain Points</span>
      </div>
      <div class="kpi-item">
        <span class="kpi-value" id="kpi-goals">-</span>
        <span class="kpi-label">Goals</span>
      </div>
      <div class="kpi-item">
        <span class="kpi-value" id="kpi-questions">-</span>
        <span class="kpi-label">Questions</span>
      </div>
      <div class="kpi-item">
        <span class="kpi-value" id="kpi-objections">-</span>
        <span class="kpi-label">Objections</span>
      </div>
    </div>

    <!-- 8 Analysis Sections -->
    <div class="copy-sections" id="copy-sections">

      <!-- 1. Pain Points -->
      <div class="copy-section" id="section-pains">
        <div class="copy-section-header" onclick="toggleSection('pains')">
          <div class="copy-section-title">
            <h2>Pain Points</h2>
            <span class="copy-section-count" id="pains-count">0</span>
          </div>
          <span class="copy-section-toggle">&#9660;</span>
        </div>
        <div class="copy-section-body">
          <div class="copy-list" id="pains-list">
            <div class="copy-loading">
              <div class="copy-loading-spinner"></div>
              <span>Loading...</span>
            </div>
          </div>
        </div>
      </div>

      <!-- 2. Goals -->
      <div class="copy-section" id="section-goals">
        <div class="copy-section-header" onclick="toggleSection('goals')">
          <div class="copy-section-title">
            <h2>Goals</h2>
            <span class="copy-section-count" id="goals-count">0</span>
          </div>
          <span class="copy-section-toggle">&#9660;</span>
        </div>
        <div class="copy-section-body">
          <div class="copy-list" id="goals-list">
            <div class="copy-loading">
              <div class="copy-loading-spinner"></div>
              <span>Loading...</span>
            </div>
          </div>
        </div>
      </div>

      <!-- 3. Wording (with subtabs) -->
      <div class="copy-section" id="section-wording">
        <div class="copy-section-header" onclick="toggleSection('wording')">
          <div class="copy-section-title">
            <h2>Wording</h2>
            <span class="copy-section-count" id="wording-count">0</span>
          </div>
          <span class="copy-section-toggle">&#9660;</span>
        </div>
        <div class="copy-section-body">
          <div class="copy-subtabs">
            <button class="copy-subtab active" data-subtab="industry" onclick="switchWordingTab('industry')" data-tooltip="View industry-specific terms">Industry Terms</button>
            <button class="copy-subtab" data-subtab="colloquial" onclick="switchWordingTab('colloquial')" data-tooltip="View problem-describing language">Problem Language</button>
            <button class="copy-subtab" data-subtab="power" onclick="switchWordingTab('power')" data-tooltip="View emotionally impactful words">Power Words</button>
          </div>
          <div class="copy-list" id="wording-list">
            <div class="copy-empty">
              <span class="copy-empty-text">Wording analysis coming soon. Run analysis with enrichment to populate.</span>
            </div>
          </div>
        </div>
      </div>

      <!-- 4. Metaphors & Analogies -->
      <div class="copy-section" id="section-metaphors">
        <div class="copy-section-header" onclick="toggleSection('metaphors')">
          <div class="copy-section-title">
            <h2>Metaphors & Analogies</h2>
            <span class="copy-section-count" id="metaphors-count">0</span>
          </div>
          <span class="copy-section-toggle">&#9660;</span>
        </div>
        <div class="copy-section-body">
          <div class="copy-list" id="metaphors-list">
            <div class="copy-empty">
              <span class="copy-empty-text">Metaphor extraction coming soon. Run analysis with enrichment to populate.</span>
            </div>
          </div>
        </div>
      </div>

      <!-- 5. Emotional Triggers -->
      <div class="copy-section" id="section-emotions">
        <div class="copy-section-header" onclick="toggleSection('emotions')">
          <div class="copy-section-title">
            <h2>Emotional Triggers</h2>
            <span class="copy-section-count" id="emotions-count">0</span>
          </div>
          <span class="copy-section-toggle">&#9660;</span>
        </div>
        <div class="copy-section-body">
          <div class="copy-list" id="emotions-list">
            <div class="copy-loading">
              <div class="copy-loading-spinner"></div>
              <span>Loading...</span>
            </div>
          </div>
        </div>
      </div>

      <!-- 6. Customer Questions -->
      <div class="copy-section" id="section-questions">
        <div class="copy-section-header" onclick="toggleSection('questions')">
          <div class="copy-section-title">
            <h2>Customer Questions</h2>
            <span class="copy-section-count" id="questions-count">0</span>
          </div>
          <span class="copy-section-toggle">&#9660;</span>
        </div>
        <div class="copy-section-body">
          <div class="copy-list" id="questions-list">
            <div class="copy-loading">
              <div class="copy-loading-spinner"></div>
              <span>Loading...</span>
            </div>
          </div>
        </div>
      </div>

      <!-- 7. Positive Reactions -->
      <div class="copy-section" id="section-positive">
        <div class="copy-section-header" onclick="toggleSection('positive')">
          <div class="copy-section-title">
            <h2>Positive Reactions</h2>
            <span class="copy-section-count" id="positive-count">0</span>
          </div>
          <span class="copy-section-toggle">&#9660;</span>
        </div>
        <div class="copy-section-body">
          <div class="copy-list" id="positive-list">
            <div class="copy-loading">
              <div class="copy-loading-spinner"></div>
              <span>Loading...</span>
            </div>
          </div>
        </div>
      </div>

      <!-- 8. Objections & Criticism -->
      <div class="copy-section" id="section-objections">
        <div class="copy-section-header" onclick="toggleSection('objections')">
          <div class="copy-section-title">
            <h2>Objections & Criticism</h2>
            <span class="copy-section-count" id="objections-count">0</span>
          </div>
          <span class="copy-section-toggle">&#9660;</span>
        </div>
        <div class="copy-section-body">
          <div class="copy-list" id="objections-list">
            <div class="copy-loading">
              <div class="copy-loading-spinner"></div>
              <span>Loading...</span>
            </div>
          </div>
        </div>
      </div>

    </div>
  </main>

  <!-- Context Drawer -->
  <div class="context-drawer-overlay" id="context-drawer-overlay" onclick="closeContextDrawer(event)">
    <div class="context-drawer" onclick="event.stopPropagation()">
      <div class="context-drawer-header">
        <h3 id="context-drawer-title">Context</h3>
        <button class="context-drawer-close" onclick="closeContextDrawer()" data-tooltip="Close context drawer">&times;</button>
      </div>
      <div class="context-drawer-body" id="context-drawer-body">
        <!-- Content loaded dynamically -->
      </div>
      <div class="context-drawer-footer">
        <button class="ds-btn ds-btn-primary" onclick="openInTranscript()" data-tooltip="Navigate to quote in call transcript">Open in Transcript</button>
        <button class="ds-btn ds-btn-secondary" onclick="closeContextDrawer()" data-tooltip="Close context drawer">Close</button>
      </div>
    </div>
  </div>

  <script>
    // ============================================
    // State
    // ============================================
    let currentFilters = {};
    let currentDashboardData = null;
    let currentWordingTab = 'industry';
    let currentContextItem = null;

    // ============================================
    // URL Filter Persistence
    // ============================================
    function getFiltersFromURL() {
      const params = new URLSearchParams(window.location.search);
      const filters = {};

      if (params.has('preset')) filters.datePreset = params.get('preset');
      if (params.has('start')) filters.startDate = params.get('start');
      if (params.has('end')) filters.endDate = params.get('end');
      if (params.has('rep')) filters.rep = params.get('rep');
      if (params.has('keyword')) filters.keyword = params.get('keyword');

      return Object.keys(filters).length > 0 ? filters : null;
    }

    function updateURLWithFilters(filters, preset) {
      const params = new URLSearchParams();

      if (preset && preset !== 'all') {
        params.set('preset', preset);
      }
      if (preset === 'custom') {
        if (filters.startDate) params.set('start', filters.startDate);
        if (filters.endDate) params.set('end', filters.endDate);
      }
      if (filters.rep) params.set('rep', filters.rep);
      if (filters.keyword) params.set('keyword', filters.keyword);

      const newURL = params.toString()
        ? `${window.location.pathname}?${params.toString()}`
        : window.location.pathname;

      window.history.replaceState({ filters, preset }, '', newURL);
    }

    function syncUIWithFilters(filters, preset) {
      const presetSelect = document.getElementById('filter-date-preset');
      if (presetSelect && preset) {
        presetSelect.value = preset;
      }

      const startGroup = document.getElementById('custom-start-group');
      const endGroup = document.getElementById('custom-end-group');

      if (preset === 'custom') {
        startGroup.style.display = '';
        endGroup.style.display = '';
        if (filters.startDate) document.getElementById('filter-start-date').value = filters.startDate;
        if (filters.endDate) document.getElementById('filter-end-date').value = filters.endDate;
      } else {
        startGroup.style.display = 'none';
        endGroup.style.display = 'none';
      }

      const repSelect = document.getElementById('filter-rep');
      if (repSelect && filters.rep) {
        repSelect.value = filters.rep;
      }

      const keywordInput = document.getElementById('filter-keyword');
      if (keywordInput && filters.keyword) {
        keywordInput.value = filters.keyword;
      }
    }

    function initFiltersFromURL() {
      const urlFilters = getFiltersFromURL();
      if (urlFilters) {
        const preset = urlFilters.datePreset || 'all';
        currentFilters = {
          startDate: urlFilters.startDate || null,
          endDate: urlFilters.endDate || null,
          rep: urlFilters.rep || null,
          keyword: urlFilters.keyword || null
        };

        if (preset !== 'custom' && preset !== 'all') {
          const dateRange = getDatePresetRange(preset);
          currentFilters.startDate = dateRange.startDate;
          currentFilters.endDate = dateRange.endDate;
        }

        // Defer UI sync until after loadFilterOptions populates rep dropdown
        setTimeout(() => syncUIWithFilters(currentFilters, preset), 100);
        return true;
      }
      return false;
    }

    // Handle browser back/forward navigation
    window.addEventListener('popstate', (event) => {
      if (event.state && event.state.filters) {
        currentFilters = { ...event.state.filters };
        syncUIWithFilters(currentFilters, event.state.preset);
        loadCopyData();
      }
    });

    // ============================================
    // User Menu
    // ============================================
    async function initUserMenu() {
      try {
        const response = await fetch('/api/auth/me', { credentials: 'include' });
        if (!response.ok) {
          window.location.href = '/admin/login.html';
          return;
        }
        const data = await response.json();
        const user = data.user;

        // Update avatar with initials
        const avatar = document.getElementById('user-avatar');
        if (avatar) {
          const initials = (user.name || user.email || '?')
            .split(/[\s@]+/)
            .map(part => part[0])
            .join('')
            .substring(0, 2)
            .toUpperCase();
          avatar.textContent = initials;
        }

        // Update user display name in header button
        const displayName = document.getElementById('user-display-name');
        if (displayName) {
          displayName.textContent = user.name || user.email.split('@')[0];
        }

        // Update user display role in header button
        const displayRole = document.getElementById('user-display-role');
        if (displayRole) {
          displayRole.textContent = user.role === 'admin' ? 'Admin' : 'User';
        }

        // Update email in dropdown
        const emailEl = document.getElementById('user-email');
        if (emailEl) emailEl.textContent = user.email;

        // Update role badge in dropdown
        const roleBadge = document.getElementById('user-role-badge');
        if (roleBadge) {
          roleBadge.textContent = user.role === 'admin' ? 'Admin' : 'User';
          roleBadge.className = 'ds-dropdown-role ' + (user.role === 'admin' ? 'admin' : 'user');
        }

        // Show admin-only items
        if (user.role === 'admin') {
          document.querySelectorAll('.ds-admin-only').forEach(el => {
            el.style.display = '';
          });
        }

        // Initialize view mode (must be after admin-only elements are shown)
        if (window.ViewMode) {
          ViewMode.initViewMode(user.role);
        }
      } catch (err) {
        console.error('Failed to load user info:', err);
      }
    }

    function setupUserMenu() {
      const button = document.getElementById('user-menu-button');
      const dropdown = document.getElementById('user-dropdown');
      const logoutBtn = document.getElementById('logout-button');

      if (button && dropdown) {
        button.addEventListener('click', (e) => {
          e.stopPropagation();
          const isOpen = dropdown.classList.contains('open');
          dropdown.classList.toggle('open', !isOpen);
          button.setAttribute('aria-expanded', !isOpen);
        });

        document.addEventListener('click', (e) => {
          if (!e.target.closest('.ds-header-user')) {
            dropdown.classList.remove('open');
            button.setAttribute('aria-expanded', 'false');
          }
        });
      }

      if (logoutBtn) {
        logoutBtn.addEventListener('click', async () => {
          try {
            await fetch('/api/auth/logout', { method: 'POST', credentials: 'include' });
          } catch (err) {
            console.error('Logout error:', err);
          }
          window.location.href = '/admin/login.html';
        });
      }
    }

    // ============================================
    // Initialization
    // ============================================
    document.addEventListener('DOMContentLoaded', () => {
      initUserMenu();
      setupUserMenu();
      loadFilterOptions();
      initFiltersFromURL(); // Restore filters from URL if present
      loadCopyData();
    });

    // ============================================
    // Date Preset Utilities
    // ============================================
    function getDatePresetRange(preset) {
      const now = new Date();
      const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());

      switch (preset) {
        case 'all':
          return { startDate: null, endDate: null };

        case 'this_week': {
          const dayOfWeek = today.getDay();
          const daysFromMonday = dayOfWeek === 0 ? 6 : dayOfWeek - 1;
          const monday = new Date(today);
          monday.setDate(today.getDate() - daysFromMonday);
          const sunday = new Date(monday);
          sunday.setDate(monday.getDate() + 6);
          return { startDate: formatDateISO(monday), endDate: formatDateISO(sunday) };
        }

        case 'last_week': {
          const dayOfWeek = today.getDay();
          const daysFromMonday = dayOfWeek === 0 ? 6 : dayOfWeek - 1;
          const thisMonday = new Date(today);
          thisMonday.setDate(today.getDate() - daysFromMonday);
          const lastMonday = new Date(thisMonday);
          lastMonday.setDate(thisMonday.getDate() - 7);
          const lastSunday = new Date(lastMonday);
          lastSunday.setDate(lastMonday.getDate() + 6);
          return { startDate: formatDateISO(lastMonday), endDate: formatDateISO(lastSunday) };
        }

        case 'last_month': {
          const firstOfThisMonth = new Date(today.getFullYear(), today.getMonth(), 1);
          const lastOfLastMonth = new Date(firstOfThisMonth);
          lastOfLastMonth.setDate(lastOfLastMonth.getDate() - 1);
          const firstOfLastMonth = new Date(lastOfLastMonth.getFullYear(), lastOfLastMonth.getMonth(), 1);
          return { startDate: formatDateISO(firstOfLastMonth), endDate: formatDateISO(lastOfLastMonth) };
        }

        case 'last_3_months': {
          const threeMonthsAgo = new Date(today.getFullYear(), today.getMonth() - 3, today.getDate());
          return { startDate: formatDateISO(threeMonthsAgo), endDate: formatDateISO(today) };
        }

        case 'last_6_months': {
          const sixMonthsAgo = new Date(today.getFullYear(), today.getMonth() - 6, today.getDate());
          return { startDate: formatDateISO(sixMonthsAgo), endDate: formatDateISO(today) };
        }

        case 'custom':
          return {
            startDate: document.getElementById('filter-start-date').value || null,
            endDate: document.getElementById('filter-end-date').value || null
          };

        default:
          return { startDate: null, endDate: null };
      }
    }

    function formatDateISO(date) {
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }

    function handleDatePresetChange() {
      const preset = document.getElementById('filter-date-preset').value;
      const startGroup = document.getElementById('custom-start-group');
      const endGroup = document.getElementById('custom-end-group');

      if (preset === 'custom') {
        startGroup.style.display = '';
        endGroup.style.display = '';
      } else {
        startGroup.style.display = 'none';
        endGroup.style.display = 'none';
        const range = getDatePresetRange(preset);
        document.getElementById('filter-start-date').value = range.startDate || '';
        document.getElementById('filter-end-date').value = range.endDate || '';
      }
    }

    // ============================================
    // Filter Options
    // ============================================
    async function loadFilterOptions() {
      try {
        const response = await fetch('/api/dashboard/filters');
        const data = await response.json();

        if (data.success) {
          const repSelect = document.getElementById('filter-rep');
          const seenReps = new Map();
          data.data.reps.forEach(rep => {
            const lowerRep = rep.toLowerCase();
            if (!seenReps.has(lowerRep)) {
              seenReps.set(lowerRep, rep);
            }
          });
          seenReps.forEach((rep) => {
            const option = document.createElement('option');
            option.value = rep;
            option.textContent = rep;
            repSelect.appendChild(option);
          });

          if (data.data.dateRange.earliest && typeof data.data.dateRange.earliest === 'string') {
            document.getElementById('filter-start-date').min = data.data.dateRange.earliest.split('T')[0];
          }
          if (data.data.dateRange.latest && typeof data.data.dateRange.latest === 'string') {
            document.getElementById('filter-end-date').max = data.data.dateRange.latest.split('T')[0];
          }
        }
      } catch (error) {
        console.error('Error loading filter options:', error);
      }
    }

    // ============================================
    // Data Loading
    // ============================================
    // Store wording and metaphors data
    let currentWordingData = null;
    let currentMetaphorsData = null;

    async function loadCopyData() {
      try {
        const params = new URLSearchParams();
        if (currentFilters.startDate) params.append('startDate', currentFilters.startDate);
        if (currentFilters.endDate) params.append('endDate', currentFilters.endDate);
        if (currentFilters.rep) params.append('rep', currentFilters.rep);
        if (currentFilters.keyword) params.append('keyword', currentFilters.keyword);
        params.append('limit', '50');

        // Fetch main data, wording, and metaphors in parallel
        const [mainResponse, wordingResponse, metaphorsResponse] = await Promise.all([
          fetch(`/api/dashboard?${params}`),
          fetch(`/api/dashboard/wording?${params}`),
          fetch(`/api/dashboard/metaphors?${params}`)
        ]);

        const [data, wordingData, metaphorsData] = await Promise.all([
          mainResponse.json(),
          wordingResponse.json(),
          metaphorsResponse.json()
        ]);

        if (data.success) {
          currentDashboardData = data.data;
          renderCopyData(data.data);
        } else {
          console.error('Error loading copy data:', data.error);
        }

        // Store and render wording data
        if (wordingData.success) {
          currentWordingData = wordingData.data;
          renderWordingSection();
        }

        // Store and render metaphors data
        if (metaphorsData.success) {
          currentMetaphorsData = metaphorsData.data;
          renderMetaphorsSection();
        }

      } catch (error) {
        console.error('Error loading copy data:', error);
      }
    }

    // ============================================
    // Label Normalization
    // ============================================

    // List of generic labels that need review
    const GENERIC_LABELS = new Set([
      'other', 'general', 'miscellaneous', 'various', 'unknown',
      'platform issues', 'platform failures', 'system issues', 'technical issues',
      'time constraints', 'resource limitations', 'process inefficiency',
      'growth', 'improvement', 'success', 'efficiency', 'better results',
      'concerns', 'worries', 'doubts', 'hesitation', 'uncertainty'
    ]);

    // Common label rewrites for better clarity
    const LABEL_REWRITES = {
      'manual time sink': 'Time Wasted on Manual Outreach',
      'platform failures': 'Software Tools Not Delivering Results',
      'affiliate recruitment difficulties': 'Difficulty Finding Quality Affiliates',
      'commission structures': 'Confusion About Commission Rates',
      'tracking issues': 'Affiliate Link/Tracking Problems',
      'agency experience': 'Bad Experience with Marketing Agencies',
      'outsourcing concerns': 'Concerns About Outsourcing Sales',
      'automation': 'Wants Automated Affiliate Outreach',
      'scale growth': 'Wants to Scale Affiliate Program',
      'quality affiliates': 'Wants Higher Quality Affiliates',
      'more sales': 'Wants More Revenue from Affiliates',
      'time savings': 'Wants to Save Time on Recruitment',
      'roi concerns': 'Questions About Return on Investment',
      'pricing objection': 'Price Seems Too High',
      'trust issues': 'Skeptical About Results/Claims',
      'complexity concerns': 'Worries About Implementation Complexity'
    };

    /**
     * Normalize a label for better display
     * @param {string} label - Original label
     * @param {string} quoteText - Sample quote for context
     * @param {string} type - Type of insight (pain, goal, etc.)
     * @returns {{ label: string, needsReview: boolean }}
     */
    function normalizeLabel(label, quoteText, type) {
      if (!label) return { label: 'Unspecified', needsReview: true };

      const lowerLabel = label.toLowerCase().trim();

      // Check for exact rewrite
      if (LABEL_REWRITES[lowerLabel]) {
        return { label: LABEL_REWRITES[lowerLabel], needsReview: false };
      }

      // Check if it's a generic label
      const isGeneric = GENERIC_LABELS.has(lowerLabel) ||
        lowerLabel.length < 4 ||
        lowerLabel === 'n/a' ||
        /^(other|misc|general|various)$/i.test(lowerLabel);

      if (isGeneric) {
        // Try to generate a better label from the quote
        const betterLabel = extractLabelFromQuote(quoteText, type);
        if (betterLabel) {
          return { label: betterLabel, needsReview: false };
        }
        return { label: capitalizeWords(label), needsReview: true };
      }

      // Clean up the label - capitalize and format
      return { label: capitalizeWords(label), needsReview: false };
    }

    /**
     * Extract a meaningful label from a quote
     */
    function extractLabelFromQuote(quote, type) {
      if (!quote || quote.length < 10) return null;

      // Keywords that indicate common themes
      const keywordPatterns = {
        pain: [
          { pattern: /wast(e|ing|ed)\s+(my\s+)?time/i, label: 'Time Wasted on Manual Tasks' },
          { pattern: /not\s+(getting|seeing|having)\s+(any\s+)?results?/i, label: 'Not Seeing Results' },
          { pattern: /too\s+(expensive|costly|much\s+money)/i, label: 'Cost Concerns' },
          { pattern: /can'?t\s+find\s+(good|quality)/i, label: 'Difficulty Finding Quality Partners' },
          { pattern: /competitor/i, label: 'Competitor Concerns' },
          { pattern: /tracking|attribution/i, label: 'Tracking/Attribution Issues' },
          { pattern: /trust|skeptic/i, label: 'Trust/Credibility Concerns' },
          { pattern: /agency|agencies/i, label: 'Agency Experience Issues' },
          { pattern: /manual|by\s+hand|myself/i, label: 'Manual Process Burden' },
          { pattern: /scale|growth|grow(ing)?/i, label: 'Scaling Challenges' }
        ],
        goal: [
          { pattern: /automat(e|ion|ed)/i, label: 'Automate Affiliate Recruitment' },
          { pattern: /scale|grow(th)?/i, label: 'Scale Affiliate Program' },
          { pattern: /more\s+(sales|revenue|money)/i, label: 'Increase Revenue' },
          { pattern: /save\s+time/i, label: 'Save Time on Outreach' },
          { pattern: /quality\s+(affiliates|partners)/i, label: 'Find Quality Affiliates' },
          { pattern: /handsfree|hands[\-\s]?free|passive/i, label: 'Hands-Free Growth' }
        ],
        objection: [
          { pattern: /expensive|price|cost/i, label: 'Price Concern' },
          { pattern: /trust|believe|proof/i, label: 'Trust/Proof Needed' },
          { pattern: /time|busy|bandwidth/i, label: 'Time/Bandwidth Concern' },
          { pattern: /complex|complicated|difficult/i, label: 'Complexity Concern' },
          { pattern: /tried\s+(before|already)/i, label: 'Tried Similar Before' }
        ]
      };

      const patterns = keywordPatterns[type] || [];
      for (const { pattern, label } of patterns) {
        if (pattern.test(quote)) {
          return label;
        }
      }

      return null;
    }

    /**
     * Capitalize first letter of each word
     */
    function capitalizeWords(str) {
      if (!str) return '';
      return str.replace(/\b\w/g, char => char.toUpperCase());
    }

    // ============================================
    // Rendering
    // ============================================
    function renderCopyData(data) {
      // Update KPIs
      document.getElementById('kpi-calls').textContent = data.summary.totalCalls;
      document.getElementById('kpi-pains').textContent = data.totalCounts.pains;
      document.getElementById('kpi-goals').textContent = data.totalCounts.goals;
      document.getElementById('kpi-questions').textContent = data.totalCounts.questions;
      document.getElementById('kpi-objections').textContent = data.totalCounts.dislikes;

      // Render sections
      renderPains(data.topPains, data.totalCounts.pains);
      renderGoals(data.topGoals, data.totalCounts.goals);
      renderQuestions(data.topQuestions, data.totalCounts.questions);
      renderPositive(data.topExcitement, data.totalCounts.excitement);
      renderObjections(data.topDislikes, data.totalCounts.dislikes);
      renderEmotions(data.topDislikes); // Derive emotions from dislikes
    }

    function renderPains(pains, total) {
      const container = document.getElementById('pains-list');
      document.getElementById('pains-count').textContent = total;

      if (!pains || pains.length === 0) {
        container.innerHTML = '<div class="copy-empty"><span class="copy-empty-text">No pain points identified yet</span></div>';
        return;
      }

      container.innerHTML = pains.map((pain, idx) => {
        const quote = pain.sampleQuotes && pain.sampleQuotes[0];
        const quoteText = quote ? (typeof quote === 'string' ? quote : quote.text) : null;
        const sourceCall = quote && typeof quote === 'object' ? quote : (pain.sourceCalls && pain.sourceCalls[0]);
        const { label, needsReview } = normalizeLabel(pain.category, quoteText, 'pain');

        return `
          <div class="copy-item" onclick="openContextDrawer('pain', ${JSON.stringify(pain).replace(/"/g, '&quot;')})">
            <span class="copy-rank ${pain.rank <= 3 ? 'top-3' : ''}">${pain.rank}</span>
            <div class="copy-item-content">
              <div class="copy-item-title ${needsReview ? 'needs-review' : ''}">
                ${pain.intensity && pain.intensity.High > 0 ? '<span class="copy-intensity high"></span>' : ''}
                ${escapeHtml(label)}
                ${needsReview ? '<span class="review-badge">Needs review</span>' : ''}
              </div>
              ${quoteText ? `<div class="copy-item-quote">"${escapeHtml(truncate(quoteText, 120))}"</div>` : ''}
              <div class="copy-item-meta">
                <span>${pain.occurrences} mentions</span>
                <span>${pain.calls} calls</span>
                ${sourceCall ? `<span class="copy-item-source">${escapeHtml(truncate(sourceCall.callTitle || sourceCall.title || 'Call', 25))} - ${formatShortDate(sourceCall.callDate || sourceCall.date)}</span>` : ''}
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    function renderGoals(goals, total) {
      const container = document.getElementById('goals-list');
      document.getElementById('goals-count').textContent = total;

      if (!goals || goals.length === 0) {
        container.innerHTML = '<div class="copy-empty"><span class="copy-empty-text">No goals identified yet</span></div>';
        return;
      }

      container.innerHTML = goals.map((goal, idx) => {
        const sourceCall = goal.sourceCalls && goal.sourceCalls[0];
        const { label, needsReview } = normalizeLabel(goal.goal, null, 'goal');

        return `
          <div class="copy-item" onclick="openContextDrawer('goal', ${JSON.stringify(goal).replace(/"/g, '&quot;')})">
            <span class="copy-rank ${goal.rank <= 3 ? 'top-3' : ''}">${goal.rank}</span>
            <div class="copy-item-content">
              <div class="copy-item-title ${needsReview ? 'needs-review' : ''}">
                ${goal.priority && goal.priority.high > 0 ? '<span class="copy-intensity high"></span>' : ''}
                ${escapeHtml(label)}
                ${needsReview ? '<span class="review-badge">Needs review</span>' : ''}
              </div>
              <div class="copy-item-meta">
                <span>${goal.occurrences} mentions</span>
                <span>${goal.calls} calls</span>
                ${sourceCall ? `<span class="copy-item-source">${escapeHtml(truncate(sourceCall.title || 'Call', 25))} - ${formatShortDate(sourceCall.date)}</span>` : ''}
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    function renderQuestions(questions, total) {
      const container = document.getElementById('questions-list');
      document.getElementById('questions-count').textContent = total;

      if (!questions || questions.length === 0) {
        container.innerHTML = '<div class="copy-empty"><span class="copy-empty-text">No questions captured yet</span></div>';
        return;
      }

      container.innerHTML = questions.map((q, idx) => {
        const sourceCall = q.sourceCalls && q.sourceCalls[0];

        return `
          <div class="copy-item" onclick="openContextDrawer('question', ${JSON.stringify(q).replace(/"/g, '&quot;')})">
            <span class="copy-rank ${q.rank <= 3 ? 'top-3' : ''}">${q.rank}</span>
            <div class="copy-item-content">
              <div class="copy-item-title">${escapeHtml(q.question)}</div>
              <div class="copy-item-meta">
                <span>${q.occurrences} times asked</span>
                <span>${q.calls} calls</span>
                ${sourceCall ? `<span class="copy-item-source">${escapeHtml(truncate(sourceCall.title || 'Call', 25))} - ${formatShortDate(sourceCall.date)}</span>` : ''}
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    function renderPositive(triggers, total) {
      const container = document.getElementById('positive-list');
      document.getElementById('positive-count').textContent = total;

      if (!triggers || triggers.length === 0) {
        container.innerHTML = '<div class="copy-empty"><span class="copy-empty-text">No positive reactions captured yet</span></div>';
        return;
      }

      container.innerHTML = triggers.map((t, idx) => {
        const quote = t.sampleQuotes && t.sampleQuotes[0];
        const quoteText = quote ? (typeof quote === 'string' ? quote : quote.text) : null;
        const sourceCall = quote && typeof quote === 'object' ? quote : (t.sourceCalls && t.sourceCalls[0]);

        return `
          <div class="copy-item" onclick="openContextDrawer('positive', ${JSON.stringify(t).replace(/"/g, '&quot;')})">
            <span class="copy-rank ${t.rank <= 3 ? 'top-3' : ''}">${t.rank}</span>
            <div class="copy-item-content">
              <div class="copy-item-title">${escapeHtml(t.trigger)}</div>
              ${quoteText ? `<div class="copy-item-quote">"${escapeHtml(truncate(quoteText, 120))}"</div>` : ''}
              <div class="copy-item-meta">
                <span>${t.occurrences} mentions</span>
                <span>${t.calls} calls</span>
                ${sourceCall ? `<span class="copy-item-source">${escapeHtml(truncate(sourceCall.callTitle || sourceCall.title || 'Call', 25))} - ${formatShortDate(sourceCall.callDate || sourceCall.date)}</span>` : ''}
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    function renderObjections(dislikes, total) {
      const container = document.getElementById('objections-list');
      document.getElementById('objections-count').textContent = total;

      if (!dislikes || dislikes.length === 0) {
        container.innerHTML = '<div class="copy-empty"><span class="copy-empty-text">No objections captured yet</span></div>';
        return;
      }

      container.innerHTML = dislikes.map((d, idx) => {
        const quote = d.sampleQuotes && d.sampleQuotes[0];
        const quoteText = quote ? (typeof quote === 'string' ? quote : quote.text) : null;
        const sourceCall = quote && typeof quote === 'object' ? quote : (d.sourceCalls && d.sourceCalls[0]);
        const { label, needsReview } = normalizeLabel(d.type, quoteText, 'objection');
        const typeBadgeClass = getObjectionTypeClass(d.type);

        return `
          <div class="copy-item" onclick="openContextDrawer('objection', ${JSON.stringify(d).replace(/"/g, '&quot;')})">
            <span class="copy-rank ${d.rank <= 3 ? 'top-3' : ''}">${d.rank}</span>
            <div class="copy-item-content">
              <div class="copy-item-title ${needsReview ? 'needs-review' : ''}">
                <span class="copy-type-badge ${typeBadgeClass}">${escapeHtml(label)}</span>
                ${needsReview ? '<span class="review-badge">Needs review</span>' : ''}
              </div>
              ${quoteText ? `<div class="copy-item-quote">"${escapeHtml(truncate(quoteText, 120))}"</div>` : ''}
              <div class="copy-item-meta">
                <span>${d.occurrences} mentions</span>
                <span>${d.calls} calls</span>
                <span>${d.resolved || 0} resolved</span>
                ${sourceCall ? `<span class="copy-item-source">${escapeHtml(truncate(sourceCall.callTitle || sourceCall.title || 'Call', 25))} - ${formatShortDate(sourceCall.callDate || sourceCall.date)}</span>` : ''}
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    function renderEmotions(dislikes) {
      const container = document.getElementById('emotions-list');

      // Extract and aggregate emotions from dislikes
      const emotionMap = new Map();

      if (dislikes) {
        dislikes.forEach(d => {
          if (d.emotions) {
            Object.entries(d.emotions).forEach(([emotion, count]) => {
              if (!emotionMap.has(emotion)) {
                emotionMap.set(emotion, { emotion, count: 0, sources: [] });
              }
              const entry = emotionMap.get(emotion);
              entry.count += count;
              if (d.sourceCalls) {
                entry.sources.push(...d.sourceCalls.slice(0, 1));
              }
            });
          }
        });
      }

      const emotions = Array.from(emotionMap.values())
        .sort((a, b) => b.count - a.count)
        .slice(0, 10)
        .map((e, idx) => ({ ...e, rank: idx + 1 }));

      document.getElementById('emotions-count').textContent = emotions.length;

      if (emotions.length === 0) {
        container.innerHTML = '<div class="copy-empty"><span class="copy-empty-text">No emotional triggers identified yet</span></div>';
        return;
      }

      container.innerHTML = emotions.map((e) => {
        const sourceCall = e.sources && e.sources[0];

        return `
          <div class="copy-item" onclick="openContextDrawer('emotion', ${JSON.stringify(e).replace(/"/g, '&quot;')})">
            <span class="copy-rank ${e.rank <= 3 ? 'top-3' : ''}">${e.rank}</span>
            <div class="copy-item-content">
              <div class="copy-item-title">${escapeHtml(e.emotion)}</div>
              <div class="copy-item-meta">
                <span>${e.count} occurrences</span>
                ${sourceCall ? `<span class="copy-item-source">${escapeHtml(truncate(sourceCall.title || 'Call', 25))} - ${formatShortDate(sourceCall.date)}</span>` : ''}
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    function getObjectionTypeClass(type) {
      if (!type) return '';
      const lower = type.toLowerCase();
      if (lower.includes('price') || lower.includes('cost') || lower.includes('expensive')) return 'price';
      if (lower.includes('trust') || lower.includes('skeptic') || lower.includes('doubt')) return 'trust';
      if (lower.includes('complex') || lower.includes('difficult') || lower.includes('confus')) return 'complexity';
      if (lower.includes('time') || lower.includes('busy') || lower.includes('later')) return 'time';
      return '';
    }

    // ============================================
    // Section Toggle
    // ============================================
    function toggleSection(sectionId) {
      const section = document.getElementById(`section-${sectionId}`);
      if (section) {
        section.classList.toggle('collapsed');
      }
    }

    // ============================================
    // Wording Section Rendering
    // ============================================
    function renderWordingSection() {
      if (!currentWordingData) return;

      // Update count
      const totalCount = (currentWordingData.totals?.industryTerms || 0) +
        (currentWordingData.totals?.problemLanguage || 0) +
        (currentWordingData.totals?.powerWords || 0);
      document.getElementById('wording-count').textContent = totalCount;

      // Render current tab
      renderWordingTab(currentWordingTab);
    }

    function switchWordingTab(tab) {
      currentWordingTab = tab;

      // Update active state
      document.querySelectorAll('.copy-subtab').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.subtab === tab);
      });

      renderWordingTab(tab);
    }

    function renderWordingTab(tab) {
      const container = document.getElementById('wording-list');

      if (!currentWordingData) {
        container.innerHTML = `<div class="copy-empty"><span class="copy-empty-text">Loading ${getWordingTabLabel(tab)}...</span></div>`;
        return;
      }

      let items = [];
      let itemType = '';

      switch (tab) {
        case 'industry':
          items = currentWordingData.industryTerms || [];
          itemType = 'term';
          break;
        case 'colloquial':
          items = currentWordingData.problemLanguage || [];
          itemType = 'phrase';
          break;
        case 'power':
          items = currentWordingData.powerWords || [];
          itemType = 'word';
          break;
      }

      if (items.length === 0) {
        container.innerHTML = `<div class="copy-empty"><span class="copy-empty-text">No ${getWordingTabLabel(tab).toLowerCase()} found in analyzed calls.</span></div>`;
        return;
      }

      // Render items
      container.innerHTML = items.slice(0, 30).map((item, index) => {
        const label = item.term || item.phrase || item.word || 'Unknown';
        const count = item.count || 1;
        const callCount = item.callCount || 1;
        const quote = item.quotes?.[0]?.text || '';
        const source = item.quotes?.[0] || {};
        const typeLabel = item.type || '';

        return `
          <div class="copy-item" data-type="${itemType}" data-label="${escapeHtml(label)}">
            <div class="copy-item-rank ${index < 3 ? 'top-rank' : ''}">${index + 1}</div>
            <div class="copy-item-content">
              <div class="copy-item-label">
                <span class="copy-item-text">${escapeHtml(label)}</span>
                ${typeLabel ? `<span class="copy-item-type-badge">${escapeHtml(typeLabel)}</span>` : ''}
              </div>
              ${quote ? `<div class="copy-item-quote">"${escapeHtml(quote.substring(0, 150))}${quote.length > 150 ? '...' : ''}"</div>` : ''}
              <div class="copy-item-meta">
                <span class="copy-item-mentions">${count} mention${count !== 1 ? 's' : ''}</span>
                <span class="copy-item-calls">${callCount} call${callCount !== 1 ? 's' : ''}</span>
                ${source.callTitle ? `
                  <span class="copy-item-source">
                    <a href="/admin/call.html?id=${source.callId}&from=copy" class="copy-source-link">${escapeHtml(source.callTitle)}</a>
                  </span>
                ` : ''}
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    function getWordingTabLabel(tab) {
      switch (tab) {
        case 'industry': return 'Industry Terms';
        case 'colloquial': return 'Problem Language';
        case 'power': return 'Power Words';
        default: return 'Wording';
      }
    }

    // ============================================
    // Metaphors Section Rendering
    // ============================================
    function renderMetaphorsSection() {
      const container = document.getElementById('metaphors-list');

      if (!currentMetaphorsData) {
        container.innerHTML = `<div class="copy-empty"><span class="copy-empty-text">Loading metaphors...</span></div>`;
        return;
      }

      const items = currentMetaphorsData.items || [];

      // Update count
      document.getElementById('metaphors-count').textContent = items.length;

      if (items.length === 0) {
        container.innerHTML = `<div class="copy-empty"><span class="copy-empty-text">No metaphors or analogies found in analyzed calls.</span></div>`;
        return;
      }

      // Render metaphors
      container.innerHTML = items.slice(0, 20).map((item, index) => {
        const excerpt = item.excerpt || '';
        const count = item.count || 1;
        const type = item.type || 'comparison';
        const marker = item.marker || '';
        const example = item.examples?.[0] || {};

        return `
          <div class="copy-item" data-type="metaphor">
            <div class="copy-item-rank ${index < 3 ? 'top-rank' : ''}">${index + 1}</div>
            <div class="copy-item-content">
              <div class="copy-item-label">
                <span class="copy-item-text">"${escapeHtml(excerpt)}"</span>
                <span class="copy-item-type-badge">${escapeHtml(type)}</span>
              </div>
              <div class="copy-item-meta">
                <span class="copy-item-mentions">${count} occurrence${count !== 1 ? 's' : ''}</span>
                ${example.callTitle ? `
                  <span class="copy-item-source">
                    <a href="/admin/call.html?id=${example.callId}&from=copy" class="copy-source-link">${escapeHtml(example.callTitle)}</a>
                  </span>
                ` : ''}
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    // ============================================
    // Context Drawer
    // ============================================
    async function openContextDrawer(type, item) {
      currentContextItem = { type, item };

      const overlay = document.getElementById('context-drawer-overlay');
      const body = document.getElementById('context-drawer-body');
      const title = document.getElementById('context-drawer-title');

      // Set title based on type
      const titles = {
        pain: 'Pain Point Context',
        goal: 'Goal Context',
        question: 'Question Context',
        positive: 'Positive Reaction Context',
        objection: 'Objection Context',
        emotion: 'Emotional Trigger Context'
      };
      title.textContent = titles[type] || 'Context';

      // Show drawer with loading state
      overlay.classList.add('active');
      body.innerHTML = '<div class="copy-loading"><div class="copy-loading-spinner"></div><span>Loading context...</span></div>';

      // Get source call info
      let sourceCallId = null;
      let quoteText = null;

      if (item.sampleQuotes && item.sampleQuotes[0]) {
        const quote = item.sampleQuotes[0];
        if (typeof quote === 'object') {
          sourceCallId = quote.callId;
          quoteText = quote.text;
        } else {
          quoteText = quote;
        }
      }

      if (!sourceCallId && item.sourceCalls && item.sourceCalls[0]) {
        sourceCallId = item.sourceCalls[0].id;
      }

      if (!sourceCallId) {
        body.innerHTML = renderContextWithoutCall(type, item);
        return;
      }

      try {
        // Fetch call data
        const response = await fetch(`/api/admin/calls/${sourceCallId}`);
        const result = await response.json();

        if (!result.success) {
          throw new Error(result.error || 'Failed to load call');
        }

        renderContextDrawerContent(type, item, result.data, quoteText);

      } catch (error) {
        console.error('Error loading context:', error);
        body.innerHTML = renderContextWithoutCall(type, item);
      }
    }

    function renderContextWithoutCall(type, item) {
      const itemTitle = getItemTitle(type, item);

      return `
        <div class="context-section">
          <div class="context-section-title">Item</div>
          <div class="context-full-quote">${escapeHtml(itemTitle)}</div>
        </div>
        <div class="context-section">
          <div class="context-section-title">Statistics</div>
          <div class="context-meta">
            <div class="context-meta-item">
              <span class="context-meta-label">Mentions:</span>
              <span>${item.occurrences || item.count || 0}</span>
            </div>
            <div class="context-meta-item">
              <span class="context-meta-label">Calls:</span>
              <span>${item.calls || 0}</span>
            </div>
          </div>
        </div>
        <div class="context-section">
          <div class="context-section-title">Transcript Context</div>
          <div class="context-summary" style="color: var(--color-text-muted); font-style: italic;">
            No transcript context available. Click "Open in Transcript" to view the full call.
          </div>
        </div>
      `;
    }

    function renderContextDrawerContent(type, item, callData, quoteText) {
      const body = document.getElementById('context-drawer-body');
      const itemTitle = getItemTitle(type, item);

      // Format call metadata
      const callDate = callData.datetime ? new Date(callData.datetime).toLocaleDateString('en-US', {
        weekday: 'short', month: 'short', day: 'numeric', year: 'numeric'
      }) : '-';
      const rep = callData.rep || callData.rep_name || '-';

      // Get transcript context (10 lines before/after)
      const transcriptContext = extractTranscriptContext(callData.transcript || callData.transcript_text, quoteText, 10);

      body.innerHTML = `
        <div class="context-section">
          <div class="context-section-title">Item</div>
          <div class="context-full-quote">${escapeHtml(itemTitle)}</div>
        </div>

        ${quoteText ? `
        <div class="context-section">
          <div class="context-section-title">Quote</div>
          <div class="context-full-quote">"${escapeHtml(quoteText)}"</div>
        </div>
        ` : ''}

        <div class="context-section">
          <div class="context-section-title">Source Call</div>
          <div class="context-meta">
            <div class="context-meta-item">
              <span class="context-meta-label">Call:</span>
              <span>${escapeHtml(callData.title || callData.call_title || 'Untitled')}</span>
            </div>
            <div class="context-meta-item">
              <span class="context-meta-label">Date:</span>
              <span>${callDate}</span>
            </div>
            <div class="context-meta-item">
              <span class="context-meta-label">Rep:</span>
              <span class="rep-badge ${getRepClass(rep)}">${getRepDisplayName(rep)}</span>
            </div>
          </div>
        </div>

        <div class="context-section">
          <div class="context-section-title">
            Transcript Context
            ${transcriptContext.isFuzzy ? '<span class="fuzzy-indicator">[~] closest match</span>' : ''}
          </div>
          <div class="context-transcript" id="context-transcript">
            ${transcriptContext.html}
          </div>
        </div>
      `;

      // Scroll to highlighted text
      setTimeout(() => {
        const highlighted = document.querySelector('.context-transcript .highlight');
        if (highlighted) {
          const container = document.getElementById('context-transcript');
          const containerRect = container.getBoundingClientRect();
          const highlightRect = highlighted.getBoundingClientRect();
          container.scrollTop = highlighted.offsetTop - container.clientHeight / 2 + highlighted.clientHeight / 2;
        }
      }, 100);
    }

    function getItemTitle(type, item) {
      switch (type) {
        case 'pain': return item.category || 'Pain Point';
        case 'goal': return item.goal || 'Goal';
        case 'question': return item.question || 'Question';
        case 'positive': return item.trigger || 'Positive Reaction';
        case 'objection': return item.type || 'Objection';
        case 'emotion': return item.emotion || 'Emotion';
        default: return 'Item';
      }
    }

    function extractTranscriptContext(transcript, quoteText, linesContext) {
      if (!transcript) {
        return { html: '<span style="color: var(--color-text-muted);">No transcript available</span>', isFuzzy: false };
      }

      const lines = transcript.split('\n');

      if (!quoteText) {
        // No quote to find, return first 20 lines
        const preview = lines.slice(0, 20);
        return { html: formatTranscriptLines(preview), isFuzzy: false };
      }

      // Try exact match first
      const normalizedQuote = normalizeText(quoteText);
      let matchLineIndex = -1;
      let isFuzzy = false;

      for (let i = 0; i < lines.length; i++) {
        if (normalizeText(lines[i]).includes(normalizedQuote)) {
          matchLineIndex = i;
          break;
        }
      }

      // If no exact match, try fuzzy matching
      if (matchLineIndex === -1) {
        const fuzzyResult = findFuzzyMatchLine(lines, quoteText);
        if (fuzzyResult.found) {
          matchLineIndex = fuzzyResult.lineIndex;
          isFuzzy = true;
        }
      }

      if (matchLineIndex === -1) {
        // No match found, return first 20 lines with note
        const preview = lines.slice(0, 20);
        return {
          html: '<span style="color: var(--color-text-muted); font-style: italic;">Quote not found in transcript. Showing beginning:</span>\n\n' + formatTranscriptLines(preview),
          isFuzzy: false
        };
      }

      // Extract context around the match
      const startLine = Math.max(0, matchLineIndex - linesContext);
      const endLine = Math.min(lines.length, matchLineIndex + linesContext + 1);
      const contextLines = lines.slice(startLine, endLine);

      // Highlight the matching line
      const highlightedLines = contextLines.map((line, idx) => {
        const actualIndex = startLine + idx;
        if (actualIndex === matchLineIndex) {
          return { line, highlight: true, fuzzy: isFuzzy };
        }
        return { line, highlight: false, fuzzy: false };
      });

      return {
        html: formatTranscriptLinesWithHighlight(highlightedLines),
        isFuzzy
      };
    }

    function formatTranscriptLines(lines) {
      return lines.map(line => {
        const match = line.match(/^([^:]+):\s*(.+)$/);
        if (match) {
          const speaker = match[1].trim().toLowerCase();
          const isRep = speaker.includes('phil') || speaker.includes('jamie');
          const className = isRep ? 'speaker-rep' : 'speaker-prospect';
          return `<span class="${className}">${escapeHtml(match[1])}:</span> ${escapeHtml(match[2])}`;
        }
        return escapeHtml(line);
      }).join('\n');
    }

    function formatTranscriptLinesWithHighlight(lines) {
      return lines.map(({ line, highlight, fuzzy }) => {
        const match = line.match(/^([^:]+):\s*(.+)$/);
        let formatted;
        if (match) {
          const speaker = match[1].trim().toLowerCase();
          const isRep = speaker.includes('phil') || speaker.includes('jamie');
          const className = isRep ? 'speaker-rep' : 'speaker-prospect';
          formatted = `<span class="${className}">${escapeHtml(match[1])}:</span> ${escapeHtml(match[2])}`;
        } else {
          formatted = escapeHtml(line);
        }

        if (highlight) {
          const highlightClass = fuzzy ? 'highlight fuzzy' : 'highlight';
          return `<mark class="${highlightClass}">${formatted}</mark>`;
        }
        return formatted;
      }).join('\n');
    }

    function findFuzzyMatchLine(lines, quoteText) {
      if (!quoteText || !lines.length) {
        return { found: false };
      }

      const quoteLower = quoteText.toLowerCase().trim();
      let bestMatch = { lineIndex: -1, score: 0 };

      for (let i = 0; i < lines.length; i++) {
        const lineLower = lines[i].toLowerCase();

        // Check for partial matches (first few words)
        const quoteWords = quoteLower.split(/\s+/).slice(0, 5);
        const lineWords = lineLower.split(/\s+/);

        let matchedWords = 0;
        for (const qWord of quoteWords) {
          if (lineWords.some(lWord => lWord.includes(qWord) || qWord.includes(lWord))) {
            matchedWords++;
          }
        }

        const score = matchedWords / quoteWords.length;
        if (score > bestMatch.score) {
          bestMatch = { lineIndex: i, score };
        }
      }

      // Only return fuzzy match if confidence is reasonable (> 60%)
      if (bestMatch.score >= 0.6) {
        return { found: true, lineIndex: bestMatch.lineIndex, matchType: 'fuzzy' };
      }

      return { found: false };
    }

    function normalizeText(text) {
      return text
        .toLowerCase()
        .replace(/['']/g, "'")
        .replace(/[""]/g, '"')
        .replace(/\s+/g, ' ')
        .trim();
    }

    function closeContextDrawer(event) {
      if (event && event.target !== event.currentTarget) return;
      document.getElementById('context-drawer-overlay').classList.remove('active');
      currentContextItem = null;
    }

    function openInTranscript() {
      if (!currentContextItem) return;

      let callId = null;
      let quoteText = null;
      const item = currentContextItem.item;

      if (item.sampleQuotes && item.sampleQuotes[0]) {
        const quote = item.sampleQuotes[0];
        if (typeof quote === 'object') {
          callId = quote.callId;
          quoteText = quote.text;
        } else {
          quoteText = quote;
        }
      }
      if (!callId && item.sourceCalls && item.sourceCalls[0]) {
        callId = item.sourceCalls[0].id;
      }

      if (callId) {
        let url = `/admin/call.html?id=${callId}&from=copy`;
        if (quoteText) {
          // Encode the quote for URL and add as highlight parameter
          url += `&highlight=${encodeURIComponent(quoteText.substring(0, 150))}`;
        }
        window.open(url, '_blank');
      }

      closeContextDrawer();
    }

    // ============================================
    // Filters
    // ============================================
    function applyFilters() {
      const preset = document.getElementById('filter-date-preset').value;
      const dateRange = getDatePresetRange(preset);

      currentFilters = {
        startDate: dateRange.startDate,
        endDate: dateRange.endDate,
        rep: document.getElementById('filter-rep').value || null,
        keyword: document.getElementById('filter-keyword').value || null
      };

      // Update URL with new filter state
      updateURLWithFilters(currentFilters, preset);

      // Show loading state
      document.querySelectorAll('.copy-list').forEach(el => {
        el.innerHTML = '<div class="copy-loading"><div class="copy-loading-spinner"></div><span>Loading...</span></div>';
      });

      loadCopyData();
    }

    function clearFilters() {
      document.getElementById('filter-date-preset').value = 'all';
      document.getElementById('filter-start-date').value = '';
      document.getElementById('filter-end-date').value = '';
      document.getElementById('filter-rep').value = '';
      document.getElementById('filter-keyword').value = '';

      document.getElementById('custom-start-group').style.display = 'none';
      document.getElementById('custom-end-group').style.display = 'none';

      currentFilters = {};

      // Clear URL parameters
      window.history.replaceState({}, '', window.location.pathname);

      loadCopyData();
    }

    // Refresh data from the database (no sync)
    async function refreshData() {
      const btn = document.getElementById('btn-refresh');
      const spinner = document.getElementById('refresh-spinner');
      const text = document.getElementById('refresh-text');

      btn.disabled = true;
      spinner.classList.remove('hidden');
      text.textContent = 'Loading...';

      // Show loading state in all copy lists
      document.querySelectorAll('.copy-list').forEach(el => {
        el.innerHTML = '<div class="copy-loading"><div class="copy-loading-spinner"></div><span>Loading...</span></div>';
      });

      try {
        await loadCopyData();

        text.textContent = 'Done!';
        setTimeout(() => {
          text.textContent = 'Refresh';
        }, 1500);

      } catch (error) {
        console.error('Error refreshing data:', error);
        text.textContent = 'Error';
        setTimeout(() => {
          text.textContent = 'Refresh';
        }, 2000);
      } finally {
        btn.disabled = false;
        spinner.classList.add('hidden');
      }
    }

    // ============================================
    // Export
    // ============================================
    async function exportToMarkdown() {
      if (!currentDashboardData) {
        alert('No data available. Please wait for the page to load.');
        return;
      }

      const params = new URLSearchParams();
      if (currentFilters.startDate) params.append('startDate', currentFilters.startDate);
      if (currentFilters.endDate) params.append('endDate', currentFilters.endDate);
      if (currentFilters.rep) params.append('rep', currentFilters.rep);
      if (currentFilters.keyword) params.append('keyword', currentFilters.keyword);
      params.append('limit', '1000');

      try {
        const response = await fetch(`/api/dashboard?${params}`);
        const result = await response.json();

        if (!result.success) {
          throw new Error(result.error || 'Failed to fetch data');
        }

        const data = result.data;
        const markdown = generateMarkdownExport(data);

        await navigator.clipboard.writeText(markdown);

        const btn = document.getElementById('btn-export');
        btn.classList.add('copied');
        btn.textContent = 'Copied!';
        setTimeout(() => {
          btn.classList.remove('copied');
          btn.textContent = 'Export MD';
        }, 2000);

      } catch (error) {
        console.error('Error exporting to Markdown:', error);
        alert('Failed to export. Please try again.');
      }
    }

    function generateMarkdownExport(data) {
      const lines = [];
      const now = new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });

      lines.push('# Customer Language Intelligence Export');
      lines.push('');
      lines.push(`**Generated:** ${now}`);

      if (currentFilters.startDate || currentFilters.endDate || currentFilters.rep || currentFilters.keyword) {
        lines.push('');
        lines.push('**Filters Applied:**');
        if (currentFilters.startDate) lines.push(`- Start Date: ${currentFilters.startDate}`);
        if (currentFilters.endDate) lines.push(`- End Date: ${currentFilters.endDate}`);
        if (currentFilters.rep) lines.push(`- Sales Rep: ${currentFilters.rep}`);
        if (currentFilters.keyword) lines.push(`- Keyword: ${currentFilters.keyword}`);
      }

      lines.push('');
      lines.push('## Summary');
      lines.push('');
      lines.push(`- **Total Calls Analyzed:** ${data.summary.totalCalls}`);
      lines.push(`- **Unique Pain Points:** ${data.totalCounts.pains}`);
      lines.push(`- **Unique Goals:** ${data.totalCounts.goals}`);
      lines.push(`- **Common Questions:** ${data.totalCounts.questions}`);
      lines.push(`- **Objections:** ${data.totalCounts.dislikes}`);

      // Pain Points
      if (data.topPains && data.topPains.length > 0) {
        lines.push('');
        lines.push('## Pain Points');
        lines.push('');
        data.topPains.forEach((pain, i) => {
          lines.push(`### ${i + 1}. ${pain.category}`);
          lines.push(`- **Mentions:** ${pain.occurrences} | **Calls:** ${pain.calls}`);
          if (pain.sampleQuotes && pain.sampleQuotes[0]) {
            const quote = typeof pain.sampleQuotes[0] === 'string' ? pain.sampleQuotes[0] : pain.sampleQuotes[0].text;
            if (quote) lines.push(`- *"${quote.substring(0, 200)}${quote.length > 200 ? '...' : ''}"*`);
          }
          lines.push('');
        });
      }

      // Goals
      if (data.topGoals && data.topGoals.length > 0) {
        lines.push('## Goals');
        lines.push('');
        data.topGoals.forEach((goal, i) => {
          lines.push(`### ${i + 1}. ${goal.goal}`);
          lines.push(`- **Mentions:** ${goal.occurrences} | **Calls:** ${goal.calls}`);
          lines.push('');
        });
      }

      // Questions
      if (data.topQuestions && data.topQuestions.length > 0) {
        lines.push('## Customer Questions');
        lines.push('');
        data.topQuestions.forEach((q, i) => {
          lines.push(`${i + 1}. **${q.question}** (${q.occurrences} times, ${q.calls} calls)`);
        });
        lines.push('');
      }

      // Positive Reactions
      if (data.topExcitement && data.topExcitement.length > 0) {
        lines.push('## Positive Reactions');
        lines.push('');
        data.topExcitement.forEach((t, i) => {
          lines.push(`### ${i + 1}. ${t.trigger}`);
          lines.push(`- **Mentions:** ${t.occurrences} | **Calls:** ${t.calls}`);
          if (t.sampleQuotes && t.sampleQuotes[0]) {
            const quote = typeof t.sampleQuotes[0] === 'string' ? t.sampleQuotes[0] : t.sampleQuotes[0].text;
            if (quote) lines.push(`- *"${quote.substring(0, 200)}${quote.length > 200 ? '...' : ''}"*`);
          }
          lines.push('');
        });
      }

      // Objections
      if (data.topDislikes && data.topDislikes.length > 0) {
        lines.push('## Objections & Criticism');
        lines.push('');
        data.topDislikes.forEach((d, i) => {
          lines.push(`### ${i + 1}. ${d.type}`);
          lines.push(`- **Mentions:** ${d.occurrences} | **Calls:** ${d.calls} | **Resolved:** ${d.resolved || 0}`);
          if (d.sampleQuotes && d.sampleQuotes[0]) {
            const quote = typeof d.sampleQuotes[0] === 'string' ? d.sampleQuotes[0] : d.sampleQuotes[0].text;
            if (quote) lines.push(`- *"${quote.substring(0, 200)}${quote.length > 200 ? '...' : ''}"*`);
          }
          lines.push('');
        });
      }

      lines.push('---');
      lines.push('*Exported from AffiliateFinder.ai Sales Call Analyzer*');

      return lines.join('\n');
    }

    // ============================================
    // Utility Functions
    // ============================================
    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Get CSS class for rep badge
    function getRepClass(repName) {
      if (!repName) return 'unknown';
      const name = repName.toLowerCase();
      if (name === 'both') return 'both';
      if (name.includes('phil')) return 'phil';
      if (name.includes('jamie')) return 'jamie';
      return 'unknown';
    }

    // Get display name for rep badge
    function getRepDisplayName(repName) {
      if (!repName) return 'Unknown';
      const name = repName.toLowerCase();
      if (name === 'both') return 'Both';
      if (name.includes('phil')) return 'Phil';
      if (name.includes('jamie')) return 'Jamie';
      return repName;
    }

    function truncate(text, maxLength) {
      if (!text) return '';
      if (text.length <= maxLength) return text;
      return text.substring(0, maxLength) + '...';
    }

    function formatShortDate(dateStr) {
      if (!dateStr) return '';
      const date = new Date(dateStr);
      return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    }

    // Close drawer on escape key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        closeContextDrawer();
      }
    });
  </script>
  <script src="js/analysis-status.js"></script>
</body>
</html>
