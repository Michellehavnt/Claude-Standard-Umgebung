<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Lead Quality - Sales Call Analyzer</title>
  <link rel="stylesheet" href="design-system.css">
  <style>
    /* Page-specific styles */

    /* Tabs */
    .tabs-container {
      display: flex;
      gap: var(--space-1);
      margin-bottom: var(--space-6);
      border-bottom: 2px solid var(--color-border);
    }

    .tab-btn {
      padding: var(--space-3) var(--space-5);
      background: none;
      border: none;
      font-size: var(--text-sm);
      font-weight: 500;
      color: var(--color-text-secondary);
      cursor: pointer;
      position: relative;
      transition: color var(--transition-fast);
    }

    .tab-btn:hover {
      color: var(--color-text-primary);
    }

    .tab-btn.active {
      color: var(--color-primary);
    }

    .tab-btn.active::after {
      content: '';
      position: absolute;
      bottom: -2px;
      left: 0;
      right: 0;
      height: 2px;
      background: var(--color-primary);
    }

    .tab-btn .tab-count {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 20px;
      height: 20px;
      padding: 0 var(--space-2);
      margin-left: var(--space-2);
      background: var(--color-surface-secondary);
      border-radius: var(--radius-full);
      font-size: var(--text-xs);
      font-weight: 600;
    }

    .tab-btn.active .tab-count {
      background: var(--color-primary-light);
      color: var(--color-primary);
    }

    .tab-panel {
      display: none;
    }

    .tab-panel.active {
      display: block;
    }

    /* Filter row layout */
    .ds-filters-row {
      display: flex;
      flex-wrap: wrap;
      gap: var(--space-4);
      align-items: flex-end;
    }

    .ds-filter-group {
      display: flex;
      flex-direction: column;
      gap: var(--space-1);
    }

    .ds-filter-label {
      font-size: var(--text-xs);
      font-weight: 500;
      color: var(--color-text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .ds-filter-actions {
      display: flex;
      gap: var(--space-2);
      margin-left: auto;
    }

    @media (max-width: 768px) {
      .ds-filters-row {
        flex-direction: column;
        align-items: stretch;
      }

      .ds-filter-group {
        width: 100%;
      }

      .ds-filter-actions {
        margin-left: 0;
        margin-top: var(--space-3);
      }
    }

    /* KPI Strip */
    .kpi-strip {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: var(--space-4);
      margin-bottom: var(--space-6);
    }

    .kpi-card {
      background: var(--color-surface);
      border-radius: var(--radius-lg);
      padding: var(--space-4);
      border: 1px solid var(--color-border);
      text-align: center;
    }

    .kpi-value {
      font-size: var(--text-2xl);
      font-weight: 700;
      color: var(--color-text-primary);
      line-height: 1;
    }

    .kpi-value.success { color: var(--color-success); }
    .kpi-value.warning { color: #f59e0b; }
    .kpi-value.danger { color: var(--color-danger); }
    .kpi-value.primary { color: var(--color-primary); }

    .kpi-label {
      font-size: var(--text-xs);
      color: var(--color-text-secondary);
      text-transform: uppercase;
      margin-top: var(--space-2);
      letter-spacing: 0.5px;
      font-weight: var(--weight-medium);
    }

    @media (max-width: 900px) {
      .kpi-strip { grid-template-columns: repeat(3, 1fr); }
    }

    @media (max-width: 600px) {
      .kpi-strip { grid-template-columns: repeat(2, 1fr); }
    }

    /* Leads Table */
    .leads-section {
      background: var(--color-surface);
      border-radius: var(--radius-lg);
      border: 1px solid var(--color-border);
      overflow-x: auto;
    }

    .leads-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: var(--space-4) var(--space-5);
      border-bottom: 1px solid var(--color-border);
    }

    .leads-header h3 {
      margin: 0;
      font-size: var(--text-base);
      font-weight: 600;
    }

    .leads-count {
      font-size: var(--text-sm);
      color: var(--color-text-muted);
    }

    .leads-table {
      width: 100%;
      border-collapse: collapse;
    }

    .leads-table th {
      padding: var(--space-3) var(--space-4);
      text-align: left;
      font-size: var(--text-xs);
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--color-text-secondary);
      background: var(--color-surface-secondary);
      border-bottom: 1px solid var(--color-border);
    }

    .leads-table td {
      padding: var(--space-3) var(--space-4);
      font-size: var(--text-sm);
      border-bottom: 1px solid var(--color-border-light);
      vertical-align: middle;
    }

    .leads-table tbody tr:hover {
      background: var(--color-surface-hover);
      cursor: pointer;
    }

    /* Score Badge */
    .score-badge {
      display: inline-flex;
      align-items: center;
      gap: var(--space-2);
      padding: var(--space-1) var(--space-2);
      border-radius: var(--radius-md);
      font-size: var(--text-xs);
      font-weight: 600;
    }

    .score-badge.high {
      background: rgba(16, 185, 129, 0.1);
      color: var(--color-success);
    }

    .score-badge.medium {
      background: rgba(245, 158, 11, 0.1);
      color: #f59e0b;
    }

    .score-badge.low {
      background: rgba(239, 68, 68, 0.1);
      color: var(--color-danger);
    }

    .score-badge.pending {
      background: var(--color-surface-secondary);
      color: var(--color-text-muted);
    }

    .score-badge.override {
      border: 1px dashed currentColor;
    }

    .score-pips {
      display: flex;
      gap: 2px;
    }

    .score-pip {
      width: 4px;
      height: 10px;
      border-radius: 1px;
      background: var(--color-border);
    }

    .score-pip.active.high { background: var(--color-success); }
    .score-pip.active.medium { background: #f59e0b; }
    .score-pip.active.low { background: var(--color-danger); }

    /* Call Status Badge */
    .call-status {
      display: inline-flex;
      align-items: center;
      gap: var(--space-1);
      padding: var(--space-1) var(--space-2);
      border-radius: var(--radius-md);
      font-size: var(--text-xs);
      font-weight: 500;
    }

    .call-status.upcoming {
      background: rgba(59, 130, 246, 0.1);
      color: #3b82f6;
    }

    .call-status.completed {
      background: rgba(16, 185, 129, 0.1);
      color: var(--color-success);
    }

    .call-status.analyzed {
      background: rgba(139, 92, 246, 0.1);
      color: #8b5cf6;
    }

    /* Row Actions */
    .row-actions {
      display: flex;
      gap: var(--space-2);
    }

    .action-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 32px;
      height: 32px;
      padding: 0;
      background: var(--color-surface-secondary);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: all var(--transition-fast);
    }

    .action-btn:hover {
      background: var(--color-primary-light);
      border-color: var(--color-primary);
    }

    .action-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .action-btn img {
      width: 18px;
      height: 18px;
      object-fit: contain;
    }

    .action-btn svg {
      width: 16px;
      height: 16px;
    }

    .action-btn-danger:hover {
      background: var(--color-error-light, #fee2e2);
      border-color: var(--color-error, #ef4444);
      color: var(--color-error, #ef4444);
    }

    /* Lead Detail */
    .lead-detail {
      display: none;
    }

    .lead-detail.expanded {
      display: table-row;
    }

    .lead-detail td {
      background: var(--color-surface-secondary);
      padding: 0 !important;
    }

    .lead-detail-content {
      padding: var(--space-4) var(--space-5);
    }

    .detail-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: var(--space-6);
    }

    @media (max-width: 900px) {
      .detail-grid {
        grid-template-columns: 1fr;
      }
    }

    .detail-section {
      background: var(--color-surface);
      border-radius: var(--radius-md);
      padding: var(--space-4);
      border: 1px solid var(--color-border-light);
    }

    .detail-section-title {
      font-size: var(--text-xs);
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--color-text-secondary);
      margin-bottom: var(--space-3);
    }

    .bucket-score {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      padding: var(--space-2) 0;
      border-bottom: 1px solid var(--color-border-light);
    }

    .bucket-score:last-child {
      border-bottom: none;
    }

    .bucket-label {
      font-size: var(--text-sm);
      font-weight: 500;
      color: var(--color-text-primary);
    }

    .bucket-rationale {
      font-size: var(--text-xs);
      color: var(--color-text-muted);
      margin-top: var(--space-1);
    }

    .bucket-value {
      font-weight: 600;
      font-size: var(--text-sm);
      color: var(--color-primary);
      white-space: nowrap;
    }

    /* Form Responses */
    .form-responses {
      display: grid;
      gap: var(--space-3);
    }

    .form-response {
      padding: var(--space-2) 0;
      border-bottom: 1px solid var(--color-border-light);
    }

    .form-response:last-child {
      border-bottom: none;
    }

    .form-response-question {
      font-size: var(--text-xs);
      font-weight: 500;
      color: var(--color-text-secondary);
      margin-bottom: var(--space-1);
    }

    .form-response-answer {
      font-size: var(--text-sm);
      color: var(--color-text-primary);
    }

    /* Transcript Analysis */
    .transcript-analysis {
      margin-top: var(--space-4);
      padding-top: var(--space-4);
      border-top: 1px solid var(--color-border-light);
    }

    .analysis-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: var(--space-3);
      margin-top: var(--space-3);
    }

    .analysis-item {
      background: var(--color-surface-secondary);
      padding: var(--space-2) var(--space-3);
      border-radius: var(--radius-sm);
    }

    .analysis-item-label {
      font-size: var(--text-xs);
      color: var(--color-text-muted);
    }

    .analysis-item-value {
      font-size: var(--text-sm);
      font-weight: 500;
      color: var(--color-text-primary);
    }

    .buying-signals, .objections-list {
      margin-top: var(--space-3);
    }

    .signal-tag {
      display: inline-block;
      padding: var(--space-1) var(--space-2);
      margin: var(--space-1);
      background: rgba(16, 185, 129, 0.1);
      color: var(--color-success);
      border-radius: var(--radius-sm);
      font-size: var(--text-xs);
    }

    .objection-tag {
      display: inline-block;
      padding: var(--space-1) var(--space-2);
      margin: var(--space-1);
      background: rgba(239, 68, 68, 0.1);
      color: var(--color-danger);
      border-radius: var(--radius-sm);
      font-size: var(--text-xs);
    }

    /* Config Warning */
    .config-warning {
      display: none;
      align-items: center;
      gap: var(--space-3);
      padding: var(--space-3) var(--space-4);
      background: #fef3c7;
      border: 1px solid #fcd34d;
      border-radius: var(--radius-md);
      margin-bottom: var(--space-6);
    }

    .config-warning.active {
      display: flex;
    }

    .config-warning-icon {
      font-size: var(--text-lg);
      color: #f59e0b;
    }

    .config-warning-text {
      font-size: var(--text-sm);
      color: #92400e;
    }

    .config-warning-text a {
      color: #92400e;
      font-weight: 500;
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: var(--space-8) var(--space-4);
    }

    .empty-state-icon {
      font-size: 48px;
      margin-bottom: var(--space-4);
      opacity: 0.5;
    }

    .empty-state-title {
      font-size: var(--text-lg);
      font-weight: 600;
      margin-bottom: var(--space-2);
    }

    .empty-state p {
      color: var(--color-text-muted);
      font-size: var(--text-sm);
    }

    /* Modal */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .modal-overlay.active {
      display: flex;
    }

    .modal {
      background: var(--color-surface);
      border-radius: var(--radius-lg);
      padding: var(--space-6);
      width: 100%;
      max-width: 400px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
    }

    .modal-title {
      font-size: var(--text-lg);
      font-weight: 600;
      margin-bottom: var(--space-4);
    }

    .modal-actions {
      display: flex;
      gap: var(--space-3);
      justify-content: flex-end;
      margin-top: var(--space-6);
    }

    .generated-at {
      text-align: center;
      font-size: var(--text-xs);
      color: var(--color-text-muted);
      margin-top: var(--space-6);
    }

    /* Transcript Modal - Model Selector */
    .modal.transcript-modal {
      max-width: 500px;
    }

    .model-selector {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: var(--space-3);
      margin-top: var(--space-3);
    }

    .model-btn {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: var(--space-2);
      padding: var(--space-4);
      border: 2px solid var(--color-border);
      border-radius: var(--radius-lg);
      background: var(--color-surface);
      cursor: pointer;
      transition: all var(--transition-fast);
    }

    .model-btn:hover {
      border-color: var(--color-primary-light);
      background: var(--color-surface-hover);
    }

    .model-btn.active {
      border-color: var(--color-primary);
      background: var(--color-primary-light);
    }

    .model-icon {
      width: 32px;
      height: 32px;
      object-fit: contain;
    }

    .model-btn span:first-of-type {
      font-weight: 600;
      font-size: var(--text-sm);
    }

    .model-desc {
      font-size: var(--text-xs);
      color: var(--color-text-muted);
      text-align: center;
    }

    /* Transcript Status */
    .transcript-status {
      margin-top: var(--space-4);
      padding: var(--space-4);
      border-radius: var(--radius-md);
      background: var(--color-surface-secondary);
    }

    .transcript-status.has-transcript {
      background: rgba(16, 185, 129, 0.1);
      border: 1px solid rgba(16, 185, 129, 0.2);
    }

    .transcript-status.no-transcript {
      background: rgba(245, 158, 11, 0.1);
      border: 1px solid rgba(245, 158, 11, 0.2);
    }

    .transcript-status-header {
      display: flex;
      align-items: center;
      gap: var(--space-2);
      font-weight: 500;
      font-size: var(--text-sm);
      margin-bottom: var(--space-2);
    }

    .transcript-status-text {
      font-size: var(--text-xs);
      color: var(--color-text-secondary);
    }

    .transcript-actions {
      display: flex;
      gap: var(--space-2);
      margin-top: var(--space-3);
    }

    .transcript-actions .ds-btn {
      flex: 1;
      font-size: var(--text-xs);
      padding: var(--space-2) var(--space-3);
    }

    /* Model section label */
    .modal-section-label {
      font-size: var(--text-xs);
      font-weight: 500;
      color: var(--color-text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: var(--space-2);
    }

    /* Analysis Info Header - clean design */
    .analysis-info-header {
      display: flex;
      align-items: center;
      gap: var(--space-4);
      padding: var(--space-3) var(--space-4);
      background: linear-gradient(135deg, var(--color-primary-light), rgba(99, 102, 241, 0.05));
      border-radius: var(--radius-md);
      margin-bottom: var(--space-4);
      border: 1px solid rgba(99, 102, 241, 0.15);
    }

    .analysis-info-header .info-item {
      display: flex;
      align-items: center;
      gap: var(--space-2);
      font-size: var(--text-xs);
      color: var(--color-text-secondary);
    }

    .analysis-info-header .info-item strong {
      color: var(--color-text-primary);
      font-weight: 600;
    }

    .analysis-info-header .info-divider {
      width: 1px;
      height: 16px;
      background: var(--color-border);
    }

    /* LinkedIn Badge */
    .linkedin-badge {
      display: inline-flex;
      align-items: center;
      gap: var(--space-2);
      padding: var(--space-2) var(--space-3);
      background: linear-gradient(135deg, #0077b5, #005a8c);
      color: white;
      border-radius: var(--radius-md);
      font-size: var(--text-sm);
      font-weight: 500;
      text-decoration: none;
      transition: all var(--transition-fast);
      box-shadow: 0 2px 4px rgba(0, 119, 181, 0.2);
    }

    .linkedin-badge:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(0, 119, 181, 0.3);
    }

    .linkedin-badge svg {
      width: 16px;
      height: 16px;
      fill: white;
    }

    /* Cleaner Detail Sections */
    .detail-section-clean {
      background: var(--color-surface);
      border-radius: var(--radius-lg);
      padding: var(--space-5);
      border: 1px solid var(--color-border-light);
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.04);
    }

    .detail-section-clean + .detail-section-clean {
      margin-top: var(--space-4);
    }

    .section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: var(--space-4);
      padding-bottom: var(--space-3);
      border-bottom: 1px solid var(--color-border-light);
    }

    .section-header h4 {
      font-size: var(--text-sm);
      font-weight: 600;
      color: var(--color-text-primary);
      margin: 0;
      display: flex;
      align-items: center;
      gap: var(--space-2);
    }

    .section-header .section-icon {
      font-size: var(--text-base);
    }

    /* Score Item Clean */
    .score-item-clean {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      padding: var(--space-3);
      background: var(--color-surface-secondary);
      border-radius: var(--radius-md);
      margin-bottom: var(--space-2);
    }

    .score-item-clean:last-child {
      margin-bottom: 0;
    }

    .score-item-clean .score-info {
      flex: 1;
    }

    .score-item-clean .score-label {
      font-size: var(--text-sm);
      font-weight: 500;
      color: var(--color-text-primary);
      margin-bottom: var(--space-1);
    }

    .score-item-clean .score-rationale {
      font-size: var(--text-xs);
      color: var(--color-text-muted);
      line-height: 1.4;
    }

    .score-item-clean .score-value {
      font-size: var(--text-lg);
      font-weight: 700;
      color: var(--color-primary);
      min-width: 50px;
      text-align: right;
    }

    /* Research Results Clean */
    .research-card {
      background: var(--color-surface-secondary);
      border-radius: var(--radius-md);
      padding: var(--space-3);
      margin-bottom: var(--space-3);
    }

    .research-card:last-child {
      margin-bottom: 0;
    }

    .research-card-title {
      font-size: var(--text-xs);
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--color-text-secondary);
      margin-bottom: var(--space-2);
      display: flex;
      align-items: center;
      gap: var(--space-2);
    }

    .research-card-content {
      font-size: var(--text-sm);
      color: var(--color-text-primary);
      line-height: 1.5;
    }

    .research-card-content p {
      margin: 0 0 var(--space-1) 0;
    }

    .research-card-content p:last-child {
      margin-bottom: 0;
    }

    .research-card-content strong {
      color: var(--color-text-secondary);
      font-weight: 500;
    }

    /* Form Response Clean */
    .form-response-clean {
      padding: var(--space-3);
      background: var(--color-surface-secondary);
      border-radius: var(--radius-md);
      margin-bottom: var(--space-2);
    }

    .form-response-clean:last-child {
      margin-bottom: 0;
    }

    .form-response-clean .question {
      font-size: var(--text-xs);
      font-weight: 500;
      color: var(--color-text-secondary);
      margin-bottom: var(--space-1);
    }

    .form-response-clean .answer {
      font-size: var(--text-sm);
      color: var(--color-text-primary);
    }

    /* Analysis Button - matches design system primary colors */
    .analyze-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: var(--space-2);
      padding: var(--space-2) var(--space-3);
      background: var(--color-primary);
      color: white;
      border: none;
      border-radius: var(--radius-md);
      font-size: var(--text-xs);
      font-weight: 600;
      cursor: pointer;
      transition: all var(--transition-fast);
      box-shadow: 0 2px 4px rgba(7, 59, 85, 0.15);
    }

    .analyze-btn:hover {
      background: var(--color-primary-hover);
      box-shadow: 0 4px 8px rgba(7, 59, 85, 0.2);
    }

    .analyze-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      background: var(--color-text-muted);
    }

    .analyze-btn svg {
      width: 14px;
      height: 14px;
    }

    /* Loading Bar */
    .loading-bar-container {
      width: 100%;
      height: 4px;
      background: var(--color-surface-secondary);
      border-radius: 2px;
      overflow: hidden;
      margin-top: var(--space-3);
      display: none;
    }

    .loading-bar-container.active {
      display: block;
    }

    .loading-bar {
      height: 100%;
      background: linear-gradient(90deg, var(--color-primary), #8b5cf6, var(--color-primary));
      background-size: 200% 100%;
      animation: loadingAnimation 1.5s ease-in-out infinite;
      border-radius: 2px;
    }

    @keyframes loadingAnimation {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }

    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    /* Unified Analyze Modal - Larger and cleaner */
    .modal.analyze-modal {
      max-width: 580px;
      padding: var(--space-6) var(--space-8);
    }

    .analyze-modal .analyze-modal-header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      margin-bottom: var(--space-5);
    }

    .analyze-modal .modal-title {
      margin: 0;
      text-align: left;
    }

    .analyze-modal .modal-subtitle {
      font-size: var(--text-sm);
      color: var(--color-text-secondary);
      margin-top: var(--space-1);
      text-align: left;
    }

    .analyze-modal .close-btn {
      background: none;
      border: none;
      padding: var(--space-2);
      cursor: pointer;
      color: var(--color-text-muted);
      border-radius: var(--radius-sm);
      transition: all var(--transition-fast);
      flex-shrink: 0;
    }

    .analyze-modal .close-btn:hover {
      background: var(--color-surface-secondary);
      color: var(--color-text-primary);
    }

    .analyze-modal .modal-body {
      text-align: left;
      padding: var(--space-4) 0;
    }

    .analyze-modal .modal-section-label {
      text-align: left;
      font-weight: 600;
      margin-bottom: var(--space-4);
      font-size: var(--text-sm);
      color: var(--color-text-secondary);
      margin-bottom: var(--space-3);
    }

    /* Model Cards - Side by side layout with more space */
    .model-cards {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: var(--space-4);
    }

    @media (max-width: 560px) {
      .model-cards {
        grid-template-columns: 1fr;
      }
    }

    .model-card {
      display: flex;
      align-items: center;
      gap: var(--space-3);
      padding: var(--space-4);
      border: 2px solid var(--color-border);
      border-radius: var(--radius-lg);
      background: var(--color-surface);
      cursor: pointer;
      transition: all var(--transition-fast);
      min-height: 80px;
    }

    .model-card:hover {
      border-color: var(--color-primary-light);
      background: var(--color-surface-hover);
    }

    .model-card.selected {
      border-color: var(--color-primary);
      background: var(--color-primary-light);
    }

    .model-card .model-icon-wrap {
      width: 52px;
      height: 52px;
      min-width: 52px;
      border-radius: var(--radius-md);
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--color-surface-secondary);
      overflow: hidden;
    }

    .model-card.selected .model-icon-wrap {
      background: white;
    }

    .model-card .model-icon {
      width: 36px;
      height: 36px;
      object-fit: contain;
    }

    .model-card .model-info {
      flex: 1;
      min-width: 0;
      text-align: left;
    }

    .model-card .model-name {
      font-weight: 600;
      font-size: var(--text-sm);
      color: var(--color-text-primary);
      margin-bottom: 2px;
      white-space: nowrap;
    }

    .model-card .model-desc {
      font-size: var(--text-xs);
      color: var(--color-text-muted);
      white-space: nowrap;
    }

    .model-card .model-check {
      width: 20px;
      height: 20px;
      border: 2px solid var(--color-border);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .model-card.selected .model-check {
      border-color: var(--color-primary);
      background: var(--color-primary);
    }

    .model-card .model-check svg {
      width: 12px;
      height: 12px;
      color: white;
      display: none;
    }

    .model-card.selected .model-check svg {
      display: block;
    }

    /* Transcript Status in Modal */
    .transcript-status-modal {
      margin-bottom: var(--space-4);
      padding: var(--space-3) var(--space-4);
      border-radius: var(--radius-md);
      display: flex;
      align-items: center;
      gap: var(--space-3);
    }

    .transcript-status-modal.available {
      background: rgba(16, 185, 129, 0.1);
      border: 1px solid rgba(16, 185, 129, 0.3);
    }

    .transcript-status-modal.unavailable {
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid rgba(239, 68, 68, 0.3);
    }

    .transcript-status-modal .status-icon {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
    }

    .transcript-status-modal.available .status-icon {
      background: var(--color-success);
      color: white;
    }

    .transcript-status-modal.unavailable .status-icon {
      background: var(--color-danger);
      color: white;
    }

    .transcript-status-modal .status-text {
      flex: 1;
    }

    .transcript-status-modal .status-title {
      font-weight: 600;
      font-size: var(--text-sm);
      color: var(--color-text-primary);
    }

    .transcript-status-modal .status-subtitle {
      font-size: var(--text-xs);
      color: var(--color-text-secondary);
    }

    /* Analyzed Button State (Green) - uses design system success color */
    .analyze-btn.analyzed {
      background: var(--color-success);
      box-shadow: 0 2px 4px rgba(13, 148, 136, 0.15);
    }

    .analyze-btn.analyzed:hover {
      background: #0a7d73;
      box-shadow: 0 4px 8px rgba(13, 148, 136, 0.2);
    }

    /* Analysis Metadata in Table Row */
    .analysis-meta {
      font-size: 10px;
      color: var(--color-text-muted);
      margin-top: 2px;
    }

    /* Deal Stage Dropdown */
    .deal-stage-select {
      font-size: var(--text-xs);
      padding: var(--space-1) var(--space-2);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-sm);
      background: var(--color-surface);
      color: var(--color-text-primary);
      cursor: pointer;
      min-width: 100px;
    }

    .deal-stage-select:focus {
      outline: none;
      border-color: var(--color-primary);
    }

    .deal-stage-select.closed {
      background: rgba(16, 185, 129, 0.1);
      border-color: var(--color-success);
      color: var(--color-success);
    }

    .deal-stage-select.lost {
      background: rgba(239, 68, 68, 0.1);
      border-color: var(--color-danger);
      color: var(--color-danger);
    }

    .deal-stage-select.follow-up {
      background: rgba(245, 158, 11, 0.1);
      border-color: #f59e0b;
      color: #f59e0b;
    }
  </style>
</head>
<body>
  <header class="ds-header">
    <div class="ds-header-inner">
      <a href="/admin/" class="ds-header-logo">
        <img src="/admin/logo.svg" alt="AffiliateFinder">
      </a>
      <div class="ds-header-divider"></div>
      <nav class="ds-header-nav">
        <a href="/admin/">Calls</a>
        <a href="/admin/lead-quality.html" class="active">Lead Quality</a>
        <a href="/admin/copy.html">Copy</a>
        <a href="/admin/phil.html">DFY</a>
        <a href="/admin/founder.html">Closing Rate</a>
      </nav>

      <!-- User Menu -->
      <div class="ds-header-user">
        <button class="ds-user-button" id="user-menu-button" aria-expanded="false" aria-haspopup="true">
          <div class="ds-user-avatar" id="user-avatar">-</div>
          <div class="ds-user-info">
            <span class="ds-user-name" id="user-display-name">Loading...</span>
            <span class="ds-user-role" id="user-display-role">-</span>
          </div>
          <svg class="ds-user-chevron" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="6 9 12 15 18 9"></polyline>
          </svg>
        </button>

        <div class="ds-user-dropdown" id="user-dropdown">
          <div class="ds-dropdown-header">
            <div class="ds-dropdown-email" id="user-email">-</div>
            <span class="ds-dropdown-role user" id="user-role-badge">User</span>
          </div>

          <div class="ds-dropdown-section">
            <a href="/admin/account.html" class="ds-dropdown-item">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                <circle cx="12" cy="7" r="4"></circle>
              </svg>
              Account
            </a>
            <a href="/admin/settings.html" class="ds-dropdown-item">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="3"></circle>
                <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
              </svg>
              Settings
            </a>
            <a href="/admin/changelog.html" class="ds-dropdown-item">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                <polyline points="14 2 14 8 20 8"></polyline>
                <line x1="16" y1="13" x2="8" y2="13"></line>
                <line x1="16" y1="17" x2="8" y2="17"></line>
                <polyline points="10 9 9 9 8 9"></polyline>
              </svg>
              Changelog
            </a>
          </div>

          <div class="ds-dropdown-divider ds-admin-only" style="display: none;"></div>

          <div class="ds-dropdown-section ds-admin-only" style="display: none;">
            <div class="ds-dropdown-label">Admin</div>
            <a href="/admin/access-requests.html" class="ds-dropdown-item">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                <circle cx="8.5" cy="7" r="4"></circle>
                <line x1="20" y1="8" x2="20" y2="14"></line>
                <line x1="23" y1="11" x2="17" y2="11"></line>
              </svg>
              Access Requests
            </a>
            <a href="/admin/users.html" class="ds-dropdown-item">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                <circle cx="9" cy="7" r="4"></circle>
                <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
              </svg>
              User Management
            </a>
          </div>

          <div class="ds-dropdown-divider"></div>

          <div class="ds-dropdown-section">
            <button class="ds-dropdown-item danger" onclick="logout()">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                <polyline points="16 17 21 12 16 7"></polyline>
                <line x1="21" y1="12" x2="9" y2="12"></line>
              </svg>
              Sign Out
            </button>
          </div>
        </div>
      </div>
    </div>
  </header>

  <main class="ds-main">
    <div class="ds-container">
      <!-- Page Header -->
      <div class="ds-page-header">
        <div>
          <h1 class="ds-page-title">Lead Quality</h1>
          <p class="ds-page-subtitle">AI-powered lead scoring for Calendly bookings</p>
        </div>
        <div style="display: flex; gap: var(--space-3);">
          <button class="ds-btn ds-btn-secondary" id="btn-refresh" onclick="syncLeads()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M23 4v6h-6"></path>
              <path d="M1 20v-6h6"></path>
              <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
            </svg>
            <span id="refresh-text">Sync Leads</span>
          </button>
        </div>
      </div>

      <!-- Config Warning -->
      <div class="config-warning" id="configWarning">
        <span class="config-warning-icon">!</span>
        <div class="config-warning-text" id="configWarningText">
          Configuration required. <a href="/admin/settings.html">Go to Settings</a> to set up Perplexity and Calendly integrations.
        </div>
      </div>

      <!-- Tabs -->
      <div class="tabs-container">
        <button class="tab-btn active" data-tab="upcoming" onclick="switchTab('upcoming')">
          Upcoming Calls
          <span class="tab-count" id="upcoming-count">0</span>
        </button>
        <button class="tab-btn" data-tab="past" onclick="switchTab('past')">
          Past Calls
          <span class="tab-count" id="past-count">0</span>
        </button>
      </div>

      <!-- Filters -->
      <div class="ds-filters">
        <div class="ds-filters-row">
          <div class="ds-filter-group">
            <label class="ds-filter-label">Rep</label>
            <select class="ds-input" id="filter-rep" onchange="applyFilters()">
              <option value="all">All Tracked Reps</option>
            </select>
          </div>

          <div class="ds-filter-group">
            <label class="ds-filter-label">Score Range</label>
            <select class="ds-input" id="filter-score" onchange="applyFilters()">
              <option value="all">All Scores</option>
              <option value="high">High (7-10)</option>
              <option value="medium">Medium (4-6)</option>
              <option value="low">Low (1-3)</option>
              <option value="pending">Not Scored</option>
            </select>
          </div>

          <div class="ds-filter-group">
            <label class="ds-filter-label">Date Range</label>
            <select class="ds-input" id="filter-date" onchange="handleDateChange()">
              <option value="last_30_days">Last 30 days</option>
              <option value="last_7_days">Last 7 days</option>
              <option value="last_90_days">Last 90 days</option>
              <option value="all">All time</option>
            </select>
          </div>

          <div class="ds-filter-actions">
            <button class="ds-btn ds-btn-secondary" onclick="clearFilters()">Clear</button>
          </div>
        </div>
      </div>

      <!-- KPI Strip -->
      <div class="kpi-strip">
        <div class="kpi-card">
          <div class="kpi-value" id="kpi-total">-</div>
          <div class="kpi-label">Total Leads</div>
        </div>
        <div class="kpi-card">
          <div class="kpi-value primary" id="kpi-avg">-</div>
          <div class="kpi-label">Avg Score</div>
        </div>
        <div class="kpi-card">
          <div class="kpi-value success" id="kpi-high">-</div>
          <div class="kpi-label">High Quality</div>
        </div>
        <div class="kpi-card">
          <div class="kpi-value warning" id="kpi-medium">-</div>
          <div class="kpi-label">Medium Quality</div>
        </div>
        <div class="kpi-card">
          <div class="kpi-value danger" id="kpi-low">-</div>
          <div class="kpi-label">Low Quality</div>
        </div>
      </div>

      <!-- Upcoming Calls Tab -->
      <div class="tab-panel active" id="panel-upcoming">
        <div class="leads-section">
          <div class="leads-header">
            <h3>Upcoming Calls</h3>
            <span class="leads-count" id="upcoming-leads-count">0 leads</span>
          </div>
          <table class="leads-table">
            <thead>
              <tr>
                <th style="width: 30px;"></th>
                <th>Lead</th>
                <th>Website</th>
                <th>Pre-Call Score</th>
                <th>Scheduled</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="upcoming-tbody">
              <tr>
                <td colspan="6">
                  <div class="empty-state">
                    <div class="empty-state-icon"><svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg></div>
                    <div class="empty-state-title">No upcoming calls</div>
                    <p>Click "Sync Leads" to fetch Calendly bookings.</p>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Past Calls Tab -->
      <div class="tab-panel" id="panel-past">
        <div class="leads-section">
          <div class="leads-header">
            <h3>Past Calls</h3>
            <span class="leads-count" id="past-leads-count">0 leads</span>
          </div>
          <table class="leads-table">
            <thead>
              <tr>
                <th style="width: 30px;"></th>
                <th>Lead</th>
                <th>Website</th>
                <th>Post-Call Score</th>
                <th>Call Date</th>
                <th>Deal Stage</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="past-tbody">
              <tr>
                <td colspan="7">
                  <div class="empty-state">
                    <div class="empty-state-title">No past calls</div>
                    <p>Past calls will appear here after the scheduled time.</p>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <div class="generated-at" id="generated-at"></div>
    </div>
  </main>

  <!-- Override Modal -->
  <div class="modal-overlay" id="overrideModal">
    <div class="modal">
      <div class="modal-title">Override Score</div>
      <div class="modal-body">
        <div class="ds-form-group">
          <label class="ds-label">New Score (1-10)</label>
          <input type="number" class="ds-input" id="override-score" min="1" max="10" value="5">
        </div>
        <div class="ds-form-group" style="margin-top: var(--space-4);">
          <label class="ds-label">Notes (optional)</label>
          <textarea class="ds-input" id="override-notes" rows="3" placeholder="Reason for override..."></textarea>
        </div>
      </div>
      <div class="modal-actions">
        <button class="ds-btn ds-btn-secondary" onclick="closeOverrideModal()">Cancel</button>
        <button class="ds-btn ds-btn-primary" onclick="saveOverride()">Save Override</button>
      </div>
    </div>
  </div>

  <!-- Unified Analyze Modal -->
  <div class="modal-overlay" id="analyzeModal">
    <div class="modal analyze-modal">
      <div class="analyze-modal-header">
        <div>
          <div class="modal-title">Analyze Lead</div>
          <div class="modal-subtitle" id="analyze-modal-lead-name">Lead Name</div>
        </div>
        <button class="close-btn" onclick="closeAnalyzeModal()">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>

      <div class="modal-body">
        <!-- Transcript Status (shown for past calls) -->
        <div id="transcript-status-section" class="transcript-status-modal available" style="display: none;">
          <div class="status-icon" id="transcript-status-icon">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
              <polyline points="20 6 9 17 4 12"></polyline>
            </svg>
          </div>
          <div class="status-text">
            <div class="status-title" id="transcript-status-title">Transcript Available</div>
            <div class="status-subtitle" id="transcript-status-subtitle">Linked from Calls tab</div>
          </div>
          <button id="btn-fetch-fireflies" class="ds-btn ds-btn-secondary ds-btn-sm" style="display: none; margin-left: auto;" onclick="fetchFromFireflies()">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 4px;">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
              <polyline points="7 10 12 15 17 10"></polyline>
              <line x1="12" y1="15" x2="12" y2="3"></line>
            </svg>
            Fetch from Fireflies
          </button>
        </div>

        <div class="modal-section-label">Choose Analysis Model</div>
        <div class="model-cards">
          <div class="model-card selected" data-model="gpt-5-nano" onclick="selectAnalysisModel('gpt-5-nano')">
            <div class="model-icon-wrap">
              <img src="/admin/icons/openai.svg" class="model-icon" alt="GPT" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 24 24%22><circle cx=%2212%22 cy=%2212%22 r=%2210%22 fill=%22%2310a37f%22/><text x=%2212%22 y=%2216%22 text-anchor=%22middle%22 fill=%22white%22 font-size=%2210%22>AI</text></svg>'">
            </div>
            <div class="model-info">
              <div class="model-name">GPT-5-nano</div>
              <div class="model-desc">Fast transcript analysis</div>
            </div>
            <div class="model-check">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                <polyline points="20 6 9 17 4 12"></polyline>
              </svg>
            </div>
          </div>

          <div class="model-card" data-model="perplexity-sonar" onclick="selectAnalysisModel('perplexity-sonar')">
            <div class="model-icon-wrap">
              <img src="/admin/icons/Perplexity.png" class="model-icon" alt="Perplexity" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 24 24%22><circle cx=%2212%22 cy=%2212%22 r=%2210%22 fill=%22%235436DA%22/><text x=%2212%22 y=%2216%22 text-anchor=%22middle%22 fill=%22white%22 font-size=%2210%22>P</text></svg>'">
            </div>
            <div class="model-info">
              <div class="model-name">Perplexity Sonar</div>
              <div class="model-desc">Web-enhanced research</div>
            </div>
            <div class="model-check">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                <polyline points="20 6 9 17 4 12"></polyline>
              </svg>
            </div>
          </div>
        </div>

        <!-- Loading Bar -->
        <div class="loading-bar-container" id="analyze-loading-bar">
          <div class="loading-bar"></div>
        </div>

        <!-- Status Message -->
        <div id="analyze-status" style="margin-top: var(--space-3); font-size: var(--text-sm); color: var(--color-text-secondary); text-align: center; display: none;"></div>
      </div>

      <div class="modal-actions">
        <button class="ds-btn ds-btn-secondary" onclick="closeAnalyzeModal()">Cancel</button>
        <button class="ds-btn ds-btn-primary" id="btn-run-analysis" onclick="runAnalysis()">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 6px;">
            <polygon points="5 3 19 12 5 21 5 3"></polygon>
          </svg>
          Run Analysis
        </button>
      </div>
    </div>
  </div>

  <script>
    // Global state
    let currentUser = null;
    let isAdmin = false;
    let allLeads = [];
    let upcomingLeads = [];
    let pastLeads = [];
    let stats = {};
    let trackedReps = [];
    let currentOverrideLeadId = null;
    let currentTab = 'upcoming';

    // Initialize
    document.addEventListener('DOMContentLoaded', async () => {
      await initUserMenu();
      await loadConfig();
      await loadLeads();
    });

    // User menu initialization
    async function initUserMenu() {
      try {
        const response = await fetch('/api/auth/me', { credentials: 'include' });
        if (!response.ok) {
          window.location.href = '/admin/login.html';
          return;
        }
        const data = await response.json();
        currentUser = data.user;
        isAdmin = currentUser.role === 'admin';

        document.getElementById('user-display-name').textContent = currentUser.name;
        document.getElementById('user-display-role').textContent = currentUser.role;
        document.getElementById('user-avatar').textContent = currentUser.name.charAt(0).toUpperCase();
        document.getElementById('user-email').textContent = currentUser.email;

        const badge = document.getElementById('user-role-badge');
        badge.textContent = currentUser.role;
        badge.className = `ds-dropdown-role ${currentUser.role}`;

        // User dropdown toggle
        const menuBtn = document.getElementById('user-menu-button');
        const dropdown = document.getElementById('user-dropdown');
        menuBtn.addEventListener('click', () => {
          dropdown.classList.toggle('open');
        });
        document.addEventListener('click', (e) => {
          if (!menuBtn.contains(e.target) && !dropdown.contains(e.target)) {
            dropdown.classList.remove('open');
          }
        });
      } catch (err) {
        console.error('Failed to load user:', err);
      }
    }

    async function logout() {
      await fetch('/api/auth/logout', { method: 'POST', credentials: 'include' });
      window.location.href = '/admin/login.html';
    }

    // Tab switching
    function switchTab(tab) {
      currentTab = tab;

      // Update tab buttons
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.tab === tab);
      });

      // Update tab panels
      document.querySelectorAll('.tab-panel').forEach(panel => {
        panel.classList.toggle('active', panel.id === `panel-${tab}`);
      });
    }

    // Load configuration
    async function loadConfig() {
      try {
        const response = await fetch('/api/lead-quality/config', { credentials: 'include' });
        const data = await response.json();

        if (data.success) {
          trackedReps = data.data.trackedReps || [];

          // Populate rep dropdown
          const repSelect = document.getElementById('filter-rep');
          trackedReps.forEach(email => {
            const option = document.createElement('option');
            option.value = email;
            option.textContent = email;
            repSelect.appendChild(option);
          });

          // Show config warning if needed
          const warning = document.getElementById('configWarning');
          const warningText = document.getElementById('configWarningText');

          if (!data.data.perplexity.configured && !data.data.calendly.configured) {
            warningText.innerHTML = 'Perplexity and Calendly are not configured. <a href="/admin/settings.html">Go to Settings</a> to set up integrations.';
            warning.classList.add('active');
          } else if (!data.data.perplexity.configured) {
            warningText.innerHTML = 'Perplexity is not configured. <a href="/admin/settings.html">Go to Settings</a> to add your API key for AI-powered research.';
            warning.classList.add('active');
          } else if (!data.data.calendly.configured) {
            warningText.innerHTML = 'Calendly is not configured. <a href="/admin/settings.html">Go to Settings</a> to connect Calendly.';
            warning.classList.add('active');
          } else if (trackedReps.length === 0) {
            warningText.innerHTML = 'No reps are being tracked. <a href="/admin/settings.html">Go to Settings</a> to add rep emails.';
            warning.classList.add('active');
          }
        }
      } catch (err) {
        console.error('Failed to load config:', err);
      }
    }

    // Load leads
    async function loadLeads() {
      try {
        const rep = document.getElementById('filter-rep').value;
        const scoreFilter = document.getElementById('filter-score').value;
        const dateFilter = document.getElementById('filter-date').value;

        // Build query params
        const params = new URLSearchParams();
        params.append('rep', rep);
        params.append('limit', '200');

        // Score filter
        if (scoreFilter === 'high') {
          params.append('minScore', '7');
        } else if (scoreFilter === 'medium') {
          params.append('minScore', '4');
          params.append('maxScore', '6');
        } else if (scoreFilter === 'low') {
          params.append('maxScore', '3');
        }

        // Date filter
        const now = new Date();
        if (dateFilter === 'last_7_days') {
          params.append('startDate', new Date(now - 7 * 24 * 60 * 60 * 1000).toISOString());
        } else if (dateFilter === 'last_30_days') {
          params.append('startDate', new Date(now - 30 * 24 * 60 * 60 * 1000).toISOString());
        } else if (dateFilter === 'last_90_days') {
          params.append('startDate', new Date(now - 90 * 24 * 60 * 60 * 1000).toISOString());
        }

        const response = await fetch(`/api/lead-quality/leads?${params}`, { credentials: 'include' });
        const data = await response.json();

        if (data.success) {
          allLeads = data.data.leads;
          stats = data.data.stats;

          // Split into upcoming and past
          const nowTime = new Date().getTime();
          upcomingLeads = allLeads.filter(lead => {
            const bookingTime = new Date(lead.calendlyBookingTime).getTime();
            return bookingTime > nowTime;
          });
          pastLeads = allLeads.filter(lead => {
            const bookingTime = new Date(lead.calendlyBookingTime).getTime();
            return bookingTime <= nowTime;
          });

          // Update tab counts
          document.getElementById('upcoming-count').textContent = upcomingLeads.length;
          document.getElementById('past-count').textContent = pastLeads.length;

          renderKPIs();
          renderUpcomingLeads();
          renderPastLeads();
          document.getElementById('generated-at').textContent = `Last updated: ${new Date().toLocaleString()}`;
        }
      } catch (err) {
        console.error('Failed to load leads:', err);
      }
    }

    // Render KPIs
    function renderKPIs() {
      document.getElementById('kpi-total').textContent = stats.totalLeads || 0;
      document.getElementById('kpi-avg').textContent = stats.avgScore || '-';
      document.getElementById('kpi-high').textContent = stats.highQuality || 0;
      document.getElementById('kpi-medium').textContent = stats.mediumQuality || 0;
      document.getElementById('kpi-low').textContent = stats.lowQuality || 0;
    }

    // Render upcoming leads table
    function renderUpcomingLeads() {
      const tbody = document.getElementById('upcoming-tbody');
      document.getElementById('upcoming-leads-count').textContent = `${upcomingLeads.length} leads`;

      if (upcomingLeads.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="6">
              <div class="empty-state">
                <div class="empty-state-icon"><svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg></div>
                <div class="empty-state-title">No upcoming calls</div>
                <p>Click "Sync Leads" to fetch Calendly bookings.</p>
              </div>
            </td>
          </tr>
        `;
        return;
      }

      tbody.innerHTML = upcomingLeads.map(lead => `
        <tr onclick="toggleDetail('upcoming-${lead.id}')">
          <td>
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" id="chevron-upcoming-${lead.id}" style="transition: transform 0.2s;">
              <polyline points="9 18 15 12 9 6"></polyline>
            </svg>
          </td>
          <td>
            <div style="font-weight: 500;">${escapeHtml(lead.inviteeName || 'Unknown')}</div>
            <div style="font-size: var(--text-xs); color: var(--color-text-muted);">${escapeHtml(lead.inviteeEmail)}</div>
          </td>
          <td>
            ${lead.website ? `<a href="${ensureHttps(lead.website)}" target="_blank" onclick="event.stopPropagation();" style="color: var(--color-primary);">${truncateUrl(lead.website)}</a>` : '-'}
          </td>
          <td>${renderScoreBadge(lead)}</td>
          <td>
            <span class="call-status upcoming">${formatDateTime(lead.calendlyBookingTime)}</span>
          </td>
          <td onclick="event.stopPropagation();">
            <div class="row-actions">
              <button class="analyze-btn" onclick="openAnalyzeModal('${lead.id}', 'upcoming')" title="Analyze lead">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><path d="M12 16v-4"></path><path d="M12 8h.01"></path></svg>
                Analyze
              </button>
              <button class="action-btn" onclick="openOverrideModal('${lead.id}')" title="Override score">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
              </button>
              <button class="action-btn action-btn-danger" onclick="deleteLead('${lead.id}', '${escapeHtml(lead.inviteeName || lead.inviteeEmail)}')" title="Delete lead">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
              </button>
            </div>
          </td>
        </tr>
        <tr class="lead-detail" id="detail-upcoming-${lead.id}">
          <td colspan="6">
            <div class="lead-detail-content">
              ${renderLeadDetail(lead, false)}
            </div>
          </td>
        </tr>
      `).join('');
    }

    // Render past leads table (no Pre-Call Score column)
    function renderPastLeads() {
      const tbody = document.getElementById('past-tbody');
      document.getElementById('past-leads-count').textContent = `${pastLeads.length} leads`;

      if (pastLeads.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="7">
              <div class="empty-state">
                <div class="empty-state-title">No past calls</div>
                <p>Past calls will appear here after the scheduled time.</p>
              </div>
            </td>
          </tr>
        `;
        return;
      }

      tbody.innerHTML = pastLeads.map(lead => {
        const hasAnalysis = lead.transcriptAnalysisJson || lead.postCallScore;
        const analysisDate = lead.transcriptAnalyzedAt;

        return `
        <tr onclick="toggleDetail('past-${lead.id}')">
          <td>
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" id="chevron-past-${lead.id}" style="transition: transform 0.2s;">
              <polyline points="9 18 15 12 9 6"></polyline>
            </svg>
          </td>
          <td>
            <div style="font-weight: 500;">${escapeHtml(lead.inviteeName || 'Unknown')}</div>
            <div style="font-size: var(--text-xs); color: var(--color-text-muted);">${escapeHtml(lead.inviteeEmail)}</div>
          </td>
          <td>
            ${lead.website ? `<a href="${ensureHttps(lead.website)}" target="_blank" onclick="event.stopPropagation();" style="color: var(--color-primary);">${truncateUrl(lead.website)}</a>` : '-'}
          </td>
          <td>
            ${renderPostCallScore(lead)}
            ${hasAnalysis && analysisDate ? `<div class="analysis-meta">${formatShortDate(analysisDate)}</div>` : ''}
          </td>
          <td>
            <span class="call-status completed">${formatDate(lead.calendlyBookingTime)}</span>
          </td>
          <td onclick="event.stopPropagation();">
            ${renderDealStageDropdown(lead)}
          </td>
          <td onclick="event.stopPropagation();">
            <div class="row-actions">
              ${renderAnalyzeButton(lead)}
              <button class="action-btn" onclick="openOverrideModal('${lead.id}')" title="Override score">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
              </button>
              <button class="action-btn action-btn-danger" onclick="deleteLead('${lead.id}', '${escapeHtml(lead.inviteeName || lead.inviteeEmail)}')" title="Delete lead">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
              </button>
            </div>
          </td>
        </tr>
        <tr class="lead-detail" id="detail-past-${lead.id}">
          <td colspan="7">
            <div class="lead-detail-content">
              ${renderLeadDetail(lead, true)}
            </div>
          </td>
        </tr>
      `;
      }).join('');
    }

    // Render Analyze button (blue for pending, green for analyzed)
    function renderAnalyzeButton(lead) {
      const hasAnalysis = lead.transcriptAnalysisJson || lead.postCallScore;

      if (hasAnalysis) {
        return `
          <button class="analyze-btn analyzed" onclick="openAnalyzeModal('${lead.id}', 'past')" title="Re-analyze (already analyzed)">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"></polyline></svg>
            Analyzed
          </button>
        `;
      }

      return `
        <button class="analyze-btn" onclick="openAnalyzeModal('${lead.id}', 'past')" title="Analyze transcript">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><path d="M12 16v-4"></path><path d="M12 8h.01"></path></svg>
          Analyze
        </button>
      `;
    }

    // Render Deal Stage dropdown
    function renderDealStageDropdown(lead) {
      const currentStage = lead.dealStage || '';
      const stageClass = currentStage === 'closed' ? 'closed' : currentStage === 'lost' ? 'lost' : currentStage === 'follow_up' ? 'follow-up' : '';

      return `
        <select class="deal-stage-select ${stageClass}" onchange="updateDealStage('${lead.id}', this.value, '${lead.inviteeEmail}')" onclick="event.stopPropagation();">
          <option value="" ${!currentStage ? 'selected' : ''}>-</option>
          <option value="closed" ${currentStage === 'closed' ? 'selected' : ''}>Closed</option>
          <option value="lost" ${currentStage === 'lost' ? 'selected' : ''}>Lost</option>
          <option value="follow_up" ${currentStage === 'follow_up' ? 'selected' : ''}>Follow up</option>
        </select>
      `;
    }

    // Get analysis model from lead data
    function getAnalysisModel(lead) {
      if (!lead.transcriptAnalysisJson) return null;
      try {
        const analysis = JSON.parse(lead.transcriptAnalysisJson);
        return analysis.model_used || null;
      } catch (e) {
        return null;
      }
    }

    // Format short date (e.g., "Jan 15")
    function formatShortDate(dateStr) {
      if (!dateStr) return '';
      const date = new Date(dateStr);
      return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    }

    // Update deal stage
    async function updateDealStage(leadId, stage, prospectEmail) {
      try {
        // Map stage to lifecycle override status
        const statusMap = {
          'closed': 'signed_up',
          'lost': 'no_close',
          'follow_up': 'active',
          '': null
        };

        const status = statusMap[stage];

        if (!status) {
          // Clear the override
          const lead = allLeads.find(l => l.id === leadId);
          if (lead && lead.transcriptId) {
            await fetch(`/api/closing-rate/lifecycle-overrides/${lead.transcriptId}`, {
              method: 'DELETE',
              credentials: 'include'
            });
          }
        } else {
          // Get the transcript ID from the lead
          const lead = allLeads.find(l => l.id === leadId);
          const callId = lead?.transcriptId;

          if (!callId) {
            console.warn('No transcript linked to this lead, cannot update deal stage');
            return;
          }

          // Set the lifecycle override
          await fetch('/api/closing-rate/lifecycle-overrides', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({
              call_id: callId,
              prospect_email: prospectEmail,
              status: status,
              notes: `Set from Lead Quality tab`
            })
          });
        }

        // Update local state
        const leadIndex = allLeads.findIndex(l => l.id === leadId);
        if (leadIndex !== -1) {
          allLeads[leadIndex].dealStage = stage;
        }

        // Update dropdown appearance
        const select = document.querySelector(`select[onchange*="${leadId}"]`);
        if (select) {
          select.className = 'deal-stage-select ' + (stage === 'closed' ? 'closed' : stage === 'lost' ? 'lost' : stage === 'follow_up' ? 'follow-up' : '');
        }
      } catch (err) {
        console.error('Failed to update deal stage:', err);
        alert('Failed to update deal stage');
      }
    }

    // Render score badge
    function renderScoreBadge(lead) {
      const score = lead.effectiveScore;
      const isOverride = lead.manualOverride !== null;

      if (score === null || score === undefined) {
        return '<span class="score-badge pending">Not Scored</span>';
      }

      let cls = 'low';
      if (score >= 7) cls = 'high';
      else if (score >= 4) cls = 'medium';

      return `
        <span class="score-badge ${cls} ${isOverride ? 'override' : ''}" title="${isOverride ? 'Manually overridden' : ''}">
          ${score}/10
          <span class="score-pips">
            ${Array.from({length: 10}, (_, i) => `<span class="score-pip ${i < score ? 'active ' + cls : ''}"></span>`).join('')}
          </span>
        </span>
      `;
    }

    // Render post-call score
    function renderPostCallScore(lead) {
      if (!lead.postCallScore) {
        if (lead.transcriptId) {
          return '<span class="call-status" style="background: rgba(245, 158, 11, 0.1); color: #f59e0b;">Has transcript</span>';
        }
        return '<span style="color: var(--color-text-muted);">-</span>';
      }

      let cls = 'low';
      if (lead.postCallScore >= 7) cls = 'high';
      else if (lead.postCallScore >= 4) cls = 'medium';

      return `<span class="score-badge ${cls}">${lead.postCallScore}/10</span>`;
    }

    // Render lead detail - REDESIGNED for cleaner layout
    function renderLeadDetail(lead, isPast) {
      // Parse form responses
      let formResponses = [];
      try {
        formResponses = JSON.parse(lead.calendlyFormResponses || '[]');
      } catch (e) {
        formResponses = [];
      }

      // Parse transcript analysis
      let transcriptAnalysis = null;
      try {
        transcriptAnalysis = lead.transcriptAnalysisJson ? JSON.parse(lead.transcriptAnalysisJson) : null;
      } catch (e) {
        transcriptAnalysis = null;
      }

      // Parse research links
      const researchLinks = lead.researchLinks || [];

      // Parse perplexity research data
      const perplexityData = lead.perplexityData || null;

      // Extract LinkedIn from perplexity data if not already set
      const linkedinUrl = lead.linkedinUrl || perplexityData?.person_info?.linkedin_url || perplexityData?.linkedin_url || null;

      // Get analysis model and date
      const analysisModel = transcriptAnalysis?.model_used || perplexityData?.model_used || lead.researchModel || null;
      const analysisDate = lead.transcriptAnalyzedAt || lead.researchedAt || lead.analyzedAt || null;

      return `
        <!-- Analysis Info Header - Always at top -->
        ${analysisModel || analysisDate ? `
          <div class="analysis-info-header">
            ${analysisDate ? `
              <div class="info-item">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <circle cx="12" cy="12" r="10"></circle>
                  <polyline points="12 6 12 12 16 14"></polyline>
                </svg>
                <span>Analyzed: <strong>${formatAnalysisDateTime(analysisDate)}</strong></span>
              </div>
            ` : ''}
            ${analysisModel && analysisDate ? '<div class="info-divider"></div>' : ''}
            ${analysisModel ? `
              <div class="info-item">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"></path>
                </svg>
                <span>Model: <strong>${escapeHtml(analysisModel)}</strong></span>
              </div>
            ` : ''}
            ${linkedinUrl ? `
              <div class="info-divider"></div>
              <a href="${escapeHtml(linkedinUrl)}" target="_blank" class="linkedin-badge" onclick="event.stopPropagation();">
                <svg viewBox="0 0 24 24"><path d="M19 0h-14c-2.761 0-5 2.239-5 5v14c0 2.761 2.239 5 5 5h14c2.762 0 5-2.239 5-5v-14c0-2.761-2.238-5-5-5zm-11 19h-3v-11h3v11zm-1.5-12.268c-.966 0-1.75-.79-1.75-1.764s.784-1.764 1.75-1.764 1.75.79 1.75 1.764-.783 1.764-1.75 1.764zm13.5 12.268h-3v-5.604c0-3.368-4-3.113-4 0v5.604h-3v-11h3v1.765c1.396-2.586 7-2.777 7 2.476v6.759z"/></svg>
                LinkedIn
              </a>
            ` : ''}
          </div>
        ` : ''}

        <div class="detail-grid">
          <!-- Left Column: Scores -->
          <div class="detail-section-clean">
            <div class="section-header">
              <h4><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle;"><line x1="18" y1="20" x2="18" y2="10"></line><line x1="12" y1="20" x2="12" y2="4"></line><line x1="6" y1="20" x2="6" y2="14"></line></svg> Pre-Call Score Breakdown</h4>
            </div>

            <div class="score-item-clean">
              <div class="score-info">
                <div class="score-label">Company Strength</div>
                <div class="score-rationale">${escapeHtml(lead.companyStrengthRationale || 'Not analyzed')}</div>
              </div>
              <div class="score-value">${lead.companyStrengthScore ?? '-'}/3</div>
            </div>

            <div class="score-item-clean">
              <div class="score-info">
                <div class="score-label">Affiliate Readiness</div>
                <div class="score-rationale">${escapeHtml(lead.affiliateReadinessRationale || 'Not analyzed')}</div>
              </div>
              <div class="score-value">${lead.affiliateReadinessScore ?? '-'}/3</div>
            </div>

            <div class="score-item-clean">
              <div class="score-info">
                <div class="score-label">Buyer Authority</div>
                <div class="score-rationale">${escapeHtml(lead.buyerAuthorityRationale || 'Not analyzed')}</div>
              </div>
              <div class="score-value">${lead.buyerAuthorityScore ?? '-'}/2</div>
            </div>

            <div class="score-item-clean">
              <div class="score-info">
                <div class="score-label">Inbound Quality</div>
                <div class="score-rationale">${escapeHtml(lead.inboundQualityRationale || 'Not analyzed')}</div>
              </div>
              <div class="score-value">${lead.inboundQualityScore ?? '-'}/2</div>
            </div>

            ${lead.manualOverride ? `
              <div style="margin-top: var(--space-4); padding: var(--space-3); background: rgba(245, 158, 11, 0.1); border-radius: var(--radius-md); border: 1px dashed rgba(245, 158, 11, 0.3);">
                <div style="font-size: var(--text-xs); font-weight: 600; color: #f59e0b; margin-bottom: var(--space-1);">Manual Override</div>
                <p style="font-size: var(--text-sm); color: var(--color-text-primary); margin: 0;">
                  Score set to <strong>${lead.manualOverride.score}</strong> on ${formatDate(lead.manualOverride.at)}
                </p>
                ${lead.manualOverride.notes ? `<p style="font-size: var(--text-xs); color: var(--color-text-muted); margin: var(--space-1) 0 0 0;">${escapeHtml(lead.manualOverride.notes)}</p>` : ''}
              </div>
            ` : ''}
          </div>

          <!-- Right Column: Research & Form Data -->
          <div>
            <!-- Perplexity Research Results -->
            ${perplexityData ? `
              <div class="detail-section-clean">
                <div class="section-header">
                  <h4><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle;"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg> Research Results</h4>
                </div>

                ${perplexityData.company_info ? `
                  <div class="research-card">
                    <div class="research-card-title">
                      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path></svg>
                      Company
                    </div>
                    <div class="research-card-content">
                      ${perplexityData.company_info.name ? `<p><strong>Name:</strong> ${escapeHtml(perplexityData.company_info.name)}</p>` : ''}
                      ${perplexityData.company_info.industry ? `<p><strong>Industry:</strong> ${escapeHtml(perplexityData.company_info.industry)}</p>` : ''}
                      ${perplexityData.company_info.size ? `<p><strong>Size:</strong> ${escapeHtml(perplexityData.company_info.size)}</p>` : ''}
                      ${perplexityData.company_info.description ? `<p><strong>About:</strong> ${escapeHtml(perplexityData.company_info.description)}</p>` : ''}
                    </div>
                  </div>
                ` : ''}

                ${perplexityData.person_info ? `
                  <div class="research-card">
                    <div class="research-card-title">
                      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                      Person
                    </div>
                    <div class="research-card-content">
                      ${perplexityData.person_info.role ? `<p><strong>Role:</strong> ${escapeHtml(perplexityData.person_info.role)}</p>` : ''}
                      ${perplexityData.person_info.title ? `<p><strong>Title:</strong> ${escapeHtml(perplexityData.person_info.title)}</p>` : ''}
                      ${perplexityData.person_info.background ? `<p><strong>Background:</strong> ${escapeHtml(perplexityData.person_info.background)}</p>` : ''}
                    </div>
                  </div>
                ` : ''}

                ${perplexityData.affiliate_signals ? `
                  <div class="research-card">
                    <div class="research-card-title">
                      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg>
                      Affiliate Signals
                    </div>
                    <div class="research-card-content">
                      ${perplexityData.affiliate_signals.has_program !== undefined ? `<p><strong>Has Program:</strong> ${perplexityData.affiliate_signals.has_program ? ' Yes' : ' No'}</p>` : ''}
                      ${perplexityData.affiliate_signals.program_details ? `<p><strong>Details:</strong> ${escapeHtml(perplexityData.affiliate_signals.program_details)}</p>` : ''}
                      ${perplexityData.affiliate_signals.readiness ? `<p><strong>Readiness:</strong> ${escapeHtml(perplexityData.affiliate_signals.readiness)}</p>` : ''}
                    </div>
                  </div>
                ` : ''}

                ${perplexityData.raw_response ? `
                  <details style="margin-top: var(--space-2);">
                    <summary style="font-size: var(--text-xs); color: var(--color-text-muted); cursor: pointer; padding: var(--space-2);">View raw response</summary>
                    <pre style="font-size: 10px; background: var(--color-surface-secondary); padding: var(--space-2); border-radius: var(--radius-sm); overflow-x: auto; margin-top: var(--space-1); white-space: pre-wrap; word-break: break-word; max-height: 200px;">${escapeHtml(typeof perplexityData.raw_response === 'string' ? perplexityData.raw_response : JSON.stringify(perplexityData.raw_response, null, 2))}</pre>
                  </details>
                ` : ''}
              </div>
            ` : ''}

            <!-- Form Responses -->
            <div class="detail-section-clean">
              <div class="section-header">
                <h4><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle;"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line></svg> Booking Info</h4>
              </div>

              ${formResponses.length > 0 ? `
                ${formResponses.map(r => `
                  <div class="form-response-clean">
                    <div class="question">${escapeHtml(r.question)}</div>
                    <div class="answer">${escapeHtml(r.answer) || '<em>Not provided</em>'}</div>
                  </div>
                `).join('')}
              ` : `
                <div class="form-response-clean">
                  <div class="question">Website</div>
                  <div class="answer">${lead.website ? `<a href="${ensureHttps(lead.website)}" target="_blank" style="color: var(--color-primary);">${escapeHtml(lead.website)}</a>` : '<em>Not provided</em>'}</div>
                </div>
                ${lead.calendlyChallenge ? `
                  <div class="form-response-clean">
                    <div class="question">Challenge</div>
                    <div class="answer">${escapeHtml(lead.calendlyChallenge)}</div>
                  </div>
                ` : ''}
                ${lead.calendlyCountry ? `
                  <div class="form-response-clean">
                    <div class="question">Country</div>
                    <div class="answer">${escapeHtml(lead.calendlyCountry)}</div>
                  </div>
                ` : ''}
              `}

              ${researchLinks.length > 0 ? `
                <div style="margin-top: var(--space-3); padding-top: var(--space-3); border-top: 1px solid var(--color-border-light);">
                  <div style="font-size: var(--text-xs); font-weight: 500; color: var(--color-text-secondary); margin-bottom: var(--space-2);">Research Sources</div>
                  <div style="display: flex; flex-wrap: wrap; gap: var(--space-1);">
                    ${researchLinks.slice(0, 5).map(link => {
                      const cleanUrl = cleanResearchUrl(link);
                      return `<a href="${escapeHtml(link)}" target="_blank" style="font-size: 10px; padding: 2px 6px; background: var(--color-surface-secondary); border-radius: var(--radius-sm); color: var(--color-primary); text-decoration: none;">${escapeHtml(cleanUrl.substring(0, 30))}</a>`;
                    }).join('')}
                    ${researchLinks.length > 5 ? `<span style="font-size: 10px; color: var(--color-text-muted);">+${researchLinks.length - 5} more</span>` : ''}
                  </div>
                </div>
              ` : ''}

              ${isPast && lead.transcriptId ? `
                <div style="margin-top: var(--space-3); padding-top: var(--space-3); border-top: 1px solid var(--color-border-light);">
                  <a href="/admin/call.html?id=${lead.transcriptId}" target="_blank" style="display: inline-flex; align-items: center; gap: var(--space-2); font-size: var(--text-sm); color: var(--color-primary); font-weight: 500;">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline></svg>
                    View Transcript
                  </a>
                </div>
              ` : ''}
            </div>
          </div>
        </div>

        <!-- Post-Call Analysis Section -->
        ${isPast && transcriptAnalysis ? `
          <div class="detail-section-clean" style="margin-top: var(--space-4);">
            <div class="section-header">
              <h4><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle;"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path></svg> Post-Call Analysis</h4>
              <span class="score-badge ${transcriptAnalysis.post_call_score >= 7 ? 'high' : transcriptAnalysis.post_call_score >= 4 ? 'medium' : 'low'}">
                ${transcriptAnalysis.post_call_score || '-'}/10
              </span>
            </div>

            ${transcriptAnalysis.post_call_rationale ? `
              <p style="font-size: var(--text-sm); color: var(--color-text-secondary); margin-bottom: var(--space-4);">
                ${escapeHtml(transcriptAnalysis.post_call_rationale)}
              </p>
            ` : ''}

            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: var(--space-2); margin-bottom: var(--space-4);">
              <div class="research-card" style="text-align: center; margin: 0;">
                <div style="font-size: var(--text-xs); color: var(--color-text-muted);">Deal Likelihood</div>
                <div style="font-size: var(--text-sm); font-weight: 600; color: var(--color-text-primary);">${escapeHtml(transcriptAnalysis.deal_likelihood || '-')}</div>
              </div>
              <div class="research-card" style="text-align: center; margin: 0;">
                <div style="font-size: var(--text-xs); color: var(--color-text-muted);">Budget</div>
                <div style="font-size: var(--text-sm); font-weight: 600; color: ${transcriptAnalysis.budget_discussed ? 'var(--color-success)' : 'var(--color-text-muted)'};">${transcriptAnalysis.budget_discussed ? ' Discussed' : ' No'}</div>
              </div>
              <div class="research-card" style="text-align: center; margin: 0;">
                <div style="font-size: var(--text-xs); color: var(--color-text-muted);">Timeline</div>
                <div style="font-size: var(--text-sm); font-weight: 600; color: ${transcriptAnalysis.timeline_discussed ? 'var(--color-success)' : 'var(--color-text-muted)'};">${transcriptAnalysis.timeline_discussed ? ' Discussed' : ' No'}</div>
              </div>
              <div class="research-card" style="text-align: center; margin: 0;">
                <div style="font-size: var(--text-xs); color: var(--color-text-muted);">Decision Maker</div>
                <div style="font-size: var(--text-sm); font-weight: 600; color: ${transcriptAnalysis.decision_maker_confirmed ? 'var(--color-success)' : 'var(--color-text-muted)'};">${transcriptAnalysis.decision_maker_confirmed ? ' Confirmed' : '? Unclear'}</div>
              </div>
            </div>

            ${transcriptAnalysis.key_insights ? `
              <div class="research-card">
                <div class="research-card-title">Key Insight</div>
                <div class="research-card-content">${escapeHtml(transcriptAnalysis.key_insights)}</div>
              </div>
            ` : ''}

            ${transcriptAnalysis.next_steps ? `
              <div class="research-card">
                <div class="research-card-title">Next Steps</div>
                <div class="research-card-content">${escapeHtml(transcriptAnalysis.next_steps)}</div>
              </div>
            ` : ''}

            ${(transcriptAnalysis.buying_signals && transcriptAnalysis.buying_signals.length > 0) || (transcriptAnalysis.objections && transcriptAnalysis.objections.length > 0) ? `
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-3); margin-top: var(--space-3);">
                ${transcriptAnalysis.buying_signals && transcriptAnalysis.buying_signals.length > 0 ? `
                  <div>
                    <div style="font-size: var(--text-xs); font-weight: 500; color: var(--color-success); margin-bottom: var(--space-2);"> Buying Signals</div>
                    <div style="display: flex; flex-wrap: wrap; gap: var(--space-1);">
                      ${transcriptAnalysis.buying_signals.map(s => `<span class="signal-tag">${escapeHtml(s)}</span>`).join('')}
                    </div>
                  </div>
                ` : ''}
                ${transcriptAnalysis.objections && transcriptAnalysis.objections.length > 0 ? `
                  <div>
                    <div style="font-size: var(--text-xs); font-weight: 500; color: var(--color-danger); margin-bottom: var(--space-2);"> Objections</div>
                    <div style="display: flex; flex-wrap: wrap; gap: var(--space-1);">
                      ${transcriptAnalysis.objections.map(o => `<span class="objection-tag">${escapeHtml(o)}</span>`).join('')}
                    </div>
                  </div>
                ` : ''}
              </div>
            ` : ''}
          </div>
        ` : ''}

        ${isPast && !transcriptAnalysis && lead.transcriptId ? `
          <div class="detail-section-clean" style="margin-top: var(--space-4); text-align: center; padding: var(--space-6);">
            <div style="margin-bottom: var(--space-3);"><svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="var(--color-primary)" stroke-width="1.5"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path></svg></div>
            <h4 style="margin: 0 0 var(--space-2) 0;">Transcript Available</h4>
            <p style="color: var(--color-text-muted); font-size: var(--text-sm); margin: 0;">
              Click "Analyze" to run post-call analysis with GPT.
            </p>
          </div>
        ` : ''}
      `;
    }

    // Toggle detail row - user clicks to open/close
    function toggleDetail(id, forceOpen = false) {
      const detail = document.getElementById(`detail-${id}`);
      const chevron = document.getElementById(`chevron-${id}`);

      if (!detail) return;

      if (detail.classList.contains('expanded') && !forceOpen) {
        // Close this detail
        detail.classList.remove('expanded');
        if (chevron) chevron.style.transform = 'rotate(0deg)';
      } else {
        // Close all other details first
        document.querySelectorAll('.lead-detail.expanded').forEach(el => {
          if (el.id !== `detail-${id}`) {
            el.classList.remove('expanded');
          }
        });
        document.querySelectorAll('[id^="chevron-"]').forEach(el => {
          if (el.id !== `chevron-${id}`) {
            el.style.transform = 'rotate(0deg)';
          }
        });

        // Open this detail
        detail.classList.add('expanded');
        if (chevron) chevron.style.transform = 'rotate(90deg)';
      }
    }

    // Sync leads
    async function syncLeads() {
      const btn = document.getElementById('btn-refresh');
      const text = document.getElementById('refresh-text');

      btn.disabled = true;

      // Step 1: Fetching from Calendly
      text.innerHTML = '<span style="display: inline-flex; align-items: center; gap: 6px;"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="animation: spin 1s linear infinite;"><path d="M21 12a9 9 0 1 1-6.219-8.56"></path></svg>Fetching Calendly...</span>';

      try {
        const response = await fetch('/api/lead-quality/sync', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({
            rep: document.getElementById('filter-rep').value,
            analyzeNew: true,
            daysBack: 60
          })
        });

        const data = await response.json();

        if (data.success) {
          // Step 2: Analyzing with Perplexity (show progress)
          if (data.data.analyzed > 0) {
            text.innerHTML = '<span style="display: inline-flex; align-items: center; gap: 6px;"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="animation: spin 1s linear infinite;"><path d="M21 12a9 9 0 1 1-6.219-8.56"></path></svg>Analyzing leads...</span>';
            await new Promise(resolve => setTimeout(resolve, 500));
          }

          // Step 3: Done
          text.innerHTML = `<span style="color: var(--color-success);"> Synced ${data.data.synced}, analyzed ${data.data.analyzed}</span>`;
          await loadLeads();
        } else {
          text.innerHTML = '<span style="color: var(--color-danger);"> Error</span>';
          alert(data.error || 'Sync failed. Check if Calendly API key is configured in Railway environment variables.');
        }
      } catch (err) {
        console.error('Sync failed:', err);
        text.innerHTML = '<span style="color: var(--color-danger);"> Error</span>';
        alert('Sync failed: ' + err.message);
      } finally {
        setTimeout(() => {
          btn.disabled = false;
          text.textContent = 'Sync Leads';
        }, 3000);
      }
    }

    // Re-analyze lead with Perplexity
    async function reanalyzeLead(id) {
      if (!confirm('Re-analyze this lead? This will fetch fresh data from Perplexity.')) return;

      try {
        const response = await fetch(`/api/lead-quality/analyze/${id}`, {
          method: 'POST',
          credentials: 'include'
        });

        const data = await response.json();

        if (data.success) {
          await loadLeads();
        } else {
          alert(data.error || 'Analysis failed');
        }
      } catch (err) {
        console.error('Re-analyze failed:', err);
        alert('Re-analyze failed');
      }
    }

    // Delete a lead
    async function deleteLead(id, name) {
      if (!confirm(`Are you sure you want to delete the lead "${name}"? This cannot be undone.`)) return;

      try {
        const response = await fetch(`/api/lead-quality/leads/${id}`, {
          method: 'DELETE',
          credentials: 'include'
        });

        const data = await response.json();

        if (data.success) {
          await loadLeads();
        } else {
          alert(data.error || 'Delete failed');
        }
      } catch (err) {
        console.error('Delete failed:', err);
        alert('Delete failed');
      }
    }

    // Unified Analyze Modal State
    let currentAnalyzeLeadId = null;
    let currentAnalyzeLeadType = null; // 'upcoming' or 'past'
    let selectedAnalysisModel = 'gpt-5-nano';
    let isAnalyzing = false;
    let currentTranscriptStatus = null;

    // Open unified analyze modal
    async function openAnalyzeModal(id, type) {
      currentAnalyzeLeadId = id;
      currentAnalyzeLeadType = type;
      isAnalyzing = false;

      // Get lead info
      const lead = allLeads.find(l => l.id === id);
      const leadName = lead?.inviteeName || lead?.inviteeEmail || 'Unknown';
      document.getElementById('analyze-modal-lead-name').textContent = leadName;

      // Reset modal state
      selectedAnalysisModel = 'gpt-5-nano';
      document.querySelectorAll('.model-card').forEach(card => {
        card.classList.toggle('selected', card.dataset.model === 'gpt-5-nano');
      });

      // Hide loading bar and status
      document.getElementById('analyze-loading-bar').classList.remove('active');
      document.getElementById('analyze-status').style.display = 'none';
      document.getElementById('analyze-status').style.color = ''; // Reset color

      // Hide fetch button (will be shown if needed)
      document.getElementById('btn-fetch-fireflies').style.display = 'none';
      document.getElementById('btn-fetch-fireflies').disabled = false;
      document.getElementById('btn-fetch-fireflies').innerHTML = `
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 4px;">
          <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
          <polyline points="7 10 12 15 17 10"></polyline>
          <line x1="12" y1="15" x2="12" y2="3"></line>
        </svg>
        Fetch from Fireflies
      `;

      // Show modal first (for responsiveness)
      document.getElementById('analyzeModal').classList.add('active');

      // For past calls, check transcript availability
      const transcriptStatusSection = document.getElementById('transcript-status-section');
      const transcriptStatusIcon = document.getElementById('transcript-status-icon');
      const transcriptStatusTitle = document.getElementById('transcript-status-title');
      const transcriptStatusSubtitle = document.getElementById('transcript-status-subtitle');

      if (type === 'past') {
        transcriptStatusSection.style.display = 'flex';
        transcriptStatusSection.className = 'transcript-status-modal';
        transcriptStatusIcon.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="animation: spin 1s linear infinite;"><path d="M21 12a9 9 0 1 1-6.219-8.56"></path></svg>';
        transcriptStatusTitle.textContent = 'Checking transcript...';
        transcriptStatusSubtitle.textContent = 'Looking for linked transcript';

        // Check transcript availability
        try {
          const response = await fetch(`/api/lead-quality/check-transcript/${id}`, { credentials: 'include' });
          const data = await response.json();
          currentTranscriptStatus = data.data;

          if (data.success && (currentTranscriptStatus.hasTranscript || currentTranscriptStatus.availableInCallsTab)) {
            transcriptStatusSection.className = 'transcript-status-modal available';
            transcriptStatusIcon.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"></polyline></svg>';
            transcriptStatusTitle.textContent = 'Transcript Available';

            if (currentTranscriptStatus.hasTranscript) {
              transcriptStatusSubtitle.textContent = 'Already linked to this lead';
            } else if (currentTranscriptStatus.availableInCallsTab) {
              transcriptStatusSubtitle.textContent = `Found in Calls tab: ${currentTranscriptStatus.callsTabMatch?.title || 'matching call'}`;
            }

            // Enable analysis button
            document.getElementById('btn-run-analysis').disabled = false;
            document.getElementById('btn-run-analysis').innerHTML = `
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 6px;">
                <polygon points="5 3 19 12 5 21 5 3"></polygon>
              </svg>
              Run Analysis
            `;
          } else {
            transcriptStatusSection.className = 'transcript-status-modal unavailable';
            transcriptStatusIcon.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>';
            transcriptStatusTitle.textContent = 'No Transcript Found';
            transcriptStatusSubtitle.textContent = 'Click "Fetch from Fireflies" to get transcript';

            // Show Fetch from Fireflies button
            document.getElementById('btn-fetch-fireflies').style.display = 'inline-flex';

            // Disable analysis button (need transcript first)
            document.getElementById('btn-run-analysis').disabled = true;
            document.getElementById('btn-run-analysis').innerHTML = `
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 6px;">
                <polygon points="5 3 19 12 5 21 5 3"></polygon>
              </svg>
              No Transcript
            `;
          }
        } catch (err) {
          console.error('Failed to check transcript:', err);
          transcriptStatusSection.className = 'transcript-status-modal unavailable';
          transcriptStatusIcon.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>';
          transcriptStatusTitle.textContent = 'Error checking transcript';
          transcriptStatusSubtitle.textContent = err.message;
        }
      } else {
        // For upcoming calls, hide transcript section
        transcriptStatusSection.style.display = 'none';
        document.getElementById('btn-run-analysis').disabled = false;
        document.getElementById('btn-run-analysis').innerHTML = `
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 6px;">
            <polygon points="5 3 19 12 5 21 5 3"></polygon>
          </svg>
          Run Analysis
        `;
      }
    }

    // Select analysis model
    function selectAnalysisModel(model) {
      if (isAnalyzing) return; // Don't allow change during analysis
      selectedAnalysisModel = model;
      document.querySelectorAll('.model-card').forEach(card => {
        card.classList.toggle('selected', card.dataset.model === model);
      });
    }

    // Run analysis
    async function runAnalysis() {
      if (isAnalyzing) return;
      isAnalyzing = true;

      const btn = document.getElementById('btn-run-analysis');
      const loadingBar = document.getElementById('analyze-loading-bar');
      const statusDiv = document.getElementById('analyze-status');

      // Show loading state
      btn.disabled = true;
      btn.innerHTML = `
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 6px; animation: spin 1s linear infinite;">
          <path d="M21 12a9 9 0 1 1-6.219-8.56"></path>
        </svg>
        Analyzing...
      `;
      loadingBar.classList.add('active');
      statusDiv.style.display = 'block';
      statusDiv.textContent = `Running ${selectedAnalysisModel === 'perplexity-sonar' ? 'Perplexity research' : 'GPT analysis'}...`;

      try {
        let response;

        if (selectedAnalysisModel === 'perplexity-sonar') {
          // Perplexity research
          response = await fetch(`/api/lead-quality/analyze/${currentAnalyzeLeadId}`, {
            method: 'POST',
            credentials: 'include'
          });
        } else {
          // GPT transcript analysis
          response = await fetch(`/api/lead-quality/analyze-transcript/${currentAnalyzeLeadId}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ model: selectedAnalysisModel })
          });
        }

        const data = await response.json();

        if (data.success) {
          statusDiv.textContent = ' Analysis complete!';
          statusDiv.style.color = 'var(--color-success)';

          // Store IDs before closing modal
          const leadId = currentAnalyzeLeadId;
          const leadType = currentAnalyzeLeadType;

          // Reload leads data to get updated analysis
          await loadLeads();

          // Auto-close modal after brief success message
          setTimeout(() => {
            closeAnalyzeModal();
            loadingBar.classList.remove('active');
            isAnalyzing = false;

            // Expand the lead detail row to show results
            const detailId = `${leadType}-${leadId}`;
            toggleDetail(detailId, true); // Force open
          }, 800);

        } else {
          throw new Error(data.error || 'Analysis failed');
        }
      } catch (err) {
        console.error('Analysis failed:', err);
        statusDiv.textContent = ` Error: ${err.message}`;
        statusDiv.style.color = 'var(--color-danger)';
        loadingBar.classList.remove('active');

        btn.disabled = false;
        btn.innerHTML = `
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 6px;">
            <polygon points="5 3 19 12 5 21 5 3"></polygon>
          </svg>
          Retry
        `;
        isAnalyzing = false;
      }
    }

    // Close analyze modal
    function closeAnalyzeModal() {
      currentAnalyzeLeadId = null;
      currentAnalyzeLeadType = null;
      isAnalyzing = false;
      document.getElementById('analyzeModal').classList.remove('active');
      // Hide fetch button when closing
      document.getElementById('btn-fetch-fireflies').style.display = 'none';
    }

    // Fetch transcript from Fireflies
    async function fetchFromFireflies() {
      if (!currentAnalyzeLeadId) return;

      const btn = document.getElementById('btn-fetch-fireflies');
      const statusDiv = document.getElementById('analyze-status');
      const transcriptStatusIcon = document.getElementById('transcript-status-icon');
      const transcriptStatusTitle = document.getElementById('transcript-status-title');
      const transcriptStatusSubtitle = document.getElementById('transcript-status-subtitle');

      // Show loading state on button
      btn.disabled = true;
      btn.innerHTML = `
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 4px; animation: spin 1s linear infinite;">
          <path d="M21 12a9 9 0 1 1-6.219-8.56"></path>
        </svg>
        Fetching...
      `;

      // Update transcript status section
      transcriptStatusIcon.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="animation: spin 1s linear infinite;"><path d="M21 12a9 9 0 1 1-6.219-8.56"></path></svg>';
      transcriptStatusTitle.textContent = 'Fetching transcript...';
      transcriptStatusSubtitle.textContent = 'Searching Fireflies for matching call';

      try {
        const response = await fetch(`/api/lead-quality/fetch-transcript/${currentAnalyzeLeadId}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ source: 'fireflies', syncToCallsTab: true, autoAnalyze: false })
        });

        const data = await response.json();

        if (data.success) {
          // Update transcript status to available
          const transcriptStatusSection = document.getElementById('transcript-status-section');
          transcriptStatusSection.className = 'transcript-status-modal available';
          transcriptStatusIcon.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"></polyline></svg>';
          transcriptStatusTitle.textContent = 'Transcript Fetched';
          transcriptStatusSubtitle.textContent = `From Fireflies: ${data.data?.transcriptTitle || 'call transcript'}`;

          // Hide fetch button
          btn.style.display = 'none';

          // Enable analysis button
          document.getElementById('btn-run-analysis').disabled = false;
          document.getElementById('btn-run-analysis').innerHTML = `
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 6px;">
              <polygon points="5 3 19 12 5 21 5 3"></polygon>
            </svg>
            Run Analysis
          `;

          // Update current transcript status
          currentTranscriptStatus = { hasTranscript: true };

        } else {
          // Show error
          transcriptStatusIcon.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>';
          transcriptStatusTitle.textContent = 'Fetch Failed';
          transcriptStatusSubtitle.textContent = data.error || 'No matching transcript found in Fireflies';

          // Reset button
          btn.disabled = false;
          btn.innerHTML = `
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 4px;">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
              <polyline points="7 10 12 15 17 10"></polyline>
              <line x1="12" y1="15" x2="12" y2="3"></line>
            </svg>
            Retry Fetch
          `;
        }
      } catch (err) {
        console.error('Fetch from Fireflies failed:', err);
        transcriptStatusIcon.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>';
        transcriptStatusTitle.textContent = 'Fetch Error';
        transcriptStatusSubtitle.textContent = err.message;

        // Reset button
        btn.disabled = false;
        btn.innerHTML = `
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 4px;">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
            <polyline points="7 10 12 15 17 10"></polyline>
            <line x1="12" y1="15" x2="12" y2="3"></line>
          </svg>
          Retry Fetch
        `;
      }
    }

    // Legacy function for backward compatibility - redirects to new modal
    function analyzeTranscript(id) {
      openAnalyzeModal(id, 'past');
    }

    // Re-analyze with Perplexity - now opens modal with Perplexity pre-selected
    async function reanalyzeLead(id) {
      // Find the lead type
      const isUpcoming = upcomingLeads.some(l => l.id === id);
      openAnalyzeModal(id, isUpcoming ? 'upcoming' : 'past');
      // Pre-select Perplexity
      selectAnalysisModel('perplexity-sonar');
    }

    // Override modal
    function openOverrideModal(id) {
      currentOverrideLeadId = id;
      const lead = allLeads.find(l => l.id === id);
      if (lead) {
        document.getElementById('override-score').value = lead.effectiveScore || 5;
        document.getElementById('override-notes').value = lead.manualOverride?.notes || '';
      }
      document.getElementById('overrideModal').classList.add('active');
    }

    function closeOverrideModal() {
      currentOverrideLeadId = null;
      document.getElementById('overrideModal').classList.remove('active');
    }

    async function saveOverride() {
      const score = parseInt(document.getElementById('override-score').value, 10);
      const notes = document.getElementById('override-notes').value;

      if (isNaN(score) || score < 1 || score > 10) {
        alert('Score must be between 1 and 10');
        return;
      }

      try {
        const response = await fetch(`/api/lead-quality/override/${currentOverrideLeadId}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ score, notes })
        });

        const data = await response.json();

        if (data.success) {
          closeOverrideModal();
          await loadLeads();
        } else {
          alert(data.error || 'Override failed');
        }
      } catch (err) {
        console.error('Override failed:', err);
        alert('Override failed');
      }
    }

    // Filter handlers
    function applyFilters() {
      loadLeads();
    }

    function handleDateChange() {
      loadLeads();
    }

    function clearFilters() {
      document.getElementById('filter-rep').value = 'all';
      document.getElementById('filter-score').value = 'all';
      document.getElementById('filter-date').value = 'last_30_days';
      loadLeads();
    }

    // Utilities
    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function formatDate(dateStr) {
      if (!dateStr) return '-';
      const date = new Date(dateStr);
      return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
    }

    function formatDateTime(dateStr) {
      if (!dateStr) return '-';
      const date = new Date(dateStr);
      return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) +
             ' at ' + date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
    }

    function truncateUrl(url) {
      if (!url) return '';
      try {
        const parsed = new URL(ensureHttps(url));
        return parsed.hostname.replace(/^www\./, '');
      } catch {
        return url.substring(0, 30) + '...';
      }
    }

    function ensureHttps(url) {
      if (!url) return '';
      if (!url.startsWith('http://') && !url.startsWith('https://')) {
        return 'https://' + url;
      }
      return url;
    }

    function cleanResearchUrl(url) {
      if (!url) return '';
      try {
        // Decode URL-encoded characters
        const decoded = decodeURIComponent(url);
        // Extract hostname and path
        const parsed = new URL(decoded.startsWith('http') ? decoded : 'https://' + decoded);
        const hostname = parsed.hostname.replace(/^www\./, '');
        // Get path without too much detail
        let path = parsed.pathname;
        if (path.length > 40) {
          path = path.substring(0, 37) + '...';
        }
        return hostname + (path !== '/' ? path : '');
      } catch {
        // If URL parsing fails, just truncate
        const decoded = url.replace(/%20/g, ' ').replace(/%2C/g, ',');
        if (decoded.length > 60) {
          return decoded.substring(0, 57) + '...';
        }
        return decoded;
      }
    }

    function formatAnalysisDateTime(dateStr) {
      if (!dateStr) return '-';
      const date = new Date(dateStr);
      return date.toLocaleDateString('en-US', {
        month: 'short',
        day: 'numeric',
        year: 'numeric'
      }) + ' at ' + date.toLocaleTimeString('en-US', {
        hour: 'numeric',
        minute: '2-digit',
        hour12: true
      });
    }
  </script>
</body>
</html>
